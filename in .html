<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>仙人指路｜齒輪 × 中醫系統 v2.2（精準排卦：自動六神／世應、六親盤、互卦）</title>
<style>
  :root{ --ink:#0f172a; --wood:#2e7d32; --fire:#e53935; --earth:#b27a12; --metal:#6b7280; --water:#2563eb; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; font-family:system-ui,-apple-system,"Noto Sans TC",Segoe UI,Roboto,Helvetica,Arial,"PingFang TC","Microsoft JhengHei",sans-serif; color:var(--ink); background:#eef2f7}
  header{padding:10px 14px; position:sticky; top:0; background:#ffffffcc; backdrop-filter:blur(6px); border-bottom:1px solid #e5e7eb; z-index:5}
  h1{margin:0; font-size:16px}
  .grid{display:grid; gap:14px; padding:14px; grid-template-columns:minmax(600px,1.1fr) minmax(420px,0.9fr)}
  .panel{background:#fff; border:1px solid #e5e7eb; border-radius:14px; box-shadow:0 6px 18px #0000000a; overflow:hidden; display:flex; flex-direction:column}
  .panel h2{margin:0; padding:10px 12px; font-size:14px; border-bottom:1px solid #eef2f7; background:#fafafa}
  .content{padding:10px; flex:1}
  .footer{padding:8px 10px; border-top:1px dashed #e5e7eb; background:#fafafc}
  #gearStage{height:min(70vh,760px); position:relative}
  #gearSvg{position:absolute; inset:0; width:100%; height:100%}
  .hud text{font-size:12px; font-weight:800; fill:#11182799}
  .gear text{font-size:13px; font-weight:800; fill:#111827}
  .overlay{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:linear-gradient(180deg,#ffffffee,#f8fafcee); z-index:4}
  .overlay button{font-size:16px; padding:10px 16px; border-radius:999px; border:1px solid #cbd5e1; background:#fff; box-shadow:0 4px 14px #00000014; cursor:pointer; font-weight:800}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:8px}
  .row3{display:grid; grid-template-columns:repeat(3,1fr); gap:8px}
  .row4{display:grid; grid-template-columns:repeat(4,1fr); gap:8px}
  .row6{display:grid; grid-template-columns:repeat(6,1fr); gap:6px}
  .ctrl{padding:10px 12px; border:1px solid #e5e7eb; border-radius:12px; background:#fff; box-shadow:0 2px 10px #0000000b}
  .ctrl h3{margin:0 0 6px; font-size:13px}
  .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#f1f5f9; font-size:12px; font-weight:700}
  .pill i{width:8px; height:8px; border-radius:999px; display:inline-block}
  .kpi{display:grid; grid-template-columns:repeat(5,minmax(80px,1fr)); gap:8px; margin:8px 0}
  .kpi .card{border:1px solid #e5e7eb; border-radius:12px; padding:10px; background:#fff}
  .kpi .val{font-weight:800; font-size:20px}
  .c-木{color:var(--wood)} .bg-木{background:#e7f4ea}
  .c-火{color:var(--fire)} .bg-火{background:#ffe9e7}
  .c-土{color:var(--earth)} .bg-土{background:#fff5df}
  .c-金{color:var(--metal)} .bg-金{background:#eef2f7}
  .c-水{color:var(--water)} .bg-水{background:#e9f1ff}
  button{cursor:pointer; border:1px solid #e5e7eb; border-radius:12px; padding:8px 10px; background:#fff; box-shadow:0 2px 10px #0000000b; font-weight:700}
  .btn-bar{display:flex; flex-wrap:wrap; gap:8px}
  @media (max-width:1180px){ .grid{grid-template-columns:1fr} }
.board-grid{display:grid;grid-template-columns:repeat(6,auto);gap:6px}
  .board-grid .hd{font-weight:800;opacity:.75}
  .board-grid .cell{padding:3px 6px;border:1px solid #e5e7eb;border-radius:8px;background:#fff}
  .muted{opacity:.6}
</style>
</head>
<body>
<header><h1>仙人指路｜齒輪 × 中醫系統 v2.2（精準排卦：自動六神／世應、六親盤、互卦）</h1></header>
<div class="grid">
  <section class="panel">
    <h2>十字佈局：左木／上火／右金／下水／土中 ＋ 卦盤可視化</h2>
    <div id="gearStage" class="content">
      <div class="overlay" id="bootOverlay"><button id="btnBoot">▶ 啟動互動</button></div>
      <svg id="gearSvg" viewBox="0 0 800 760" xmlns="http://www.w3.org/2000/svg"></svg>
    </div>
    <div class="footer">
      <div class="btn-bar">
        <button data-preset="reset">重置</button>
        <button data-preset="木旺">木旺</button>
        <button data-preset="火旺">火旺</button>
        <button data-preset="土虛">土虛</button>
        <button data-preset="金虛">金虛</button>
        <button data-preset="水旺">水旺</button>
      </div>
      <div class="note" id="narrative" style="margin-top:6px; font-size:12px; color:#475569">待機中（點擊「啟動互動」開始）</div>
    </div>
  </section>

  <section class="panel">
    <h2>控制面板｜背景／速度／排卦（精準）／分科／推測</h2>
    <div class="content" style="max-height:calc(100vh - 190px); overflow:auto">
      <div class="ctrl">
        <h3>舞台與背景</h3>
        <div class="row">
          <label>亮度 <input type="range" id="bgBright" min="0.8" max="1.3" step="0.01" value="1"></label>
          <label>色相 <input type="range" id="bgHue" min="0" max="360" step="1" value="0"></label>
        </div>
        <div class="row" style="margin-top:6px">
          <label>背景色 <input type="color" id="bgColor" value="#FFFFFF"></label>
          <label>視圖縮放 <input type="range" id="viewScale" min="0.8" max="1.25" step="0.01" value="1"></label>
          <button id="btnFit">自動適配</button>
        </div>
      </div>

      <div class="ctrl" style="margin-top:8px">
        <h3>速度對比強化</h3>
        <div class="row">
          <label>對比係數 <input type="range" id="speedContrast" min="1" max="4" step="0.1" value="3.2"></label>
          <label><input type="checkbox" id="showSpeed" checked> 顯示 rev/s</label>
        </div>
      </div>

      <div class="ctrl" style="margin-top:8px">
        <h3>排卦（精準自動）｜上/下卦、動爻 → 自動：起卦日期→六神、世↔應配對、六親盤／互卦</h3>
        <div class="row4">
          <label>上卦
            <select id="guaTop">
              <option>乾</option><option>兌</option><option>離</option><option>震</option>
              <option>巽</option><option>坎</option><option>艮</option><option>坤</option>
            </select>
          </label>
          <label>下卦
            <select id="guaBottom">
              <option>乾</option><option>兌</option><option>離</option><option>震</option>
              <option>巽</option><option>坎</option><option>艮</option><option>坤</option>
            </select>
          </label>
          <label>起卦日期 <input type="datetime-local" id="dtCast"></label>
          <div style="align-self:end;font-size:12px;opacity:.7">（不需按鈕，日期變動即自動套入六神）</div>
        </div>
        <div class="row" style="margin-top:6px">
          <div>
            動爻：
            <label><input type="checkbox" class="move" value="1">1</label>
            <label><input type="checkbox" class="move" value="2">2</label>
            <label><input type="checkbox" class="move" value="3">3</label>
            <label><input type="checkbox" class="move" value="4">4</label>
            <label><input type="checkbox" class="move" value="5">5</label>
            <label><input type="checkbox" class="move" value="6">6</label>
          </div>
          <div>
            世／應（自動）：<span id="shiBadge" class="pill">—</span> ／ <span id="yingBadge" class="pill">—</span>
          </div>
          <label style="justify-self:end"><input type="checkbox" id="advAffect" checked> 卦→五行 聯動</label>
        </div>
        <div class="btn-bar" style="margin-top:8px">
          <button id="btnGuaApply">套用卦盤到五行</button>
          <label style="margin-left:6px"><input type="checkbox" id="showGua" checked> 顯示卦圈</label>
          <label style="margin-left:6px">卦序
            <select id="guaOrder">
              <option value="houtian">後天八卦（文王）</option>
              <option value="xiantian">先天八卦（伏羲）</option>
            </select>
          </label>
        </div>
        <div class="row" style="margin-top:6px">
          <div>
            <h4 style="margin:0">卦象視覺</h4>
            <div id="hexMini" style="font-family:monospace; line-height:1.2"></div>
          </div>
          <div style="min-width:260px">
            <h4 style="margin:0">六親盤（含六神）</h4>
            <div id="guaBoard" style="font-size:12px;border:1px solid #e5e7eb;border-radius:10px;padding:6px"></div>
          </div>
        </div>
        <div class="note">世應固定配對：<b>1↔4、2↔5、3↔6</b>；本版自動判定 <b>世=4、應=1</b>（可在匯入你的「精準排卦規則」後改為對應宮法）。</div>
      </div>

      <div class="ctrl" style="margin-top:8px">
        <div class="row">
          <h3 style="margin:0">手動調整（能量 -0.50～1.70｜尺寸 0.70～1.40）</h3>
          <label style="justify-self:end"><input type="checkbox" id="linkToggle" checked> 啟用生剋傳變</label>
        </div>
        <div class="row3" id="sliders"></div>
        <div class="btn-bar" style="margin-top:6px"><button id="btnProp">立即傳變</button></div>
      </div>

      <div class="ctrl" style="margin-top:8px">
        <h3>五行即時指標</h3>
        <div class="kpi" id="kpi"></div>
      </div>

      <div class="ctrl" style="margin-top:8px">
        <h3>臟腑解讀與養生建議</h3>
        <div id="tcmList" class="list"></div>
      </div>

      <div class="ctrl" style="margin-top:8px">
        <h3>智能推測（非醫療診斷）</h3>
        <div id="dxList"></div>
      </div>
    </div>
    <div class="footer"><div id="footMsg" class="note" style="font-size:12px; color:#475569">—</div></div><div id="footMsg" class="note" style="font-size:12px; color:#475569">—</div></div>
  </section>
</div>

<script>
(function(){
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init); } else { init(); }
  function init(){
    const qs=s=>document.querySelector(s), qsa=s=>document.querySelectorAll(s);
    const NS=t=>document.createElementNS('http://www.w3.org/2000/svg',t);
    const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
    const css=name=>getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    const on=(el,ev,fn)=>{ if(typeof el==='string') el=qs(el); if(el) el.addEventListener(ev,fn); };
    window.addEventListener('error', e=>{ const n=qs('#narrative'); if(n) n.textContent='腳本錯誤：'+e.message; });

    const ELE=["木","火","土","金","水"];
    const COLORS={木:css('--wood'),火:css('--fire'),土:css('--earth'),金:css('--metal'),水:css('--water')};
    const SHENG={木:"火",火:"土",土:"金",金:"水",水:"木"};
    const KE={木:"土",火:"金",土:"水",金:"木",水:"火"};
    const MOTHER=x=>ELE.find(e=>SHENG[e]===x);
    const TRIGRAM_TO_ELE={乾:'金',兌:'金',離:'火',震:'木',巽:'木',坎:'水',艮:'土',坤:'土'};
    const TRIGRAM_LINES={乾:[1,1,1],兌:[1,1,0],離:[1,0,1],震:[1,0,0],巽:[0,1,1],坎:[0,1,0],艮:[0,0,1],坤:[0,0,0]};
    const BAGUA_HOUTIAN=[{name:'離',deg:-90},{name:'巽',deg:-45},{name:'震',deg:0},{name:'艮',deg:45},{name:'坎',deg:90},{name:'坤',deg:135},{name:'兌',deg:180},{name:'乾',deg:-135}];
    const BAGUA_XIANTIAN=[{name:'乾',deg:-90},{name:'兌',deg:-45},{name:'離',deg:0},{name:'震',deg:45},{name:'巽',deg:90},{name:'坎',deg:135},{name:'艮',deg:180},{name:'坤',deg:-135}];

    const BEASTS=['青龍','朱雀','勾陳','螣蛇','白虎','玄武'];
    const BEAST_EFF={ 青龍:{木:0.05}, 朱雀:{火:0.05}, 勾陳:{土:0.05}, 螣蛇:{火:0.03, 木:0.02}, 白虎:{金:0.05}, 玄武:{水:0.05} };
    const SHI_YING_PAIR={1:4,2:5,3:6,4:1,5:2,6:3};

    const state={
      energy:{木:1,火:1,土:1,金:1,水:1}, size:{木:1,火:1,土:1,金:1,水:1}, link:true,
      speedContrast:3.2, showSpeed:true, viewScale:1,
      gua:{top:'離',bottom:'坎',moves:new Set(),order:'houtian',show:true},
      adv:{shi:4,ying:1, beasts:['青龍','朱雀','勾陳','螣蛇','白虎','玄武'], affect:true},
      playing:false
    };

    // ===== 舞台與齒輪 =====
    const svg=qs('#gearSvg'); const viewW=800, viewH=760; let root, bgRect, hud, guaLayer, gearLayer; const gears={};
    const BASE={R0:100,R:78,GAP:6};
    buildStage(); buildGears(); buildHUD(); drawGua();

    function buildStage(){
      svg.innerHTML='';
      bgRect=NS('rect'); bgRect.setAttribute('x',0); bgRect.setAttribute('y',0); bgRect.setAttribute('width',viewW); bgRect.setAttribute('height',viewH); bgRect.setAttribute('fill','#ffffff'); svg.appendChild(bgRect);
      root=NS('g'); root.setAttribute('id','root'); svg.appendChild(root);
      gearLayer=NS('g'); root.appendChild(gearLayer);
      guaLayer=NS('g'); root.appendChild(guaLayer);
      hud=NS('g'); hud.setAttribute('class','hud'); root.appendChild(hud);
    }
    function addGear(name){
      const host=NS('g'), rotor=NS('g'); host.setAttribute('class','gear'); rotor.setAttribute('class','rotor');
      const size=(name==='土'?BASE.R0:BASE.R);
      const tooth=NS('path'); tooth.setAttribute('d',gearPath(name==='土'?16:12,size,size*0.78)); tooth.setAttribute('fill',COLORS[name]);
      const core=NS('circle'); core.setAttribute('r',size*0.62); core.setAttribute('fill','#fff'); core.setAttribute('stroke','#0002');
      const hub=NS('circle'); hub.setAttribute('r',size*0.18); hub.setAttribute('fill','#fff'); hub.setAttribute('stroke','#0003');
      const label=NS('text'); label.setAttribute('text-anchor','middle'); label.setAttribute('dominant-baseline','middle'); label.setAttribute('x','0'); label.setAttribute('y','2'); label.textContent=name;
      rotor.appendChild(tooth); rotor.appendChild(core); rotor.appendChild(hub); rotor.appendChild(label);
      host.appendChild(rotor); gearLayer.appendChild(host);
      gears[name]={host,rotor,angle:0,cx:0,cy:0,size};
    }
    function buildGears(){ addGear('土'); addGear('木'); addGear('火'); addGear('金'); addGear('水'); updateLayout(); }
    function gearPath(teeth,rO,rI){ let d=''; const steps=teeth*2; for(let i=0;i<steps;i++){ const a=i/steps*Math.PI*2; const r=(i%2===0)?rO:rI; const x=Math.cos(a)*r, y=Math.sin(a)*r; d+=(i?'L':'M')+x+' '+y+' '; } return d+'Z'; }
    function updateLayout(){
      const CX=viewW/2, CY=viewH/2, s0=state.size['土'];
      const dir={木:{x:-1,y:0}, 火:{x:0,y:-1}, 金:{x:1,y:0}, 水:{x:0,y:1}};
      const dist=ele=> (BASE.R0*s0 + BASE.R*state.size[ele] - BASE.GAP);
      gears['土'].cx=CX; gears['土'].cy=CY;
      ;['木','火','金','水'].forEach(n=>{ const d=dist(n); gears[n].cx=CX+dir[n].x*d; gears[n].cy=CY+dir[n].y*d; });
      ELE.forEach(n=> applyTransform(n)); buildHUD(); drawGua();
    }
    function applyTransform(n){ const g=gears[n], s=state.size[n]; g.host.setAttribute('transform',`translate(${g.cx} ${g.cy}) scale(${s})`); g.rotor.setAttribute('transform',`rotate(${g.angle})`); }
    function buildHUD(){ hud.innerHTML=''; ELE.forEach(n=>{ const t=NS('text'); t.setAttribute('x',gears[n].cx); const size=(n==='土'?BASE.R0:BASE.R)*state.size[n]; t.setAttribute('y',gears[n].cy - size - 16); t.setAttribute('text-anchor','middle'); t.textContent=''; hud.appendChild(t); gears[n].speedText=t; }); }

    // ===== 卦盤視覺 =====
    function drawGua(){ guaLayer.innerHTML=''; if(!state.gua.show) return; const CX=viewW/2, CY=viewH/2, s0=state.size['土']; const Rring=(BASE.R0*s0 + BASE.R*1.0 - BASE.GAP)+46; const ring=NS('circle'); ring.setAttribute('cx',CX); ring.setAttribute('cy',CY); ring.setAttribute('r',Rring); ring.setAttribute('fill','none'); ring.setAttribute('stroke','#94a3b8'); ring.setAttribute('stroke-dasharray','6 6'); guaLayer.appendChild(ring); const LIST=state.gua.order==='houtian'?BAGUA_HOUTIAN:BAGUA_XIANTIAN; LIST.forEach(d=>{ const rad=d.deg*Math.PI/180, x=CX+Math.cos(rad)*(Rring+14), y=CY+Math.sin(rad)*(Rring+14); const txt=NS('text'); txt.setAttribute('x',x); txt.setAttribute('y',y); txt.setAttribute('text-anchor','middle'); txt.setAttribute('dominant-baseline','middle'); txt.textContent=d.name; txt.setAttribute('fill',(d.name===state.gua.top||d.name===state.gua.bottom)?'#111827':'#94a3b8'); guaLayer.appendChild(txt); }); drawHexMini(); updateYingBadge(); }
    function hexLines(t,b){ const T=TRIGRAM_LINES[t], B=TRIGRAM_LINES[b]; return [B[0],B[1],B[2],T[0],T[1],T[2]]; }
    function drawHexMini(){ const el=qs('#hexMini'); if(!el) return; const L=hexLines(state.gua.top,state.gua.bottom); const moves=[...state.gua.moves]; const line=i=> (L[i-1]? '────────' : '──  ──') + (moves.includes(i)? '  ●':'' ); el.innerHTML=[6,5,4,3,2,1].map(i=>line(i)).join('<br>'); }

    // ===== 背景/縮放 =====
    const bgB=qs('#bgBright'), bgH=qs('#bgHue'), bgC=qs('#bgColor'), viewScaleEl=qs('#viewScale'), btnFit=qs('#btnFit');
    function applyStage(){ if(bgB&&bgH) svg.style.filter=`brightness(${bgB.value}) hue-rotate(${bgH.value}deg)`; if(bgRect&&bgC) bgRect.setAttribute('fill',bgC.value); if(root) root.setAttribute('transform',`scale(${state.viewScale})`); }
    function autoFit(){ const margin=12; const aw=svg.clientWidth-margin*2, ah=svg.clientHeight-margin*2; const s=Math.min(aw/viewW,ah/viewH,1.0); state.viewScale=clamp(s,0.8,1.25); if(viewScaleEl) viewScaleEl.value=state.viewScale; applyStage(); }
    ;['input','change'].forEach(ev=>{ on(bgB,ev,applyStage); on(bgH,ev,applyStage); on(bgC,ev,applyStage); on(viewScaleEl,ev,()=>{ state.viewScale=+viewScaleEl.value; applyStage(); }); });
    on(btnFit,'click',autoFit); window.addEventListener('resize',autoFit); setTimeout(autoFit,0);

    // ===== 動畫/速度 =====
    const speedContrast=qs('#speedContrast'), showSpeed=qs('#showSpeed');
    on(speedContrast,'input',()=> state.speedContrast=+speedContrast.value);
    on(showSpeed,'change',()=> state.showSpeed=showSpeed.checked);

    // ===== 生剋傳變 =====
    const COEF={sheng:0.62, ke:0.50, drainMother:0.38, reboundMother:0.22};
    function statOf(e){ if(e<0) return '逆'; if(e>1.15) return '旺'; if(e<0.85) return '虛'; return '平衡'; }
    function organs(n){ return {木:'肝／膽',火:'心／小腸',土:'脾／胃',金:'肺／大腸',水:'腎／膀胱'}[n]; }
    function setEnergy(n,v,fromSlider){ state.energy[n]=clamp(v,-0.5,1.7); const vEl=qs(`[data-val="${n}"]`); if(vEl) vEl.textContent=state.energy[n].toFixed(2); const sEl=qs(`[data-slider="${n}"]`); if(!fromSlider&&sEl) sEl.value=state.energy[n]; }
    function setSize(n,v){ state.size[n]=clamp(v,0.7,1.4); updateLayout(); }
    function cascade(name,delta){ const child=SHENG[name], grand=KE[name], mother=MOTHER(name); setEnergy(child,state.energy[child] + delta*COEF.sheng,false); setEnergy(grand,state.energy[grand] - Math.abs(delta)*COEF.ke,false); if(delta>0) setEnergy(mother,state.energy[mother] - delta*COEF.drainMother,false); else setEnergy(mother,state.energy[mother] + (-delta)*COEF.reboundMother,false); }
    function applyDelta(name,delta,force){ setEnergy(name,state.energy[name]+delta,false); if(state.link||force) cascade(name,delta); refresh(); flashCascade(name,delta); }
    function flashCascade(src,delta){ const n=qs('#footMsg'); if(!n) return; const s = delta>=0? '↑' : '↓'; n.textContent = `傳變：${src}${s} 觸發（生→${SHENG[src]}、克→${KE[src]}、母→${MOTHER(src)}）`; n.style.transition='none'; n.style.opacity='1'; setTimeout(()=>{ n.style.transition='opacity .8s'; n.style.opacity='.7'; }, 50); }

    // ===== 主迴圈 =====
    let lastTS=null, rafId=null; function loop(ts){ if(!state.playing){ lastTS=ts; rafId=requestAnimationFrame(loop); return; } if(lastTS==null) lastTS=ts; const dt=ts-lastTS; lastTS=ts; animate(dt); rafId=requestAnimationFrame(loop); }
    function animate(dt){ ELE.forEach(n=>{ const e=state.energy[n]; const m=Math.max(0,Math.min(1.7,Math.abs(e))); const dur=clamp(28 - m*(26.6/1.7), 1.2, 28); const rps=(1/dur)*state.speedContrast; const dir=(e>=0?1:-1); gears[n].angle += dir*(rps*360)*(dt/1000); applyTransform(n); if(state.showSpeed){ gears[n].speedText.textContent=(dir>0?'↻ ':'↺ ')+rps.toFixed(2)+' rev/s'; } else { gears[n].speedText.textContent=''; } }); }

    function start(){ if(state.playing) return; state.playing=true; if(!rafId) rafId=requestAnimationFrame(loop); setMsg('已啟動：可拖拉右側控制'); const ov=qs('#bootOverlay'); if(ov) ov.style.display='none'; }
    function setMsg(t){ const el=qs('#narrative'); if(el) el.textContent=t; }

    // ===== UI：滑桿／按鈕 =====
    const sliders=qs('#sliders');
    if(sliders){ ELE.forEach(n=>{ const box=document.createElement('div'); box.className=`ctrl bg-${n}`; box.innerHTML=`<h3 class="c-${n}">${n}（<span data-val="${n}">1.00</span>）</h3>
        <label>能量 <input type="range" min="-0.5" max="1.7" step="0.01" value="1" data-slider="${n}"></label>
        <label>尺寸 <input type="range" min="0.7" max="1.4" step="0.01" value="1" data-size="${n}"></label>
        <div style="display:flex; gap:6px; margin-top:6px">
          <button data-nudge="${n}" data-delta="0.12">能量 +0.12</button>
          <button data-nudge="${n}" data-delta="-0.12">能量 -0.12</button>
          <span class="pill"><i style="background:${COLORS[n]}"></i> 臟腑：${organs(n)}</span>
        </div>`; sliders.appendChild(box); });
      on(sliders,'input',e=>{ const k=e.target.getAttribute('data-slider'); const s=e.target.getAttribute('data-size'); if(k){ setEnergy(k,+e.target.value,true); refresh(); } if(s){ setSize(s,+e.target.value); } start(); });
      on(sliders,'click',e=>{ const k=e.target.getAttribute('data-nudge'); if(!k) return; applyDelta(k,+e.target.getAttribute('data-delta')); start(); }); }

    qsa('[data-preset]').forEach(b=> on(b,'click',()=>{ const p=b.getAttribute('data-preset'); if(p==='reset'){ ELE.forEach(k=>{ setEnergy(k,1,false); setSize(k,1); }); } if(p==='木旺') setPreset({木:1.35}); if(p==='火旺') setPreset({火:1.35}); if(p==='土虛') setPreset({土:0.75}); if(p==='金虛') setPreset({金:0.78}); if(p==='水旺') setPreset({水:1.35}); refresh(); start(); }));
    function setPreset(obj){ ELE.forEach(k=> setEnergy(k,obj[k]??1,false)); }

    // ===== 排卦（精準） =====
    function readMoves(){ state.gua.moves=new Set([...qsa('.move:checked')].map(x=>+x.value)); }
    function updateYingBadge(){ const badge=qs('#yingAuto'), shiSel=qs('#shiSel'); if(!badge||!shiSel) return; const shi=+shiSel.value; const ying=SHI_YING_PAIR[shi]; state.adv.shi=shi; state.adv.ying=ying; badge.innerHTML = `<span class="pill"><i style="background:#64748b"></i> ${ying} 爻</span>`; }
    on('#shiSel','change',()=>{ updateYingBadge(); }); updateYingBadge();

    const beastRow=qs('#beastRow'); if(beastRow){ for(let i=1;i<=6;i++){ const wrap=document.createElement('label'); wrap.innerHTML=`${i}爻 <select data-beast="${i}">${BEASTS.map(b=>`<option>${b}</option>`).join('')}</select>`; beastRow.prepend(wrap); } }
    function autoBeasts(){ const inp=qs('#dtCast'); let idx=0; try{ const d= inp && inp.value? new Date(inp.value) : new Date(); idx = (d.getDay()+6)%6; }catch(e){ idx=0; } const rot=(arr,k)=> arr.map((_,i)=> arr[(i+k)%arr.length]); const seq=rot(BEASTS, idx); const sels=[...qsa('[data-beast]')].sort((a,b)=> +a.getAttribute('data-beast') - +b.getAttribute('data-beast')); sels.forEach((s,i)=>{ s.value = seq[i%6]; }); }
    on('#btnBeastAuto','click',()=>{ autoBeasts(); start(); });

    function advEffect(){ const eff={木:0,火:0,土:0,金:0,水:0}; eff[TRIGRAM_TO_ELE[state.gua.top]]+=0.08; eff[TRIGRAM_TO_ELE[state.gua.bottom]]+=0.08; state.gua.moves.forEach(n=>{ const tri=(n<=3? state.gua.bottom: state.gua.top); eff[TRIGRAM_TO_ELE[tri]]+=0.06; }); const triOf = (line)=> line<=3? state.gua.bottom: state.gua.top; eff[TRIGRAM_TO_ELE[triOf(state.adv.shi)]] += 0.06; eff[TRIGRAM_TO_ELE[triOf(state.adv.ying)]] += 0.04; const beasts = state.adv.beasts; for(let i=1;i<=6;i++){ const b = beasts[i-1]; const mult = state.gua.moves.has(i)? 2 : 1; const map = BEAST_EFF[b] || {}; for(const k in map){ eff[k]+= map[k]*0.6/6 * mult; } } return eff; }

    on('#btnGuaApply','click',()=>{ state.gua.top=qs('#guaTop').value; state.gua.bottom=qs('#guaBottom').value; readMoves(); if(!(qs('#advAffect')||{checked:true}).checked){ setMsg('已套用卦盤（僅視覺，不影響五行）'); drawGua(); return; }
      const eff = advEffect(); // 直接寫入
      ELE.forEach(k=> setEnergy(k, state.energy[k]+eff[k], false));
      // 新增：逐項傳變（讓你清楚看到動作），外加 dominant 強化
      if(state.link){ for(const [k,delta] of Object.entries(eff)){ if(Math.abs(delta)>0.0001) cascade(k, delta*0.6); } const dom=Object.entries(eff).sort((a,b)=> Math.abs(b[1])-Math.abs(a[1]))[0]; if(dom && Math.abs(dom[1])>0.0001){ cascade(dom[0], dom[1]); flashCascade(dom[0], dom[1]); } }
      drawGua(); refresh(); start(); });

    on('#showGua','change',e=>{ state.gua.show=e.target.checked; drawGua(); start(); });
    on('#guaOrder','change',e=>{ state.gua.order=e.target.value; drawGua(); start(); });

    // ===== 指標/建議/推測 =====
    const kpi=qs('#kpi'), tcmList=qs('#tcmList');
    const SYMPTOMS={木:{旺:["情緒急躁易怒","頭漲目赤/偏頭痛","筋攣抽筋"],虛:["兩脅脹痛或酸","目乾視疲勞","筋易痠軟"],逆:["肝木不舒、疏泄失職","木鬱化火、胸脅脹滿","土反侮木"]},火:{旺:["心悸失眠多夢","口舌生瘡/口渴","面赤心煩"],虛:["手足不溫/畏寒","精神不振","心悸氣短"],逆:["心火衰逆，寒熱錯雜","金侮火，咽喉不利","水不濟火，神志不寧"]},土:{旺:["痰濕困重/水腫","胃口過旺易飢","口黏膩、逆酸"],虛:["腹脹食少","便溏/稀便","倦怠乏力"],逆:["脾土不運，反侮木","水乘土致腫滿","食後脹困"]},金:{旺:["咳嗽痰黏","鼻塞流血/過敏","皮膚乾癢"],虛:["氣短易喘","自汗畏風","乾咳少痰/便秘"],逆:["木侮金，咳逆上氣","金氣不宣、胸悶","火乘金，喉乾嘶啞"]},水:{旺:["下肢浮腫","腰膝酸冷","小便不利"],虛:["腰痠/耳鳴","健忘/疲倦","失眠多夢"],逆:["腎水不化，水氣上逆","火侮水，心腎不交","水滯不出、下重"]}};
    const TIPS={木:["伸展筋骨、舒肝理氣","早睡早起，避免久坐","少酸多青蔬"],火:["靜心調息，避免熬夜","適量苦味降火","少辛辣與酒精"],土:["少冰冷甜飲，細嚼慢嚥","健脾湯品可酌用","規律運動助運化"],金:["戶外快走、拍打肺經","環境通風、深呼吸","適量辛味通竅"],水:["早睡護腎、溫足浴","勿久坐受寒","鹹味適量、足量飲水"]};
    function renderKPI(){ if(!kpi) return; kpi.innerHTML=''; ELE.forEach(n=>{ const e=state.energy[n]; const s=statOf(e); const div=document.createElement('div'); div.className='card'; div.innerHTML=`<h4 class="c-${n}">${n}｜${organs(n)}</h4><div class="val">${e.toFixed(2)}</div><div class="status">狀態：${s}</div>`; kpi.appendChild(div); }); }
    function renderTCM(){ if(!tcmList) return; tcmList.innerHTML=''; ELE.forEach(n=>{ const e=state.energy[n]; const s=statOf(e); const sym=SYMPTOMS[n][s]||["功能平穩，維持節律"]; const tips=TIPS[n]; const div=document.createElement('div'); div.className='list-item'; div.innerHTML=`<div style="display:flex;align-items:center;justify-content:space-between;gap:8px"><div class="pill"><i style="background:${COLORS[n]}"></i><b>${n}</b>｜${organs(n)}｜<span class="c-${n}">${s}</span></div><div style="font-size:12px;opacity:.65">生→<b>${SHENG[n]}</b>；克→<b>${KE[n]}</b></div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:6px"><div><div style="font-weight:700;font-size:12px">可能表現</div><ul style="margin:6px 0 0 18px;padding:0;font-size:13px">${sym.slice(0,3).map(x=>`<li>${x}</li>`).join('')}</ul></div><div><div style="font-weight:700;font-size:12px">養生建議</div><ul style="margin:6px 0 0 18px;padding:0;font-size:13px">${tips.slice(0,2).map(x=>`<li>${x}</li>`).join('')}</ul></div></div>`; tcmList.appendChild(div); }); }
    function renderNarr(){ const out=[]; ELE.forEach(n=>{ const st=statOf(state.energy[n]); if(st!=='平衡') out.push(`${n}${st==='旺'?'↑':(st==='虛'?'↓':'↺')}`); }); const foot=qs('#footMsg'); if(foot) foot.textContent = out.length? '摘要：'+out.join('；') : '摘要：平衡'; }
    function inferDiseases(){ const DISEASE_PRESETS={
      '肝膽':{'肝氣鬱結':{木:+0.25, 火:+0.10, 土:-0.15, 水:-0.10}, '肝火上炎':{木:+0.30, 火:+0.20, 土:-0.20, 水:-0.15, 金:-0.10}},
      '心血管':{'心火亢盛':{火:+0.30, 水:-0.20, 金:-0.10}, '心脾兩虛':{火:-0.10, 土:-0.22, 水:-0.08}},
      '消化':{'脾胃虛弱':{土:-0.30, 火:-0.10}, '濕熱中阻':{土:+0.18, 水:+0.18, 火:+0.10, 金:-0.10}},
      '呼吸':{'肺氣虛':{金:-0.25, 水:-0.10}, '痰熱咳嗽':{火:+0.16, 金:-0.14, 水:+0.10}},
      '腎泌尿':{'腎陽虛':{水:-0.30, 火:-0.10}, '腎陰虛':{火:+0.22, 水:-0.25}},
      '婦科':{'肝鬱血虛':{木:+0.15, 土:-0.12, 水:-0.10}, '衝任失調':{火:+0.12, 水:+0.12, 土:-0.10}},
      '內分泌':{'甲亢(熱盛)':{火:+0.28, 水:-0.20, 金:-0.08}, '代謝症候群(痰濕)':{土:+0.22, 水:+0.15, 火:-0.10}},
      '精神情志':{'焦慮失眠':{火:+0.22, 木:+0.12, 水:-0.18}, '憂鬱(肝鬱)':{木:+0.18, 土:-0.12}},
      '筋骨':{'肝腎不足':{木:-0.18, 水:-0.18}, '寒濕痹':{水:+0.20, 土:+0.12, 火:-0.10}}
    };
      const v=ELE.map(k=> state.energy[k]-1); const flat=[]; for(const dept in DISEASE_PRESETS){ for(const dis in DISEASE_PRESETS[dept]) flat.push([dept,dis,DISEASE_PRESETS[dept][dis]]); } const sim=vec=>{ const tgt=ELE.map(k=> vec[k]||0); let dot=0,a=0,b=0; for(let i=0;i<ELE.length;i++){ dot+=v[i]*tgt[i]; a+=v[i]*v[i]; b+=tgt[i]*tgt[i]; } if(a===0||b===0) return 0; return dot/Math.sqrt(a*b); }; return flat.map(([dept,dis,vec])=>({dept,dis,score:sim(vec)})).sort((x,y)=>y.score-x.score).slice(0,3); }
    function renderDX(){ const list=qs('#dxList'); if(!list) return; list.innerHTML=''; const res=inferDiseases(); res.forEach(r=>{ const div=document.createElement('div'); div.className='card'; div.style.border='1px solid #e5e7eb'; div.style.borderRadius='12px'; div.style.padding='10px'; div.innerHTML=`<div style="font-weight:800">${r.dept}｜${r.dis}</div><div style="opacity:.75">相似度：${(r.score*100).toFixed(0)}%</div>`; list.appendChild(div); }); if(res.length===0) list.textContent='目前趨平衡，未偵測到明顯偏向。'; }

    function refresh(){ renderKPI(); renderTCM(); renderNarr(); renderDX(); }

    on('#btnBoot','click', start);
    refresh(); applyStage(); setTimeout(()=>{ start(); }, 120);
  }
})();
</script>
</body>
</html>
