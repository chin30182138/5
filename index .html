<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>仙人指路六爻排盤（0831-V3）</title>
<style>
  :root{--card:#fff;--line:#e5e7eb;--muted:#64748b}
  *{box-sizing:border-box}
  body{margin:0;background:#f6f7fb;font-family:"Noto Sans TC","Microsoft JhengHei",system-ui}
  main{max-width:1180px;margin:18px auto;padding:0 12px}
  h1{margin:0 0 10px;font-size:22px}
  .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:12px}
  .sec{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;margin:10px 0}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0}
  input[type=text]{flex:1;min-width:220px;border:1px solid #cbd5e1;border-radius:8px;height:36px;padding:0 10px;font-size:14px}
  input[type=datetime-local], select, button{height:36px;border:1px solid #cbd5e1;border-radius:8px;background:#fff;padding:0 10px;font-size:14px}
  button{cursor:pointer}
  .muted{color:var(--muted);font-size:13px}
  .badge{display:inline-block;padding:2px 10px;border-radius:999px;background:#eef2ff;color:#4338ca;font-size:12px}
  .canvasWrap{border:1px solid var(--line);border-radius:10px;background:#fff;padding:8px}
  canvas{display:block;width:100%;height:560px}
  .yaoCtl{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
  .yaoCtl>label{display:flex;align-items:center;gap:6px;justify-content:center;border:1px dashed #cbd5e1;border-radius:8px;padding:6px;font-size:14px}
  #err{position:fixed;right:12px;top:12px;max-width:60ch;background:#fee2e2;color:#991b1b;border:1px solid #fecaca;border-radius:10px;padding:10px;display:none}
  .miniVal{font-variant-numeric:tabular-nums;color:#475569;font-size:13px}
  .btns button{height:32px}
  .pillars{display:flex;gap:10px;flex-wrap:wrap}
  .pillars span{background:#eef2ff;color:#1e3a8a;border-radius:8px;padding:4px 10px;font-size:13px}
  .rightNote{white-space:pre-wrap;margin-top:8px;background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:10px;font-size:14px}
  @media print {
    @page { size: A4 portrait; margin: 12mm; }
    .grid { display:block; }
    .sec { border:none; padding:0; margin:0 0 10px; }
    .hide-print, .btns, .yaoCtl, #redraw, #download, #btnNow, #btnPrint, #size, #offx, #offy, #gap, #headgap, #sizeVal, #offxVal, #offyVal, #gapVal, #headgapVal { display:none !important; }
    .canvasWrap { border:none; padding:0; }
    canvas { height:auto; width:100%; }
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.11/lunar.min.js"></script>
</head>
<body>
<main>
  <h1>仙人指路六爻排盤（0831-V3）</h1>
  <div id="err"></div>

  <div class="grid">
    <section class="sec">
      <div class="row hide-print">
        <label>上卦</label>
        <select id="upper">
          <option>乾</option><option>兌</option><option>離</option><option>震</option>
          <option>巽</option><option selected>坎</option><option>艮</option><option>坤</option>
        </select>
        <span>下卦</span>
        <select id="lower">
          <option selected>坎</option><option>乾</option><option>兌</option><option>離</option>
          <option>震</option><option>巽</option><option>艮</option><option>坤</option>
        </select>
        <span class="badge">伏神＝缺則回本宮純卦補位｜世應：1↔4、2↔5、3↔6</span>
      </div>

      <div class="row btns hide-print" style="gap:8px">
        <button id="btnTai">地天泰（坤宮）</button>
        <button id="btnWeiJi">火水未濟（離宮）</button>
      </div>

      <div class="row hide-print" style="gap:14px">
        <label>問題</label>
        <input id="question" type="text" placeholder="請輸入起卦問題（會印在卦象上方）" value="示例：求財運">
      </div>

      <div class="row hide-print" style="gap:14px">
        <label>時間</label>
        <input id="dt" type="datetime-local">
        <button id="btnNow">現在</button>
        <button id="btnPrint">列印（A4）</button>
        <span class="muted">四柱由 Lunar.js 精準換算（含節氣切換）</span>
      </div>

      <div class="row pillars">
        <span id="gzYear">年：—</span>
        <span id="gzMonth">月：—</span>
        <span id="gzDay">日：—</span>
        <span id="gzHour">時：—</span>
        <span id="gzXun">旬首：—</span>
        <span id="gzKW">空亡：—</span>
      </div>

      <div class="row hide-print">
        <label>動爻</label>
        <div class="yaoCtl" id="mvCtl"></div>
      </div>

      <div class="row hide-print" style="gap:10px">
        <button id="redraw">重繪卦象</button>
        <button id="download">匯出 PNG</button>
      </div>

      <div class="canvasWrap"><canvas id="hexCanvas"></canvas></div>
<!-- 備註（可列印） -->
<div id="noteBox" class="noteBox">
  <label for="userNote" style="display:block;margin:6px 0 4px;color:#0f172a;font-size:14px">備註（會列印）</label>
  <textarea id="userNote" rows="5" placeholder="在此輸入要印在卦象旁的說明、重點、問卦背景等"></textarea>
</div>

      <div class="row hide-print">
        <label>大小</label><input type="range" id="size" min="140" max="440" value="300"><span class="miniVal" id="sizeVal">300</span>
        <label>水平</label><input type="range" id="offx" min="-320" max="320" value="0"><span class="miniVal" id="offxVal">0</span>
        <label>垂直</label><input type="range" id="offy" min="-220" max="220" value="0"><span class="miniVal" id="offyVal">0</span>
        <label>爻距</label><input type="range" id="gap" min="26" max="38" value="32"><span class="miniVal" id="gapVal">32</span>
        <label>欄頭間距</label><input type="range" id="headgap" min="16" max="48" value="24"><span class="miniVal" id="headgapVal">24</span>
      </div>

      <div class="muted">欄序：<b>六獸</b>｜<b>伏神</b>｜<b>爻象</b>｜<b>六親</b>｜<b>地支</b>｜<b>世應</b>｜<b>變六親</b>｜<b>變支</b>（初爻在下；動爻：陽○、陰×）。</div>
    </section>

    <section class="sec hide-print">
      <div id="headInfo" class="muted" style="font-size:14px">卦名：—　上卦：—　下卦：—　卦宮：—　卦型：—　世：—　應：—</div>
      <pre id="brief" class="rightNote">（這裡會列出六爻摘要）</pre>
<!-- ★ 中醫系統：放在右欄（可列印） -->
<div id="tcmBox" class="tcm-box">
  <h3>中醫分科建議</h3>
  <div id="tcmCore"></div>
  <div id="tcmLists"></div>
  <div class="tcm-note">※ 本欄為一般性養生與就診建議，非醫療診斷；若有急性或持續性不適，請儘速就醫。</div>
</div>
</section>
  </div>
</main>

<script>
const E=(id)=>{const el=document.getElementById(id);if(!el){const b=document.getElementById('err');b.style.display='block';b.textContent='⚠️ 缺少元素 #'+id;}return el;};
(function(){const box=E('err');const show=msg=>{box.style.display='block';box.textContent='⚠️ 發生錯誤：'+msg};window.addEventListener('error',e=>show(e.message||e.error));window.addEventListener('unhandledrejection',e=>show(e.reason&&e.reason.message?e.reason:String(e.reason)));})();

/* ===== 常量 ===== */
const GAN=['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
const ZHI=['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];
const ZHI_ELEM={子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'};
const GONG_ELEM={乾:'金',坤:'土',震:'木',巽:'木',坎:'水',離:'火',艮:'土',兌:'金'};
const TRIG={乾:[1,1,1],兌:[1,1,0],離:[1,0,1],震:[1,0,0],巽:[0,1,1],坎:[0,1,0],艮:[0,0,1],坤:[0,0,0]};
const TRINAMES=Object.keys(TRIG); const YANG_TRIG=new Set(['乾','震','坎','艮']);
const INNER_START={乾:'子',坎:'寅',震:'子',艮:'辰',坤:'未',巽:'丑',離:'卯',兌:'巳'};
const OUTER_START={乾:'午',坎:'申',震:'午',艮:'戌',坤:'丑',巽:'未',離:'酉',兌:'亥'};
const SEQ_YANG=['子','寅','辰','午','申','戌']; const SEQ_YIN=['亥','酉','未','巳','卯','丑'];
const SIX=['青龍','朱雀','勾陳','螣蛇','白虎','玄武'];
const SIX_START_BY_GAN={甲:0,乙:0,丙:1,丁:1,戊:2,己:3,庚:4,辛:4,壬:5,癸:5};
const NAMES={ '乾':{'乾':'乾為天','兌':'天澤履','離':'天火同人','震':'天雷無妄','巽':'天風姤','坎':'天水訟','艮':'天山遁','坤':'天地否'},
 '兌':{'乾':'澤天夬','兌':'兌為澤','離':'澤火革','震':'澤雷隨','巽':'澤風大過','坎':'澤水困','艮':'澤山咸','坤':'澤地萃'},
 '離':{'乾':'火天大有','兌':'火澤睽','離':'離為火','震':'火雷噬嗑','巽':'火風鼎','坎':'火水未濟','艮':'火山旅','坤':'火地晉'},
 '震':{'乾':'雷天大壯','兌':'雷澤歸妹','離':'雷火豐','震':'震為雷','巽':'雷風恆','坎':'雷水解','艮':'雷山小過','坤':'雷地豫'},
 '巽':{'乾':'風天小畜','兌':'風澤中孚','離':'風火家人','震':'風雷益','巽':'巽為風','坎':'風水渙','艮':'風山漸','坤':'風地觀'},
 '坎':{'乾':'水天需','兌':'水澤節','離':'水火既濟','震':'水雷屯','巽':'水風井','坎':'坎為水','艮':'水山蹇','坤':'水地比'},
 '艮':{'乾':'山天大畜','兌':'山澤損','離':'山火賁','震':'山雷頤','巽':'山風蠱','坎':'山水蒙','艮':'艮為山','坤':'山地謙'},
 '坤':{'乾':'地天泰','兌':'地澤臨','離':'地火明夷','震':'地雷復','巽':'地風升','坎':'地水師','艮':'地山謙','坤':'坤為地'} };

/* ===== 64卦：卦宮/類型查表 ===== */
const GUA_CLASS = {
  "乾為天":{gong:"乾",type:"本宮"},"天風姤":{gong:"乾",type:"飛"},"天山遯":{gong:"乾",type:"飛"},"天地否":{gong:"乾",type:"飛"},
  "風地觀":{gong:"乾",type:"飛"},"山地剝":{gong:"乾",type:"飛"},"火地晉":{gong:"乾",type:"遊魂"},"火天大有":{gong:"乾",type:"歸魂"},
  "坤為地":{gong:"坤",type:"本宮"},"地雷復":{gong:"坤",type:"飛"},"地澤臨":{gong:"坤",type:"飛"},"地天泰":{gong:"坤",type:"飛"},
  "雷天大壯":{gong:"坤",type:"飛"},"澤天夬":{gong:"坤",type:"飛"},"水天需":{gong:"坤",type:"遊魂"},"水地比":{gong:"坤",type:"歸魂"},
  "震為雷":{gong:"震",type:"本宮"},"雷地豫":{gong:"震",type:"飛"},"雷水解":{gong:"震",type:"飛"},"雷風恆":{gong:"震",type:"飛"},
  "地風升":{gong:"震",type:"飛"},"水風井":{gong:"震",type:"飛"},"澤風大過":{gong:"震",type:"遊魂"},"澤雷隨":{gong:"震",type:"歸魂"},
  "巽為風":{gong:"巽",type:"本宮"},"風天小畜":{gong:"巽",type:"飛"},"風火家人":{gong:"巽",type:"飛"},"風雷益":{gong:"巽",type:"飛"},
  "天雷無妄":{gong:"巽",type:"飛"},"火雷噬嗑":{gong:"巽",type:"飛"},"山雷頤":{gong:"巽",type:"遊魂"},"山風蠱":{gong:"巽",type:"歸魂"},
  "坎為水":{gong:"坎",type:"本宮"},"水澤節":{gong:"坎",type:"飛"},"水雷屯":{gong:"坎",type:"飛"},"水火既濟":{gong:"坎",type:"飛"},
  "澤火革":{gong:"坎",type:"飛"},"雷火豐":{gong:"坎",type:"飛"},"地火明夷":{gong:"坎",type:"遊魂"},"地水師":{gong:"坎",type:"歸魂"},
  "離為火":{gong:"離",type:"本宮"},"火山旅":{gong:"離",type:"飛"},"火風鼎":{gong:"離",type:"飛"},"火水未濟":{gong:"離",type:"飛"},
  "山水蒙":{gong:"離",type:"飛"},"風水渙":{gong:"離",type:"飛"},"天水訟":{gong:"離",type:"遊魂"},"天火同人":{gong:"離",type:"歸魂"},
  "艮為山":{gong:"艮",type:"本宮"},"山火賁":{gong:"艮",type:"飛"},"山天大畜":{gong:"艮",type:"飛"},"山澤損":{gong:"艮",type:"飛"},
  "火澤睽":{gong:"艮",type:"飛"},"天澤履":{gong:"艮",type:"飛"},"風澤中孚":{gong:"艮",type:"遊魂"},"風山漸":{gong:"艮",type:"歸魂"},
  "兌為澤":{gong:"兌",type:"本宮"},"澤水困":{gong:"兌",type:"飛"},"澤地萃":{gong:"兌",type:"飛"},"澤山咸":{gong:"兌",type:"飛"},
  "水山蹇":{gong:"兌",type:"飛"},"地山謙":{gong:"兌",type:"飛"},"雷山小過":{gong:"兌",type:"遊魂"},"雷澤歸妹":{gong:"兌",type:"歸魂"}
};

function trigFromBits(b3){for(const n of TRINAMES){const t=TRIG[n];if(t[0]===b3[0]&&t[1]===b3[1]&&t[2]===b3[2]) return n} return null}
function upperLowerOf(lines){const lo=trigFromBits([lines[0],lines[1],lines[2]]), up=trigFromBits([lines[3],lines[4],lines[5]]); return {up,lo}}
function guaNameOf(up,lo){
  const N={'乾':{'乾':'乾為天','兌':'天澤履','離':'天火同人','震':'天雷無妄','巽':'天風姤','坎':'天水訟','艮':'天山遁','坤':'天地否'},
           '兌':{'乾':'澤天夬','兌':'兌為澤','離':'澤火革','震':'澤雷隨','巽':'澤風大過','坎':'澤水困','艮':'澤山咸','坤':'澤地萃'},
           '離':{'乾':'火天大有','兌':'火澤睽','離':'離為火','震':'火雷噬嗑','巽':'火風鼎','坎':'火水未濟','艮':'火山旅','坤':'火地晉'},
           '震':{'乾':'雷天大壯','兌':'雷澤歸妹','離':'雷火豐','震':'震為雷','巽':'雷風恆','坎':'雷水解','艮':'雷山小過','坤':'雷地豫'},
           '巽':{'乾':'風天小畜','兌':'風澤中孚','離':'風火家人','震':'風雷益','巽':'巽為風','坎':'風水渙','艮':'風山漸','坤':'風地觀'},
           '坎':{'乾':'水天需','兌':'水澤節','離':'水火既濟','震':'水雷屯','巽':'水風井','坎':'坎為水','艮':'水山蹇','坤':'水地比'},
           '艮':{'乾':'山天大畜','兌':'山澤損','離':'山火賁','震':'山雷頤','巽':'山風蠱','坎':'山水蒙','艮':'艮為山','坤':'山地謙'},
           '坤':{'乾':'地天泰','兌':'地澤臨','離':'地火明夷','震':'地雷復','巽':'地風升','坎':'地水師','艮':'地山謙','坤':'坤為地'} };
  return (N[up]&&N[up][lo])?N[up][lo]:`${up}上·${lo}下`;
}

const toYMDhm=d=>{const z=n=>(n<10?'0'+n:n);return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}T${z(d.getHours())}:${z(d.getMinutes())}`;};
function threeBranchesOfTrigram(tri,inner){
  const start=inner?INNER_START[tri]:OUTER_START[tri];
  const seq=YANG_TRIG.has(tri)?SEQ_YANG:SEQ_YIN;
  const i0=seq.indexOf(start); return [seq[i0%6],seq[(i0+1)%6],seq[(i0+2)%6]];
}
function naJiaBranches(lines){const {up,lo}=upperLowerOf(lines); return [...threeBranchesOfTrigram(lo,true), ...threeBranchesOfTrigram(up,false)]}
function sixKin(meElem,branch){
  const e=ZHI_ELEM[branch]||'土';
  const GEN={木:'火',火:'土',土:'金',金:'水',水:'木'};
  const CTL={木:'土',土:'水',水:'火',火:'金',金:'木'};
  if(e===meElem) return '兄弟';
  if(CTL[e]===meElem) return '官鬼';
  if(CTL[meElem]===e) return '妻財';
  if(GEN[e]===meElem) return '父母';
  if(GEN[meElem]===e) return '子孫';
  return '兄弟';
}
function changedLines(lines,moving){ return lines.map((v,i)=> moving[i] ? (v?0:1) : v); }

function cycleIndexFromGZ(ganChar,zhiChar){
  const gi=GAN.indexOf(ganChar), zi=ZHI.indexOf(zhiChar);
  for(let k=0;k<60;k++){ if(k%10===gi && k%12===zi) return k; }
  return 0;
}
let pillars=null, dayGan='甲', dayZhi='子';
function calcPillarsAndSix(){
  const s=E('dt').value; const dt=s?new Date(s):new Date();
  const lunar=Lunar.fromDate(dt);
  const Y=lunar.getYearInGanZhiExact();
  const M=lunar.getMonthInGanZhiExact();
  const D=lunar.getDayInGanZhiExact();
  const H=lunar.getTimeInGanZhi();
  pillars={year:Y,month:M,day:D,hour:H};
  dayGan=D.charAt(0); dayZhi=D.charAt(1);
  const idx=cycleIndexFromGZ(dayGan, dayZhi);
  const start=Math.floor(idx/10)*10; const startBranch=ZHI[start%12];
  const kw1=ZHI[(start%12+10)%12], kw2=ZHI[(start%12+11)%12];
  E('gzYear').textContent=`年：${Y}`; E('gzMonth').textContent=`月：${M}`;
  E('gzDay').textContent=`日：${D}`; E('gzHour').textContent=`時：${H}`;
  E('gzXun').textContent=`旬首：${GAN[start%10]}${startBranch}`;
  E('gzKW').textContent=`空亡：${kw1}${kw2}`;
  const startIdx=SIX_START_BY_GAN[dayGan]??0;
  return [0,1,2,3,4,5].map(i=> SIX[(startIdx+i)%6]); // 初→上
}

function purePalaceRows(palace){
  const lines=[...TRIG[palace], ...TRIG[palace]];
  const branches=naJiaBranches(lines);
  const elem=GONG_ELEM[palace];
  const kins=branches.map(b=>sixKin(elem,b));
  return {branches, kins};
}
function buildFuShenForCurrent(meElem,palace,currentKins){
  const NEEDS=['兄弟','父母','官鬼','妻財','子孫'];
  const have=new Set(currentKins);
  const missing=NEEDS.filter(k=>!have.has(k));
  if(missing.length===0) return {};
  const {branches, kins}=purePalaceRows(palace);
  const fuMap={};
  for(const miss of missing){
    const idx=kins.findIndex(k=>k===miss);
    if(idx!==-1){
      const pos=idx+1;
      if(currentKins[idx]!==miss){
        fuMap[pos]=`${branches[idx]} ${miss}`;
      }
    }
  }
  return fuMap;
}
function yingFromShi_fixed(shi){const y=shi+3;return y>6?y-6:y;}
function findShiByYaoBian(lines){
  const eqTri = arr => { const {up,lo}=upperLowerOf(arr); return (up===lo)?up:null; };
  const flipAt=(arr,i)=>{const t=[...arr]; t[i]=t[i]?0:1; return t;};
  let tmp=[...lines];
  for(let i=0;i<5;i++){ tmp=flipAt(tmp,i); if(eqTri(tmp)) return i+1; }
  tmp=[...lines];
  for(let i=4;i>=0;i--){ tmp=flipAt(tmp,i); if(eqTri(tmp)) return (i===0?3:i+1); }
  return 6; 
}
function decideShiYing(upTri, loTri, guaName, lines){
  const info = GUA_CLASS[guaName];
  if(!info || info.type==='飛'){
    const shi=findShiByYaoBian(lines);
    return {shi, ying:yingFromShi_fixed(shi), gong: (info&&info.gong) || upTri, kind: (info?'飛':'飛（保險）')};
  }
  if(info.type==='本宮') return {shi:6, ying:3, gong:info.gong, kind:'本宮'};
  if(info.type==='遊魂') return {shi:4, ying:1, gong:info.gong, kind:'遊魂'};
  if(info.type==='歸魂') return {shi:3, ying:6, gong:info.gong, kind:'歸魂'};
  const shi=findShiByYaoBian(lines);
  return {shi, ying:yingFromShi_fixed(shi), gong:info.gong, kind:'飛（保險）'};
}
let moving=[false,false,false,false,false,false];
let cvs,ctx,DPR=1;
function setupCanvas(){
  cvs=E('hexCanvas'); ctx=cvs.getContext('2d');
  DPR=window.devicePixelRatio||1;
  const cssW=cvs.clientWidth, cssH=cvs.clientHeight;
  cvs.width=Math.max(1,Math.floor(cssW*DPR));
  cvs.height=Math.max(1,Math.floor(cssH*DPR));
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
function drawWhiteTag(x,y,text){
  ctx.font='14px "Noto Sans TC","Microsoft JhengHei"';
  const pad=6, h=20, w=ctx.measureText(text).width+pad*2;
  const pa=ctx.textAlign, pb=ctx.textBaseline;
  ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillStyle='rgba(255,255,255,.96)'; ctx.fillRect(x-w/2, y-h/2, w, h);
  ctx.fillStyle='#0f172a'; ctx.fillText(text, x, y+1);
  ctx.textAlign=pa; ctx.textBaseline=pb;
}
function drawBoard(meta,rows){
  setupCanvas(); const W=cvs.width/DPR, H=cvs.height/DPR;
  ctx.clearRect(0,0,W,H);

  ctx.fillStyle='#0f172a'; ctx.font='bold 18px "Noto Sans TC","Microsoft JhengHei",sans-serif';
  ctx.fillText(`問題：${meta.q}`,12,26);
  ctx.font='15px "Noto Sans TC","Microsoft JhengHei",sans-serif';
  ctx.fillText(`起卦：${meta.dt}`,12,48);
  ctx.fillText(`四柱：${meta.gzY}　${meta.gzM}　${meta.gzD}　${meta.gzH}　（旬首：${meta.xun}　空亡：${meta.kw}）`,12,70);
  ctx.fillText(`卦名：${meta.name}　上卦：${meta.up}　下卦：${meta.lo}　卦宮：${meta.gong}　卦型：${meta.kind}　世：${meta.shi}　應：${meta.ying}`,12,92);

  const size=+E('size').value, offx=+E('offx').value, offy=+E('offy').value, gap=+E('gap').value;
  const rowOffset=+E('headgap').value || 24;
  E('sizeVal').textContent=size; E('offxVal').textContent=offx; E('offyVal').textContent=offy; E('gapVal').textContent=gap; E('headgapVal').textContent=rowOffset;

  const x0=16+offx, y0=120+offy;
  const headerY=y0-8;
  const lineGap=gap;
  const yaoLen=size, yaoX1=x0+120, yaoX2=yaoX1+yaoLen;

  const col={six:x0, fu:x0+76, yao:yaoX1, kin:yaoX2+30, zhi:yaoX2+98, mark:yaoX2+160, kinc:yaoX2+220, zhic:yaoX2+290};

  ctx.fillStyle='#475569'; ctx.font='bold 13px "Noto Sans TC","Microsoft JhengHei"';
  ctx.fillText('六獸',col.six,headerY); ctx.fillText('伏神',col.fu,headerY);
  ctx.fillText('爻象',col.yao,headerY); ctx.fillText('六親',col.kin,headerY);
  ctx.fillText('地支',col.zhi,headerY); ctx.fillText('世應',col.mark,headerY);
  ctx.fillText('變六親',col.kinc,headerY); ctx.fillText('變支',col.zhic,headerY);

  ctx.strokeStyle='#e5e7eb'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(x0, headerY+8); ctx.lineTo(yaoX2+320, headerY+8); ctx.stroke();

  ctx.lineWidth=6; ctx.strokeStyle='#111827'; ctx.fillStyle='#0f172a';
  rows.forEach((r,idx)=>{
    const y=y0 + rowOffset + idx*lineGap;
    ctx.font='14px "Noto Sans TC","Microsoft JhengHei"';
    ctx.fillText(r.six||'—', col.six, y+5);
    if(r.fu) drawWhiteTag(col.fu, y, r.fu); else ctx.fillText('—', col.fu, y+5);

    if(r.yy===1){ ctx.beginPath(); ctx.moveTo(col.yao, y); ctx.lineTo(col.yao+yaoLen, y); ctx.stroke(); }
    else{ const g=yaoLen*0.22, seg=(yaoLen-g)/2;
      ctx.beginPath(); ctx.moveTo(col.yao, y); ctx.lineTo(col.yao+seg, y);
      ctx.moveTo(col.yao+seg+g, y); ctx.lineTo(col.yao+yaoLen, y); ctx.stroke(); }

    if(r.mv){ ctx.font='15px "Noto Sans TC","Microsoft JhengHei"'; ctx.fillText(r.yy===1?'○':'×', col.yao+yaoLen+12, y+6); }
    ctx.fillText(r.kin||'—', col.kin, y+5);
    ctx.fillText(r.zhi||'—', col.zhi, y+5);

    if(r.mark) drawWhiteTag(col.mark, y, r.mark);
    if(r.kinc) drawWhiteTag(col.kinc, y, r.kinc);
    if(r.zhic) drawWhiteTag(col.zhic, y, r.zhic);
  });

  ctx.fillStyle='#64748b'; ctx.font='12.5px "Noto Sans TC","Microsoft JhengHei"';
  ctx.fillText('（初爻在下；動爻：陽○／陰×；伏神＝本卦缺誰→回本宮純卦補誰；世應：固定配對 1↔4、2↔5、3↔6；遊魂世=四，歸魂世=三；飛卦以爻變法求世。）', 12, H-12);
}

function render(){
  const upTri=E('upper').value, loTri=E('lower').value;
  const baseLines=[...TRIG[loTri], ...TRIG[upTri]]; 
  const q=(E('question').value||'').trim()||'—';
  const dt=E('dt').value||toYMDhm(new Date());
  const gzSix=calcPillarsAndSix();
  const xun=E('gzXun').textContent.replace('旬首：','');
  const kw=E('gzKW').textContent.replace('空亡：','');

  const guaName = guaNameOf(upTri, loTri);
  const {shi, ying, gong, kind} = decideShiYing(upTri, loTri, guaName, baseLines);
  const meElem=GONG_ELEM[gong];
  window.__lastMeElem = meElem;

  const branches=naJiaBranches(baseLines);
  const kins=branches.map(b=>sixKin(meElem,b));

  const chLines=changedLines(baseLines,moving);
  const branchesC=naJiaBranches(chLines);
  const kinsC=branchesC.map(b=>sixKin(meElem,b));

  const fuMap=buildFuShenForCurrent(meElem,gong,kins);

  const rows=[];
  for(let pos=6;pos>=1;pos--){
    const i=pos-1;
    rows.push({
      six:gzSix[i],
      fu: fuMap[pos] || '',
      yy: baseLines[i],
      mv: moving[i],
      kin: kins[i],
      zhi: branches[i],
      kinc: moving[i]? kinsC[i] : '',
      zhic: moving[i]? branchesC[i] : '',
      mark:(pos===shi)?'世':(pos===ying)?'應':''
    });
  }

  const y=pillars.year, m=pillars.month, d=pillars.day, h=pillars.hour;
  drawBoard({
    q, dt:dt.replace('T',' '),
    gzY:y, gzM:m, gzD:d, gzH:h,
    xun, kw, name:guaName, up:upTri, lo:loTri, gong, shi, ying, kind
  }, rows);

  // 更新右欄中醫建議（若有載入）
  if (window.updateTCMAdvice) try{ window.updateTCMAdvice(meElem); } catch(_) { }

  const yaoTxt=(yy,mv)=> mv?(yy?'—○—':'--×--'):(yy?'———':'-- --');
  let brief=`卦名：${guaName}｜上：${upTri} 下：${loTri}｜卦宮：${gong}｜卦型：${kind}｜世：${shi} 應：${ying}
`;
  brief+=`四柱：${y} ${m} ${d} ${h}　（${xun}｜空亡${kw}）
`;
  brief+=`問題：${q}
起卦：${dt.replace('T',' ')}

位次  六獸  伏神    爻象  六親  地支  世應  變六親  變支
`;
  for(let pos=6;pos>=1;pos--){
    const i=pos-1; const fuTxt=fuMap[pos] || '—';
    brief+=`${pos===6?'上':pos===1?'初':pos}  ${gzSix[i]}  ${fuTxt.padEnd(6,' ')}  ${yaoTxt(baseLines[i],moving[i])}  ${(kins[i]||'').padEnd(2,' ')}  ${(branches[i]||'').padEnd(2,' ')}  ${(pos===shi?'世':(pos===ying?'應':' '))}  ${(moving[i]?kinsC[i]:'').padEnd(2,' ')}  ${moving[i]?branchesC[i]:''}
`;
  }
  E('headInfo').textContent=`卦名：${guaName}　上卦：${upTri}　下卦：${loTri}　卦宮：${gong}　卦型：${kind}　世：${shi}　應：${ying}`;
  E('brief').textContent=brief;
}

function downloadPNG(){
  const canvas=E('hexCanvas'); const filename='hexagram.png';
  function openFallback(){
    const data=canvas.toDataURL('image/png');
    const win=window.open('about:blank','_blank');
    if (win) { win.document.title='另存圖片'; win.document.body.style.margin='0'; const img=new Image(); img.src=data; win.document.body.appendChild(img); }
    else { const a=document.createElement('a'); a.href=data; a.download=filename; document.body.appendChild(a);
      a.dispatchEvent(new MouseEvent('click',{bubbles:true,cancelable:true,view:window})); a.remove(); }
  }
  if (canvas.toBlob) {
    canvas.toBlob(blob=>{
      if(!blob){ openFallback(); return; }
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a);
      a.dispatchEvent(new MouseEvent('click',{bubbles:true,cancelable:true,view:window}));
      setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},0);
    });
  } else { openFallback(); }
}

function applyTai(){ E('upper').value='坤'; E('lower').value='乾'; E('question').value='示例：地天泰（坤宮）'; render(); }
function applyWeiJi(){ E('upper').value='離'; E('lower').value='坎'; E('question').value='示例：火水未濟（離宮）'; render(); }

window.addEventListener('DOMContentLoaded', ()=>{
  const now=new Date(); const z=n=>(n<10?'0'+n:n);
  E('dt').value=`${now.getFullYear()}-${z(now.getMonth()+1)}-${z(now.getDate())}T${z(now.getHours())}:${z(now.getMinutes())}`;

  E('btnNow').addEventListener('click', ()=>{ const t=new Date(); const z=n=>(n<10?'0'+n:n);
    E('dt').value=`${t.getFullYear()}-${z(t.getMonth()+1)}-${z(t.getDate())}T${z(t.getHours())}:${z(t.getMinutes())}`; render(); });
  E('btnPrint').addEventListener('click', ()=>{ window.print(); });

  const mvCtl=E('mvCtl'); mvCtl.innerHTML='';
  for(let pos=1;pos<=6;pos++){ const i=pos-1; const lab=document.createElement('label');
    lab.innerHTML=`<input type="checkbox" data-mv="${i}"> ${pos===6?'上':pos===1?'初':pos}爻動`; mvCtl.appendChild(lab); }
  mvCtl.addEventListener('change',e=>{const i=+e.target.getAttribute('data-mv'); if(!isNaN(i)){moving[i]=e.target.checked; render();}});

  const bind=(id,fn)=>{const el=E(id);['input','change'].forEach(ev=>el&&el.addEventListener(ev,fn));};
  ['upper','lower','question','dt','size','offx','offy','gap','headgap'].forEach(id=>bind(id,render));
  E('redraw').addEventListener('click',render);
  E('download').addEventListener('click',downloadPNG);

  E('btnTai').addEventListener('click',applyTai);
  E('btnWeiJi').addEventListener('click',applyWeiJi);

  render();
});
</script>
<style id="TCM_BOX_CSS">
/* 右欄：中醫建議區（可列印） */
#tcmBox{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin:10px 0}
#tcmBox h3{margin:0 0 10px;font-size:16px;color:#0f172a}
#tcmCore{font-size:14px;color:#0f172a;line-height:1.6}
#tcmCore .tag{display:inline-block;margin-right:8px;margin-bottom:6px;padding:2px 10px;border-radius:999px;background:#eef2ff;color:#1e3a8a;font-size:12px}
#tcmLists{margin-top:8px}
#tcmLists .blk{margin:8px 0}
#tcmLists .blk h4{margin:6px 0;font-size:14px;color:#334155}
#tcmLists ul{margin:4px 0 8px 18px;padding:0}
#tcmLists li{margin:2px 0}
#tcmBox .tcm-note{margin-top:8px;color:#64748b;font-size:12px}
/* 隱藏六爻摘要，但保留節點避免報錯 */
#brief{display:none!important}
#headInfo{display:none!important}
</style>
<script id="TCM_BOX_JS">
(function(){
  if(window.__TCM_BOX__) return; window.__TCM_BOX__=true;
  const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
  const MAP={
    '木':{zang:'肝',fu:'膽',dept:['肝膽科','情志/睡眠','骨傷/筋膜'],patterns:['肝氣鬱結','肝火上炎','肝血不足','肝腎陰虛'],self:['規律作息、舒展拉筋','少酒辣與熬夜','情志舒解（散步、冥想）']},
    '火':{zang:'心',fu:'小腸',dept:['心血管','身心/睡眠'],patterns:['心火亢盛','心脾兩虛','心陰不足'],self:['少咖啡酒精','減少熬夜與重鹹','午間小憩、清心安神']},
    '土':{zang:'脾',fu:'胃',dept:['脾胃消化','內分泌/代謝'],patterns:['脾胃虛弱','濕困脾胃','胃氣上逆'],self:['少冰冷甜膩','三餐定時少量多餐','腹式呼吸、飯後步行']},
    '金':{zang:'肺',fu:'大腸',dept:['呼吸過敏','皮膚','耳鼻喉'],patterns:['肺氣虛','肺陰虛','風寒/風熱犯肺'],self:['避免過敏源','適度蒸氣/保濕','早睡早起、練呼吸']},
    '水':{zang:'腎',fu:'膀胱',dept:['腎泌尿','內科體質'],patterns:['腎陽虛','腎陰虛','腎氣不足'],self:['保暖腰腹與足部','規律作息、早睡','溫和伸展與補水']}
  };
  function pickFive(){
    // 優先讀「w5_」拉桿（外掛雷達），找不到就略過
    const get=id=>{const el=document.getElementById(id); return el?Number(el.value):null};
    const v={木:get('w5_mu'),火:get('w5_huo'),土:get('w5_tu'),金:get('w5_jin'),水:get('w5_shui')};
    const has=Object.values(v).some(x=>typeof x==='number' && !isNaN(x));
    return has?v:null;
  }
  function hiLo(v){ if(!v) return null; const arr=Object.entries(v); arr.sort((a,b)=>b[1]-a[1]); return {hi:arr.slice(0,2), lo:arr.slice(-2)}; }
  function htmlList(items){ return '<ul>'+items.map(s=>'<li>'+s+'</li>').join('')+'</ul>'; }
  function build(meElem){
    const core=$('#tcmCore'), lists=$('#tcmLists'); if(!core||!lists) return;
    const base=MAP[meElem]||MAP['土'];
    const five=pickFive(); const trend=hiLo(five);
    let tags=`<span class="tag">卦宮五行：${meElem}</span><span class="tag">臟腑：${base.zang}／${base.fu}</span>`;
    if(trend){ tags+=trend.hi.length? `<span class="tag">偏旺：${trend.hi.map(x=>x[0]+x[1]).join('、')}</span>`:''; tags+=trend.lo.length? `<span class="tag">偏弱：${trend.lo.map(x=>x[0]+x[1]).join('、')}</span>`:''; }
    core.innerHTML=tags;

    let html='';
    html+=`<div class="blk"><h4>建議就診科別</h4>${htmlList(base.dept)}</div>`;
    html+=`<div class="blk"><h4>常見體質／症候（參考）</h4>${htmlList(base.patterns)}</div>`;
    html+=`<div class="blk"><h4>日常調養建議</h4>${htmlList(base.self)}</div>`;

    // 若五行拉桿有讀到偏旺/偏弱，給加權提示
    if(trend){
      const hiTxt = trend.hi.length? ('偏旺提示：'+trend.hi.map(([k])=>({木:'疏肝解鬱',火:'清心養陰',土:'健脾祛濕',金:'潤肺養陰',水:'溫腎固本'}[k])).join('、')):'';
      const loTxt = trend.lo.length? ('偏弱提示：'+trend.lo.map(([k])=>({木:'養血柔肝',火:'補心健脾',土:'培土健脾',金:'益氣潤肺',水:'滋補腎陰/溫腎陽'}[k])).join('、')):'';
      if(hiTxt||loTxt){ html+=`<div class="blk"><h4>五行傾向</h4><ul>${hiTxt?'<li>'+hiTxt+'</li>':''}${loTxt?'<li>'+loTxt+'</li>':''}</ul></div>`; }
    }
    lists.innerHTML=html;
  }
  // 對外方法：render() 之後會呼叫
  window.updateTCMAdvice = build;

  // 若外掛雷達存在，拖動即更新
  ['w5_mu','w5_huo','w5_tu','w5_jin','w5_shui','w5_size'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.addEventListener('input', ()=>{ try{ build(window.__lastMeElem||'土'); }catch(_){} }); }});
})();
</script>
<script id="TCM_HOOK_RENDER">
// 讓主 render 結束後會順便更新中醫建議
(function(){
  const _render = window.render; if(!_render) return;
  window.render = function(){ _render.apply(this, arguments); try{ if(window.updateTCMAdvice){ window.updateTCMAdvice(window.__lastMeElem||'土'); } }catch(_){} };
})();
</script>
<style id="W5_SAFE_CSS">
  #w5_sec{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin:10px 0}
  #w5_canv{display:block;width:100%;height:300px}
  #w5_ctrl .row{display:flex;gap:10px;align-items:center;margin:6px 0}
  #w5_ctrl input[type=range]{flex:1}
  @media print{#w5_canv{height:260px!important}}
</style>
<script id="W5_SAFE_JS">
(function(){
  if(window.__W5_SAFE__) return; window.__W5_SAFE__=true;
  const $=s=>document.querySelector(s);
  function rightSec(){ const g=$('.grid'); if(!g) return null; const secs=[...g.querySelectorAll(':scope > .sec, :scope > section.sec')]; return secs[1]||secs[secs.length-1]||null; }
  const host=rightSec(); if(host){ const sec=document.createElement('div'); sec.id='w5_sec'; sec.className='sec'; sec.innerHTML=`
      <h3 style="margin:0 0 8px;font-size:16px;color:#0f172a">五行雷達圖</h3>
      <div class="canvasWrap"><canvas id="w5_canv"></canvas></div>
      <div id="w5_ctrl">
        <div class="row"><span>大小</span><input id="w5_size" type="range" min="0.8" max="1.8" step="0.05" value="1.30"><span id="w5_sizeVal" class="miniVal">1.30</span></div>
        <div class="row"><label>木</label><input id="w5_mu" type="range" min="1" max="10" step="1" value="6"><span id="w5_muVal" class="miniVal">6</span></div>
        <div class="row"><label>火</label><input id="w5_huo" type="range" min="1" max="10" step="1" value="6"><span id="w5_huoVal" class="miniVal">6</span></div>
        <div class="row"><label>土</label><input id="w5_tu" type="range" min="1" max="10" step="1" value="6"><span id="w5_tuVal" class="miniVal">6</span></div>
        <div class="row"><label>金</label><input id="w5_jin" type="range" min="1" max="10" step="1" value="6"><span id="w5_jinVal" class="miniVal">6</span></div>
        <div class="row"><label>水</label><input id="w5_shui" type="range" min="1" max="10" step="1" value="6"><span id="w5_shuiVal" class="miniVal">6</span></div>
      </div>`; host.insertBefore(sec, host.firstChild||null); }

  // 畫圖
  const COLORS={木:'#16a34a',火:'#ef4444',土:'#f59e0b',金:'#64748b',水:'#3b82f6'}; const ORDER=['火','木','土','金','水'];
  const id=s=>document.getElementById(s), val=(i,d=6)=>{const el=id(i); const v=Number(el&&el.value); return isFinite(v)?v:d;};
  function sizeScale(){ const el=id('w5_size'); let f=parseFloat(el&&el.value)||1.3; f=Math.max(0.8,Math.min(1.8,f)); const tip=id('w5_sizeVal'); if(tip) tip.textContent=f.toFixed(2); return f; }
  function values(){ return {火:val('w5_huo'),木:val('w5_mu'),土:val('w5_tu'),金:val('w5_jin'),水:val('w5_shui')}; }
  function drawRadar(){ const c=id('w5_canv'); if(!c) return; const dpr=window.devicePixelRatio||1; const W=c.clientWidth||600, H=c.clientHeight||300; c.width=Math.floor(W*dpr); c.height=Math.floor(H*dpr); const ctx=c.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0); ctx.clearRect(0,0,W,H);
    const cx=W/2, cy=H/2+6, sc=sizeScale(); const R=Math.min(W,H*0.9)/2*0.78*sc, rings=5, ang0=-Math.PI/2;
    ctx.lineWidth=1; ctx.strokeStyle='#e5e7eb'; for(let r=1;r<=rings;r++){ const rr=R*r/rings; ctx.beginPath(); for(let i=0;i<ORDER.length;i++){ const a=ang0+i*(2*Math.PI/ORDER.length); const x=cx+rr*Math.cos(a), y=cy+rr*Math.sin(a); i?ctx.lineTo(x,y):ctx.moveTo(x,y);} ctx.closePath(); ctx.stroke(); }
    ctx.font='12px "Noto Sans TC","Microsoft JhengHei"'; ctx.textAlign='center'; ctx.textBaseline='middle'; ORDER.forEach((k,i)=>{ const a=ang0+i*(2*Math.PI/ORDER.length); const x=cx+R*Math.cos(a), y=cy+R*Math.sin(a); ctx.strokeStyle='#cbd5e1'; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(x,y); ctx.stroke(); ctx.fillStyle=COLORS[k]||'#334155'; ctx.fillText(k,x,y-12); });
    const v=values(), pts=[]; ORDER.forEach((k,i)=>{ const rr=R*(Math.max(1,Math.min(10,v[k]))/10), a=ang0+i*(2*Math.PI/ORDER.length); pts.push([cx+rr*Math.cos(a), cy+rr*Math.sin(a), v[k], k]); });
    ctx.beginPath(); pts.forEach((p,i)=> i?ctx.lineTo(p[0],p[1]):ctx.moveTo(p[0],p[1])); ctx.closePath(); ctx.fillStyle='rgba(59,130,246,0.18)'; ctx.strokeStyle='rgba(59,130,246,0.9)'; ctx.lineWidth=2; ctx.fill(); ctx.stroke();
    pts.forEach(p=>{ ctx.beginPath(); ctx.arc(p[0],p[1],4,0,Math.PI*2); ctx.fillStyle=COLORS[p[3]]||'#111827'; ctx.fill(); ctx.fillStyle='#0f172a'; ctx.fillText(String(p[2]), p[0], p[1]-16); }); }
  window.w5_draw=drawRadar;
  ['w5_mu','w5_huo','w5_tu','w5_jin','w5_shui','w5_size'].forEach(i=>{ const el=id(i); if(el){ el.addEventListener('input',()=>{ const tip=id(i+'Val'); if(tip) tip.textContent=String(el.value); drawRadar(); if(window.updateTCMAdvice && window.__lastMeElem) try{ window.updateTCMAdvice(window.__lastMeElem); }catch(_){} }); }});
  window.addEventListener('resize', drawRadar);
  document.addEventListener('DOMContentLoaded', drawRadar);
  window.addEventListener('load', ()=>{ drawRadar(); setTimeout(drawRadar,150); });
})();
</script>
<style id="PRINT_W5_TCM_CSS">
/* 讓「五行雷達圖 + 中醫建議」能列印 */
@media print{
  /* 右欄容器若原本有 hide-print，一律在列印時顯示 */
  .grid > .sec.hide-print#printRight, .grid > section.sec.hide-print#printRight{display:block!important}
  /* 確保雷達圖高度、避免被全域 canvas 規則覆蓋 */
  #w5_canv{height:260px!important;width:100%!important;display:block!important}
  /* 中醫建議完整顯示 */
  #tcmBox{display:block!important}
}
</style>
<script id="PRINT_W5_TCM_JS">(function(){
  if(window.__PRINT_W5_TCM__) return; window.__PRINT_W5_TCM__=true;
  const $=s=>document.querySelector(s);
  function markRight(){
    // 把「第二欄」加上固定 id，並移除 hide-print（或至少在列印時可覆蓋）
    const grid=$('.grid'); if(!grid) return null;
    const secs=[...grid.querySelectorAll(':scope > .sec, :scope > section.sec')];
    const right=secs[1]||secs[secs.length-1]||null; if(!right) return null;
    if(!right.id) right.id='printRight';
    // 永久拿掉 hide-print，避免被整欄隱藏
    right.classList.remove('hide-print');
    return right;
  }
  function ensure(){ markRight(); }
  document.addEventListener('DOMContentLoaded', ensure);
  window.addEventListener('load', ensure);
  // 列印前重繪一次雷達與卦盤，確保畫面入稿
  function preprint(){ try{ if(window.w5_draw) window.w5_draw(); }catch(_){}
                       try{ if(window.render) window.render(); }catch(_){} }
  if('onbeforeprint' in window){ window.addEventListener('beforeprint', preprint); }
  try{ var mq=window.matchMedia('print'); if(mq&&mq.addListener){ mq.addListener(function(m){ if(m.matches) preprint(); }); } }catch(_){ }
})();</script>
<style id="SAVE_BAR_V1_CSS">
/* —— 存檔工具列（右上角，列印隱藏） —— */
#saveBarTop{position:fixed;top:10px;right:120px;z-index:10002;display:flex;gap:6px;flex-wrap:wrap}
#saveBarTop button{height:30px;padding:0 10px;border:1px solid #cbd5e1;border-radius:8px;background:#fff;cursor:pointer;font-size:13px}
#saveBarTop button:hover{box-shadow:0 1px 6px rgba(0,0,0,.08)}
@media print{#saveBarTop{display:none!important}}
</style>
<script id="SAVE_BAR_V1_JS">(function(){
  if(window.__SAVE_BAR_V1__) return; window.__SAVE_BAR_V1__=true;
  function q(s){return document.querySelector(s)}
  function qa(s){return Array.prototype.slice.call(document.querySelectorAll(s))}
  function ensureBar(){
    if(q('#saveBarTop')) return;
    var bar=document.createElement('div'); bar.id='saveBarTop';
    bar.innerHTML=
      '<button id="btnSaveLocal" title="保存到本機（瀏覽器）">保存</button>'+
      '<button id="btnLoadLocal" title="從本機載入">載入</button>'+
      '<button id="btnExportJSON" title="匯出設定為檔案">匯出設定</button>'+
      '<button id="btnImportJSON" title="從檔案匯入設定">匯入設定</button>'+
      '<button id="btnPNGHex" title="匯出卦盤 PNG">盤PNG</button>'+
      '<button id="btnPNGRadar" title="匯出雷達 PNG">雷達PNG</button>'+
      '<input id="fileImportJSON" type="file" accept="application/json" style="display:none">';
    document.body.appendChild(bar);
  }
  function toast(msg){ try{ var box=q('#err'); if(box){ box.style.display='block'; box.textContent='✔ '+msg; setTimeout(function(){ box.style.display='none'; },1400);} else { alert(msg);} }catch(e){}
  }
  function showErr(msg){ var box=q('#err'); if(box){ box.style.display='block'; box.textContent='⚠️ '+msg; } else { alert(msg);} }

  function getVal(id){ var el=document.getElementById(id); return el?el.value:null; }
  function setVal(id,v){ var el=document.getElementById(id); if(el!=null && v!=null){ el.value=v; el.dispatchEvent(new Event('input',{bubbles:true})); el.dispatchEvent(new Event('change',{bubbles:true})); } }
  function getMoving(){ var arr=[false,false,false,false,false,false]; qa('#mvCtl input[type=checkbox][data-mv]').forEach(function(cb){ var i=+cb.getAttribute('data-mv'); if(!isNaN(i)) arr[i]=!!cb.checked; }); return arr; }
  function setMoving(a){ if(!a||!a.length) return; qa('#mvCtl input[type=checkbox][data-mv]').forEach(function(cb){ var i=+cb.getAttribute('data-mv'); if(!isNaN(i) && typeof a[i]!== 'undefined'){ cb.checked=!!a[i]; cb.dispatchEvent(new Event('change',{bubbles:true})); } }); }

  function collect(){
    var S={ ver:'v1',
      question:getVal('question'), dt:getVal('dt'), upper:getVal('upper'), lower:getVal('lower'),
      size:getVal('size'), offx:getVal('offx'), offy:getVal('offy'), gap:getVal('gap'), headgap:getVal('headgap'),
      moving:getMoving(),
      w5:{ size:getVal('w5_size'), 木:getVal('w5_mu'), 火:getVal('w5_huo'), 土:getVal('w5_tu'), 金:getVal('w5_jin'), 水:getVal('w5_shui') },
      tcmHTML:(document.getElementById('tcmBox')||{}).innerHTML||null,
      note:(document.getElementById('userNote')||{}).value||null
    };
    return S;
  }
  function apply(S){ try{
    setVal('question',S.question); setVal('dt',S.dt); setVal('upper',S.upper); setVal('lower',S.lower);
    setVal('size',S.size); setVal('offx',S.offx); setVal('offy',S.offy); setVal('gap',S.gap); setVal('headgap',S.headgap);
    setMoving(S.moving);
    if(S.w5){ setVal('w5_size',S.w5.size); setVal('w5_mu',S.w5.木); setVal('w5_huo',S.w5.火); setVal('w5_tu',S.w5.土); setVal('w5_jin',S.w5.金); setVal('w5_shui',S.w5.水); }
    if(S.note!=null){ var n=document.getElementById('userNote'); if(n) n.value=S.note; }
    if(S.tcmHTML!=null){ var t=document.getElementById('tcmBox'); if(t) t.innerHTML=S.tcmHTML; }
    try{ if(window.render) window.render(); }catch(e){}
    try{ if(window.w5_draw) window.w5_draw(); }catch(e){}
    toast('已套用設定');
  }catch(e){ showErr('套用設定失敗：'+(e.message||e)); } }

  function saveLocal(){ try{ localStorage.setItem('hex_state_v1', JSON.stringify(collect())); toast('已保存到本機'); }catch(e){ showErr('保存失敗：'+(e.message||e)); } }
  function loadLocal(){ try{ var s=localStorage.getItem('hex_state_v1'); if(!s) return toast('本機尚無保存'); apply(JSON.parse(s)); }catch(e){ showErr('載入失敗：'+(e.message||e)); } }
  function downloadBlob(data, filename, type){ var blob=new Blob([data],{type:type||'application/octet-stream'}); var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); setTimeout(function(){URL.revokeObjectURL(url); a.remove();},0); }
  function ts(){ var d=new Date(); function z(n){return n<10?'0'+n:n} return d.getFullYear()+''+z(d.getMonth()+1)+''+z(d.getDate())+'_'+z(d.getHours())+z(d.getMinutes()); }
  function exportJSON(){ try{ downloadBlob(JSON.stringify(collect(),null,2),'hex_state_'+ts()+'.json','application/json'); }catch(e){ showErr('匯出失敗：'+(e.message||e)); } }
  function importJSONFile(file){ if(!file) return; var r=new FileReader(); r.onload=function(){ try{ apply(JSON.parse(String(r.result))); }catch(e){ showErr('匯入失敗：'+(e.message||e)); } }; r.readAsText(file); }
  function canvasToPNG(id, filename){ var c=document.getElementById(id); if(!c){ return showErr('找不到畫布：'+id); } try{ if(c.toBlob){ c.toBlob(function(b){ var u=URL.createObjectURL(b); var a=document.createElement('a'); a.href=u; a.download=filename; document.body.appendChild(a); a.click(); setTimeout(function(){URL.revokeObjectURL(u); a.remove();},0); }); } else { var a2=document.createElement('a'); a2.href=c.toDataURL('image/png'); a2.download=filename; a2.click(); } }catch(e){ showErr('匯出 PNG 失敗：'+(e.message||e)); } }

  function bind(){ ensureBar();
    var f=q('#fileImportJSON');
    q('#btnSaveLocal').addEventListener('click', saveLocal);
    q('#btnLoadLocal').addEventListener('click', loadLocal);
    q('#btnExportJSON').addEventListener('click', exportJSON);
    q('#btnImportJSON').addEventListener('click', function(){ if(f) f.click(); });
    if(f){ f.addEventListener('change', function(){ importJSONFile(this.files&&this.files[0]); this.value=''; }); }
    q('#btnPNGHex').addEventListener('click', function(){ try{ if(window.render) window.render(); }catch(e){} canvasToPNG('hexCanvas','hexagram_'+ts()+'.png'); });
    q('#btnPNGRadar').addEventListener('click', function(){ try{ if(window.w5_draw) window.w5_draw(); }catch(e){} canvasToPNG('w5_canv','radar_'+ts()+'.png'); });

    // 自動保存：重要互動 1.2 秒後寫入
    var t=null; function autosave(){ clearTimeout(t); t=setTimeout(saveLocal, 1200); }
    var ids=['upper','lower','question','dt','size','offx','offy','gap','headgap','w5_size','w5_mu','w5_huo','w5_tu','w5_jin','w5_shui'];
    for(var i=0;i<ids.length;i++){ var el=document.getElementById(ids[i]); if(el){ ['input','change'].forEach(function(ev){ el.addEventListener(ev, autosave); }); } }
    qa('#mvCtl input[type=checkbox][data-mv]').forEach(function(cb){ cb.addEventListener('change', autosave); });
  }
  document.addEventListener('DOMContentLoaded', bind);
  window.addEventListener('load', bind);
})();</script>
<style id="SAVE_BAR_V1_TWEAK">#saveBarTop{right:12px}</style>
<style id="NOTE_PRINT_VAULT_CSS">
/* 備註區塊 */
#noteBox{margin:8px 0 4px}
#userNote{width:100%;min-height:110px;border:1px solid #cbd5e1;border-radius:8px;padding:8px;font-size:14px;resize:vertical}
/* 列印調整：隱藏五行拉桿、工具列與舊列印鈕 */
@media print{
  #w5_ctrl, #saveBarTop, #vaultWrap, #btnPrint{display:none!important}
}
/* 保存庫面板 */
#vaultWrap{position:fixed;top:50px;right:12px;z-index:10003;background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.12);width:360px;max-height:70vh;display:none;overflow:auto}
#vaultWrap .vhdr{font-weight:600;padding:10px 12px;border-bottom:1px solid #e5e7eb;color:#0f172a}
#vaultWrap .vsec{padding:10px 12px}
#vaultWrap .vrow{display:flex;gap:8px;align-items:center;margin:6px 0;flex-wrap:wrap}
#vaultWrap input[type=text]{flex:1;min-width:120px;border:1px solid #cbd5e1;border-radius:8px;height:30px;padding:0 8px}
#vaultWrap select{height:30px;border:1px solid #cbd5e1;border-radius:8px;padding:0 8px}
#vaultWrap button{height:30px;border:1px solid #cbd5e1;border-radius:8px;background:#fff;padding:0 10px;cursor:pointer}
#vaultWrap ul{list-style:none;margin:6px 0 0 0;padding:0;border:1px solid #e5e7eb;border-radius:8px;max-height:36vh;overflow:auto}
#vaultWrap li{display:flex;justify-content:space-between;gap:8px;padding:8px 10px;border-bottom:1px solid #f1f5f9;cursor:pointer}
#vaultWrap li:last-child{border-bottom:none}
#vaultWrap li.sel{background:#f1f5f9}
#vaultWrap .vfoot{padding:10px 12px;border-top:1px solid #e5e7eb;display:flex;justify-content:flex-end;gap:8px}
</style>
<script id="SAVE_BAR_VAULT_JS">(function(){
  if(window.__SAVE_BAR_VAULT__) return; window.__SAVE_BAR_VAULT__=true;
  function q(s){return document.querySelector(s)} function qa(s){return Array.prototype.slice.call(document.querySelectorAll(s))}
  // ——— 增加右上角：列印、保存庫 ———
  function ensureExtraButtons(){
    var bar=q('#saveBarTop'); if(!bar) return;
    function addBtn(id,txt,ttl){ if(q('#'+id)) return; var b=document.createElement('button'); b.id=id; b.textContent=txt; if(ttl) b.title=ttl; bar.insertBefore(b, bar.firstChild); }
    addBtn('btnPrintTop','列印','列印 A4');
    addBtn('btnVault','保存庫','管理與快速開啟');
    q('#btnPrintTop').addEventListener('click', function(){ try{ if(window.w5_draw) window.w5_draw(); }catch(e){} try{ if(window.render) window.render(); }catch(e){} window.print(); });
    q('#btnVault').addEventListener('click', function(){ var w=q('#vaultWrap'); if(!w){ buildVault(); w=q('#vaultWrap'); } if(!w) return; w.style.display = (w.style.display==='none'||!w.style.display)?'block':'none'; refreshVaultUI(); });
  }

  // ——— 保存庫（localStorage） ———
  function vread(){ try{ return JSON.parse(localStorage.getItem('hex_vault_v1')||'{}'); }catch(e){ return {}; } }
  function vwrite(v){ try{ localStorage.setItem('hex_vault_v1', JSON.stringify(v)); }catch(e){} }
  function ensureVault(){ var v=vread(); if(!v.folders) v.folders={}; if(!v.currentFolder) v.currentFolder='預設'; if(!v.folders[v.currentFolder]) v.folders[v.currentFolder]=[]; vwrite(v); return v; }
  function nowTs(){ var d=new Date(); function z(n){return n<10?'0'+n:n} return d.getFullYear()+'-'+z(d.getMonth()+1)+'-'+z(d.getDate())+' '+z(d.getHours())+':'+z(d.getMinutes()); }

  function buildVault(){
    var wrap=document.createElement('div'); wrap.id='vaultWrap';
    wrap.innerHTML='\
      <div class="vhdr">保存庫</div>\
      <div class="vsec">\
        <div class="vrow"><span>資料夾</span><select id="vFolderSel"></select><input id="vNewFolder" type="text" placeholder="新增資料夾"><button id="vAddFolder">新增</button></div>\
        <div class="vrow" style="width:100%"><span>清單</span></div>\
        <ul id="vList"></ul>\
        <div class="vrow"><span>檔名</span><input id="vSaveName" type="text" placeholder="另存新檔名稱"><button id="vSaveAs">另存新檔</button><button id="vDel">刪除</button></div>\
      </div>\
      <div class="vfoot"><button id="vClose">關閉</button></div>';
    document.body.appendChild(wrap);

    q('#vClose').addEventListener('click', function(){ q('#vaultWrap').style.display='none'; });
    q('#vAddFolder').addEventListener('click', function(){ var v=ensureVault(); var name=(q('#vNewFolder').value||'').trim(); if(!name) return; if(!v.folders[name]) v.folders[name]=[]; v.currentFolder=name; vwrite(v); q('#vNewFolder').value=''; refreshVaultUI(); });
    q('#vFolderSel').addEventListener('change', function(){ var v=ensureVault(); v.currentFolder=this.value; vwrite(v); refreshVaultUI(); });
    q('#vSaveAs').addEventListener('click', function(){ var v=ensureVault(); var fname=(q('#vSaveName').value||'').trim(); if(!fname) fname='未命名'; var folder=v.currentFolder; var data=collectSafe(); var item={id:Date.now(), name:fname, ts:nowTs(), data:data}; v.folders[folder].push(item); vwrite(v); refreshVaultUI(); });
    q('#vDel').addEventListener('click', function(){ var v=ensureVault(); var li=q('#vList li.sel'); if(!li) return; var id=Number(li.getAttribute('data-id')); var arr=v.folders[v.currentFolder]; v.folders[v.currentFolder]=arr.filter(function(x){return x.id!==id}); vwrite(v); refreshVaultUI(); });
  }

  function refreshVaultUI(){ var v=ensureVault(); var sel=q('#vFolderSel'); if(!sel) return; // modal 未建好
    // folders
    sel.innerHTML=''; Object.keys(v.folders).forEach(function(name){ var opt=document.createElement('option'); opt.value=name; opt.textContent=name; sel.appendChild(opt); }); sel.value=v.currentFolder;
    // list
    var list=q('#vList'); list.innerHTML=''; var arr=v.folders[v.currentFolder]||[]; arr.sort(function(a,b){return b.id-a.id});
    arr.forEach(function(item){ var li=document.createElement('li'); li.setAttribute('data-id', item.id); li.innerHTML='<span>'+escapeHtml(item.name)+'</span><span style="color:#64748b">'+item.ts+'</span>';
      li.addEventListener('click', function(){ qa('#vList li').forEach(function(x){x.classList.remove('sel')}); li.classList.add('sel'); q('#vSaveName').value=item.name; });
      li.addEventListener('dblclick', function(){ try{ applySafe(item.data); q('#vaultWrap').style.display='none'; }catch(e){ alert('載入失敗：'+(e.message||e)); } });
      list.appendChild(li);
    });
  }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, function(c){ return ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]) || c; }); }

  // ——— 與既有存取對接（包一層，避免抓不到 collect/apply） ———
  function collectSafe(){ try{ if(typeof collect==='function') return collect(); }catch(e){} // Fallback 手作
    var get=function(id){ var el=document.getElementById(id); return el?el.value:null; };
    var mov=qa('#mvCtl input[type=checkbox][data-mv]').map(function(cb){ return !!cb.checked });
    return {ver:'v1',question:get('question'),dt:get('dt'),upper:get('upper'),lower:get('lower'),size:get('size'),offx:get('offx'),offy:get('offy'),gap:get('gap'),headgap:get('headgap'),moving:mov,
      w5:{ size:get('w5_size'), 木:get('w5_mu'), 火:get('w5_huo'), 土:get('w5_tu'), 金:get('w5_jin'), 水:get('w5_shui') }, note:(q('#userNote')||{}).value||null};
  }
  function applySafe(S){ try{ if(typeof apply==='function') return apply(S); }catch(e){}
    function set(id,v){ var el=document.getElementById(id); if(el!=null && v!=null){ el.value=v; el.dispatchEvent(new Event('input',{bubbles:true})); el.dispatchEvent(new Event('change',{bubbles:true})); } }
    set('question',S.question); set('dt',S.dt); set('upper',S.upper); set('lower',S.lower); set('size',S.size); set('offx',S.offx); set('offy',S.offy); set('gap',S.gap); set('headgap',S.headgap);
    if(S.moving&&S.moving.length){ qa('#mvCtl input[type=checkbox][data-mv]').forEach(function(cb,i){ if(typeof S.moving[i]!== 'undefined'){ cb.checked=!!S.moving[i]; cb.dispatchEvent(new Event('change',{bubbles:true})); } }); }
    if(S.w5){ set('w5_size',S.w5.size); set('w5_mu',S.w5.木); set('w5_huo',S.w5.火); set('w5_tu',S.w5.土); set('w5_jin',S.w5.金); set('w5_shui',S.w5.水); }
    if(S.note!=null){ var n=q('#userNote'); if(n) n.value=S.note; }
    try{ if(window.render) window.render(); }catch(e){}
    try{ if(window.w5_draw) window.w5_draw(); }catch(e){}
  }

  // 啟動
  document.addEventListener('DOMContentLoaded', ensureExtraButtons);
  window.addEventListener('load', ensureExtraButtons);
})();</script>
<script id="TCM_EXAMPLES_ADDON">
/* 只追加中醫範例，不動你原本邏輯 */
(function(){
  if (window.__TCM_EXAMPLES_ADDON__) return; window.__TCM_EXAMPLES_ADDON__ = true;

  // 資料庫（示例，僅作教學用途）
  const ACUP = {
    '木': ['太衝 (LR3)','陽陵泉 (GB34)','期門 (LR14)','肝俞 (BL18)'],
    '火': ['神門 (HT7)','內關 (PC6)','少府 (HT8)','膻中 (CV17)'],
    '土': ['足三里 (ST36)','中脘 (CV12)','脾俞 (BL20)','陰陵泉 (SP9)'],
    '金': ['列缺 (LU7)','太淵 (LU9)','合谷 (LI4)','曲池 (LI11)'],
    '水': ['太溪 (KI3)','腎俞 (BL23)','命門 (GV4)','復溜 (KI7)']
  };
  const FORMULA = {
    '木': ['逍遙散','柴胡疏肝散','小柴胡湯'],
    '火': ['酸棗仁湯','天王補心丹','朱砂安神丸（慎用）'],
    '土': ['四君子湯','香砂六君子湯','平胃散'],
    '金': ['玉屏風散','桑菊飲','荊芥連翹湯'],
    '水': ['六味地黃丸','右歸丸','腎氣丸']
  };
  // 常見訴求速查（按五行思路給示例搭配）
  const QUICK = [
    {key:'失眠/心悸', tips:{
      '火':'神門、內關；酸棗仁湯',
      '木':'太衝、期門；逍遙散',
      '水':'太溪、腎俞；天王補心丹（偏陰虛心腎不交）'}},
    {key:'壓力/易怒/胸悶', tips:{
      '木':'太衝、陽陵泉；柴胡疏肝散',
      '火':'膻中、內關；清心安神',
      '土':'足三里、中脘；健脾祛濕以助調情志'}},
    {key:'脹悶/食少/便溏', tips:{
      '土':'足三里、中脘、脾俞；四君子湯/香砂六君子湯',
      '木':'太衝；疏肝理氣配和中',
      '水':'命門、復溜；溫陽助運（寒濕明顯者）'}},
    {key:'咳嗽/鼻過敏', tips:{
      '金':'列缺、太淵、合谷；玉屏風散/桑菊飲',
      '水':'太溪；滋腎納氣以助肺',
      '土':'足三里；健脾化痰以資肺氣'}},
    {key:'腰膝痠軟/畏寒', tips:{
      '水':'腎俞、命門、太溪；右歸丸/腎氣丸',
      '土':'足三里；培土生金水',
      '火':'湧泉按揉；引火下行、溫煦四肢'}}
  ];

  // 包一層：保留你原本的 updateTCMAdvice，跑完後再追加內容
  const OLD = window.updateTCMAdvice;
  window.updateTCMAdvice = function(meElem){
    if (typeof OLD === 'function') { try { OLD(meElem); } catch(_){} }

    // 右欄容器
    const box = document.getElementById('tcmLists');
    if (!box) return;

    // 產生 HTML 片段（不覆蓋、只 append）
    const acup = (ACUP[meElem] || []).map(s=>`<li>${s}</li>`).join('') || '<li>—</li>';
    const rx   = (FORMULA[meElem] || []).map(s=>`<li>${s}</li>`).join('') || '<li>—</li>';

    // 症狀速查：優先顯示與本宮同色的條目在最上方
    const quickHtml = QUICK.map(q=>{
      const mine = q.tips[meElem] ? `<li><b>（本卦優先）</b> ${q.tips[meElem]}</li>` : '';
      const others = Object.entries(q.tips)
        .filter(([k])=>k!==meElem)
        .map(([k,v])=>`<li><b>${k}</b>：${v}</li>`).join('');
      return `<div class="blk"><h4>${q.key}（示例）</h4><ul>${mine}${others}</ul></div>`;
    }).join('');

    // 追加（如果本輪已經加過，就先清掉舊的再加）
    box.querySelectorAll('.blk.__addon').forEach(n=>n.remove());
    box.insertAdjacentHTML('beforeend', `
      <div class="blk __addon"><h4>常用穴位（示例）</h4><ul>${acup}</ul></div>
      <div class="blk __addon"><h4>參考方藥（示例）</h4><ul>${rx}</ul></div>
      <div class="blk __addon"><h4>症狀速查（教學用）</h4>
        <div class="muted" style="margin:4px 0 6px">僅供教學示例，請依實際證候辨證取用；慢性或嚴重症狀請就醫。</div>
      </div>
      ${quickHtml}
    `);
  };

  // 首次載入時補畫一次（若主程式已經跑了 render）
  try{
    if (typeof window.__lastMeElem !== 'undefined' && window.updateTCMAdvice) {
      window.updateTCMAdvice(window.__lastMeElem || '土');
    }
  }catch(_){}
})();
</script>
<script id="TCM_DYNAMICS_PATCH">
/* 最小補丁：五行雷達 → 中醫內容即時同步 + 智能重點排序 */
(function(){
  if (window.__TCM_DYNAMICS_PATCH__) return; window.__TCM_DYNAMICS_PATCH__=true;

  // 取得雷達值（讀你右欄 w5 拉桿）
  function getFive(){
    const g = k => { const el = document.getElementById(k); return el? +el.value : NaN; };
    const v = {木:g('w5_mu'),火:g('w5_huo'),土:g('w5_tu'),金:g('w5_jin'),水:g('w5_shui')};
    return Object.values(v).some(x=>isFinite(x)) ? v : null;
  }
  // 找強弱
  function trend(v){
    const arr = Object.entries(v); const avg = arr.reduce((a,[,b])=>a+b,0)/arr.length;
    const hi = arr.filter(([,x])=>x>avg+0.5).map(([k])=>k);
    const lo = arr.filter(([,x])=>x<avg-0.5).map(([k])=>k);
    return {hi, lo, avg};
  }

  // 各五行 → 對應症候優先級（只重排你原本的「常見體質／症候」清單，不改文字）
  const PRIORITY = {
    木: {旺:['肝火','上炎','鬱'], 弱:['血虛','肝腎陰虛','抽筋']},
    火: {旺:['心火','煩躁','口瘡'], 弱:['心陰不足','心脾兩虛','失眠']},
    土: {旺:['濕','痰','困脾'],      弱:['脾胃虛','食少','便溏']},
    金: {旺:['燥','鼻','皮膚乾'],    弱:['肺氣虛','咳','過敏']},
    水: {旺:['水腫','痰飲','寒濕'],  弱:['腎陽虛','腎陰虛','腰膝']}
  };

  // 針對 #tcmLists 的「常見體質／症候（參考）」區塊做重排、加上標籤
  function postProcessTCM(meElem){
    const lists = document.getElementById('tcmLists'); if(!lists) return;
    // 找到標題是「常見體質／症候（參考）」的區塊
    const blocks = Array.from(lists.querySelectorAll('.blk'));
    const patBlk = blocks.find(b => /常見體質|症候/.test(b.textContent || ''));
    if(!patBlk) return;

    const five = getFive(); if(!five) return;
    const {hi, lo} = trend(five);

    // 讀 li
    const ul = patBlk.querySelector('ul'); if(!ul) return;
    const items = Array.from(ul.querySelectorAll('li'));
    // 打分：與高/低對應關鍵字越接近，分數越高（高旺優先、低弱次之）
    function score(text){
      let s = 0, T = text.replace(/\s/g,'');
      hi.forEach(k => { (PRIORITY[k]?.旺||[]).forEach(key=>{ if(T.includes(key)) s += 3; }); });
      lo.forEach(k => { (PRIORITY[k]?.弱||[]).forEach(key=>{ if(T.includes(key)) s += 2; }); });
      // 與卦宮同五行略加權（你左側 render() 已把 meElem 存在 __lastMeElem）
      if (meElem && PRIORITY[meElem]) {
        (PRIORITY[meElem].旺||[]).forEach(key=>{ if(T.includes(key)) s += 0.8; });
        (PRIORITY[meElem].弱||[]).forEach(key=>{ if(T.includes(key)) s += 0.8; });
      }
      return s;
    }
    const ranked = items.map(li => ({li, sc:score(li.textContent||'')}))
                        .sort((a,b)=>b.sc - a.sc);

    // 先清空再插回（高分在前）
    ul.innerHTML = '';
    ranked.forEach(({li,sc})=>{
      if(sc>0){
        const tag = document.createElement('span');
        tag.textContent = '★';
        tag.style.cssText = 'display:inline-block;margin-left:6px;color:#ef4444';
        li.appendChild(tag);
      }
      ul.appendChild(li);
    });

    // 在區塊下面補一行「依五行傾向」的提示（不覆蓋你原文）
    const tipCls = '__dyn_tip';
    patBlk.querySelectorAll('.'+tipCls).forEach(n=>n.remove());
    const tip = document.createElement('div');
    tip.className = 'muted '+tipCls;
    tip.style.marginTop = '6px';
    tip.textContent = `依五行傾向排序：偏旺 ${hi.join('、') || '—'}／偏弱 ${lo.join('、') || '—'}（僅示例）`;
    patBlk.appendChild(tip);
  }

  // 包裝你現有的 updateTCMAdvice：跑完 → 動態重排
  const OLD = window.updateTCMAdvice;
  window.updateTCMAdvice = function(meElem){
    if (typeof OLD === 'function') { try{ OLD(meElem); }catch(_){} }
    try { postProcessTCM(meElem || window.__lastMeElem || '土'); } catch(_) {}
  };

  // 監聽五行拉桿，任何變化都會重算（保險重綁）
  ['w5_mu','w5_huo','w5_tu','w5_jin','w5_shui','w5_size'].forEach(id=>{
    const el = document.getElementById(id);
    if(el){ el.addEventListener('input', ()=> {
      try{ window.updateTCMAdvice(window.__lastMeElem || '土'); }catch(_){}
    });}
  });

  // 首次進來也跑一次
  try{ window.updateTCMAdvice(window.__lastMeElem || '土'); }catch(_){}
})();
</script>
<style id="TCM_RHS_POLISH">
/* 只影響右欄，讓畫面變短變漂亮 */
#tcmBox{padding:14px;border-radius:14px;border:1px solid #e2e8f0}
#tcmCore{display:flex;flex-wrap:wrap;gap:6px}
#tcmCore .tag{background:#f1f5ff;color:#1d4ed8}
#tcmLists{display:grid;grid-template-columns:1fr 1fr;gap:10px}
#tcmLists .blk{border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff}
#tcmLists .blk h4{margin:0 0 6px;font-size:14px;color:#0f172a}
#tcmLists ul{margin:6px 0 0 18px}
#tcmLists li{margin:2px 0}
#tcmBox .tcm-note{grid-column:1/-1}

/* 五行雷達卡片也稍微緊湊 */
#w5_sec{padding:12px;border-radius:14px}
#w5_ctrl .row{margin:4px 0}
#w5_ctrl input[type=range]{height:8px}

/* 小螢幕自動回單欄 */
@media (max-width: 900px){
  #tcmLists{grid-template-columns:1fr}
}

/* 可收合（小箭頭按鈕） */
.tcm-collapse{display:flex;align-items:center;justify-content:space-between;gap:8px;margin:0 0 8px}
.tcm-collapse button{border:1px solid #e2e8f0;background:#fff;border-radius:8px;height:28px;padding:0 8px;cursor:pointer}
</style>

<script id="TCM_RHS_POLISH_JS">
(function(){
  if(window.__TCM_RHS_POLISH__) return; window.__TCM_RHS_POLISH__=true;
  const box = document.getElementById('tcmBox'); if(!box) return;

  // 加個收合列
  const title = box.querySelector('h3');
  const bar = document.createElement('div');
  bar.className = 'tcm-collapse';
  bar.innerHTML = '<div style="font-weight:600;color:#0f172a">中醫分科建議</div><div><button id="tcmToggle">收合</button></div>';
  title.replaceWith(bar);

  let opened = true;
  function setOpen(on){
    opened = on;
    const core = document.getElementById('tcmCore');
    const lists = document.getElementById('tcmLists');
    const note = box.querySelector('.tcm-note');
    [core,lists,note].forEach(el=>{ if(el) el.style.display = on?'':'none'; });
    const btn = document.getElementById('tcmToggle'); if(btn) btn.textContent = on?'收合':'展開';
  }
  box.querySelector('#tcmToggle').addEventListener('click', ()=> setOpen(!opened));

  // 初次：保持展開
  setOpen(true);

  // 列印時自動展開
  function preprint(){ setOpen(true); try{ if(window.w5_draw) window.w5_draw(); }catch(_){ } }
  if('onbeforeprint' in window) window.addEventListener('beforeprint', preprint);
  try{ const mq = window.matchMedia('print'); mq && mq.addEventListener?.('change', e=>{ if(e.matches) preprint(); }); }catch(_){}
})();
</script>
<style id="TCM_HINT_STYLE">
.tcm-hintwrap{display:flex;align-items:center;gap:6px;margin:4px 0 8px}
.tcm-hintwrap .icon{display:inline-block;width:16px;height:16px;border-radius:50%;background:#e2e8f0;
  color:#334155;font-size:12px;line-height:16px;text-align:center;cursor:help;position:relative}
.tcm-hintwrap .tip{visibility:hidden;opacity:0;position:absolute;top:22px;left:0;z-index:20;
  min-width:220px;max-width:320px;padding:8px 10px;border-radius:6px;background:#334155;color:#f8fafc;
  font-size:12px;line-height:1.4;transition:opacity .2s}
.tcm-hintwrap .icon:hover .tip{visibility:visible;opacity:1}
</style>

<script id="TCM_HINT_ICON">
(function(){
  if(window.__TCM_HINT_ICON__) return; window.__TCM_HINT_ICON__=true;
  const box=document.getElementById('tcmBox'); if(!box) return;

  // 只加一次
  if(!box.querySelector('.tcm-hintwrap')){
    const wrap=document.createElement('div');
    wrap.className='tcm-hintwrap';
    wrap.innerHTML=`<span style="font-size:13px;color:#0f172a">建議來源</span>
      <div class="icon">?
        <div class="tip">
          卦象卦宮五行 → 決定核心臟腑、科別、症候、調養建議；<br>
          五行雷達拉桿 → 即時標示偏旺／偏弱，並重排症候順序。<br><br>
          ※ 此內容僅供學習參考，非臨床診斷。
        </div>
      </div>`;
    box.insertBefore(wrap, box.firstElementChild.nextSibling);
  }
})();
</script>
<style id="TCM_DEPT_TABS_CSS">
/* 右欄：分頁＋卡片＋縮短高度 */
#tcmBox{max-height:78vh;overflow:auto}
@media print{#tcmBox{max-height:none;overflow:visible}}

#tcmTabs{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0 8px}
#tcmTabs button{border:1px solid #e2e8f0;background:#fff;border-radius:999px;height:28px;padding:0 10px;cursor:pointer;font-size:12px;color:#334155}
#tcmTabs button.on{background:#1d4ed8;color:#fff;border-color:#1d4ed8}

#tcmPanels>.panel{display:none}
#tcmPanels>.panel.on{display:block}

.tcm-cards{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.tcm-card{border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:10px}
.tcm-card h5{margin:0 0 6px;font-size:14px;color:#0f172a;display:flex;justify-content:space-between;gap:8px}
.tcm-card .tag{font-size:11px;background:#f1f5ff;color:#1d4ed8;border-radius:999px;padding:2px 8px}
.tcm-card ul{margin:6px 0 0 18px}
.tcm-card .muted{font-size:12px;color:#64748b}

@media (max-width:900px){.tcm-cards{grid-template-columns:1fr}}

/* 右欄 sticky（縮短整頁滾動距離） */
#printRight{position:sticky;top:10px;align-self:flex-start}
</style>

<script id="TCM_DEPT_TABS_JS">
(function(){
  if(window.__TCM_DEPT_TABS__) return; window.__TCM_DEPT_TABS__=true;
  const box=document.getElementById('tcmBox'); if(!box) return;

  // --------- 專科資料（示例，教學用；可任意增修） ---------
  const MAP_DEPT = [
    {id:'head',  name:'頭面/神經', phase:'木', cases:['偏頭痛','緊張型頭痛','眩暈','鼻竇炎','落髮'], pts:['太衝 LR3','風池 GB20','合谷 LI4','印堂 EX-HN3'], rx:['川芎茶調散','天麻鉤藤飲','鼻淵方']},
    {id:'sleep', name:'情志/睡眠', phase:'火', cases:['失眠多夢','心悸','焦慮煩躁','胸悶'], pts:['神門 HT7','內關 PC6','膻中 CV17','湧泉 KI1'], rx:['酸棗仁湯','天王補心丹']},
    {id:'resp',  name:'呼吸/過敏', phase:'金', cases:['過敏性鼻炎','反覆感冒','咳嗽','氣喘'], pts:['列缺 LU7','太淵 LU9','合谷 LI4','曲池 LI11'], rx:['玉屏風散','桑菊飲']},
    {id:'gi',    name:'脾胃/消化', phase:'土', cases:['脹悶食少','胃食道逆流','便溏腹瀉','食積'], pts:['足三里 ST36','中脘 CV12','脾俞 BL20','陰陵泉 SP9'], rx:['四君子湯','香砂六君子湯','平胃散']},
    {id:'male',  name:'男性科/泌尿', phase:'水', cases:['腰膝痠軟','腎虛','攝護腺症候','遺精早泄'], pts:['腎俞 BL23','命門 GV4','太溪 KI3','復溜 KI7'], rx:['右歸丸','腎氣丸']},
    {id:'gyn',   name:'婦科', phase:'木', cases:['月經不調','痛經','經前症候群','更年期調理'], pts:['三陰交 SP6','太衝 LR3','血海 SP10','子宮 EX-CA1'], rx:['逍遙散','加味逍遙散','溫經湯']},
    {id:'skin',  name:'皮膚', phase:'金', cases:['濕疹','蕁麻疹','痘痘','皮膚乾癢'], pts:['曲池 LI11','合谷 LI4','血海 SP10','太溪 KI3'], rx:['涼血消風散','消風散']},
    {id:'msk',   name:'筋骨運動', phase:'木', cases:['落枕','肩頸痛','腰痛','扭挫傷'], pts:['陽陵泉 GB34','委中 BL40','阿是穴','肩髃 LI15'], rx:['獨活寄生湯','身痛逐瘀湯']}
  ];
  // 五行→偏旺/偏弱時的權重加成
  const PHASE_WEIGHT = {hi:2, lo:1, base:0.6};

  function getFive(){
    const v = {
      木:+(document.getElementById('w5_mu')?.value||NaN),
      火:+(document.getElementById('w5_huo')?.value||NaN),
      土:+(document.getElementById('w5_tu')?.value||NaN),
      金:+(document.getElementById('w5_jin')?.value||NaN),
      水:+(document.getElementById('w5_shui')?.value||NaN)
    };
    return Object.values(v).every(n=>!isNaN(n)) ? v : null;
  }
  function trend(v){
    const arr=Object.entries(v); const avg=arr.reduce((a,[,b])=>a+b,0)/arr.length;
    return {
      hi: arr.filter(([,x])=>x>avg+0.5).map(([k])=>k),
      lo: arr.filter(([,x])=>x<avg-0.5).map(([k])=>k)
    };
  }

  // 產生分頁骨架（不覆蓋你原本內容；只是加一層 Tab）
  function ensureTabs(){
    if(document.getElementById('tcmTabs')) return;
    const tabs=document.createElement('div'); tabs.id='tcmTabs';
    tabs.innerHTML = `
      <button data-p="dept" class="on">分科</button>
      <button data-p="acup">穴位</button>
      <button data-p="formula">方藥</button>
      <button data-p="quick">速查</button>
      <button data-p="overview">總覽</button>`;
    const panels=document.createElement('div'); panels.id='tcmPanels';
    panels.innerHTML = `
      <div class="panel on" id="p_dept"></div>
      <div class="panel" id="p_acup"></div>
      <div class="panel" id="p_formula"></div>
      <div class="panel" id="p_quick"></div>
      <div class="panel" id="p_overview"></div>`;
    // 插到原本 tcmBox 的最上層（保留你原先 core/lists 內容在 overview）
    const core = document.getElementById('tcmCore');
    const lists= document.getElementById('tcmLists');
    if(core && lists){
      // 把現有內容移到 overview 面板
      const ov = panels.querySelector('#p_overview');
      const wrap=document.createElement('div');
      wrap.innerHTML = `<div id="__tcm_ov_core"></div><div id="__tcm_ov_lists"></div>`;
      ov.appendChild(wrap);
      wrap.querySelector('#__tcm_ov_core').appendChild(core);
      wrap.querySelector('#__tcm_ov_lists').appendChild(lists);
    }
    box.insertBefore(tabs, box.firstChild.nextSibling);
    box.insertBefore(panels, tabs.nextSibling);

    tabs.addEventListener('click', e=>{
      const btn=e.target.closest('button[data-p]'); if(!btn) return;
      tabs.querySelectorAll('button').forEach(b=>b.classList.remove('on'));
      btn.classList.add('on');
      const key=btn.getAttribute('data-p');
      panels.querySelectorAll('.panel').forEach(p=>p.classList.remove('on'));
      panels.querySelector('#p_'+key)?.classList.add('on');
      // 切到非 overview 頁時，右欄就更短；列印前會自動展開
    });
  }

  // 根據卦宮（meElem）＋雷達，給分科排序
  function renderDept(meElem){
    ensureTabs();
    const pane=document.getElementById('p_dept'); if(!pane) return;
    const five=getFive(); const tr=five?trend(five):{hi:[],lo:[]};

    function score(d){
      let s = PHASE_WEIGHT.base;
      if(meElem && d.phase===meElem) s += 1;       // 卦宮加權
      if(tr.hi.includes(d.phase)) s += PHASE_WEIGHT.hi; // 偏旺
      if(tr.lo.includes(d.phase)) s += PHASE_WEIGHT.lo; // 偏弱
      return s;
    }
    const sorted = MAP_DEPT.map(d=>({d, sc:score(d)})).sort((a,b)=>b.sc-a.sc);

    pane.innerHTML = `<div class="tcm-cards">` + 
      sorted.map(({d,sc})=>`
        <div class="tcm-card">
          <h5>${d.name}<span class="tag">${d.phase}｜${sc.toFixed(1)}</span></h5>
          <div class="muted">常見：${d.cases.join('、')}</div>
          <ul>${d.pts.slice(0,3).map(s=>`<li>穴：${s}</li>`).join('')}
              ${d.rx.slice(0,2).map(s=>`<li>方：${s}</li>`).join('')}</ul>
        </div>`).join('') + `</div>`;
  }

  // 其他分頁：沿用你之前外掛的資料（若存在）
  function renderAcupFormulaQuick(meElem){
    const pA=document.getElementById('p_acup');
    const pF=document.getElementById('p_formula');
    const pQ=document.getElementById('p_quick');
    // 從先前 Addon 的常量取資料（若無，就用簡版）
    const ACUP = (window.__TCM_ACUP__||{}); // 你若需要我可把之前常量掛進全域
    const FORM = (window.__TCM_FORMULA__||{});
    const QUICK = (window.__TCM_QUICK__||[]);

    if(pA) pA.innerHTML = `
      <div class="tcm-cards">
        ${(ACUP[meElem]||[]).map(s=>`<div class="tcm-card"><h5>穴位<span class="tag">${meElem}</span></h5><ul><li>${s}</li></ul></div>`).join('') ||
          `<div class="tcm-card"><h5>穴位</h5><div class="muted">依分科頁面參考相應常用穴位</div></div>`}
      </div>`;
    if(pF) pF.innerHTML = `
      <div class="tcm-cards">
        ${(FORM[meElem]||[]).map(s=>`<div class="tcm-card"><h5>方藥<span class="tag">${meElem}</span></h5><ul><li>${s}</li></ul></div>`).join('') ||
          `<div class="tcm-card"><h5>方藥</h5><div class="muted">依分科頁面參考相應常用方藥</div></div>`}
      </div>`;
    if(pQ) pQ.innerHTML = `
      <div class="tcm-card"><h5>症狀速查</h5>
        <div class="muted">依卦宮＋五行雷達排序的重點症候，詳見「分科」分頁。</div>
      </div>`;
  }

  // 包裝：你原本的 updateTCMAdvice 跑完 → 我再渲染分科分頁
  const OLD = window.updateTCMAdvice;
  window.updateTCMAdvice = function(meElem){
    if(typeof OLD==='function'){ try{ OLD(meElem); }catch(e){} }
    try{
      renderDept(meElem||window.__lastMeElem||'土');
      renderAcupFormulaQuick(meElem||window.__lastMeElem||'土');
    }catch(e){}
  };

  // 監聽雷達拉桿 → 即時更新分科排序
  ['w5_mu','w5_huo','w5_tu','w5_jin','w5_shui'].forEach(id=>{
    const el=document.getElementById(id);
    if(el){ el.addEventListener('input', ()=>{ try{ window.updateTCMAdvice(window.__lastMeElem||'土'); }catch(e){} }); }
  });

  // 初次也跑一次
  try{ window.updateTCMAdvice(window.__lastMeElem||'土'); }catch(e){}
})();
</script>
<script id="TCM_TABS_FILLER_JS">
/* 補齊 Tabs 內容：穴位 / 方藥 / 速查 —— 依卦宮＋五行雷達動態產生 */
(function(){
  if (window.__TCM_TABS_FILLER__) return; window.__TCM_TABS_FILLER__=true;

  function ready(fn){ if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', fn); else fn(); }

  ready(function(){
    const box = document.getElementById('tcmBox');
    if(!box) return;

    // 目標面板（由分頁補丁建立）
    const pA = document.getElementById('p_acup');
    const pF = document.getElementById('p_formula');
    const pQ = document.getElementById('p_quick');

    // 如果分頁還沒建好（你可能還沒貼分科分頁的補丁），就先直接離開
    if(!pA || !pF || !pQ) return;

    // —— 內建一份精簡資料（與分科卡片一致的口味），僅示例用途 ——
    const MAP_DEPT_FIX = [
      {id:'head',  name:'頭面/神經', phase:'木', cases:['偏頭痛','緊張型頭痛','眩暈','鼻竇炎','落髮'], pts:['太衝 (LR3)','風池 (GB20)','合谷 (LI4)','印堂 (EX-HN3)'], rx:['川芎茶調散','天麻鉤藤飲','鼻淵方']},
      {id:'sleep', name:'情志/睡眠', phase:'火', cases:['失眠多夢','心悸','焦慮煩躁','胸悶'], pts:['神門 (HT7)','內關 (PC6)','膻中 (CV17)','湧泉 (KI1)'], rx:['酸棗仁湯','天王補心丹']},
      {id:'resp',  name:'呼吸/過敏', phase:'金', cases:['過敏性鼻炎','反覆感冒','咳嗽','氣喘'], pts:['列缺 (LU7)','太淵 (LU9)','合谷 (LI4)','曲池 (LI11)'], rx:['玉屏風散','桑菊飲']},
      {id:'gi',    name:'脾胃/消化', phase:'土', cases:['脹悶食少','胃食道逆流','便溏腹瀉','食積'], pts:['足三里 (ST36)','中脘 (CV12)','脾俞 (BL20)','陰陵泉 (SP9)'], rx:['四君子湯','香砂六君子湯','平胃散']},
      {id:'male',  name:'男性科/泌尿', phase:'水', cases:['腰膝痠軟','腎虛','攝護腺症候','遺精早泄'], pts:['腎俞 (BL23)','命門 (GV4)','太溪 (KI3)','復溜 (KI7)'], rx:['右歸丸','腎氣丸']},
      {id:'gyn',   name:'婦科', phase:'木', cases:['月經不調','痛經','PMS','更年期調理'], pts:['三陰交 (SP6)','太衝 (LR3)','血海 (SP10)','子宮 (EX-CA1)'], rx:['逍遙散','加味逍遙散','溫經湯']},
      {id:'skin',  name:'皮膚', phase:'金', cases:['濕疹','蕁麻疹','痘痘','皮膚乾癢'], pts:['曲池 (LI11)','合谷 (LI4)','血海 (SP10)','太溪 (KI3)'], rx:['涼血消風散','消風散']},
      {id:'msk',   name:'筋骨運動', phase:'木', cases:['落枕','肩頸痛','腰痛','扭挫傷'], pts:['陽陵泉 (GB34)','委中 (BL40)','阿是穴','肩髃 (LI15)'], rx:['獨活寄生湯','身痛逐瘀湯']}
    ];

    // 取得五行雷達數值
    function getFive(){
      const v = {
        木:+(document.getElementById('w5_mu')?.value || NaN),
        火:+(document.getElementById('w5_huo')?.value || NaN),
        土:+(document.getElementById('w5_tu')?.value || NaN),
        金:+(document.getElementById('w5_jin')?.value || NaN),
        水:+(document.getElementById('w5_shui')?.value || NaN),
      };
      return Object.values(v).every(n=>!isNaN(n)) ? v : null;
    }
    // 偏旺/偏弱
    function trend(v){
      const arr = Object.entries(v);
      const avg = arr.reduce((a,[,b])=>a+b,0) / arr.length;
      return {
        hi: arr.filter(([,x])=>x>avg+0.5).map(([k])=>k),
        lo: arr.filter(([,x])=>x<avg-0.5).map(([k])=>k)
      };
    }
    function dedup(list){ const s=new Set(); const out=[]; list.forEach(x=>{ if(!s.has(x)){ s.add(x); out.push(x); } }); return out; }

    // 依卦宮＋雷達，挑選 Top 清單
    function fillTabs(meElem){
      const five = getFive();
      const tr = five ? trend(five) : {hi:[], lo:[]};

      // 權重：卦宮 + 偏旺/偏弱
      function phaseWeight(ph){
        let w = 0;
        if (meElem === ph) w += 2;
        if (tr.hi.includes(ph)) w += 1.5;
        if (tr.lo.includes(ph)) w += 1.0;
        return w;
      }

      const ptsWeighted = [];
      const rxWeighted  = [];
      MAP_DEPT_FIX.forEach(d=>{
        const w = phaseWeight(d.phase);
        (d.pts||[]).forEach(name => ptsWeighted.push({name, w}));
        (d.rx ||[]).forEach(name => rxWeighted .push({name, w}));
      });

      const topPts = dedup(ptsWeighted.sort((a,b)=>b.w-a.w).map(x=>x.name)).slice(0,12);
      const topRx  = dedup(rxWeighted .sort((a,b)=>b.w-a.w).map(x=>x.name)).slice(0,12);

      // —— 寫入「穴位」分頁 ——（單卡片、清單）
      if (pA) {
        pA.innerHTML = `
          <div class="tcm-card">
            <h5>常用穴位（依卦宮＋雷達）<span class="tag">${meElem||'—'}</span></h5>
            <ul>${topPts.map(s=>`<li>${s}</li>`).join('')}</ul>
            <div class="muted">※ 僅示例，臨床需辨證選穴。</div>
          </div>`;
      }
      // —— 寫入「方藥」分頁 ——（單卡片、清單）
      if (pF) {
        pF.innerHTML = `
          <div class="tcm-card">
            <h5>參考方藥（依卦宮＋雷達）<span class="tag">${meElem||'—'}</span></h5>
            <ul>${topRx.map(s=>`<li>${s}</li>`).join('')}</ul>
            <div class="muted">※ 僅示例，方藥使用請諮詢專業醫師。</div>
          </div>`;
      }
      // —— 寫入「速查」分頁 ——（每科一張卡，列常見症狀）
      if (pQ) {
        pQ.innerHTML =
          `<div class="tcm-cards">` +
          MAP_DEPT_FIX
            .sort((a,b)=>phaseWeight(b.phase)-phaseWeight(a.phase))
            .map(d=>`
              <div class="tcm-card">
                <h5>${d.name}<span class="tag">${d.phase}</span></h5>
                <div class="muted">常見：${d.cases.join('、')}</div>
              </div>
            `).join('') +
          `</div>`;
      }
    }

    // 讓 render() 完成後自動填入（包裝既有 updateTCMAdvice）
    const OLD = window.updateTCMAdvice;
    window.updateTCMAdvice = function(meElem){
      if (typeof OLD === 'function') { try{ OLD(meElem); }catch(e){} }
      try{ fillTabs(meElem || window.__lastMeElem || '土'); }catch(_){}
    };

    // 切換分頁或拖拉雷達，都會刷新
    document.getElementById('tcmTabs')?.addEventListener('click', ()=> fillTabs(window.__lastMeElem||'土'));
    ['w5_mu','w5_huo','w5_tu','w5_jin','w5_shui'].forEach(id=>{
      const el=document.getElementById(id); if(el){ el.addEventListener('input', ()=> fillTabs(window.__lastMeElem||'土')); }
    });

    // 首次填入
    fillTabs(window.__lastMeElem || '土');
  });
})();
</script>
<style id="ACUP_MER_STYLE">
  .ac-mer{margin-left:6px;font-size:12px;color:#64748b}
</style>
<style id="ACUP_MER_STYLE_V2">
  .ac-mer{margin-left:6px;font-size:12px;color:#64748b}
</style>

<script id="ACUP_MER_TAGS_V2">
(function(){
  if(window.__ACUP_MER_V2__) return; window.__ACUP_MER_V2__=true;

  const MER = {
    LU:'手太陰肺經', LI:'手陽明大腸經', ST:'足陽明胃經', SP:'足太陰脾經',
    HT:'手少陰心經', SI:'手太陽小腸經', BL:'足太陽膀胱經', KI:'足少陰腎經',
    PC:'手厥陰心包經', TE:'手少陽三焦經', SJ:'手少陽三焦經', TB:'手少陽三焦經',
    GB:'足少陽膽經', LR:'足厥陰肝經', CV:'任脈', GV:'督脈', EX:'經外奇穴'
  };
  const EX_AREA = { HN:'（頭頸）', UE:'（上肢）', LE:'（下肢）', CA:'（胸腹）', BACK:'（背部）' };

  function meridianOf(text){
    const T = String(text||'');
    let m = T.match(/\(([A-Z]{2,3}(?:-[A-Z]{2})?)[0-9]*\)/) || T.match(/\b([A-Z]{2,3}(?:-[A-Z]{2})?)\s*\d{0,2}\b/);
    if(!m){ if(/阿是/.test(T)) return '阿是穴（壓痛點）'; return ''; }
    const code = m[1];
    if(code.startsWith('EX')){ const area = code.split('-')[1]; return MER.EX + (EX_AREA[area]||''); }
    return MER[code.replace(/[0-9]/g,'')] || '';
  }

  function annotateLis(root){
    if(!root) return;
    root.querySelectorAll('li').forEach(li=>{
      if(li.querySelector('.ac-mer')) return;
      const mer = meridianOf(li.textContent);
      if(!mer) return;
      const tag = document.createElement('span');
      tag.className = 'ac-mer';
      tag.textContent = '— ' + mer;
      li.appendChild(tag);
    });
  }

  function annotateAcupTab(){
    const pA = document.getElementById('p_acup');
    if(pA){ annotateLis(pA); return; }
    const lists = document.getElementById('tcmLists');
    if(lists){
      lists.querySelectorAll('.blk').forEach(blk=>{
        const h = blk.querySelector('h4'); if(h && /穴位/.test(h.textContent||'')) annotateLis(blk);
      });
    }
  }

  function annotateDeptTab(){
    const pD = document.getElementById('p_dept'); if(!pD) return;
    pD.querySelectorAll('.tcm-card ul li').forEach(li=>{
      if(li.querySelector('.ac-mer')) return;
      if(!/^穴：/.test(li.textContent||'')) return;
      const mer = meridianOf(li.textContent);
      if(!mer) return;
      const tag = document.createElement('span');
      tag.className='ac-mer';
      tag.textContent='— ' + mer;
      li.appendChild(tag);
    });
  }

  const safeAnnotate = ()=>{ try{ annotateAcupTab(); annotateDeptTab(); }catch(e){} };

  const OLD = window.updateTCMAdvice;
  window.updateTCMAdvice = function(meElem){
    if(typeof OLD==='function'){ try{ OLD(meElem); }catch(e){} }
    safeAnnotate();
  };

  document.getElementById('tcmTabs')?.addEventListener('click', safeAnnotate);

  // 可留可去：監看穴位分頁內容變動（有防抖，不會卡）
  const pA = document.getElementById('p_acup');
  if(pA && 'MutationObserver' in window){
    let scheduled = false;
    const mo = new MutationObserver(()=> {
      if(scheduled) return;
      scheduled = true;
      requestAnimationFrame(()=>{ scheduled = false; safeAnnotate(); });
    });
    mo.observe(pA, { childList:true, subtree:true });
  }

  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', safeAnnotate);
  else safeAnnotate();
})();
</script>
<style id="PRINT_TIGHT_PATCH">
@media print{
  /* 整體更緊湊 */
  .grid{display:block}
  .sec{margin:0 0 8px !important; padding:0 !important; border:none !important}

  /* 卦盤容器去邊距，canvas 100% 寬已有 */
  .canvasWrap{padding:0 !important; margin:0 !important}

  /* 讓備註緊貼卦盤，盡量避免跑到下一頁 */
  #noteBox{
    margin-top:6px !important;
    break-before: avoid-page;
    page-break-before: auto;
    break-inside: auto;
  }

  /* 右欄避免硬性斷頁造成上一頁大留白 */
  #printRight{
    break-before: avoid-page;
    page-break-before: auto;
  }
}
</style>
<script id="PRINT_FIT_PATCH">
(function(){
  if(window.__PRINT_FIT_PATCH__) return; window.__PRINT_FIT_PATCH__=true;
  var bak=null;

  function setVal(id,v){
    var el=document.getElementById(id);
    if(!el || v==null) return;
    el.value=String(v);
    el.dispatchEvent(new Event('input',{bubbles:true}));
    el.dispatchEvent(new Event('change',{bubbles:true}));
  }

  function compactForPrint(){
    // 記住原值
    var g=id=>document.getElementById(id);
    bak = {
      size: g('size')?.value,
      gap: g('gap')?.value,
      head: g('headgap')?.value,
      offx: g('offx')?.value,
      offy: g('offy')?.value
    };
    /* 這組是 A4 一頁比較保險的緊湊參數，你可再微調：
       - size 小一點（卦線長度）
       - gap 爻距小一點
       - head 列頭間距小一點
    */
    setVal('size',    260);
    setVal('gap',     28);
    setVal('headgap', 18);
    setVal('offx',     0);
    setVal('offy',     0);
    try{ if(window.render) window.render(); }catch(_){}
  }

  function restoreAfterPrint(){
    if(!bak) return;
    setVal('size',    bak.size);
    setVal('gap',     bak.gap);
    setVal('headgap', bak.head);
    setVal('offx',    bak.offx);
    setVal('offy',    bak.offy);
    try{ if(window.render) window.render(); }catch(_){}
  }

  if('onbeforeprint' in window){
    window.addEventListener('beforeprint', compactForPrint);
    window.addEventListener('afterprint',  restoreAfterPrint);
  } else {
    // 某些瀏覽器不支援 afterprint，保險起見監聽媒體查詢
    try{
      var mq=window.matchMedia('print');
      mq && mq.addEventListener && mq.addEventListener('change', e=>{
        if(e.matches) compactForPrint(); else restoreAfterPrint();
      });
    }catch(_){}
  }
})();
</script>
<style id="PRINT_TIGHT_PLUS">
@media print{
  .grid{display:block}
  .sec{margin:0 0 8px !important; padding:0 !important; border:none !important}
  .canvasWrap{padding:0 !important; margin:0 !important}
  /* 避免因 sticky 造成版面保留空間 */
  #printRight{position:static !important; top:auto !important}
  /* 優先讓卦盤與備註排同頁，別中途斷頁 */
  #hexCanvas, #noteBox{page-break-inside: avoid; break-inside: avoid}
  /* textarea 印起來像純文字 */
  #userNote{border:none !important; outline:none !important; background:transparent !important}
}
</style>
<style id="PRINT_TIGHT_PLUS">
@media print{
  .grid{display:block}
  .sec{margin:0 0 8px !important; padding:0 !important; border:none !important}
  .canvasWrap{padding:0 !important; margin:0 !important}
  /* 避免因 sticky 造成版面保留空間 */
  #printRight{position:static !important; top:auto !important}
  /* 優先讓卦盤與備註排同頁，別中途斷頁 */
  #hexCanvas, #noteBox{page-break-inside: avoid; break-inside: avoid}
  /* textarea 印起來像純文字 */
  #userNote{border:none !important; outline:none !important; background:transparent !important}
}
</style>
<script id="PRINT_CANVAS_SHRINK_FIT">
(function(){
  if(window.__PRINT_CANVAS_SHRINK_FIT__) return; window.__PRINT_CANVAS_SHRINK_FIT__=true;
  const $ = id => document.getElementById(id);

  function num(id, def){ const el=$(id); const v=+(el&&el.value); return isFinite(v)?v:def; }

  // 依你現有 drawBoard 參數推回需要的最小高度（px）
  function computeUsedCanvasHeight(){
    // 與你 drawBoard 內一致的變數：y0 = 120 + offy；最後一條 y = y0 + headgap + 5*gap
    const offy    = num('offy',    0);
    const headgap = num('headgap', 24);
    const gap     = num('gap',     32);
    const y0      = 120 + offy;

    const lastLineY = y0 + headgap + 5*gap;
    const bottomPad = 90;   // 行尾標籤與註腳的緩衝
    const minTop    = 120;  // 標題區保守高度
    // 取較大者，避免被頂部資訊吃掉
    return Math.max(lastLineY + bottomPad, minTop + 40);
  }

  let bakStyleHeight = null;

  function shrinkAndRedraw(){
    const cvs = $('hexCanvas'); if(!cvs) return;
    if(bakStyleHeight===null) bakStyleHeight = cvs.style.height || '';
    // 先把 canvas 的 CSS 高度設成「剛好需要的高度」
    const h = Math.max(420, Math.round(computeUsedCanvasHeight())); // 設下限，避免過矮
    cvs.style.height = h + 'px';
    // 再叫你的 render()，讓 setupCanvas 以新的 clientHeight 重配像素並重繪
    try{ if(window.render) window.render(); }catch(_){}
  }

  function restore(){
    const cvs = $('hexCanvas'); if(!cvs) return;
    cvs.style.height = (bakStyleHeight==null? '' : bakStyleHeight);
    bakStyleHeight = null;
    try{ if(window.render) window.render(); }catch(_){}
  }

  // 列印前/後掛鉤
  if('onbeforeprint' in window){
    window.addEventListener('beforeprint', shrinkAndRedraw);
    window.addEventListener('afterprint',  restore);
  }
  // 某些瀏覽器只支援媒體查詢變化
  try{
    const mq = window.matchMedia('print');
    mq && mq.addEventListener?.('change', e => { if(e.matches) shrinkAndRedraw(); else restore(); });
  }catch(_){}

  // 你手動按右上角「列印」按鈕（或工具列列印）時也保險縮一次
  document.getElementById('btnPrintTop')?.addEventListener('click', shrinkAndRedraw);
  document.getElementById('btnPrint')?.addEventListener('click',     shrinkAndRedraw);
})();
</script>
<style id="TCM_MODE_MINI_CSS">
  /* 模式切換條 */
  #tcmModeBar{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0 8px}
  #tcmModeBar button{border:1px solid #e2e8f0;background:#fff;border-radius:999px;height:28px;padding:0 10px;cursor:pointer;font-size:12px;color:#334155}
  #tcmModeBar button.on{background:#1d4ed8;color:#fff;border-color:#1d4ed8}
  /* 列印時隱藏控制與非必要分頁 */
  @media print{
    #tcmModeBar,#tcmTabs{display:none!important}
    /* 右欄仍可印，但由 JS 先切到精簡模式 */
  }
</style>

<script id="TCM_MODE_MINI_JS">
(function(){
  if(window.__TCM_MODE_MINI__) return; window.__TCM_MODE_MINI__=true;
  const box = document.getElementById('tcmBox'); if(!box) return;

  // ---- 1) UI：模式切換條（插在提示/標題下） ----
  let bar = document.createElement('div'); bar.id='tcmModeBar';
  bar.innerHTML = `
    <button data-mode="compact" class="on">精簡</button>
    <button data-mode="standard">標準</button>
    <button data-mode="full">完整</button>`;
  // 嘗試插在 hint 或收合列之後
  const anchor = box.querySelector('.tcm-hintwrap') || box.firstElementChild;
  box.insertBefore(bar, anchor ? anchor.nextSibling : box.firstChild);

  // ---- 2) 狀態管理 ----
  const LSKEY='tcm_mode_v1';
  function getMode(){ return localStorage.getItem(LSKEY) || 'compact'; }
  function setMode(m){ localStorage.setItem(LSKEY,m); reflectBar(m); applyTrim(m); }
  function reflectBar(m){
    bar.querySelectorAll('button').forEach(b=>b.classList.toggle('on', b.getAttribute('data-mode')===m));
  }

  bar.addEventListener('click', e=>{
    const btn=e.target.closest('button[data-mode]'); if(!btn) return;
    setMode(btn.getAttribute('data-mode'));
  });

  // ---- 3) 核心：依模式「只顯示前 N 項」 ----
  const LIMITS = {
    compact:  { dept:1, acup:4, rx:4, quick:false, overview:false },
    standard: { dept:3, acup:8, rx:8, quick:true,  overview:true  },
    full:     { dept:99,acup:99,rx:99,quick:true,  overview:true  }
  };

  function hideAfter(parent, selector, keepN){
    if(!parent) return;
    const nodes = Array.from(parent.querySelectorAll(selector));
    nodes.forEach((el,i)=> el.style.display = (i<keepN ? '' : 'none'));
  }

  function applyTabsTrim(m){
    const lim = LIMITS[m]||LIMITS.compact;
    const pDept = document.getElementById('p_dept');
    const pAcup = document.getElementById('p_acup');
    const pRx   = document.getElementById('p_formula');
    const pQuick= document.getElementById('p_quick');
    const pOv   = document.getElementById('p_overview');

    // 分科卡片：已經依相關性排序，保留前 N 張
    if(pDept) hideAfter(pDept, '.tcm-card', lim.dept);
    // 穴位 / 方藥清單：保留前 N 個 <li>
    if(pAcup) hideAfter(pAcup, 'li', lim.acup);
    if(pRx)   hideAfter(pRx,   'li', lim.rx);

    // 是否顯示「速查」「總覽」分頁內容
    if(pQuick) pQuick.style.display = lim.quick ? '' : 'none';
    if(pOv)    pOv.style.display    = lim.overview ? '' : 'none';
  }

  function applyFallbackTrim(m){
    // 沒有分頁補丁時，直接在 #tcmLists 裡面做精簡
    const lim = LIMITS[m]||LIMITS.compact;
    const lists = document.getElementById('tcmLists'); if(!lists) return;

    lists.querySelectorAll('.blk').forEach(blk=>{
      const h = (blk.querySelector('h4')?.textContent||'');
      // 分科：通常是「建議就診科別」
      if(/就診科別/.test(h)) hideAfter(blk, 'li, .pill, .tag, ul>li', lim.dept*2); // 粗略保留 2N
      // 穴位
      if(/穴位/.test(h)) hideAfter(blk, 'li', lim.acup);
      // 方藥
      if(/方藥|方藥|方劑/.test(h)) hideAfter(blk, 'li', lim.rx);
      // 其他清單（體質/症候、日常調養）在精簡模式各保留 4 項即可
      if(/體質|症候/.test(h)) hideAfter(blk, 'li', m==='compact'?4:99);
      if(/調養|建議/.test(h)) hideAfter(blk, 'li', m==='compact'?4:99);
    });
  }

  function applyTrim(m){
    // 兩種情況都試：有「分頁」就修分頁；沒有就修傳統列表
    applyTabsTrim(m);
    applyFallbackTrim(m);
  }

  // ---- 4) 與你現有流程掛鉤：render/update 後重套模式 ----
  const OLD = window.updateTCMAdvice;
  window.updateTCMAdvice = function(meElem){
    if(typeof OLD==='function'){ try{ OLD(meElem); }catch(e){} }
    try{ applyTrim(getMode()); }catch(_){}
  };

  // 列印前自動切精簡，印完還原
  let bakMode=null;
  function beforePrint(){ bakMode=getMode(); setMode('compact'); }
  function afterPrint(){ if(bakMode) setMode(bakMode); bakMode=null; }
  if('onbeforeprint' in window){
    window.addEventListener('beforeprint', beforePrint);
    window.addEventListener('afterprint',  afterPrint);
  } else {
    try{
      const mq=window.matchMedia('print');
      mq && mq.addEventListener?.('change', e=>{ if(e.matches) beforePrint(); else afterPrint(); });
    }catch(_){}
  }

  // 初次套用
  reflectBar(getMode());
  applyTrim(getMode());
})();
</script>
<script id="W5_ORIENT_PATCH">
(function(){
  if(window.__W5_ORIENT_PATCH__) return; window.__W5_ORIENT_PATCH__=true;

  // 方位：上方=火；順時針：火→土→金→水→木（木位在左上，視覺上在左側）
  const ORDER=['火','土','金','水','木'];
  const ANG0 = -Math.PI/2; // -90°=正上方
  const COLORS={木:'#16a34a',火:'#ef4444',土:'#f59e0b',金:'#64748b',水:'#3b82f6'};

  const $=id=>document.getElementById(id);
  const num=(id,def)=>{const el=$(id); const v=Number(el&&el.value); return isFinite(v)?v:def;};
  const values=()=>({木:num('w5_mu',6),火:num('w5_huo',6),土:num('w5_tu',6),金:num('w5_jin',6),水:num('w5_shui',6)});
  function sizeScale(){
    let f=parseFloat(($('w5_size')&&$('w5_size').value)||1.3);
    f=Math.max(0.8,Math.min(1.8,f));
    const tip=$('w5_sizeVal'); if(tip) tip.textContent=Number(f).toFixed(2);
    return f;
  }

  function drawPoly(ctx, cx, cy, R, vMap, dash){
    if(dash){ ctx.save(); ctx.setLineDash([6,4]); }
    ctx.beginPath();
    ORDER.forEach((k,i)=>{
      const a = ANG0 + i*(2*Math.PI/ORDER.length);
      const rr = R * (Math.max(0,Math.min(10, vMap[k]))/10);
      const x = cx + rr*Math.cos(a), y = cy + rr*Math.sin(a);
      i ? ctx.lineTo(x,y) : ctx.moveTo(x,y);
    });
    ctx.closePath();
    if(dash){ ctx.lineWidth=2; ctx.strokeStyle='rgba(17,24,39,.9)'; ctx.stroke(); ctx.restore(); }
    else    { ctx.fillStyle='rgba(59,130,246,0.18)'; ctx.strokeStyle='rgba(59,130,246,0.9)'; ctx.lineWidth=2; ctx.fill(); ctx.stroke(); }
  }

  function draw(){
    const c=$('w5_canv'); if(!c) return;
    const dpr=window.devicePixelRatio||1, W=c.clientWidth||600, H=c.clientHeight||300;
    c.width=Math.floor(W*dpr); c.height=Math.floor(H*dpr);
    const ctx=c.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0); ctx.clearRect(0,0,W,H);

    const cx=W/2, cy=H/2+6, sc=sizeScale();
    const R=Math.min(W,H*0.9)/2*0.78*sc, rings=5;

    // 網格
    ctx.lineWidth=1; ctx.strokeStyle='#e5e7eb';
    for(let r=1;r<=rings;r++){
      const rr=R*r/rings; ctx.beginPath();
      for(let i=0;i<ORDER.length;i++){
        const a=ANG0+i*(2*Math.PI/ORDER.length);
        const x=cx+rr*Math.cos(a), y=cy+rr*Math.sin(a);
        i?ctx.lineTo(x,y):ctx.moveTo(x,y);
      }
      ctx.closePath(); ctx.stroke();
    }

    // 軸 + 標籤
    ctx.font='12px "Noto Sans TC","Microsoft JhengHei"'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ORDER.forEach((k,i)=>{
      const a=ANG0+i*(2*Math.PI/ORDER.length);
      const x=cx+R*Math.cos(a), y=cy+R*Math.sin(a);
      ctx.strokeStyle='#cbd5e1'; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(x,y); ctx.stroke();
      ctx.fillStyle=COLORS[k]||'#334155'; ctx.fillText(k, x, y-12);
    });

    // 實線多邊形（滑桿原值）
    const v=values();
    drawPoly(ctx, cx, cy, R, v, /*dash=*/false);

    // 虛線多邊形（若你有裝「互動平衡」外掛且已勾選）
    if (typeof window.balanced10 === 'function' && ($('w5_mode')?.checked)){
      drawPoly(ctx, cx, cy, R, window.balanced10(), /*dash=*/true);
    }

    // 頂點圓點 + 數字
    ORDER.forEach((k,i)=>{
      const a=ANG0+i*(2*Math.PI/ORDER.length);
      const rr=R*(Math.max(1,Math.min(10,v[k]))/10);
      const x=cx+rr*Math.cos(a), y=cy+rr*Math.sin(a);
      ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fillStyle=COLORS[k]||'#111827'; ctx.fill();
      ctx.fillStyle='#0f172a'; ctx.fillText(String(v[k]), x, y-16);
    });
  }

  // 覆蓋成新的畫法（不用動舊程式）
  window.w5_draw = draw;

  // 互動重繪
  ['w5_mu','w5_huo','w5_tu','w5_jin','w5_shui','w5_size','w5_mode'].forEach(id=>{
    const el=$(id); if(el){ el.addEventListener('input', draw); }
  });
  window.addEventListener('resize', draw);
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', ()=>setTimeout(draw,50));
  else setTimeout(draw,50);
})();
</script>
<style id="W5_BAL_MODE_CSS">
  #w5_mode_row{display:flex;gap:8px;align-items:center;margin:6px 0}
  #w5_mode_row input{vertical-align:middle}
  #w5_mode_row .w5_badge{font-size:11px;color:#64748b}
</style>

<script id="W5_BAL_MODE_JS">
(function(){
  if(window.__W5_BAL_MODE__) return; window.__W5_BAL_MODE__=true;
  const id=s=>document.getElementById(s);

  // 1) 開關 UI：加到雷達控制區最上面
  function ensureUI(){
    const ctrl=id('w5_ctrl'); if(!ctrl) return;
    if(id('w5_mode_row')) return;
    const row=document.createElement('div'); row.className='row'; row.id='w5_mode_row';
    row.innerHTML=`<label style="display:flex;align-items:center;gap:6px">
      <input id="w5_mode" type="checkbox"> 互動平衡（總分100）
    </label>
    <span class="w5_badge">相生：木→火→土→金→水；相剋：木克土、土克水、水克火、火克金、金克木</span>`;
    ctrl.insertBefore(row, ctrl.firstChild);
  }

  // 2) 參數（可微調）
  const BASE=20;           // 理想均衡分（100/5）
  const ALPHA=0.5;         // 生的傳導強度（↑則旺者拉高子行更多）
  const BETA =0.7;         // 剋的抑制強度（↑則旺者壓低所剋更多）
  const ORDER=['木','火','土','金','水'];
  const SHENG={木:'火',火:'土',土:'金',金:'水',水:'木'};
  const KE   ={木:'土',土:'水',水:'火',火:'金',金:'木'};

  // 3) 讀原始滑桿 → 100分正規化
  function getRaw(){ return {
    木:+(id('w5_mu')?.value||6), 火:+(id('w5_huo')?.value||6),
    土:+(id('w5_tu')?.value||6), 金:+(id('w5_jin')?.value||6),
    水:+(id('w5_shui')?.value||6)
  }; }
  function to100(v){ const s=ORDER.reduce((a,k)=>a+(+v[k]||0),0)||1; const o={}; ORDER.forEach(k=>o[k]=v[k]*100/s); return o; }
  function to10(p100){ const o={}; ORDER.forEach(k=>o[k]=Math.max(0,Math.min(10,p100[k]/10))); return o; }

  // 4) 一輪平衡（生加、剋減），再正規化
  function balanceOnce(p){
    const add={木:0,火:0,土:0,金:0,水:0};
    ORDER.forEach(k=>{
      const r=(p[k]-BASE)/BASE;           // 正=過旺，負=不足
      add[SHENG[k]] += ALPHA*r*BASE;      // 生子
      add[KE[k]]    -= BETA *r*BASE;      // 剋所剋
    });
    const s={}; ORDER.forEach(k=> s[k]=Math.max(0,p[k]+add[k]));
    const sum=ORDER.reduce((a,k)=>a+s[k],0)||1; ORDER.forEach(k=> s[k]=s[k]*100/sum);
    return s;
  }
  function balanced100(){ const raw=to100(getRaw()); const on=!!id('w5_mode')?.checked; return on? balanceOnce(raw): raw; }
  function balanced10(){ return to10(balanced100()); }

  // 5) 雷達疊「平衡後」虛線（不改原 draw）
  const OLD_DRAW=window.w5_draw;
  window.w5_draw=function(){
    if(typeof OLD_DRAW==='function') OLD_DRAW();
    try{
      const c=id('w5_canv'); if(!c) return;
      const dpr=window.devicePixelRatio||1, W=c.clientWidth, H=c.clientHeight;
      const ctx=c.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0);
      const cx=W/2, cy=H/2+6, R=Math.min(W,H*0.9)/2*0.78*(+id('w5_size')?.value||1.3);
      const ang0=-Math.PI/2, v=balanced10();
      ctx.save(); ctx.beginPath();
      ORDER.forEach((k,i)=>{ const a=ang0+i*(2*Math.PI/ORDER.length); const rr=R*(Math.max(0,Math.min(10,v[k]))/10);
        const x=cx+rr*Math.cos(a), y=cy+rr*Math.sin(a); i?ctx.lineTo(x,y):ctx.moveTo(x,y); });
      ctx.closePath(); ctx.setLineDash([6,4]); ctx.lineWidth=2; ctx.strokeStyle='rgba(17,24,39,.9)'; ctx.stroke(); ctx.restore();
    }catch(_){}
  };

  // 6) 讓中醫排序也用「平衡後」：暫換滑桿值呼叫，再還原
  const OLD_UPD=window.updateTCMAdvice;
  window.updateTCMAdvice=function(meElem){
    const on=!!id('w5_mode')?.checked;
    if(!on || typeof OLD_UPD!=='function'){ if(typeof OLD_UPD==='function') OLD_UPD(meElem); return; }
    const els={木:id('w5_mu'),火:id('w5_huo'),土:id('w5_tu'),金:id('w5_jin'),水:id('w5_shui')};
    const bak={}; ORDER.forEach(k=> bak[k]=els[k]?.value);
    const b10=balanced10();
    try{
      ORDER.forEach(k=>{ if(els[k]) els[k].value=String(Math.round(b10[k])); });
      OLD_UPD(meElem);
    } finally {
      ORDER.forEach(k=>{ if(els[k]) els[k].value=bak[k]; });
    }
    try{ window.w5_draw && window.w5_draw(); }catch(_){}
  };

  // 7) 事件：滑桿/尺寸或開關變動 → 更新
  ['w5_mu','w5_huo','w5_tu','w5_jin','w5_shui','w5_size','w5_mode'].forEach(s=>{
    const el=id(s); if(el){ el.addEventListener('input', ()=>{ try{ window.updateTCMAdvice(window.__lastMeElem||'土'); }catch(_){} }); }
  });

  function init(){ ensureUI(); try{ window.updateTCMAdvice && window.updateTCMAdvice(window.__lastMeElem||'土'); }catch(_){} }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', init); else init();
})();
</script>
<style id="W5_HELP_DOC_CSS">
  /* 說明按鈕 + 圖例 */
  .w5-help-btn{border:1px solid #e2e8f0;background:#fff;border-radius:999px;height:26px;padding:0 10px;cursor:pointer;font-size:12px;color:#334155}
  .w5-help-btn:hover{box-shadow:0 1px 6px rgba(0,0,0,.08)}
  .w5-legend{display:flex;align-items:center;gap:10px;margin:6px 0 0;color:#475569;font-size:12px}
  .w5-leg-item{display:flex;align-items:center;gap:6px}
  .w5-leg-line{display:inline-block;width:22px;height:0;border-top:2px solid #1f2937}
  .w5-leg-dash{display:inline-block;width:22px;height:0;border-top:2px dashed #1f2937}
  /* Modal */
  #w5_help_modal{position:fixed;inset:0;background:rgba(15,23,42,.4);display:none;z-index:10060}
  #w5_help_modal.on{display:block}
  #w5_help_modal .dlg{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(720px,92vw);max-height:80vh;overflow:auto;background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.22)}
  #w5_help_modal .hdr{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #e5e7eb;color:#0f172a;font-weight:600}
  #w5_help_modal .x{border:1px solid #e2e8f0;background:#fff;border-radius:8px;height:28px;padding:0 10px;cursor:pointer}
  #w5_help_modal .body{padding:12px 14px;color:#0f172a;font-size:14px;line-height:1.65}
  #w5_help_modal .body h4{margin:10px 0 6px;font-size:15px;color:#334155}
  #w5_help_modal .body ul{margin:6px 0 10px 20px}
  #w5_help_modal .foot{display:flex;justify-content:flex-end;gap:8px;padding:10px 12px;border-top:1px solid #e5e7eb}
  #w5_help_modal .foot .x{height:30px}
  .w5-badge{display:inline-block;margin-left:6px;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#1d4ed8;font-size:11px}
  @media print{#w5_help_modal,.w5-help-btn{display:none!important}} /* 列印時不顯示說明層與按鈕 */
</style>

<script id="W5_HELP_DOC_JS">
(function(){
  if(window.__W5_HELP_DOC__) return; window.__W5_HELP_DOC__=true;
  const $=s=>document.querySelector(s);

  function ensureUI(){
    const host = document.getElementById('w5_sec');  // 五行雷達圖區塊
    if(!host) return;

    // 1) 在標題旁加「說明」按鈕
    const h3 = host.querySelector('h3');
    if(h3 && !host.querySelector('.w5-help-btn')){
      const btn = document.createElement('button');
      btn.className='w5-help-btn'; btn.id='w5_help_btn'; btn.textContent='說明';
      h3.appendChild(document.createTextNode(' '));
      h3.appendChild(btn);
    }

    // 2) 在雷達圖下方加圖例（若尚未存在）
    if(!host.querySelector('.w5-legend')){
      const legend = document.createElement('div');
      legend.className='w5-legend';
      legend.innerHTML = `
        <div class="w5-leg-item"><span class="w5-leg-line"></span> 實線：原始拉桿</div>
        <div class="w5-leg-item"><span class="w5-leg-dash"></span> 虛線：平衡後（相生相剋一次傳導、總分100）</div>
        <span class="w5-badge">方位：上＝火 → 土 → 金 → 水 → 木（木在左側）</span>`;
      host.appendChild(legend);
    }

    // 3) 全頁共用的 Modal（只建一次）
    if(!document.getElementById('w5_help_modal')){
      const modal = document.createElement('div');
      modal.id='w5_help_modal';
      modal.innerHTML = `
        <div class="dlg">
          <div class="hdr">
            <div>五行雷達與虛線怎麼看？</div>
            <button class="x" data-act="close">關閉</button>
          </div>
          <div class="body">
            <h4>方位與圖例</h4>
            <ul>
              <li><b>上方＝火</b>，順時針依序：火 → 土 → 金 → 水 → 木（木位在左側/左上）。</li>
              <li><span class="w5-leg-line"></span> <b>實線</b>：你拉桿的原始值。</li>
              <li><span class="w5-leg-dash"></span> <b>虛線</b>：啟用「互動平衡（總分100）」後，依相生相剋做一次溫和傳導後的<b>平衡後分布</b>（原始拉桿不會被改）。</li>
            </ul>

            <h4>判讀口訣</h4>
            <ul>
              <li><b>X 旺 → 子行↑、所剋↓</b>（例：<b>木旺</b> ⇒ <b>火</b>虛線 ↑、<b>土</b>虛線 ↓）。</li>
              <li><b>X 弱 → 子行↓、所剋↑</b>（例：<b>水弱</b> ⇒ <b>木</b>虛線 ↓、<b>火</b>虛線 ↑）。</li>
              <li>右欄「分科/穴位/方藥」排序：<b>勾選互動平衡</b>時參考虛線；取消勾選則回到實線。</li>
            </ul>

            <h4>迷你示例</h4>
            <ul>
              <li>你把 <b>木</b> 拉高：虛線在 <b>火</b>（被木生）會凸一點，在 <b>土</b>（被木克）會縮一點。</li>
              <li>你把 <b>水</b> 拉低：虛線的 <b>木</b>（得水生）下降、<b>火</b>（原本被水克）回升。</li>
            </ul>

            <h4>常見問題</h4>
            <ul>
              <li>看不到虛線？請確認有勾選 <b>互動平衡（總分100）</b>；未勾選時只顯示實線。</li>
              <li>列印時會顯示嗎？預設只印實線與內容；說明視窗與按鈕不會出現在列印頁。</li>
            </ul>
          </div>
          <div class="foot">
            <button class="x" data-act="close">我了解了</button>
          </div>
        </div>`;
      document.body.appendChild(modal);

      // 關閉事件：按鈕、遮罩點擊、ESC
      const close = ()=> modal.classList.remove('on');
      modal.addEventListener('click', e=>{
        if(e.target===modal || e.target.closest('[data-act="close"]')) close();
      });
      window.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });
    }

    // 綁定開啟
    const btn = document.getElementById('w5_help_btn');
    const modal = document.getElementById('w5_help_modal');
    btn && modal && btn.addEventListener('click', ()=> modal.classList.add('on'));
  }

  function init(){
    ensureUI();
    // 如果雷達區塊是動態插入（你本來就是），稍微等一下再跑一次
    setTimeout(ensureUI, 200);
  }

  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', init);
  else init();
})();
</script>
<style id="W5_HELP_DRAG_CSS">
  /* 讓標題列成為拖曳把手 */
  #w5_help_modal .hdr{ cursor: move }
  /* 拖動時一點點透明，給回饋 */
  #w5_help_modal .dlg.dragging{ opacity:.98 }
</style>

<script id="W5_HELP_DRAG_JS">
(function(){
  if(window.__W5_HELP_DRAG__) return; window.__W5_HELP_DRAG__=true;
  const modal = document.getElementById('w5_help_modal'); if(!modal) return;
  const dlg   = modal.querySelector('.dlg'); const hdr = modal.querySelector('.hdr'); if(!dlg||!hdr) return;

  const LSKEY='w5_help_pos_v1';
  const clamp=(x,min,max)=>Math.max(min,Math.min(max,x));

  function center(){
    dlg.style.left='50%'; dlg.style.top='50%'; dlg.style.transform='translate(-50%,-50%)';
    localStorage.removeItem(LSKEY);
  }
  function applyPos(left,top){
    dlg.style.left = left+'px';
    dlg.style.top  = top +'px';
    dlg.style.transform = 'none';
  }
  function loadSaved(){
    const s = localStorage.getItem(LSKEY); if(!s) return;
    try{
      const p = JSON.parse(s);
      // 若視窗縮放過，確保還在可視範圍內
      const maxL = window.innerWidth  - dlg.offsetWidth  - 8;
      const maxT = window.innerHeight - dlg.offsetHeight - 8;
      applyPos(clamp(p.left,8,maxL), clamp(p.top,8,maxT));
    }catch(_){}
  }
  function saveNow(){
    const r = dlg.getBoundingClientRect();
    localStorage.setItem(LSKEY, JSON.stringify({left:r.left, top:r.top}));
  }

  // —— 拖曳（滑鼠 + 觸控）——
  let dragging=false, offX=0, offY=0;
  function start(clientX, clientY){
    dragging=true; dlg.classList.add('dragging');
    const r=dlg.getBoundingClientRect();
    offX = clientX - r.left; offY = clientY - r.top;
    document.documentElement.style.userSelect='none';
  }
  function move(clientX, clientY){
    if(!dragging) return;
    const L = clamp(clientX - offX, 8, window.innerWidth  - dlg.offsetWidth  - 8);
    const T = clamp(clientY - offY, 8, window.innerHeight - dlg.offsetHeight - 8);
    applyPos(L,T);
  }
  function end(){
    if(!dragging) return;
    dragging=false; dlg.classList.remove('dragging');
    document.documentElement.style.userSelect='';
    saveNow();
  }

  // 滑鼠
  hdr.addEventListener('mousedown', e=>{ start(e.clientX,e.clientY); e.preventDefault(); });
  window.addEventListener('mousemove', e=> move(e.clientX,e.clientY));
  window.addEventListener('mouseup',   end);

  // 觸控
  hdr.addEventListener('touchstart', e=>{
    const t=e.touches[0]; start(t.clientX,t.clientY); e.preventDefault();
  }, {passive:false});
  window.addEventListener('touchmove', e=>{
    if(!dragging) return;
    const t=e.touches[0]; move(t.clientX,t.clientY); e.preventDefault();
  }, {passive:false});
  window.addEventListener('touchend', end);

  // 雙擊標題列：回到置中
  hdr.addEventListener('dblclick', center);

  // 視窗縮放後，若跑出邊界就拉回來
  window.addEventListener('resize', ()=>{
    const r=dlg.getBoundingClientRect();
    const L = clamp(r.left, 8, window.innerWidth  - dlg.offsetWidth  - 8);
    const T = clamp(r.top,  8, window.innerHeight - dlg.offsetHeight - 8);
    applyPos(L,T);
    saveNow();
  });

  // 每次開啟說明時套用上次位置
  const openBtn = document.getElementById('w5_help_btn');
  if(openBtn){
    openBtn.addEventListener('click', ()=> setTimeout(loadSaved, 0));
  }
  // 若你是用其他方式打開，也保險觀察 class 變化
  if('MutationObserver' in window){
    const mo = new MutationObserver(()=>{ if(modal.classList.contains('on')) loadSaved(); });
    mo.observe(modal, {attributes:true, attributeFilter:['class']});
  }

  // 初次也載入一次位置
  if(modal.classList.contains('on')) loadSaved();
})();
</script>
<style id="W5_HELP_DRAG_PASS_V2_CSS">
  /* 讓整個遮罩不攔截滑鼠事件（背景可點、可拖拉雷達） */
  #w5_help_modal{ pointer-events: none; }
  /* 只有對話框本身可以互動（拖曳、按鈕） */
  #w5_help_modal .dlg{ pointer-events: auto; }
  /* 拖曳游標與拖曳時的微透明效果 */
  #w5_help_modal .hdr{ cursor: move; }
  #w5_help_modal .dlg.dragging{ opacity:.98; }
</style>
<script id="W5_HELP_DRAG_PASS_V2_JS">
(function(){
  if(window.__W5_HELP_DRAG_PASS_V2__) return; window.__W5_HELP_DRAG_PASS_V2__=true;

  const LSKEY='w5_help_pos_v2';
  const clamp=(x,min,max)=>Math.max(min,Math.min(max,x));

  function bindDrag(modal){
    const dlg = modal.querySelector('.dlg');
    const hdr = modal.querySelector('.hdr');
    if(!dlg || !hdr) return;

    function center(){
      dlg.style.left='50%'; dlg.style.top='50%'; dlg.style.transform='translate(-50%,-50%)';
      try{ localStorage.removeItem(LSKEY); }catch(_){}
    }
    function applyPos(left,top){
      dlg.style.left = left+'px';
      dlg.style.top  = top +'px';
      dlg.style.transform = 'none';
    }
    function loadSaved(){
      try{
        const s=localStorage.getItem(LSKEY); if(!s) return;
        const p=JSON.parse(s);
        const maxL = window.innerWidth  - dlg.offsetWidth  - 8;
        const maxT = window.innerHeight - dlg.offsetHeight - 8;
        applyPos(clamp(p.left,8,maxL), clamp(p.top,8,maxT));
      }catch(_){}
    }
    function saveNow(){
      const r=dlg.getBoundingClientRect();
      try{ localStorage.setItem(LSKEY, JSON.stringify({left:r.left, top:r.top})); }catch(_){}
    }

    // 拖曳（滑鼠 + 觸控）
    let dragging=false, offX=0, offY=0;
    function start(clientX, clientY){
      dragging=true; dlg.classList.add('dragging');
      const r=dlg.getBoundingClientRect();
      offX = clientX - r.left; offY = clientY - r.top;
      document.documentElement.style.userSelect='none';
    }
    function move(clientX, clientY){
      if(!dragging) return;
      const L = clamp(clientX - offX, 8, window.innerWidth  - dlg.offsetWidth  - 8);
      const T = clamp(clientY - offY, 8, window.innerHeight - dlg.offsetHeight - 8);
      applyPos(L,T);
    }
    function end(){
      if(!dragging) return;
      dragging=false; dlg.classList.remove('dragging');
      document.documentElement.style.userSelect='';
      saveNow();
    }

    // 事件註冊
    hdr.addEventListener('mousedown', e=>{ start(e.clientX,e.clientY); e.preventDefault(); });
    window.addEventListener('mousemove', e=> move(e.clientX,e.clientY));
    window.addEventListener('mouseup',   end);

    hdr.addEventListener('touchstart', e=>{
      const t=e.touches[0]; start(t.clientX,t.clientY); e.preventDefault();
    }, {passive:false});
    window.addEventListener('touchmove', e=>{
      if(!dragging) return;
      const t=e.touches[0]; move(t.clientX,t.clientY); e.preventDefault();
    }, {passive:false});
    window.addEventListener('touchend', end);

    // 雙擊標題列回到置中
    hdr.addEventListener('dblclick', center);

    // 每次視窗打開時套用上次位置
    const applyWhenOpen = ()=>{
      if(modal.classList.contains('on')) loadSaved();
    };
    if('MutationObserver' in window){
      const mo = new MutationObserver(applyWhenOpen);
      mo.observe(modal, {attributes:true, attributeFilter:['class']});
    }
    // 若當下就是開啟狀態，也套一次
    applyWhenOpen();

    // 視窗縮放時，若視窗超出邊界就拉回
    window.addEventListener('resize', ()=>{
      const r=dlg.getBoundingClientRect();
      const L = clamp(r.left, 8, window.innerWidth  - dlg.offsetWidth  - 8);
      const T = clamp(r.top,  8, window.innerHeight - dlg.offsetHeight - 8);
      applyPos(L,T);
      saveNow();
    });
  }

  // 等 #w5_help_modal 建好再綁定（避免早於說明外掛執行而失效）
  function waitForModalAndBind(){
    const modal = document.getElementById('w5_help_modal');
    if(modal){ bindDrag(modal); return; }
    // 監看 body，有建立就綁
    if('MutationObserver' in window){
      const mo = new MutationObserver(()=>{
        const m = document.getElementById('w5_help_modal');
        if(m){ mo.disconnect(); bindDrag(m); }
      });
      mo.observe(document.body, {childList:true, subtree:true});
    } else {
      // 後備輪詢
      const t=setInterval(()=>{
        const m=document.getElementById('w5_help_modal');
        if(m){ clearInterval(t); bindDrag(m); }
      }, 200);
      setTimeout(()=>clearInterval(t), 6000);
    }
  }

  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', waitForModalAndBind);
  else waitForModalAndBind();
})();
</script>
<script id="W5_AUTO_FROM_GUA_JS">
(function(){
  if(window.__W5_AUTO_FROM_GUA__) return; window.__W5_AUTO_FROM_GUA__=true;
  const id=s=>document.getElementById(s);

  /* —— 權重（可依喜好微調）—— */
  const WEI = {
    lineBase: 1.0,   // 每一爻的納甲本支
    moveChange: 0.7, // 動爻→變卦對應支
    shi: 0.5,        // 世爻加權
    ying: 0.25,      // 應爻加權
    palace: 0.5,     // 卦宮五行（本卦屬性）
    month: 1.4,      // 月令（旺相）
    day: 0.8         // 日令（次要）
  };
  const ORDER=['木','火','土','金','水'];

  const isZhi = c => (window.ZHI_ELEM && window.ZHI_ELEM[c]);
  const elemOfBranch = b => (window.ZHI_ELEM && window.ZHI_ELEM[b]) || '';
  const add = (m,k,v)=>{ if(!k) return; m[k]=(m[k]||0)+v; };
  const to100 = m=>{
    let s=ORDER.reduce((a,k)=>a+(m[k]||0),0); if(s<=0) s=1;
    const o={}; ORDER.forEach(k=>o[k]=(m[k]||0)*100/s); return o;
  };
  const to10 = v100 => Math.max(1,Math.min(10,Math.round(v100/10)));
  const setSlider = (sid,val)=>{ const el=id(sid); if(!el) return; el.value=String(val);
    el.dispatchEvent(new Event('input',{bubbles:true})); el.dispatchEvent(new Event('change',{bubbles:true})); };
  const toast = msg => { const box=id('err'); if(!box){ alert(msg); return; }
    box.style.display='block'; box.textContent='✔ '+msg; setTimeout(()=>{ box.style.display='none'; },1200); };

  function estimateFromHex(){
    try{
      const up=id('upper')?.value, lo=id('lower')?.value;
      if(!(window.TRIG && window.naJiaBranches && up && lo)) return toast('缺少卦象資料');
      const baseLines=[...TRIG[lo], ...TRIG[up]];
      const branches = window.naJiaBranches(baseLines);
      const counts   = {木:0,火:0,土:0,金:0,水:0};

      // 1) 本卦六爻的納甲地支 → 五行
      branches.forEach(br=> add(counts, elemOfBranch(br), WEI.lineBase));

      // 2) 動爻：變卦對應的地支
      const mv = Array.isArray(window.moving)? window.moving : [false,false,false,false,false,false];
      if(mv.some(Boolean) && window.changedLines){
        const chLines   = window.changedLines(baseLines, mv);
        const branchesC = window.naJiaBranches(chLines);
        branchesC.forEach((br,i)=>{ if(mv[i]) add(counts, elemOfBranch(br), WEI.moveChange); });
      }

      // 3) 世/應加權
      if(window.decideShiYing){
        const gName = window.guaNameOf? window.guaNameOf(up,lo) : '';
        const {shi, ying} = window.decideShiYing(up, lo, gName, baseLines) || {};
        if(shi){ add(counts, elemOfBranch(branches[shi-1]), WEI.shi); }
        if(ying){ add(counts, elemOfBranch(branches[ying-1]), WEI.ying); }
      }

      // 4) 卦宮五行（你的主程式在 render() 會寫到 __lastMeElem）
      if(window.__lastMeElem) add(counts, window.__lastMeElem, WEI.palace);

      // 5) 月令/日令（從畫面四柱讀出支）
      const mTxt = id('gzMonth')?.textContent||''; // 例：月：乙酉
      const dTxt = id('gzDay')?.textContent||'';   // 例：日：庚子
      const mZhi = mTxt.replace(/.*月：/,'').trim().charAt(1);
      const dZhi = dTxt.replace(/.*日：/,'').trim().charAt(1);
      if(isZhi(mZhi)) add(counts, elemOfBranch(mZhi), WEI.month);
      if(isZhi(dZhi)) add(counts, elemOfBranch(dZhi), WEI.day);

      // 6) 正規化 → 設定滑桿（1~10）
      const p100 = to100(counts);
      setSlider('w5_mu',   to10(p100['木']));
      setSlider('w5_huo',  to10(p100['火']));
      setSlider('w5_tu',   to10(p100['土']));
      setSlider('w5_jin',  to10(p100['金']));
      setSlider('w5_shui', to10(p100['水']));

      // 7) 重繪/更新建議
      try{ window.updateTCMAdvice && window.updateTCMAdvice(window.__lastMeElem||'土'); }catch(_){}
      try{ window.w5_draw && window.w5_draw(); }catch(_){}
      toast('已依卦象估算五行（納甲/動變/世應/月日/卦宮）');
    }catch(e){ console.error(e); toast('估算失敗：'+(e.message||e)); }
  }

  // 在「五行雷達圖」的控制區加一顆按鈕
  function injectButton(){
    const ctrl=id('w5_ctrl'); if(!ctrl) return;
    if(id('w5_auto_from_gua')) return;
    const row=document.createElement('div'); row.className='row';
    row.innerHTML='<button id="w5_auto_from_gua" title="根據卦象估算五行強弱並正規化為100分"></button>';
    ctrl.insertBefore(row, ctrl.firstChild?.nextSibling || ctrl.firstChild);
    id('w5_auto_from_gua').addEventListener('click', estimateFromHex);
  }

  function init(){ injectButton(); }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', init); else init();
})();
</script>
<style id="W5_AUTO_FROM_GUA_BTN_CSS">
  /* 內嵌在雷達控制列的按鈕樣式 */
  #w5_auto_from_gua{height:30px;border:1px solid #cbd5e1;border-radius:8px;background:#fff;padding:0 10px;cursor:pointer;font-size:13px}
  #w5_auto_from_gua:hover{box-shadow:0 1px 6px rgba(0,0,0,.08)}
  /* 右下角浮動備援按鈕（找不到容器時出現） */
  #w5_auto_float{position:fixed;right:14px;bottom:14px;z-index:10020;height:38px;padding:0 14px;border:1px solid #cbd5e1;border-radius:999px;background:#fff;
    box-shadow:0 8px 24px rgba(0,0,0,.12);font-size:13px;display:none}
  #w5_auto_float:hover{box-shadow:0 10px 28px rgba(0,0,0,.16)}
  @media print{#w5_auto_float{display:none!important}}
</style>

<script id="W5_AUTO_FROM_GUA_JS_V2">
(function(){
  if(window.__W5_AUTO_FROM_GUA_V2__) return; window.__W5_AUTO_FROM_GUA_V2__=true;
  const id=s=>document.getElementById(s);

  /* —— 權重（可依喜好微調）—— */
  const WEI = { lineBase:1.0, moveChange:0.7, shi:0.5, ying:0.25, palace:0.5, month:1.4, day:0.8 };
  const ORDER=['木','火','土','金','水'];

  const isZhi = c => (window.ZHI_ELEM && window.ZHI_ELEM[c]);
  const elemOfBranch = b => (window.ZHI_ELEM && window.ZHI_ELEM[b]) || '';
  const add = (m,k,v)=>{ if(!k) return; m[k]=(m[k]||0)+v; };
  const to100 = m=>{ let s=ORDER.reduce((a,k)=>a+(m[k]||0),0)||1; const o={}; ORDER.forEach(k=>o[k]=(m[k]||0)*100/s); return o; };
  const to10 = v100 => Math.max(1,Math.min(10,Math.round(v100/10)));
  const setSlider = (sid,val)=>{ const el=id(sid); if(!el) return; el.value=String(val);
    el.dispatchEvent(new Event('input',{bubbles:true})); el.dispatchEvent(new Event('change',{bubbles:true})); };
  const toast = msg => { const box=id('err'); if(!box){ try{ alert(msg);}catch(_){ } return; }
    box.style.display='block'; box.textContent='✔ '+msg; setTimeout(()=>{ box.style.display='none'; },1200); };

  function estimateFromHex(){
    try{
      const up=id('upper')?.value, lo=id('lower')?.value;
      if(!(window.TRIG && window.naJiaBranches && up && lo)) return toast('缺少卦象資料');
      const baseLines=[...TRIG[lo], ...TRIG[up]];
      const branches = window.naJiaBranches(baseLines);
      const counts   = {木:0,火:0,土:0,金:0,水:0};

      // 1) 本卦六爻納甲
      branches.forEach(br=> add(counts, elemOfBranch(br), WEI.lineBase));

      // 2) 動爻 → 變卦支
      const mv = Array.isArray(window.moving)? window.moving : [false,false,false,false,false,false];
      if(mv.some(Boolean) && window.changedLines){
        const chLines   = window.changedLines(baseLines, mv);
        const branchesC = window.naJiaBranches(chLines);
        branchesC.forEach((br,i)=>{ if(mv[i]) add(counts, elemOfBranch(br), WEI.moveChange); });
      }

      // 3) 世/應加權
      if(window.decideShiYing){
        const gName = window.guaNameOf? window.guaNameOf(up,lo) : '';
        const r = window.decideShiYing(up, lo, gName, baseLines) || {};
        if(r.shi){ add(counts, elemOfBranch(branches[r.shi-1]), WEI.shi); }
        if(r.ying){ add(counts, elemOfBranch(branches[r.ying-1]), WEI.ying); }
      }

      // 4) 卦宮五行
      if(window.__lastMeElem) add(counts, window.__lastMeElem, WEI.palace);

      // 5) 月令/日令
      const mTxt = id('gzMonth')?.textContent||''; // e.g. "月：乙酉"
      const dTxt = id('gzDay')?.textContent||'';   // e.g. "日：庚子"
      const mZhi = mTxt.replace(/.*月：/,'').trim().charAt(1);
      const dZhi = dTxt.replace(/.*日：/,'').trim().charAt(1);
      if(isZhi(mZhi)) add(counts, elemOfBranch(mZhi), WEI.month);
      if(isZhi(dZhi)) add(counts, elemOfBranch(dZhi), WEI.day);

      // 6) 正規化→設滑桿→重繪
      const p100 = to100(counts);
      setSlider('w5_mu',   to10(p100['木']));
      setSlider('w5_huo',  to10(p100['火']));
      setSlider('w5_tu',   to10(p100['土']));
      setSlider('w5_jin',  to10(p100['金']));
      setSlider('w5_shui', to10(p100['水']));

      try{ window.updateTCMAdvice && window.updateTCMAdvice(window.__lastMeElem||'土'); }catch(_){}
      try{ window.w5_draw && window.w5_draw(); }catch(_){}
      toast('已依卦象估算五行（納甲/動變/世應/月日/卦宮）');
    }catch(e){ console.error(e); toast('估算失敗：'+(e.message||e)); }
  }

  // —— UI 注入：優先插到 #w5_ctrl，其次顯示右下角浮動備援鈕 —— //
  function ensureInlineBtn(){
    const ctrl=id('w5_ctrl'); if(!ctrl) return false;
    if(id('w5_auto_from_gua')) return true;
    const row=document.createElement('div'); row.className='row';
    row.innerHTML='<button id="w5_auto_from_gua" title="根據卦象估算五行強弱並正規化為100分">依卦一鍵估算</button>';
    // 插在大小滑桿上方一點點：放在第一個 row 後面
    const firstRow = ctrl.querySelector('.row') || ctrl.firstChild;
    ctrl.insertBefore(row, firstRow ? firstRow.nextSibling : ctrl.firstChild);
    id('w5_auto_from_gua').addEventListener('click', estimateFromHex);
    return true;
  }

  function ensureFloatBtn(){
    if(id('w5_auto_float')) return;
    const b=document.createElement('button');
    b.id='w5_auto_float'; b.textContent='依卦一鍵估算';
    b.addEventListener('click', estimateFromHex);
    document.body.appendChild(b);
    // 只有當 #w5_ctrl 目前不存在時顯示
    if(!id('w5_ctrl')) b.style.display='block';
  }

  function syncFloatVisibility(){
    const f=id('w5_auto_float'); if(!f) return;
    f.style.display = id('w5_ctrl') && id('w5_auto_from_gua') ? 'none' : 'block';
  }

  function boot(){
    const ok = ensureInlineBtn();
    ensureFloatBtn();
    syncFloatVisibility();

    // 觀察 DOM：等 W5_SAFE_JS 把 #w5_ctrl 插進來時再補插按鈕
    if('MutationObserver' in window){
      const mo = new MutationObserver(()=>{ 
        const ready = ensureInlineBtn();
        syncFloatVisibility();
        if(ready){ /* 一旦插成功就可以維持觀察以防重繪，但也可選擇 disconnect */ }
      });
      mo.observe(document.body, {childList:true, subtree:true});
    } else {
      // 保底輪詢 6 秒
      let n=0; const t=setInterval(()=>{ ensureInlineBtn(); syncFloatVisibility(); if(++n>30) clearInterval(t); }, 200);
    }
  }

  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', boot);
  else boot();
})();
</script>
<style id="W5_AUTO_FROM_GUA_BTN_CSS_V3">
  #w5_auto_from_gua{height:30px;border:1px solid #cbd5e1;border-radius:8px;background:#fff;padding:0 10px;cursor:pointer;font-size:13px}
  #w5_auto_from_gua:hover{box-shadow:0 1px 6px rgba(0,0,0,.08)}
  #w5_auto_float{position:fixed;right:14px;bottom:14px;z-index:10020;height:38px;padding:0 14px;border:1px solid #cbd5e1;border-radius:999px;background:#fff;
    box-shadow:0 8px 24px rgba(0,0,0,.12);font-size:13px;display:none}
  #w5_auto_float:hover{box-shadow:0 10px 28px rgba(0,0,0,.16)}
  @media print{#w5_auto_float{display:none!important}}
</style>

<script id="W5_AUTO_FROM_GUA_JS_V3">
(function(){
  if(window.__W5_AUTO_FROM_GUA_V3__) return; window.__W5_AUTO_FROM_GUA_V3__=true;
  const $=id=>document.getElementById(id);

  /* ===== 內建資料表（不依賴主程式） ===== */
  const TRIG_BITS={乾:[1,1,1],兌:[1,1,0],離:[1,0,1],震:[1,0,0],巽:[0,1,1],坎:[0,1,0],艮:[0,0,1],坤:[0,0,0]};
  const YANG_TRIG=new Set(['乾','震','坎','艮']);
  const SEQ_YANG=['子','寅','辰','午','申','戌'], SEQ_YIN=['亥','酉','未','巳','卯','丑'];
  const INNER_START={乾:'子',坎:'寅',震:'子',艮:'辰',坤:'未',巽:'丑',離:'卯',兌:'巳'};
  const OUTER_START={乾:'午',坎:'申',震:'午',艮:'戌',坤:'丑',巽:'未',離:'酉',兌:'亥'};
  const ZHI_ELEM={子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'};
  const GONG_ELEM={乾:'金',坤:'土',震:'木',巽:'木',坎:'水',離:'火',艮:'土',兌:'金'};
  const NAMES={'乾':{'乾':'乾為天','兌':'天澤履','離':'天火同人','震':'天雷無妄','巽':'天風姤','坎':'天水訟','艮':'天山遁','坤':'天地否'},
               '兌':{'乾':'澤天夬','兌':'兌為澤','離':'澤火革','震':'澤雷隨','巽':'澤風大過','坎':'澤水困','艮':'澤山咸','坤':'澤地萃'},
               '離':{'乾':'火天大有','兌':'火澤睽','離':'離為火','震':'火雷噬嗑','巽':'火風鼎','坎':'火水未濟','艮':'火山旅','坤':'火地晉'},
               '震':{'乾':'雷天大壯','兌':'雷澤歸妹','離':'雷火豐','震':'震為雷','巽':'雷風恆','坎':'雷水解','艮':'雷山小過','坤':'雷地豫'},
               '巽':{'乾':'風天小畜','兌':'風澤中孚','離':'風火家人','震':'風雷益','巽':'巽為風','坎':'風水渙','艮':'風山漸','坤':'風地觀'},
               '坎':{'乾':'水天需','兌':'水澤節','離':'水火既濟','震':'水雷屯','巽':'水風井','坎':'坎為水','艮':'水山蹇','坤':'水地比'},
               '艮':{'乾':'山天大畜','兌':'山澤損','離':'山火賁','震':'山雷頤','巽':'山風蠱','坎':'山水蒙','艮':'艮為山','坤':'山地謙'},
               '坤':{'乾':'地天泰','兌':'地澤臨','離':'地火明夷','震':'地雷復','巽':'地風升','坎':'地水師','艮':'地山謙','坤':'坤為地'}};
  const GUA_CLASS={
    "乾為天":{gong:"乾",type:"本宮"},"天風姤":{gong:"乾",type:"飛"},"天山遯":{gong:"乾",type:"飛"},"天地否":{gong:"乾",type:"飛"},
    "風地觀":{gong:"乾",type:"飛"},"山地剝":{gong:"乾",type:"飛"},"火地晉":{gong:"乾",type:"遊魂"},"火天大有":{gong:"乾",type:"歸魂"},
    "坤為地":{gong:"坤",type:"本宮"},"地雷復":{gong:"坤",type:"飛"},"地澤臨":{gong:"坤",type:"飛"},"地天泰":{gong:"坤",type:"飛"},
    "雷天大壯":{gong:"坤",type:"飛"},"澤天夬":{gong:"坤",type:"飛"},"水天需":{gong:"坤",type:"遊魂"},"水地比":{gong:"坤",type:"歸魂"},
    "震為雷":{gong:"震",type:"本宮"},"雷地豫":{gong:"震",type:"飛"},"雷水解":{gong:"震",type:"飛"},"雷風恆":{gong:"震",type:"飛"},
    "地風升":{gong:"震",type:"飛"},"水風井":{gong:"震",type:"飛"},"澤風大過":{gong:"震",type:"遊魂"},"澤雷隨":{gong:"震",type:"歸魂"},
    "巽為風":{gong:"巽",type:"本宮"},"風天小畜":{gong:"巽",type:"飛"},"風火家人":{gong:"巽",type:"飛"},"風雷益":{gong:"巽",type:"飛"},
    "天雷無妄":{gong:"巽",type:"飛"},"火雷噬嗑":{gong:"巽",type:"飛"},"山雷頤":{gong:"巽",type:"遊魂"},"山風蠱":{gong:"巽",type:"歸魂"},
    "坎為水":{gong:"坎",type:"本宮"},"水澤節":{gong:"坎",type:"飛"},"水雷屯":{gong:"坎",type:"飛"},"水火既濟":{gong:"坎",type:"飛"},
    "澤火革":{gong:"坎",type:"飛"},"雷火豐":{gong:"坎",type:"飛"},"地火明夷":{gong:"坎",type:"遊魂"},"地水師":{gong:"坎",type:"歸魂"},
    "離為火":{gong:"離",type:"本宮"},"火山旅":{gong:"離",type:"飛"},"火風鼎":{gong:"離",type:"飛"},"火水未濟":{gong:"離",type:"飛"},
    "山水蒙":{gong:"離",type:"飛"},"風水渙":{gong:"離",type:"飛"},"天水訟":{gong:"離",type:"遊魂"},"天火同人":{gong:"離",type:"歸魂"},
    "艮為山":{gong:"艮",type:"本宮"},"山火賁":{gong:"艮",type:"飛"},"山天大畜":{gong:"艮",type:"飛"},"山澤損":{gong:"艮",type:"飛"},
    "火澤睽":{gong:"艮",type:"飛"},"天澤履":{gong:"艮",type:"飛"},"風澤中孚":{gong:"艮",type:"遊魂"},"風山漸":{gong:"艮",type:"歸魂"},
    "兌為澤":{gong:"兌",type:"本宮"},"澤水困":{gong:"兌",type:"飛"},"澤地萃":{gong:"兌",type:"飛"},"澤山咸":{gong:"兌",type:"飛"},
    "水山蹇":{gong:"兌",type:"飛"},"地山謙":{gong:"兌",type:"飛"},"雷山小過":{gong:"兌",type:"遊魂"},"雷澤歸妹":{gong:"兌",type:"歸魂"}
  };

  /* ===== 小工具 ===== */
  const add=(m,k,v)=>{ if(!k) return; m[k]=(m[k]||0)+v; };
  const to100=m=>{ const K=['木','火','土','金','水']; let s=K.reduce((a,k)=>a+(m[k]||0),0)||1; const o={}; K.forEach(k=>o[k]=(m[k]||0)*100/s); return o; };
  const to10 = v100 => Math.max(1,Math.min(10,Math.round(v100/10)));
  const setSlider=(sid,val)=>{ const el=$(sid); if(!el) return; el.value=String(val);
    el.dispatchEvent(new Event('input',{bubbles:true})); el.dispatchEvent(new Event('change',{bubbles:true})); };
  const toast=msg=>{ const box=$('err'); if(!box){ alert(msg); return; } box.style.display='block'; box.textContent='✔ '+msg; setTimeout(()=>{ box.style.display='none'; },1200); };

  function threeBranchesOfTrigram(tri,inner){
    const start = inner? INNER_START[tri] : OUTER_START[tri];
    const seq = YANG_TRIG.has(tri) ? SEQ_YANG : SEQ_YIN;
    const i0 = seq.indexOf(start);
    return [seq[i0%6], seq[(i0+1)%6], seq[(i0+2)%6]];
  }
  function naJiaBranches(lines){
    const lo=trigFromBits([lines[0],lines[1],lines[2]]), up=trigFromBits([lines[3],lines[4],lines[5]]);
    return [...threeBranchesOfTrigram(lo,true), ...threeBranchesOfTrigram(up,false)];
  }
  function trigFromBits(b3){
    for(const k in TRIG_BITS){ const t=TRIG_BITS[k]; if(t[0]===b3[0]&&t[1]===b3[1]&&t[2]===b3[2]) return k; } return null;
  }
  function changedLines(lines,mv){ return lines.map((v,i)=> mv[i] ? (v?0:1) : v); }
  function guaNameOf(up,lo){ return (NAMES[up]&&NAMES[up][lo])?NAMES[up][lo] : `${up}上·${lo}下`; }
  function findShiByYaoBian(lines){
    const eqTri = arr => { const lo=trigFromBits([arr[0],arr[1],arr[2]]), up=trigFromBits([arr[3],arr[4],arr[5]]); return (up===lo)?up:null; };
    const flipAt=(arr,i)=>{const t=[...arr]; t[i]=t[i]?0:1; return t;};
    let tmp=[...lines];
    for(let i=0;i<5;i++){ tmp=flipAt(tmp,i); if(eqTri(tmp)) return i+1; }
    tmp=[...lines];
    for(let i=4;i>=0;i--){ tmp=flipAt(tmp,i); if(eqTri(tmp)) return (i===0?3:i+1); }
    return 6;
  }
  function decideShiYing(upTri, loTri, guaName, lines){
    const info=GUA_CLASS[guaName];
    if(!info || info.type==='飛'){
      const shi=findShiByYaoBian(lines);
      const ying=((shi+3-1)%6)+1; // 1↔4,2↔5,3↔6
      return {shi,ying,gong:(info&&info.gong)||upTri};
    }
    if(info.type==='本宮') return {shi:6,ying:3,gong:info.gong};
    if(info.type==='遊魂') return {shi:4,ying:1,gong:info.gong};
    if(info.type==='歸魂') return {shi:3,ying:6,gong:info.gong};
    const shi=findShiByYaoBian(lines); const ying=((shi+3-1)%6)+1;
    return {shi,ying,gong:info.gong};
  }

  /* —— 權重（可微調）—— */
  const WEI = { lineBase:1.0, moveChange:0.7, shi:0.5, ying:0.25, palace:0.5, month:1.4, day:0.8 };

  function estimateFromHex(){
    try{
      const up=$('upper')?.value, lo=$('lower')?.value;
      if(!up||!lo) return toast('缺少卦象：請先選上卦/下卦');
      const baseLines=[...TRIG_BITS[lo], ...TRIG_BITS[up]];
      const branches = naJiaBranches(baseLines);
      const counts   = {木:0,火:0,土:0,金:0,水:0};

      // 1) 本卦六爻納甲
      branches.forEach(br=> add(counts, ZHI_ELEM[br], WEI.lineBase));

      // 2) 動爻 → 變卦支（從勾選框讀）
      const mv=[];
      document.querySelectorAll('#mvCtl input[type=checkbox][data-mv]').forEach((cb,i)=> mv[i]=!!cb.checked);
      if(mv.some(Boolean)){
        const branchesC = naJiaBranches(changedLines(baseLines, mv));
        branchesC.forEach((br,i)=>{ if(mv[i]) add(counts, ZHI_ELEM[br], WEI.moveChange); });
      }

      // 3) 世/應 & 卦宮
      const gName = guaNameOf(up,lo);
      const {shi,ying,gong} = decideShiYing(up,lo,gName,baseLines);
      if(shi)  add(counts, ZHI_ELEM[branches[shi-1]],  WEI.shi);
      if(ying) add(counts, ZHI_ELEM[branches[ying-1]], WEI.ying);
      if(gong) add(counts, GONG_ELEM[gong], WEI.palace);

      // 4) 月令/日令：優先用 Lunar.js，退而取介面四柱文字
      let mZhi='', dZhi='';
      try{
        const dtStr=$('dt')?.value; const dt=dtStr? new Date(dtStr) : new Date();
        if(window.Lunar){
          const lunar=window.Lunar.fromDate(dt);
          const M=lunar.getMonthInGanZhiExact(), D=lunar.getDayInGanZhiExact();
          mZhi = M && M.charAt(1); dZhi = D && D.charAt(1);
        }
      }catch(_){}
      if(!mZhi||!dZhi){
        const mTxt=$('gzMonth')?.textContent||'', dTxt=$('gzDay')?.textContent||'';
        mZhi = mZhi || (mTxt.replace(/.*月：/,'').trim().charAt(1)||'');
        dZhi = dZhi || (dTxt.replace(/.*日：/,'').trim().charAt(1)||'');
      }
      if(ZHI_ELEM[mZhi]) add(counts, ZHI_ELEM[mZhi], WEI.month);
      if(ZHI_ELEM[dZhi]) add(counts, ZHI_ELEM[dZhi], WEI.day);

      // 5) 正規化→調滑桿→重繪
      const p100=to100(counts);
      setSlider('w5_mu',   to10(p100['木']));
      setSlider('w5_huo',  to10(p100['火']));
      setSlider('w5_tu',   to10(p100['土']));
      setSlider('w5_jin',  to10(p100['金']));
      setSlider('w5_shui', to10(p100['水']));

      try{ window.updateTCMAdvice && window.updateTCMAdvice(GONG_ELEM[gong]||'土'); }catch(_){}
      try{ window.w5_draw && window.w5_draw(); }catch(_){}
      toast('已依卦象估算五行（納甲/動變/世應/月日/卦宮）');
    }catch(e){
      console.error(e);
      const box=$('err'); if(box){ box.style.display='block'; box.textContent='⚠️ 估算錯誤：'+(e.message||e); }
      else alert('估算錯誤：'+(e.message||e));
    }
  }

  /* —— UI：插按鈕（內嵌＋浮動備援） —— */
  function ensureInlineBtn(){
    const ctrl=$('w5_ctrl'); if(!ctrl) return false;
    if($('w5_auto_from_gua')) return true;
    const row=document.createElement('div'); row.className='row';
    row.innerHTML='<button id="w5_auto_from_gua" title="根據卦象估算五行強弱並正規化為100分">依卦一鍵估算</button>';
    const firstRow = ctrl.querySelector('.row') || ctrl.firstChild;
    ctrl.insertBefore(row, firstRow ? firstRow.nextSibling : ctrl.firstChild);
    $('w5_auto_from_gua').addEventListener('click', estimateFromHex);
    return true;
  }
  function ensureFloatBtn(){
    if($('w5_auto_float')) return;
    const b=document.createElement('button');
    b.id='w5_auto_float'; b.textContent='依卦一鍵估算';
    b.addEventListener('click', estimateFromHex);
    document.body.appendChild(b);
    if(!$('w5_ctrl')) b.style.display='block';
  }
  function syncFloatVisibility(){
    const f=$('w5_auto_float'); if(!f) return;
    f.style.display = ($('w5_ctrl') && $('w5_auto_from_gua')) ? 'none' : 'block';
  }

  function boot(){
    const ok=ensureInlineBtn();
    ensureFloatBtn();
    syncFloatVisibility();
    if('MutationObserver' in window){
      const mo=new MutationObserver(()=>{ const ready=ensureInlineBtn(); syncFloatVisibility(); if(ready){ /* 保持監看亦可 */ } });
      mo.observe(document.body,{childList:true,subtree:true});
    } else {
      let n=0; const t=setInterval(()=>{ ensureInlineBtn(); syncFloatVisibility(); if(++n>30) clearInterval(t); },200);
    }
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', boot); else boot();
})();
</script>
<style id="FIX_PACK_V1_CSS">
/* 一鍵估算／說明 按鈕區塊更好看 */
#w5_ctrl .row.fixpack{justify-content:flex-start; gap:8px}
#w5_ctrl .row.fixpack button{height:30px;border:1px solid #cbd5e1;border-radius:8px;background:#fff;padding:0 10px;cursor:pointer;font-size:13px}
#w5_ctrl .row.fixpack button:hover{box-shadow:0 1px 6px rgba(0,0,0,.08)}

/* 浮動說明面板：可拖曳，預設不擋整個雷達 */
#w5_help{position:fixed;right:16px;bottom:16px;width:280px;max-width:78vw;z-index:10010;
  background:#ffffffeb;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.12);display:none}
#w5_help header{cursor:move;padding:8px 10px;border-bottom:1px solid #eef2f7;color:#0f172a;font-weight:600;font-size:13px}
#w5_help .body{padding:10px;font-size:13px;line-height:1.6;color:#334155}
#w5_help .body ul{margin:6px 0 0 18px}
#w5_help .close{position:absolute;top:6px;right:8px;border:none;background:transparent;cursor:pointer;font-size:16px;color:#64748b}
#w5_help .hint{font-size:12px;color:#64748b;margin-top:6px}
</style>
<script id="FIX_PACK_V1_JS">
(function(){
  if (window.__FIX_PACK_V1__) return; window.__FIX_PACK_V1__=true;

  // —— 0) 去掉重複 ID 的 style/script（避免偶發卡頓/衝突）——
  (function dedupeIds(){
    var seen=new Set();
    document.querySelectorAll('style[id],script[id]').forEach(function(n){
      var id=n.id;
      if(!id) return;
      if(seen.has(id)){
        // 只針對已知重複最常見的補丁 ID 做移除；其他保守忽略
        if(id==='PRINT_TIGHT_PLUS') n.remove();
      } else { seen.add(id); }
    });
  })();

  // —— 1) 追加：一鍵估算 & 說明 —— 
  function ensureButtons(){
    var ctrl=document.getElementById('w5_ctrl'); if(!ctrl) return;
    if(!document.getElementById('w5_auto') || !document.getElementById('w5_help_btn')){
      var row=document.createElement('div'); row.className='row fixpack';
      row.innerHTML='<button id="w5_auto">一鍵估算（依卦）</button><button id="w5_help_btn">說明</button>';
      ctrl.insertBefore(row, ctrl.firstChild||null);
    }
  }
  ensureButtons();

  // 浮動說明面板（可拖曳）
  (function ensureHelp(){
    if(document.getElementById('w5_help')) return;
    var box=document.createElement('div'); box.id='w5_help';
    box.innerHTML = '<header>五行雷達說明<button class="close" title="關閉">×</button></header>\
    <div class="body">\
      <div>方位：<b>上＝火、左＝木</b>（順時針：火→土→金→水→木）</div>\
      <div>虛線圈＝<b>6/10</b>：建議均衡參考線。</div>\
      <ul>\
        <li>「一鍵估算」：依卦宮（世）、上下卦、動爻、月/日支，推估木火土金水。</li>\
        <li>可拖曳本視窗；開著也能操作雷達（別把它拖到雷達上即可）。</li>\
      </ul>\
      <div class="hint">※ 本系統僅供學習參考，不作醫療診斷。</div>\
    </div>';
    document.body.appendChild(box);

    // 開關
    var btn=document.getElementById('w5_help_btn');
    if(btn) btn.addEventListener('click', function(){
      box.style.display = (box.style.display==='none'||!box.style.display)?'block':'none';
    });
    box.querySelector('.close').addEventListener('click', function(){ box.style.display='none'; });

    // 拖曳
    (function drag(ele, handle){
      var dx=0, dy=0, dragging=false, sx=0, sy=0;
      handle.addEventListener('mousedown', function(e){ dragging=true; sx=e.clientX; sy=e.clientY; var r=ele.getBoundingClientRect(); dx=sx-r.left; dy=sy-r.top; e.preventDefault(); });
      window.addEventListener('mousemove', function(e){ if(!dragging) return;
        var x=e.clientX-dx, y=e.clientY-dy;
        // 邊界保護
        x=Math.max(6, Math.min(window.innerWidth - ele.offsetWidth - 6, x));
        y=Math.max(6, Math.min(window.innerHeight- ele.offsetHeight- 6, y));
        ele.style.left=x+'px'; ele.style.top=y+'px'; ele.style.right='auto'; ele.style.bottom='auto';
      });
      window.addEventListener('mouseup', function(){ dragging=false; });
    })(box, box.querySelector('header'));
  })();

  // —— 2) 改寫雷達畫法：上＝火、左＝木；加 6/10 虛線 —— 
  function byId(id){return document.getElementById(id)}
  function valNum(id, d){ var el=byId(id); var v=+(el&&el.value); return isFinite(v)?v:d; }
  function sizeScale(){ var f=parseFloat(byId('w5_size')?.value||1.3); return Math.max(0.8,Math.min(1.8,f)); }
  function values(){ return {火:valNum('w5_huo',6),土:valNum('w5_tu',6),金:valNum('w5_jin',6),水:valNum('w5_shui',6),木:valNum('w5_mu',6)}; }
  function setMini(id){ var el=byId(id+'Val'); var v=byId(id)?.value; if(el&&v!=null) el.textContent=String(v); }

  // 新版：順時針 ['火','土','金','水','木']；ang0=-90° 讓火在上
  var ORDER=['火','土','金','水','木'];
  window.w5_draw = function(){
    var c=byId('w5_canv'); if(!c) return;
    var dpr=window.devicePixelRatio||1, W=c.clientWidth||600, H=c.clientHeight||300;
    c.width=Math.floor(W*dpr); c.height=Math.floor(H*dpr);
    var ctx=c.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0); ctx.clearRect(0,0,W,H);

    var cx=W/2, cy=H/2+6, sc=sizeScale(), R=Math.min(W,H*0.9)/2*0.78*sc, rings=5, ang0=-Math.PI/2;
    // 背景多邊形
    ctx.lineWidth=1; ctx.strokeStyle='#e5e7eb';
    for(var r=1;r<=rings;r++){
      var rr=R*r/rings; ctx.beginPath();
      for(var i=0;i<ORDER.length;i++){ var a=ang0+i*(2*Math.PI/ORDER.length), x=cx+rr*Math.cos(a), y=cy+rr*Math.sin(a); i?ctx.lineTo(x,y):ctx.moveTo(x,y); }
      ctx.closePath(); ctx.stroke();
    }
    // 軸線與標籤
    ctx.font='12px "Noto Sans TC","Microsoft JhengHei"'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillStyle='#0f172a'; ctx.strokeStyle='#cbd5e1';
    for(var j=0;j<ORDER.length;j++){
      var a=ang0+j*(2*Math.PI/ORDER.length), x=cx+R*Math.cos(a), y=cy+R*Math.sin(a);
      ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(x,y); ctx.stroke();
      ctx.fillText(ORDER[j], x, y-12);
    }
    // 6/10 參考虛線圈
    ctx.setLineDash([5,5]); ctx.lineWidth=1.2; ctx.strokeStyle='#94a3b8';
    ctx.beginPath();
    var r6=R*0.6;
    for(var k=0;k<ORDER.length;k++){ var a2=ang0+k*(2*Math.PI/ORDER.length), x2=cx+r6*Math.cos(a2), y2=cy+r6*Math.sin(a2); k?ctx.lineTo(x2,y2):ctx.moveTo(x2,y2); }
    ctx.closePath(); ctx.stroke();
    ctx.setLineDash([]);

    // 數值面
    var COLORS={木:'#16a34a',火:'#ef4444',土:'#f59e0b',金:'#64748b',水:'#3b82f6'};
    var v=values(), pts=[];
    for(var t=0;t<ORDER.length;t++){
      var key=ORDER[t], rr=R*(Math.max(1,Math.min(10,v[key]))/10), a3=ang0+t*(2*Math.PI/ORDER.length);
      pts.push([cx+rr*Math.cos(a3), cy+rr*Math.sin(a3), v[key], key]);
    }
    ctx.beginPath(); pts.forEach(function(p,i){ i?ctx.lineTo(p[0],p[1]):ctx.moveTo(p[0],p[1]); }); ctx.closePath();
    ctx.fillStyle='rgba(59,130,246,0.18)'; ctx.strokeStyle='rgba(59,130,246,0.9)'; ctx.lineWidth=2; ctx.fill(); ctx.stroke();
    pts.forEach(function(p){ ctx.beginPath(); ctx.arc(p[0],p[1],4,0,Math.PI*2); ctx.fillStyle=COLORS[p[3]]||'#111827'; ctx.fill();
      ctx.fillStyle='#0f172a'; ctx.fillText(String(p[2]), p[0], p[1]-16); });
  };

  // 同步顯示數字
  ['w5_mu','w5_huo','w5_tu','w5_jin','w5_shui','w5_size'].forEach(function(i){
    var el=byId(i); if(el){ el.addEventListener('input', function(){ setMini(i); window.w5_draw(); if(window.updateTCMAdvice && window.__lastMeElem) try{ window.updateTCMAdvice(window.__lastMeElem); }catch(_){} }); }
  });
  window.addEventListener('resize', function(){ try{ window.w5_draw(); }catch(_){} });

  // —— 3) 一鍵估算（依卦）——
  function setRange(id,v){ var el=byId(id); if(!el) return; el.value=String(v); el.dispatchEvent(new Event('input',{bubbles:true})); el.dispatchEvent(new Event('change',{bubbles:true})); }
  function normalize1to10(score){
    var arr=Object.values(score), mi=Math.min.apply(null,arr), ma=Math.max.apply(null,arr);
    var out={}; Object.keys(score).forEach(function(k){
      var x = (mi===ma)? 6 : (1 + (score[k]-mi)*(9)/(ma-mi));
      out[k] = Math.round(Math.max(1,Math.min(10,x)));
    }); return out;
  }
  function estFromHex(){
    try{
      // 取上/下卦與動爻
      var up = byId('upper')?.value, lo = byId('lower')?.value;
      if(!up||!lo) return;
      var baseLines = (window.TRIG && TRIG[lo] && TRIG[up]) ? [].concat(TRIG[lo], TRIG[up]) : [0,0,0,0,0,0];
      var branches = (window.naJiaBranches)? naJiaBranches(baseLines) : [];
      var mv = (window.moving && moving.length===6)? moving.slice() : [false,false,false,false,false,false];

      // 卦名/卦宮/類型
      var gname = (window.guaNameOf)? guaNameOf(up,lo) : (up+'-'+lo);
      var info  = (window.decideShiYing)? decideShiYing(up,lo,gname,baseLines) : {gong:up,kind:'本宮'};
      var meElem = window.__lastMeElem || (window.GONG_ELEM && GONG_ELEM[info.gong]) || '土';

      // 初始分：偏中性
      var S = {木:5,火:5,土:5,金:5,水:5};

      // 上下卦權重
      if(window.GONG_ELEM){ S[GONG_ELEM[up]]  = (S[GONG_ELEM[up]]||0) + 2; }
      if(window.GONG_ELEM){ S[GONG_ELEM[lo]]  = (S[GONG_ELEM[lo]]||0) + 2; }

      // 卦宮（世）加權
      S[meElem] = (S[meElem]||0) + 1.5;

      // 動爻：按納甲地支 → 五行加權
      for(var i=0;i<6;i++){
        if(mv[i] && branches[i]){
          var e = (window.ZHI_ELEM && ZHI_ELEM[branches[i]]) || null;
          if(e) S[e] = (S[e]||0) + 1.4;
        }
      }

      // 月支/日支（若有）
      try{
        if(window.pillars && pillars.month && pillars.day){
          var mE = ZHI_ELEM[pillars.month.charAt(1)]||null;
          var dE = ZHI_ELEM[pillars.day.charAt(1)]||null;
          if(mE) S[mE] += 1.0;
          if(dE) S[dE] += 1.0;
        }
      }catch(_){}

      // 一輪相剋微調（避免單行過頭）：木剋土、土剋水、水剋火、火剋金、金剋木
      (function controlPass(){
        var CTL={木:'土',土:'水',水:'火',火:'金',金:'木'};
        var sum=Object.values(S).reduce((a,b)=>a+b,0), avg=sum/5;
        Object.keys(S).forEach(function(k){
          if(S[k] > avg + 1){ var c=CTL[k]; S[c] = Math.max(1, S[c]-0.6); }
        });
      })();

      // 轉 1–10 並寫回滑桿
      var V = normalize1to10(S);
      setRange('w5_mu',  V.木);
      setRange('w5_huo', V.火);
      setRange('w5_tu',  V.土);
      setRange('w5_jin', V.金);
      setRange('w5_shui',V.水);

      // 重繪＋同步右欄
      try{ window.w5_draw(); }catch(_){}
      try{ if(window.updateTCMAdvice) window.updateTCMAdvice(meElem); }catch(_){}
    }catch(e){
      var err=document.getElementById('err'); if(err){ err.style.display='block'; err.textContent='⚠️ 一鍵估算失敗：'+(e.message||e); }
    }
  }

  var autoBtn=document.getElementById('w5_auto');
  if(autoBtn) autoBtn.addEventListener('click', estFromHex);

  // —— 4) 首次進入：同步顯示數字＆重畫雷達 —— 
  ['w5_mu','w5_huo','w5_tu','w5_jin','w5_shui','w5_size'].forEach(setMini);
  try{ window.w5_draw(); }catch(_){}
})();
</script>
<script>
/* 移除舊的／重複的「依卦一鍵估算」按鈕，只保留 #w5_auto */
(function(){
  function removeLegacyEstimateBtn(){
    var ctrl = document.getElementById('w5_ctrl');
    if(!ctrl) return;
    Array.from(ctrl.querySelectorAll('button')).forEach(function(btn){
      var txt = (btn.textContent || '').replace(/\s/g,'');
      // 找到文字長得像「依卦一鍵估算」的舊按鈕，且不是我們的 #w5_auto，就移除
      if(/依卦一鍵估算/.test(txt) && btn.id !== 'w5_auto'){
        btn.remove();
      }
    });
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', removeLegacyEstimateBtn);
  } else {
    removeLegacyEstimateBtn();
  }
})();
</script>
<script>
/* 移除文字為「依卦一鍵估算」的那顆按鈕（安全版：僅跑一次＋補跑一次） */
(function(){
  function norm(s){ return (s||'').replace(/\s/g,'').replace(/[()（）]/g,''); }
  function killOnce(){
    var btns = Array.from(document.querySelectorAll('button, a, [role="button"]'));
    btns.forEach(function(el){
      var t = norm(el.textContent || el.innerText || '');
      if (t === '依卦一鍵估算') {
        try { el.remove(); }
        catch(_){
          // 移除失敗就停用並隱藏，避免誤觸
          el.onclick = function(e){ e.preventDefault(); e.stopPropagation(); return false; };
          el.setAttribute('disabled','disabled');
          el.style.pointerEvents='none';
          el.style.opacity='0.4';
          el.style.display='none';
          el.title = '已停用';
        }
      }
    });
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', killOnce);
  } else { killOnce(); }
  // 有些按鈕晚一點才插入，保險再補掃一次
  setTimeout(killOnce, 800);
})();
</script>
<script id="REMOVE_BAD_ESTM_BTN">
(function(){
  function norm(s){
    return (s||'')
      .replace(/\s+/g,'')                 // 去空白
      .replace(/[()（）［］【】\[\]{}]/g,'') // 去括號
      .replace(/[^\p{Script=Han}A-Za-z0-9]/gu,''); // 只留中英數
  }
  function kill(){
    var list = Array.from(document.querySelectorAll('button, [role="button"], a, .btn, .button'));
    list.forEach(function(el){
      var t = norm(el.textContent || el.innerText || '');
      // 只移除文字就是「依卦一鍵估算」的那顆；不會影響「一鍵估算（依卦）」
      if (t === '依卦一鍵估算') {
        try { el.remove(); }
        catch(_){
          el.disabled = true;
          el.setAttribute('disabled','disabled');
          el.style.display='none';
          el.style.pointerEvents='none';
          el.title = '已停用';
        }
      }
    });
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', kill);
  else kill();
  setTimeout(kill, 1200); // 保險補掃一次
})();
</script>
<script id="W5_DASH_RING_PATCH">
(function(){
  if(window.__W5_DASH_RING_PATCH__) return; window.__W5_DASH_RING_PATCH__=true;
  var old = window.w5_draw;
  window.w5_draw = function(){
    if (typeof old === 'function') old();   // 先畫原本的
    try{
      var c = document.getElementById('w5_canv'); if(!c) return;
      var dpr = window.devicePixelRatio||1, W=c.clientWidth, H=c.clientHeight;
      var ctx = c.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0);
      var cx=W/2, cy=H/2+6;
      var sc = parseFloat(document.getElementById('w5_size')?.value || 1.3);
      var R  = Math.min(W,H*0.9)/2*0.78*sc;
      var N  = 5, ang0 = -Math.PI/2;

      ctx.save();
      ctx.lineWidth = 1;
      ctx.setLineDash([6,6]);           // 虛線樣式
      ctx.strokeStyle = '#94a3b8';      // 100 分框線顏色
      ctx.beginPath();
      for(let i=0;i<N;i++){
        const a=ang0+i*(2*Math.PI/N);
        const x=cx+R*Math.cos(a), y=cy+R*Math.sin(a);
        i?ctx.lineTo(x,y):ctx.moveTo(x,y);
      }
      ctx.closePath(); ctx.stroke();
      ctx.setLineDash([]);
      ctx.restore();
    }catch(_){}
  };
  // 首次／拉桿變動時都重畫一次
  window.addEventListener('load', ()=> window.w5_draw && window.w5_draw());
  ['w5_mu','w5_huo','w5_tu','w5_jin','w5_shui','w5_size'].forEach(id=>{
    var el=document.getElementById(id);
    if(el) el.addEventListener('input', ()=> window.w5_draw && window.w5_draw());
  });
})();
</script>
<script id="PATCH_TOPBTN_DASHRING_v3">
(function(){
  if(window.__PATCH_TOPBTN_DASHRING_v3__) return; window.__PATCH_TOPBTN_DASHRING_v3__=true;

  /* ① 只把「最上面」那顆一鍵估算藏起來，保留下面那顆 */
  function hideTopDup(){
    try{
      var cands = Array.from(document.querySelectorAll('button,[role="button"],.btn'))
        .filter(el => /一鍵估算|依卦/.test(el.textContent||''));
      if(cands.length < 2) return; // 只有一顆就不動
      // 依畫面垂直位置排序，隱藏最上面那顆
      cands.sort((a,b)=>a.getBoundingClientRect().top - b.getBoundingClientRect().top);
      var topBtn = cands[0];
      topBtn.style.display = 'none';
      topBtn.setAttribute('aria-hidden','true');
      if('disabled' in topBtn) topBtn.disabled = true;
    }catch(e){}
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', hideTopDup);
  else hideTopDup();
  setTimeout(hideTopDup, 800); // 有延遲載入時再掃一次

  /* ② 在雷達圖最外圈疊 100 分虛線（不改你原本的 w5_draw，只是包一層） */
  function drawDash(){
    try{
      var c=document.getElementById('w5_canv'); if(!c) return;
      var dpr=window.devicePixelRatio||1, W=c.clientWidth||600, H=c.clientHeight||300;
      var ctx=c.getContext('2d'); if(!ctx) return;
      ctx.save();
      ctx.setTransform(dpr,0,0,dpr,0,0);
      var cx=W/2, cy=H/2+6;
      var sc=parseFloat(document.getElementById('w5_size')?.value||'1.3')||1.3;
      var R=Math.min(W,H*0.9)/2*0.78*sc;

      ctx.beginPath();
      for(var i=0;i<5;i++){
        var a=-Math.PI/2 + i*(2*Math.PI/5);
        var x=cx + R*Math.cos(a), y=cy + R*Math.sin(a);
        i?ctx.lineTo(x,y):ctx.moveTo(x,y);
      }
      ctx.closePath();
      ctx.lineWidth=1.2;
      ctx.setLineDash([6,6]);
      ctx.strokeStyle='rgba(71,85,105,0.9)'; // 比較明顯的灰
      ctx.stroke();
      ctx.setLineDash([]);
      ctx.restore();
    }catch(e){}
  }

  // 只包一次，不會造成遞迴
  function patchDrawOnce(){
    var w = window.w5_draw;
    if(typeof w === 'function' && !w.__withDash){
      var orig = w;
      var wrapped = function(){ orig.apply(this, arguments); drawDash(); };
      wrapped.__withDash = true;
      window.w5_draw = wrapped;
      try{ window.w5_draw(); }catch(_){ drawDash(); }
      return true;
    }
    return false;
  }
  if(!patchDrawOnce()){
    var t=setInterval(function(){ if(patchDrawOnce()) clearInterval(t); }, 300);
    setTimeout(function(){ clearInterval(t); }, 4000);
  }

  // 相關事件時，也補畫一次虛線（在下一個 frame 執行，確保疊在最上層）
  ['w5_mu','w5_huo','w5_tu','w5_jin','w5_shui','w5_size'].forEach(function(id){
    var el=document.getElementById(id);
    if(el){ el.addEventListener('input', function(){ requestAnimationFrame(drawDash); }); }
  });
  window.addEventListener('resize', function(){ requestAnimationFrame(drawDash); });

  if(document.readyState==='complete') requestAnimationFrame(drawDash);
  else window.addEventListener('load', function(){ requestAnimationFrame(drawDash); });
})();
</script>
<script id="W5_INTERACTIVE_DASH_OVERLAY">
(function(){
  if (window.__W5_INTERACTIVE_DASH_OVERLAY__) return;
  window.__W5_INTERACTIVE_DASH_OVERLAY__ = true;

  // —— 小工具 —— //
  const $ = s => document.querySelector(s);
  const id = s => document.getElementById(s);

  // 在控制列加「顯示估算虛線（依卦）」勾選框
  function ensureToggle(){
    const ctrl = id('w5_ctrl'); if(!ctrl) return;
    if(id('w5_show_est')) return;
    const row = document.createElement('div');
    row.className = 'row';
    row.innerHTML = `
      <label style="display:flex;align-items:center;gap:6px">
        <input type="checkbox" id="w5_show_est" checked>
        顯示估算虛線（依卦）
      </label>`;
    // 放在「大小」下面
    const first = ctrl.querySelector('.row');
    if(first && first.nextSibling) ctrl.insertBefore(row, first.nextSibling);
    else ctrl.appendChild(row);
    id('w5_show_est').addEventListener('change', ()=>{ try{ if(window.w5_draw) window.w5_draw(); }catch(_){} });
  }

  // 讀目前拉桿（供座標計算參考用）
  function readCurrent(){
    const g = k => +((id(k)&&id(k).value) || NaN);
    return {火:g('w5_huo'), 木:g('w5_mu'), 土:g('w5_tu'), 金:g('w5_jin'), 水:g('w5_shui')};
  }

  // 依卦宮五行給一組「參考值」（不改拉桿，只用來畫虛線）
  function estimateFromHex(){
    const me = (window.__lastMeElem || '土').trim(); // 卦宮五行
    // 以 6 為中位，母/子 +1，本位 +2，被我剋 -1，剋我 +0（你要更強烈可調整）
    const GEN = {木:'火',火:'土',土:'金',金:'水',水:'木'};      // 生
    const CTL = {木:'土',土:'水',水:'火',火:'金',金:'木'};      // 我剋
    const MOTHER = {木:'水',火:'木',土:'火',金:'土',水:'金'};    // 生我
    const KILLME = {木:'金',火:'水',土:'木',金:'火',水:'土'};    // 剋我

    const v = {木:6, 火:6, 土:6, 金:6, 水:6};
    v[me] += 2;
    v[GEN[me]] += 1;
    v[MOTHER[me]] += 1;
    v[CTL[me]] -= 1;
    // KILLME 保持 0（有需要可改成 -0.5 或 +0.5）
    Object.keys(v).forEach(k=>{
      v[k] = Math.max(1, Math.min(10, Math.round(v[k])));
    });
    return v;
  }

  // 在現有雷達上疊一層「估算虛線多邊形」
  function drawDashOverlay(est){
    const c = id('w5_canv'); if(!c) return;
    const dpr = window.devicePixelRatio || 1;
    const W = c.clientWidth || 600, H = c.clientHeight || 300;
    const ctx = c.getContext('2d'); if(!ctx) return;

    // 幾何參數要跟你的雷達一致
    const ORDER = ['火','木','土','金','水'];  // 你的繪圖順序
    const sc = parseFloat(id('w5_size')?.value || '1.3') || 1.3;
    const cx = W/2, cy = H/2 + 6;
    const R  = Math.min(W, H*0.9)/2 * 0.78 * sc;
    const ang0 = -Math.PI/2;

    ctx.save();
    ctx.setTransform(dpr,0,0,dpr,0,0);

    // 路徑
    const pts = ORDER.map((k,i)=>{
      const rr = R * (Math.max(1, Math.min(10, est[k])) / 10);
      const a  = ang0 + i * (2*Math.PI/ORDER.length);
      return [cx + rr*Math.cos(a), cy + rr*Math.sin(a)];
    });

    ctx.beginPath();
    pts.forEach((p,i)=> i?ctx.lineTo(p[0],p[1]):ctx.moveTo(p[0],p[1]));
    ctx.closePath();
    ctx.lineWidth = 2;
    ctx.setLineDash([6,6]);
    ctx.strokeStyle = 'rgba(51,65,85,0.9)'; // 深灰
    ctx.stroke();
    ctx.setLineDash([]);

    // 節點（空心）
    pts.forEach(([x,y])=>{
      ctx.beginPath();
      ctx.arc(x,y,4,0,Math.PI*2);
      ctx.lineWidth = 1.5;
      ctx.strokeStyle = 'rgba(51,65,85,0.9)';
      ctx.stroke();
    });

    // 小標籤（在點的上方顯示數字）
    ctx.font = '12px "Noto Sans TC","Microsoft JhengHei"';
    ctx.fillStyle = '#334155';
    ORDER.forEach((k,i)=>{
      const rr = R * (est[k]/10);
      const a  = ang0 + i * (2*Math.PI/ORDER.length);
      const x  = cx + rr*Math.cos(a), y = cy + rr*Math.sin(a);
      ctx.fillText(String(est[k]), x, y - 14);
    });

    ctx.restore();
  }

  // 包一層 w5_draw：先跑原本 → 如果勾選就畫虛線
  function patchRadarDraw(){
    const orig = window.w5_draw;
    if (typeof orig !== 'function' || orig.__withInteractiveDash) return false;
    const wrapped = function(){
      orig.apply(this, arguments);
      ensureToggle();
      const on = !!id('w5_show_est') && id('w5_show_est').checked;
      if (on){
        const est = estimateFromHex();
        drawDashOverlay(est);
      }
    };
    wrapped.__withInteractiveDash = true;
    window.w5_draw = wrapped;
    // 立即重畫一次
    try{ window.w5_draw(); }catch(_){}
    return true;
  }

  // 初始化：等雷達可用就打補丁
  function boot(){
    ensureToggle();
    if(!patchRadarDraw()){
      // 還沒掛好就稍後再試
      let tries = 0;
      const t = setInterval(()=>{
        tries++;
        if(patchRadarDraw() || tries>20) clearInterval(t);
      }, 200);
    }
    // 拉桿改動、大小改動，都重畫
    ['w5_mu','w5_huo','w5_tu','w5_jin','w5_shui','w5_size'].forEach(k=>{
      const el = id(k); if(el){ el.addEventListener('input', ()=>{ try{ if(window.w5_draw) window.w5_draw(); }catch(_){} }); }
    });
    // 卦宮變了（上卦/下卦或重繪），估算也要跟著變
    ['upper','lower'].forEach(k=>{
      const el = id(k); if(el){ el.addEventListener('change', ()=>{ try{ if(window.w5_draw) window.w5_draw(); }catch(_){} }); }
    });
    // render() 跑完也保險重畫一次（不呼叫 render，避免互相觸發）
    try{
      const R = window.render;
      if(typeof R==='function' && !R.__trigW5Redraw){
        const wrap = function(){ R.apply(this, arguments); try{ if(window.w5_draw) window.w5_draw(); }catch(_){} };
        wrap.__trigW5Redraw = true;
        window.render = wrap;
      }
    }catch(_){}
  }

  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', boot);
  else boot();
  window.addEventListener('load', ()=>{ try{ if(window.w5_draw) window.w5_draw(); }catch(_){} });
})();
</script>
<script id="W5_APPLY_ESTIMATE">
(function(){
  if(window.__W5_APPLY_ESTIMATE__) return; window.__W5_APPLY_ESTIMATE__=true;
  const $=s=>document.querySelector(s);
  const id=s=>document.getElementById(s);

  // 依卦宮五行推估（與虛線同邏輯）
  function estimateFromHex(){
    const me=(window.__lastMeElem||'土').trim();
    const GEN={木:'火',火:'土',土:'金',金:'水',水:'木'};
    const MOM={木:'水',火:'木',土:'火',金:'土',水:'金'};
    const CTL={木:'土',土:'水',水:'火',火:'金',金:'木'};
    const v={木:6,火:6,土:6,金:6,水:6};
    v[me]+=2; v[GEN[me]]+=1; v[MOM[me]]+=1; v[CTL[me]]-=1;
    for(const k in v){ v[k]=Math.max(1,Math.min(10,Math.round(v[k]))); }
    return v;
  }
  function setSlider(k,val){
    const el=id(k); if(!el) return;
    el.value=val;
    el.dispatchEvent(new Event('input',{bubbles:true}));
    el.dispatchEvent(new Event('change',{bubbles:true}));
  }
  function applyEstimate(){
    const e=estimateFromHex();
    setSlider('w5_mu',e['木']); setSlider('w5_huo',e['火']);
    setSlider('w5_tu',e['土']); setSlider('w5_jin',e['金']); setSlider('w5_shui',e['水']);
    try{ if(window.w5_draw) window.w5_draw(); }catch(_){}
  }
  function resetAvg(){
    ['w5_mu','w5_huo','w5_tu','w5_jin','w5_shui'].forEach(k=>setSlider(k,6));
    try{ if(window.w5_draw) window.w5_draw(); }catch(_){}
  }

  // 在雷達控制列加兩顆按鈕（放在「顯示估算虛線」下方；沒有就加在最後）
  function ensureBtns(){
    const ctrl=id('w5_ctrl'); if(!ctrl || id('w5_apply_est')) return;
    const row=document.createElement('div'); row.className='row';
    row.innerHTML='<button id="w5_apply_est">套用估算到拉桿</button> <button id="w5_reset_avg">全部重置為 6</button>';
    const toggle=id('w5_show_est')?.closest('.row');
    if(toggle && toggle.nextSibling) ctrl.insertBefore(row, toggle.nextSibling); else ctrl.appendChild(row);
    id('w5_apply_est').addEventListener('click', applyEstimate);
    id('w5_reset_avg').addEventListener('click', resetAvg);
  }

  // 把任何寫著「互動平衡」的東西藏起來（只影響 UI）
  function hideInteractiveBalance(){
    const ctrl=id('w5_ctrl'); if(!ctrl) return;
    Array.from(ctrl.querySelectorAll('button, .row, label, span'))
      .filter(n=>/互動平衡/.test(n.textContent||''))
      .forEach(n=>{ n.style.display='none'; });
  }

  function boot(){ ensureBtns(); hideInteractiveBalance(); }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', boot); else boot();
  window.addEventListener('load', boot);
})();
</script>
<script id="W5_KILL_EMPTY_BUTTON">
(function(){
  if(window.__W5_KILL_EMPTY_BUTTON__) return; window.__W5_KILL_EMPTY_BUTTON__=true;

  function cleanup(){
    var ctrl = document.getElementById('w5_ctrl');
    if(!ctrl) return;

    // 1) 移除沒有任何文字的按鈕
    Array.from(ctrl.querySelectorAll('button')).forEach(function(btn){
      var txt = (btn.textContent || '').trim();
      if(txt.length === 0) btn.remove();
    });

    // 2) 把已經沒有可見內容的 .row 一併移除（避免留下大空白）
    Array.from(ctrl.querySelectorAll('.row')).forEach(function(row){
      var hasVisible = Array.from(row.children).some(function(el){
        var s = window.getComputedStyle(el);
        var nonEmpty = (el.textContent||'').trim().length > 0;
        var isInput  = (el.tagName === 'INPUT' || el.tagName === 'SELECT' || el.tagName === 'BUTTON' || el.tagName === 'LABEL');
        return s.display !== 'none' && s.visibility !== 'hidden' && (nonEmpty || isInput);
      });
      if(!hasVisible) row.remove();
    });
  }

  if(document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', cleanup);
  } else {
    cleanup();
  }
  window.addEventListener('load', cleanup);
})();
</script>
<script id="W5_EST_LINE_RECOLOR">
(function(){
  if (window.__W5_EST_LINE_RECOLOR__) return; window.__W5_EST_LINE_RECOLOR__ = true;

  // 專改 #w5_canv 上的「虛線」筆畫顏色（不影響實線）
  const targetCanvasId = 'w5_canv';
  const EST_COLOR = '#CE0000';   // 想改色只改這一行

  const Ctx = CanvasRenderingContext2D.prototype;
  const _setLineDash = Ctx.setLineDash;
  const _stroke      = Ctx.stroke;

  let lastDash = [];
  Ctx.setLineDash = function(arr){
    lastDash = Array.isArray(arr) ? arr.slice() : [];
    return _setLineDash.apply(this, arguments);
  };

  Ctx.stroke = function(){
    try{
      // 只針對雷達畫布，且僅限「有虛線」的筆畫（避免動到實線）
      if (this.canvas && this.canvas.id === targetCanvasId &&
          lastDash && lastDash.length && (lastDash[0] >= 4)) {
        const bak = this.strokeStyle;
        this.strokeStyle = EST_COLOR;
        const r = _stroke.apply(this, arguments);
        this.strokeStyle = bak;
        return r;
      }
    }catch(e){}
    return _stroke.apply(this, arguments);
  };
})();
</script>
<style>
/* 假如那顆按鈕的 id 是 #btnAutoEstimate 或文字節點只有「一鍵估算」 */
#btnAutoEstimate { display:none !important; }
/* 或者用文字選擇器（保險做法就用上面那個 id 版本就好）*/
</style>
<script id="KILL_OLD_ESTIMATE_BTN">
(function(){
  if (window.__KILL_OLD_ESTIMATE_BTN__) return;
  window.__KILL_OLD_ESTIMATE_BTN__ = true;

  // 判斷是否為「舊的一顆沒作用」：文字包含估算關鍵字，且不在雷達區(#w5_sec)內
  function isOldEstimateBtn(btn){
    const txt = (btn.textContent || '').replace(/\s/g,'');
    const inRadar = !!btn.closest('#w5_sec');   // 下面那盒（有效的）都在這裡
    if (inRadar) return false;                  // 保留有效那兩顆
    const looksEstimate = /(依卦)?一鍵?估算/.test(txt) || /顯示估算/.test(txt);
    const isBlank = txt === '';                 // 你說只剩空白那顆也一起清掉
    return looksEstimate || isBlank;
  }

  function removeOld(){
    document.querySelectorAll('button').forEach(b=>{
      if (isOldEstimateBtn(b)) b.remove();
    });
  }

  // 初次執行
  const once = () => { try{ removeOld(); }catch(e){} };
  document.addEventListener('DOMContentLoaded', once);
  window.addEventListener('load', once);

  // 若有程式動態又把舊按鈕插回來，10 秒內自動再清一次
  const mo = new MutationObserver(()=>removeOld());
  mo.observe(document.documentElement, {childList:true, subtree:true});
  setTimeout(()=>mo.disconnect(), 10000);
})();
</script>
<script id="W5_EST_COLOR_PATCH">
(function(){
  if (window.__W5_EST_COLOR_PATCH__) return; 
  window.__W5_EST_COLOR_PATCH__ = true;

  // ←← 想要的顏色改這裡（例如：紫 #8b5cf6、紅 #ef4444、綠 #16a34a）
  window.W5_EST_COLOR = '#16a34';

  function patch(){
    var c = document.getElementById('w5_canv');
    if (!c) return;
    var ctx = c.getContext('2d');
    if (!ctx || ctx.__patchedForEst) return;

    ctx.__patchedForEst = true;
    var origSetDash = ctx.setLineDash.bind(ctx);
    var origStroke  = ctx.stroke.bind(ctx);

    ctx.__dashOn = false;
    ctx.setLineDash = function(arr){
      ctx.__dashOn = Array.isArray(arr) && arr.some(n => n > 0); // 只有設了虛線才標記
      return origSetDash(arr);
    };

    ctx.stroke = function(){
      if (ctx.__dashOn) {
        var bak = ctx.strokeStyle;
        ctx.strokeStyle = window.W5_EST_COLOR || bak; // 只有虛線才換色
        try { return origStroke(); } 
        finally { ctx.strokeStyle = bak; }
      }
      return origStroke();
    };
  }

  function redraw(){ try{ if (window.w5_draw) window.w5_draw(); }catch(_){} }

  document.addEventListener('DOMContentLoaded', function(){ patch(); redraw(); });
  window.addEventListener('load', function(){ patch(); redraw(); });

})();
</script>
<script id="W5_ONLY_EST_COLOR">
(function(){
  if(window.__W5_ONLY_EST_COLOR__) return; window.__W5_ONLY_EST_COLOR__=true;

  /* —— 設定區 —— */
  window.W5_EST_COLOR = '#16a34a';   // 估算虛線要換成的顏色
  window.W5_EST_INDEX = 1;           // 第幾條虛線要染色：1 / 2 / 3  擇一
  // （進階可用樣式比對：回傳 true 才上色；不需要可不動）
  window.W5_EST_MATCH = function(dashArray){
    // 例：若你的估算虛線用 [6,4] 的虛線樣式，就比對它
    // return Array.isArray(dashArray) && dashArray.length===2 && dashArray[0]===6 && dashArray[1]===4;
    return true; // 預設不比對樣式，只用索引
  };

  function patch(){
    var c=document.getElementById('w5_canv'); if(!c) return;
    var ctx=c.getContext('2d'); if(!ctx || ctx.__onlyEstPatched) return;
    ctx.__onlyEstPatched=true;

    var origSetDash=ctx.setLineDash.bind(ctx);
    var origStroke =ctx.stroke.bind(ctx);
    var origClear  =ctx.clearRect.bind(ctx);

    ctx.__dashOn=false; ctx.__dashArr=[]; ctx.__dashCount=0;

    ctx.setLineDash=function(arr){
      ctx.__dashOn=Array.isArray(arr)&&arr.some(n=>n>0);
      ctx.__dashArr=Array.isArray(arr)?arr.slice():[];
      return origSetDash(arr);
    };
    ctx.clearRect=function(){ ctx.__dashCount=0; return origClear.apply(ctx,arguments); };

    ctx.stroke=function(){
      if(ctx.__dashOn){
        ctx.__dashCount++;
        var isTarget = (ctx.__dashCount===(window.W5_EST_INDEX||1)) &&
                       (typeof window.W5_EST_MATCH!=='function' || window.W5_EST_MATCH(ctx.__dashArr));
        if(isTarget){
          var bak=ctx.strokeStyle;
          ctx.strokeStyle=window.W5_EST_COLOR||bak;
          try{ return origStroke(); } finally{ ctx.strokeStyle=bak; }
        }
      }
      return origStroke();
    };
  }

  function redraw(){ try{ window.w5_draw && window.w5_draw(); }catch(_){} }
  document.addEventListener('DOMContentLoaded', function(){ patch(); redraw(); });
  window.addEventListener('load', function(){ patch(); redraw(); });
})();
</script>
<script id="W5_EST_DASH_COLOR_PATCH">
(function(){
  if(window.__W5_EST_DASH_COLOR_PATCH__) return; 
  window.__W5_EST_DASH_COLOR_PATCH__=true;

  // ← 想要的顏色：紫 (#8b5cf6)。要換色直接改這裡。
  window.W5_EST_DASH_COLOR = '#8b5cf6';

  const P = CanvasRenderingContext2D.prototype;
  const _stroke = P.stroke, _setLineDash = P.setLineDash;

  // 標記目前是否在畫「虛線」
  P.setLineDash = function(arr){
    this.__dashOn = Array.isArray(arr) && arr.some(n=>n>0);
    this.__dash = Array.isArray(arr) ? arr.slice() : null;
    return _setLineDash.apply(this, arguments);
  };

  // 把任何色字串標準化並轉成 RGB
  function parseColor(s){
    try{
      const ctx = document.createElement('canvas').getContext('2d');
      ctx.strokeStyle = s;
      const cs = (ctx.strokeStyle||'').toString();
      if(cs.startsWith('#')){
        let hex = cs.slice(1);
        if(hex.length===3) hex = hex.split('').map(c=>c+c).join('');
        const n = parseInt(hex,16);
        return {r:(n>>16)&255, g:(n>>8)&255, b:n&255, a:1};
      }
      const m = cs.match(/rgba?\(([\d.]+),\s*([\d.]+),\s*([\d.]+)(?:,\s*([\d.]+))?\)/);
      if(m) return {r:+m[1], g:+m[2], b:+m[3], a:m[4]==null?1:+m[4]};
    }catch(e){}
    return null;
  }

  // 判斷是不是「紅色系」
  function isRedish(c){
    if(!c) return false;
    const {r,g,b} = c;
    return r>=180 && g<=120 && b<=120 && (r - Math.max(g,b) >= 40);
  }

  // 只在 w5_canv（雷達）或 hexCanvas（卦盤），而且是「虛線」且「紅色系」時，強制改色
  P.stroke = function(){
    const onTargetCanvas = this.canvas && (this.canvas.id==='w5_canv' || this.canvas.id==='hexCanvas');
    if(onTargetCanvas && this.__dashOn){
      const col = parseColor(this.strokeStyle);
      if(isRedish(col)){
        const bak = this.strokeStyle;
        this.strokeStyle = window.W5_EST_DASH_COLOR || bak;
        try { return _stroke.apply(this, arguments); }
        finally { this.strokeStyle = bak; }
      }
    }
    return _stroke.apply(this, arguments);
  };

  // 立刻重繪一次，讓改色生效
  function redraw(){ try{ window.w5_draw && window.w5_draw(); }catch(_){}
                     try{ window.render && window.render(); }catch(_){} }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', redraw);
  else redraw();
  window.addEventListener('load', redraw);
})();
</script>
<!-- 估算虛線顏色控制：貼在所有 <script> 之後、</body> 前 -->
<script id="W5_EST_COLOR_PICKER">
(function(){
  if(window.__W5_EST_COLOR_PICKER__) return; 
  window.__W5_EST_COLOR_PICKER__ = true;

  // 預設色（可改）
  window.W5_EST_DASH_COLOR = '#8b5cf6';

  // —— 1) 在「顯示估算虛線（依卦）」旁邊加一個 color picker —— //
  function attachPicker(){
    // 找到包含此文字的元素（label/button/span/div 都掃）
    var anchor = Array.from(document.querySelectorAll('label,button,span,div'))
      .find(el => /顯示估算虛線/.test((el.textContent||'')));
    // 後備：找不到就插在雷達控制列 #w5_ctrl 標題附近
    if(!anchor){
      var ctrl = document.getElementById('w5_ctrl');
      if(ctrl) anchor = ctrl.querySelector('.row') || ctrl;
    }
    if(!anchor || anchor.querySelector('#estColorPickWrap')) return;

    var wrap = document.createElement('span');
    wrap.id = 'estColorPickWrap';
    wrap.style.marginLeft = '8px';
    wrap.innerHTML = 
      '<input id="estColorPick" type="color" value="'+(window.W5_EST_DASH_COLOR||'#8b5cf6')+'" '+
      'title="估算虛線顏色" style="width:28px;height:22px;padding:0;border:none;vertical-align:middle;">';
    anchor.appendChild(wrap);

    var pick = wrap.querySelector('#estColorPick');
    pick.addEventListener('input', function(e){
      window.W5_EST_DASH_COLOR = e.target.value || '#8b5cf6';
      redrawAll();
    });
  }

  // —— 2) 只改雷達 canvas 上「虛線」的顏色 —— //
  // 不需要知道原始程式怎麼畫；只要是 w5_canv 上的虛線，就用選到的顏色描邊
  var P = CanvasRenderingContext2D.prototype;
  if(!P.__patched_w5_est_color__){
    P.__patched_w5_est_color__ = true;
    var _stroke = P.stroke, _setLineDash = P.setLineDash;

    P.setLineDash = function(arr){
      this.__dashOn = Array.isArray(arr) && arr.some(n=>n>0);
      return _setLineDash.apply(this, arguments);
    };

    P.stroke = function(){
      // 只影響五行雷達（#w5_canv）且目前是「虛線」的描邊
      if(this.canvas && this.canvas.id === 'w5_canv' && this.__dashOn){
        var bak = this.strokeStyle;
        if(window.W5_EST_DASH_COLOR) this.strokeStyle = window.W5_EST_DASH_COLOR;
        try{ return _stroke.apply(this, arguments); }
        finally{ this.strokeStyle = bak; }
      }
      return _stroke.apply(this, arguments);
    };
  }

  function redrawAll(){
    try{ window.w5_draw && window.w5_draw(); }catch(_){}
    try{ window.render && window.render(); }catch(_){}
  }

  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', attachPicker);
  else attachPicker();
  window.addEventListener('load', attachPicker);
})();
</script>
<script id="W5_EST_OVERLAY_V4">
(function(){
  if(window.__W5_EST_OVERLAY_V4__) return; window.__W5_EST_OVERLAY_V4__=true;

  // 清掉我之前加的顏色列與覆蓋層（若存在）
  (function cleanup(){
    try{ document.getElementById('w5_overlay')?.remove(); }catch(e){}
    try{ document.getElementById('w5_est_color_row')?.remove(); }catch(e){}
  })();

  const ORDER=['火','木','土','金','水'], ang0=-Math.PI/2;
  const $id = id => document.getElementById(id);

  // —— 單一控制列（勾選 + 色票） —— //
  function ensureUnifiedRow(){
    if($id('w5_est_unified')) return;
    const host = $id('w5_ctrl') || $id('w5_sec') || document.body;

    // 隱藏舊「顯示估算虛線」那一列，並取消勾選，避免它再畫紅色線
    Array.from(host.querySelectorAll('.row')).forEach(r=>{
      if(/顯示估算虛線/.test(r.textContent||'')){
        const cb=r.querySelector('input[type=checkbox]');
        if(cb){ cb.checked=false; cb.dispatchEvent(new Event('input',{bubbles:true})); }
        r.style.display='none';
      }
    });

    const row=document.createElement('div');
    row.className='row'; row.id='w5_est_unified';
    row.innerHTML=`
      <label style="display:flex;align-items:center;gap:6px">
        <input id="w5_est_show" type="checkbox">
        <span>估算虛線（依卦）</span>
      </label>
      <input id="w5_est_color" type="color" style="width:34px;height:22px;padding:0;border:none;margin-left:6px">
      <span class="miniVal" id="w5_est_color_txt" style="margin-left:6px"></span>`;
    host.appendChild(row);

    // 狀態初始化
    const show = localStorage.getItem('w5_est_show')==='1';
    const col  = localStorage.getItem('w5_est_color') || '#8b5cf6';
    $id('w5_est_show').checked = show;
    $id('w5_est_color').value  = col;
    $id('w5_est_color_txt').textContent = col;

    // 事件
    $id('w5_est_show').addEventListener('change', ()=>{
      localStorage.setItem('w5_est_show', $id('w5_est_show').checked?'1':'0');
      drawOverlay();
    });
    $id('w5_est_color').addEventListener('input', ()=>{
      localStorage.setItem('w5_est_color', $id('w5_est_color').value);
      $id('w5_est_color_txt').textContent = $id('w5_est_color').value;
      drawOverlay();
    });
  }

  function sizeScale(){ let f=parseFloat($id('w5_size')?.value||'1.3'); return Math.max(0.8,Math.min(1.8,f)); }

  function ensureOverlay(){
    const base=$id('w5_canv'); if(!base) return null;
    const wrap=base.parentElement;
    if(getComputedStyle(wrap).position==='static') wrap.style.position='relative';
    let ov=$id('w5_overlay');
    if(!ov){
      ov=document.createElement('canvas');
      ov.id='w5_overlay';
      ov.style.position='absolute'; ov.style.inset='0';
      ov.style.pointerEvents='none'; ov.style.zIndex='3';
      wrap.appendChild(ov);
    }
    const dpr=window.devicePixelRatio||1, W=base.clientWidth, H=base.clientHeight;
    ov.width=Math.max(1,Math.floor(W*dpr)); ov.height=Math.max(1,Math.floor(H*dpr));
    ov.style.width=W+'px'; ov.style.height=H+'px';
    const ctx=ov.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0);
    return {ctx,W,H};
  }

  // 估算資料：__w5_est → w5_estimate() → localStorage('w5_est') →（最後）目前拉桿值
  function getEstimate(){
    if (window.__w5_est && typeof window.__w5_est==='object') return window.__w5_est;
    if (typeof window.w5_estimate==='function'){ try{ const r=window.w5_estimate(); if(r) return r; }catch(_){ } }
    try{ const s=localStorage.getItem('w5_est'); if(s) return JSON.parse(s); }catch(_){}
    const v=k=>+($id(k)?.value||NaN); const mu=v('w5_mu'),huo=v('w5_huo'),tu=v('w5_tu'),jin=v('w5_jin'),shui=v('w5_shui');
    if([mu,huo,tu,jin,shui].every(n=>!isNaN(n))) return {木:mu,火:huo,土:tu,金:jin,水:shui};
    return null;
  }

  function drawOverlay(){
    ensureUnifiedRow(); // 也會把舊列藏起來
    const pack=ensureOverlay(); if(!pack) return;
    const {ctx,W,H}=pack;
    ctx.clearRect(0,0,W,H);

    const show = $id('w5_est_show')?.checked;
    if(!show) return;

    const est=getEstimate(); if(!est) return;
    const cx=W/2, cy=H/2+6, R=Math.min(W, H*0.9)/2*0.78*sizeScale();
    const col=localStorage.getItem('w5_est_color') || '#8b5cf6';

    ctx.save();
    ctx.setLineDash([8,6]);
    ctx.lineWidth=3;
    ctx.lineJoin='round'; ctx.lineCap='round';
    ctx.strokeStyle=col;
    ctx.beginPath();
    ORDER.forEach((k,i)=>{
      const v=Math.max(1,Math.min(10,+est[k]||6));
      const rr=R*(v/10);
      const a=ang0 + i*(2*Math.PI/ORDER.length);
      const x=cx+rr*Math.cos(a), y=cy+rr*Math.sin(a);
      i?ctx.lineTo(x,y):ctx.moveTo(x,y);
    });
    ctx.closePath(); ctx.stroke();
    ctx.restore();
  }

  // 盡可能關閉舊紅線：每次重畫前把舊的 checkbox 取消
  function disableOldEstimate(){
    const host=$id('w5_ctrl')||$id('w5_sec')||document.body;
    Array.from(host.querySelectorAll('.row')).forEach(r=>{
      if(/顯示估算虛線/.test(r.textContent||'')){
        const cb=r.querySelector('input[type=checkbox]');
        if(cb){ cb.checked=false; cb.dispatchEvent(new Event('input',{bubbles:true})); }
      }
    });
  }

  // 掛到你的 w5_draw 後面：先讓原雷達畫完，再關舊紅線，最後畫覆蓋層
  (function hook(){
    const orig=window.w5_draw;
    window.w5_draw=function(){ try{ orig && orig.apply(this, arguments); }catch(_){} disableOldEstimate(); drawOverlay(); };
  })();

  // 互動事件
  ['w5_mu','w5_huo','w5_tu','w5_jin','w5_shui','w5_size'].forEach(id=>{ $id(id)?.addEventListener('input', drawOverlay); });
  window.addEventListener('resize', drawOverlay);
  document.addEventListener('DOMContentLoaded', ()=>{ disableOldEstimate(); drawOverlay(); });
  window.addEventListener('load', ()=>{ disableOldEstimate(); drawOverlay(); });
  document.addEventListener('click', e=>{
    const b=e.target.closest('button'); if(!b) return;
    if(/估算|依卦|套用/i.test((b.textContent||'').trim())) setTimeout(()=>{ disableOldEstimate(); drawOverlay(); }, 30);
  });
})();
</script>


</body>
</html>
