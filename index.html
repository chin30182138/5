<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ä»™äººæŒ‡è·¯å…­çˆ»æ’ç›¤ - å®Œæ•´ç‰ˆï¼ˆå«é›¶éŒ¢èµ·å¦+ç”¨ç¥ä¸–æ‡‰åˆ†æ+ä¸­é†«APIï¼‰</title>
  <style>
    :root{--card:#fff;--line:#e5e7eb;--muted:#64748b}
    *{box-sizing:border-box}
    body{margin:0;background:#f6f7fb;font-family:"Noto Sans TC","Microsoft JhengHei",system-ui}
    main{max-width:1180px;margin:18px auto;padding:0 12px}
    h1{margin:0 0 10px;font-size:22px}
    .grid{
      display:grid;
      grid-template-columns: 1.5fr 1fr;
      gap:12px
    }
    .sec{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px;
      margin:10px 0;
      overflow-x: auto;
    }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0}
    input[type=text]{flex:1;min-width:220px;border:1px solid #cbd5e1;border-radius:8px;height:36px;padding:0 10px;font-size:14px}
    input[type=datetime-local], select, button{height:36px;border:1px solid #cbd5e1;border-radius:8px;background:#fff;padding:0 10px;font-size:14px}
    button{cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    .badge{display:inline-block;padding:2px 10px;border-radius:999px;background:#eef2ff;color:#4338ca;font-size:12px}
    .canvasWrap{
      border:1px solid var(--line);
      border-radius:10px;
      background:#fff;
      padding:8px;
    }
    canvas{display:block;min-width:600px;width:100%;height:560px}
    .yaoCtl{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
    .yaoCtl>label{display:flex;align-items:center;gap:6px;justify-content:center;border:1px dashed #cbd5e1;border-radius:8px;padding:6px;font-size:14px}
    #err{position:fixed;right:12px;top:12px;z-index:9999;max-width:60ch;background:#fee2e2;color:#991b1b;border:1px solid #fecaca;border-radius:10px;padding:10px;display:none}
    .miniVal{font-variant-numeric:tabular-nums;color:#475569;font-size:13px}
    .btns button{height:32px}
    .pillars{display:flex;gap:10px;flex-wrap:wrap}
    .pillars span{background:#eef2ff;color:#1e3a8a;border-radius:8px;padding:4px 10px;font-size:13px}
    .rightNote{white-space:pre-wrap;margin-top:8px;background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:10px;font-size:14px}
    .grid > .sec:nth-child(2) {
      display: flex;
      flex-direction: column;
      gap: 12px;
      height: fit-content;
    }
    #w5_sec, #tcmBox {
      margin: 0;
      flex: 1;
    }
    #w5_sec h3, #tcmBox h3 {
      margin-top: 0;
      padding-bottom: 10px;
      border-bottom: 1px solid #e5e7eb;
    }
    #w5_sec { order: 1; }
    #tcmBox { order: 2; }
    @media (max-width: 1024px) {
      .grid { grid-template-columns: 1fr; }
      .grid > .sec:nth-child(2) { flex-direction: column; }
      #w5_sec, #tcmBox { flex: none; }
    }
    @media print {
      @page { size: A4 portrait; margin: 12mm; }
      .grid { display:block; }
      .sec { border:none; padding:0; margin:0 0 10px; overflow-x: visible; }
      .hide-print, .btns, .yaoCtl, #redraw, #download, #btnNow, #btnPrint, #size, #offx, #offy, #gap, #headgap, #sizeVal, #offxVal, #offyVal, #gapVal, #headgapVal { display:none !important; }
      .canvasWrap { border:none; padding:0; overflow-x: visible; }
      canvas { height:auto; width:100%; min-width: auto; }
      #w5_canv { height:260px !important; width:100% !important; display:block !important; }
      #tcmBox { display:block !important; }
    }
    #tcmBox{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px}
    #tcmBox h3{margin:0 0 10px;font-size:16px;color:#0f172a}
    #tcmCore{font-size:14px;color:#0f172a;line-height:1.6}
    #tcmCore .tag{display:inline-block;margin-right:8px;margin-bottom:6px;padding:2px 10px;border-radius:999px;background:#eef2ff;color:#4338ca;font-size:12px}
    #tcmLists{margin-top:8px}
    #tcmLists .blk{margin:8px 0}
    #tcmLists .blk h4{margin:6px 0;font-size:14px;color:#334155}
    #tcmLists ul{margin:4px 0 8px 18px;padding:0}
    #tcmLists li{margin:2px 0}
    #tcmBox .tcm-note{margin-top:8px;color:#64748b;font-size:12px}
    
    /* ç”¨ç¥åˆ†ææ¨£å¼ */
    .yongShenAnalysis {
      margin: 10px 0;
      padding: 12px;
      background: #f0f9ff;
      border-radius: 8px;
      border-left: 4px solid #3b82f6;
    }
    .yongShenAnalysis h4 {
      margin: 0 0 8px 0;
      color: #1e40af;
      font-size: 16px;
    }
    .yongShenAnalysis p {
      margin: 4px 0;
      font-size: 14px;
    }
    
    /* é›¶éŒ¢èµ·å¦æ¨£å¼ */
    .coin-section {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 12px;
      margin: 10px 0;
    }
    .coin-section h3 {
      margin: 0 0 10px;
      font-size: 16px;
      color: #1e293b;
    }
    .coin-container {
      display: flex;
      gap: 15px;
      align-items: center;
      justify-content: center;
      margin: 10px 0;
      flex-wrap: wrap;
    }
    .coin {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(145deg, #fbbf24, #d97706);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      color: white;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    .coin.spinning {
      animation: coinSpin 1s linear infinite;
    }
    .coin-result {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      color: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }
    .coin-result.yang {
      background: linear-gradient(145deg, #3b82f6, #1d4ed8);
    }
    .coin-result.yin {
      background: linear-gradient(145deg, #64748b, #475569);
    }
    @keyframes coinSpin {
      0% { transform: rotateY(0deg) scale(1); }
      50% { transform: rotateY(180deg) scale(1.1); }
      100% { transform: rotateY(360deg) scale(1); }
    }
    .coin-controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
    }
    .coin-controls button {
      padding: 8px 16px;
      font-size: 14px;
    }
    .coin-results {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .coin-yao {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }
    .coin-yao .yao-line {
      width: 40px;
      height: 6px;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: white;
      font-weight: bold;
    }
    .coin-yao .yao-line.yang {
      background: #3b82f6;
    }
    .coin-yao .yao-line.yin {
      background: #64748b;
    }
    .coin-yao .yao-number {
      font-size: 12px;
      color: #64748b;
    }
    .coin-progress {
      margin-top: 10px;
      text-align: center;
      font-size: 14px;
      color: #64748b;
    }
    .sound-control {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      justify-content: center;
    }

    /* ä¸­è—¥åç¨±æ¨£å¼ */
    .herb-name {
      color: #059669;
      cursor: pointer;
      text-decoration: underline;
      text-decoration-style: dotted;
    }
    .herb-name:hover {
      color: #047857;
      background: #f0fdf4;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.11/lunar.min.js"></script>
</head>
<body>
  <main>
    <h1>ä»™äººæŒ‡è·¯å…­çˆ»æ’ç›¤ - å®Œæ•´ç‰ˆï¼ˆå«é›¶éŒ¢èµ·å¦+ç”¨ç¥ä¸–æ‡‰åˆ†æ+ä¸­é†«APIï¼‰</h1>
    <div id="err"></div>
    
    <!-- é›¶éŒ¢èµ·å¦å€å¡Š -->
    <div class="coin-section">
      <h3>é›¶éŒ¢èµ·å¦</h3>
      <div class="coin-container">
        <div class="coin" id="coin1">1</div>
        <div class="coin" id="coin2">2</div>
        <div class="coin" id="coin3">3</div>
      </div>
      <div class="coin-progress" id="coinProgress">å·²æ“²ï¼š0/6 æ¬¡</div>
      <div class="sound-control">
        <input type="checkbox" id="soundEnabled" checked>
        <label for="soundEnabled">æ“²å¹£éŸ³æ•ˆ</label>
      </div>
      <div class="coin-controls">
        <button id="btnTossCoins">æ“²é›¶éŒ¢</button>
        <button id="btnResetCoins">é‡ç½®</button>
        <button id="btnApplyCoins">å¥—ç”¨å¦è±¡</button>
        <button id="btnAutoToss">è‡ªå‹•æ“²å…­æ¬¡</button>
      </div>
      <div class="coin-results" id="coinResults">
        <!-- çˆ»ä½çµæœå°‡åœ¨é€™è£¡é¡¯ç¤º -->
      </div>
    </div>
    
    <div class="grid">
      <section class="sec">
        <div class="row hide-print">
          <label>ä¸Šå¦</label>
          <select id="upper">
            <option>ä¹¾</option><option>å…Œ</option><option>é›¢</option><option>éœ‡</option>
            <option>å·½</option><option selected>å</option><option>è‰®</option><option>å¤</option>
          </select>
          <span>ä¸‹å¦</span>
          <select id="lower">
            <option selected>å</option><option>ä¹¾</option><option>å…Œ</option><option>é›¢</option>
            <option>éœ‡</option><option>å·½</option><option>è‰®</option><option>å¤</option>
          </select>
          <span class="badge">ä¼ç¥ï¼ç¼ºå‰‡å›æœ¬å®®ç´”å¦è£œä½ï½œä¸–æ‡‰ï¼š1â†”4ã€2â†”5ã€3â†”6</span>
        </div>
        
        <div class="row btns hide-print" style="gap:8px">
          <button id="btnRandomHex">éš¨æ©Ÿèµ·å¦</button>
        </div>
        
        <div class="row hide-print" style="gap:14px">
          <label>å•é¡Œ</label>
          <input id="question" type="text" placeholder="è«‹è¼¸å…¥èµ·å¦å•é¡Œ" value="ç¤ºä¾‹ï¼šæ±‚è²¡é‹">
        </div>
        
        <div class="row hide-print" style="gap:14px">
          <label>ç”¨ç¥</label>
          <select id="yongShen">
            <option value="">ï¼ˆæœªæŒ‡å®šï¼‰</option>
            <option value="çˆ¶æ¯">çˆ¶æ¯ (å­¸æ¥­/æ–‡æ›¸)</option>
            <option value="å…„å¼Ÿ">å…„å¼Ÿ (ç«¶çˆ­/åŠ«è²¡)</option>
            <option value="å®˜é¬¼">å®˜é¬¼ (äº‹æ¥­/ç–¾ç—…)</option>
            <option value="å¦»è²¡" selected>å¦»è²¡ (æ±‚è²¡/å¦»å­)</option>
            <option value="å­å­«">å­å­« (ç¦å¾·/è§£æ†‚)</option>
          </select>
          <span id="ysName" class="badge"></span>
        </div>

        <!-- ç—‡ç‹€è¼¸å…¥å€å¡Š -->
        <div class="row hide-print" style="gap:14px; margin-top:10px;">
          <label>ç—‡ç‹€æè¿°</label>
          <input id="symptoms" type="text" placeholder="å¯é¸ï¼šæè¿°å…·é«”ä¸é©ç—‡ç‹€ï¼ˆå¦‚ï¼šå¤±çœ ã€é ­ç—›ã€æ¶ˆåŒ–ä¸è‰¯ç­‰ï¼‰">
          <button id="btnAnalyzeSymptoms">åˆ†æç—‡ç‹€</button>
        </div>
        
        <div class="row hide-print" style="gap:14px">
          <label>æ™‚é–“</label>
          <input id="dt" type="datetime-local">
          <button id="btnNow">ç¾åœ¨</button>
          <button id="btnPrint">åˆ—å°ï¼ˆA4ï¼‰</button>
          <span class="muted">å››æŸ±ç”± Lunar.js ç²¾æº–æ›ç®—</span>
        </div>
        
        <div class="row pillars">
          <span id="gzYear">å¹´ï¼šâ€”</span>
          <span id="gzMonth">æœˆï¼šâ€”</span>
          <span id="gzDay">æ—¥ï¼šâ€”</span>
          <span id="gzHour">æ™‚ï¼šâ€”</span>
          <span id="gzXun">æ—¬é¦–ï¼šâ€”</span>
          <span id="gzKW">ç©ºäº¡ï¼šâ€”</span>
        </div>
        
        <div class="row hide-print">
          <label>å‹•çˆ»</label>
          <div class="yaoCtl" id="mvCtl"></div>
        </div>
        
        <div class="row hide-print" style="gap:10px">
          <button id="redraw">é‡ç¹ªå¦è±¡</button>
          <button id="download">åŒ¯å‡º PNG</button>
          <button id="btnUpdateRadar">æ›´æ–°é›·é”åœ–</button>
        </div>
        
        <!-- ç”¨ç¥åˆ†æé¡¯ç¤ºå€åŸŸ -->
        <div id="yongShenAnalysis"></div>
        
        <div class="canvasWrap">
          <canvas id="hexCanvas"></canvas>
        </div>
        
        <div id="noteBox" class="noteBox">
          <label for="userNote" style="display:block;margin:6px 0 4px;color:#0f172a;font-size:14px">å‚™è¨»ï¼ˆæœƒåˆ—å°ï¼‰</label>
          <textarea id="userNote" rows="5" placeholder="åœ¨æ­¤è¼¸å…¥è¦å°åœ¨å¦è±¡æ—çš„èªªæ˜ã€é‡é»ã€å•å¦èƒŒæ™¯ç­‰"></textarea>
        </div>
        
        <div class="row hide-print">
          <label>å¤§å°</label><input type="range" id="size" min="140" max="440" value="300"><span class="miniVal" id="sizeVal">300</span>
          <label>æ°´å¹³</label><input type="range" id="offx" min="-320" max="320" value="0"><span class="miniVal" id="offxVal">0</span>
          <label>å‚ç›´</label><input type="range" id="offy" min="-220" max="220" value="0"><span class="miniVal" id="offyVal">0</span>
          <label>çˆ»è·</label><input type="range" id="gap" min="26" max="38" value="32"><span class="miniVal" id="gapVal">32</span>
          <label>æ¬„é ­é–“è·</label><input type="range" id="headgap" min="16" max="48" value="24"><span class="miniVal" id="headgapVal">24</span>
        </div>
        
        <div class="muted">æ¬„åºï¼š<b>å…­ç¸</b>ï½œ<b>ä¼ç¥</b>ï½œ<b>çˆ»è±¡</b>ï½œ<b>å…­è¦ª</b>ï½œ<b>åœ°æ”¯</b>ï½œ<b>ä¸–æ‡‰</b>ï½œ<b>è®Šå…­è¦ª</b>ï½œ<b>è®Šæ”¯</b>ï¼ˆåˆçˆ»åœ¨ä¸‹ï¼›å‹•çˆ»ï¼šé™½â—‹ã€é™°Ã—ï¼‰ã€‚</div>
      </section>
      
      <section class="sec">
        <div id="w5_sec" class="w5-sec">
          <h3>äº”è¡Œé›·é”åœ–</h3>
          <div class="canvasWrap" style="overflow-x:visible;">
            <canvas id="w5_canv" style="min-width:auto; height:300px;"></canvas>
          </div>
          <div id="w5_ctrl">
            <div class="row"><label>æœ¨</label><input id="w5_mu" type="range" min="1" max="10" step="1" value="6"><span id="w5_muVal" class="miniVal">6</span></div>
            <div class="row"><label>ç«</label><input id="w5_huo" type="range" min="1" max="10" step="1" value="6"><span id="w5_huoVal" class="miniVal">6</span></div>
            <div class="row"><label>åœŸ</label><input id="w5_tu" type="range" min="1" max="10" step="1" value="6"><span id="w5_tuVal" class="miniVal">6</span></div>
            <div class="row"><label>é‡‘</label><input id="w5_jin" type="range" min="1" max="10" step="1" value="6"><span id="w5_jinVal" class="miniVal">6</span></div>
            <div class="row"><label>æ°´</label><input id="w5_shui" type="range" min="1" max="10" step="1" value="6"><span id="w5_shuiVal" class="miniVal">6</span></div>
          </div>
        </div>
        
        <div id="tcmBox" class="tcm-box">
          <h3>ä¸­é†«åˆ†ç§‘å»ºè­°</h3>
          <div id="tcmCore"></div>
          <div id="tcmLists"></div>
          <div class="tcm-note">â€» æœ¬æ¬„ç‚ºä¸€èˆ¬æ€§é¤Šç”Ÿèˆ‡å°±è¨ºå»ºè­°ï¼Œéé†«ç™‚è¨ºæ–·ï¼›è‹¥æœ‰æ€¥æ€§æˆ–æŒçºŒæ€§ä¸é©ï¼Œè«‹å„˜é€Ÿå°±é†«ã€‚</div>
        </div>
      </section>
    </div>
  </main>

  <script>
    // ==================== é›¶éŒ¢èµ·å¦ç³»çµ± ====================
    let coinResults = [null, null, null, null, null, null];
    let coinTossCount = 0;
    let isAnimating = false;

    // éŸ³æ•ˆç›¸é—œ
    function playCoinSound() {
      if (!document.getElementById('soundEnabled').checked) return;
      
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.type = 'sine';
        oscillator.frequency.value = 800 + Math.random() * 400;
        gainNode.gain.value = 0.1;
        
        oscillator.start();
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
        oscillator.stop(audioContext.currentTime + 0.5);
      } catch (e) {
        console.log('éŸ³æ•ˆæ’­æ”¾å¤±æ•—:', e);
      }
    }

    // æ“²é›¶éŒ¢å‡½æ•¸
    function tossCoins() {
      if (coinTossCount >= 6) {
        alert('å·²å®Œæˆå…­æ¬¡æ“²å¹£ï¼Œè«‹é»æ“Š"å¥—ç”¨å¦è±¡"æˆ–"é‡ç½®"å¾Œå†æ“²');
        return;
      }

      if (isAnimating) return;
      isAnimating = true;

      // æ’­æ”¾éŸ³æ•ˆ
      playCoinSound();

      // ç²å–ç¡¬å¹£å…ƒç´ 
      const coin1 = document.getElementById('coin1');
      const coin2 = document.getElementById('coin2');
      const coin3 = document.getElementById('coin3');

      // é‡ç½®ç¡¬å¹£ç‹€æ…‹
      coin1.className = 'coin';
      coin2.className = 'coin';
      coin3.className = 'coin';
      
      // å¼·åˆ¶é‡æ’ä»¥é‡ç½®å‹•ç•«
      void coin1.offsetWidth;
      void coin2.offsetWidth;
      void coin3.offsetWidth;

      // é–‹å§‹å‹•ç•«
      coin1.classList.add('spinning');
      coin2.classList.add('spinning');
      coin3.classList.add('spinning');

      // åœæ­¢å‹•ç•«ä¸¦é¡¯ç¤ºçµæœ
      setTimeout(() => {
        // åœæ­¢å‹•ç•«
        coin1.classList.remove('spinning');
        coin2.classList.remove('spinning');
        coin3.classList.remove('spinning');

        // æ¨¡æ“¬æ“²å¹£çµæœï¼ˆ1=é™½ï¼Œ0=é™°ï¼‰
        const results = [
          Math.random() > 0.5 ? 1 : 0,
          Math.random() > 0.5 ? 1 : 0,
          Math.random() > 0.5 ? 1 : 0
        ];

        // é¡¯ç¤ºç¡¬å¹£çµæœ
        coin1.textContent = results[0] ? 'é™½' : 'é™°';
        coin1.className = `coin-result ${results[0] ? 'yang' : 'yin'}`;

        coin2.textContent = results[1] ? 'é™½' : 'é™°';
        coin2.className = `coin-result ${results[1] ? 'yang' : 'yin'}`;

        coin3.textContent = results[2] ? 'é™½' : 'é™°';
        coin3.className = `coin-result ${results[2] ? 'yang' : 'yin'}`;

        // è¨ˆç®—çˆ»è±¡ï¼ˆä¸‰æšç¡¬å¹£çš„é™°é™½çµ„åˆï¼‰
        const yangCount = results.reduce((sum, val) => sum + val, 0);
        let yaoValue, yaoType;

        if (yangCount === 3) {
          yaoValue = 1; yaoType = 'è€é™½'; // ä¸‰é™½ç‚ºè€é™½ï¼ˆå‹•çˆ»ï¼‰
        } else if (yangCount === 2) {
          yaoValue = 0; yaoType = 'å°‘é™°'; // å…©é™½ä¸€é™°ç‚ºå°‘é™°
        } else if (yangCount === 1) {
          yaoValue = 1; yaoType = 'å°‘é™½'; // ä¸€é™½å…©é™°ç‚ºå°‘é™½
        } else {
          yaoValue = 0; yaoType = 'è€é™°'; // ä¸‰é™°ç‚ºè€é™°ï¼ˆå‹•çˆ»ï¼‰
        }

        // è¨˜éŒ„çµæœ
        coinResults[coinTossCount] = {
          value: yaoValue,
          type: yaoType,
          moving: yangCount === 3 || yangCount === 0 // è€é™½æˆ–è€é™°ç‚ºå‹•çˆ»
        };

        coinTossCount++;
        
        // æ›´æ–°é€²åº¦é¡¯ç¤º
        document.getElementById('coinProgress').textContent = `å·²æ“²ï¼š${coinTossCount}/6 æ¬¡`;
        
        // æ›´æ–°çˆ»è±¡é¡¯ç¤º
        updateCoinResultsDisplay();

        isAnimating = false;

        // å¦‚æœå·²å®Œæˆå…­æ¬¡æ“²å¹£ï¼Œæç¤ºç”¨æˆ¶
        if (coinTossCount === 6) {
          setTimeout(() => {
            alert('å·²å®Œæˆå…­æ¬¡æ“²å¹£ï¼Œè«‹é»æ“Š"å¥—ç”¨å¦è±¡"å°‡çµæœæ‡‰ç”¨åˆ°å¦ç›¤');
          }, 300);
        }
      }, 1000);
    }

    // è‡ªå‹•æ“²å…­æ¬¡é›¶éŒ¢
    function autoTossSixTimes() {
      resetCoins(); // å…ˆé‡ç½®
      
      function tossSequence(count) {
        if (count >= 6) {
          // å®Œæˆå¾Œè‡ªå‹•å¥—ç”¨
          setTimeout(() => {
            applyCoinResults();
          }, 500);
          return;
        }
        
        setTimeout(() => {
          tossCoins();
          tossSequence(count + 1);
        }, 1200); // æ¯æ¬¡æ“²å¹£é–“éš”
      }
      
      tossSequence(0);
    }

    // æ›´æ–°ç¡¬å¹£çµæœé¡¯ç¤º
    function updateCoinResultsDisplay() {
      const resultsContainer = document.getElementById('coinResults');
      resultsContainer.innerHTML = '';

      for (let i = 0; i < 6; i++) {
        const yaoDiv = document.createElement('div');
        yaoDiv.className = 'coin-yao';

        const yaoLine = document.createElement('div');
        yaoLine.className = 'yao-line';

        const yaoNumber = document.createElement('div');
        yaoNumber.className = 'yao-number';

        if (i < coinTossCount && coinResults[i]) {
          const result = coinResults[i];
          yaoLine.classList.add(result.value ? 'yang' : 'yin');
          yaoLine.textContent = result.type;
          yaoNumber.textContent = `${i+1}çˆ»`;

          if (result.moving) {
            yaoLine.style.boxShadow = '0 0 5px #ef4444';
            yaoLine.style.border = '2px solid #ef4444';
          }
        } else {
          yaoLine.style.background = '#e2e8f0';
          yaoLine.textContent = '?';
          yaoNumber.textContent = `${i+1}çˆ»`;
        }

        yaoDiv.appendChild(yaoLine);
        yaoDiv.appendChild(yaoNumber);
        resultsContainer.appendChild(yaoDiv);
      }
    }

    // é‡ç½®ç¡¬å¹£çµæœ
    function resetCoins() {
      coinResults = [null, null, null, null, null, null];
      coinTossCount = 0;
      isAnimating = false;

      // é‡ç½®ç¡¬å¹£é¡¯ç¤º
      const coins = [document.getElementById('coin1'), document.getElementById('coin2'), document.getElementById('coin3')];
      coins.forEach(coin => {
        coin.textContent = coin.id.replace('coin', '');
        coin.className = 'coin';
      });

      // é‡ç½®é€²åº¦
      document.getElementById('coinProgress').textContent = 'å·²æ“²ï¼š0/6 æ¬¡';

      updateCoinResultsDisplay();
    }

    // å¥—ç”¨ç¡¬å¹£çµæœåˆ°å¦ç›¤
    function applyCoinResults() {
      if (coinTossCount < 6) {
        alert('è«‹å…ˆå®Œæˆå…­æ¬¡æ“²å¹£ï¼');
        return;
      }

      // æ§‹å»ºå¦è±¡ï¼ˆå¾åˆçˆ»åˆ°ä¸Šçˆ»ï¼‰
      const lines = coinResults.map(result => result.value);
      const moving = coinResults.map(result => result.moving);

      // æ ¹æ“šå¦è±¡ç¢ºå®šä¸Šä¸‹å¦ï¼ˆä¸‹å¦=åˆäºŒä¸‰çˆ»ï¼Œä¸Šå¦=å››äº”å…­çˆ»ï¼‰
      const lowerBits = lines.slice(0, 3);
      const upperBits = lines.slice(3, 6);

      const lowerTrig = trigFromBits(lowerBits);
      const upperTrig = trigFromBits(upperBits);

      if (lowerTrig && upperTrig) {
        // è¨­ç½®ä¸Šä¸‹å¦
        document.getElementById('lower').value = lowerTrig;
        document.getElementById('upper').value = upperTrig;

        // è¨­ç½®å‹•çˆ»
        const mvCtlInputs = document.querySelectorAll('#mvCtl input[type="checkbox"][data-mv]');
        mvCtlInputs.forEach((cb, index) => {
          const movingIndex = 5 - index; // è½‰æ›ç´¢å¼•ï¼ˆå¦ç›¤é¡¯ç¤ºé †åºï¼‰
          cb.checked = moving[movingIndex];
          window.moving[movingIndex] = moving[movingIndex];
        });

        // æ›´æ–°å¦ç›¤
        render();

        // æ›´æ–°å•é¡Œæ¬„ä½
        document.getElementById('question').value = 'é›¶éŒ¢èµ·å¦';

        alert('å¦è±¡å·²å¥—ç”¨ï¼');
      } else {
        alert('ç„¡æ³•è§£æå¦è±¡ï¼Œè«‹é‡è©¦ï¼');
      }
    }

    // ==================== å¦ç›¤ç³»çµ±æ ¸å¿ƒä»£ç¢¼ ====================
    const E = (id) => document.getElementById(id);

    const GAN = ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'];
    const ZHI = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];
    const ZHI_ELEM = { å­: 'æ°´', ä¸‘: 'åœŸ', å¯…: 'æœ¨', å¯: 'æœ¨', è¾°: 'åœŸ', å·³: 'ç«', åˆ: 'ç«', æœª: 'åœŸ', ç”³: 'é‡‘', é…‰: 'é‡‘', æˆŒ: 'åœŸ', äº¥: 'æ°´' };
    const GONG_ELEM = { ä¹¾: 'é‡‘', å¤: 'åœŸ', éœ‡: 'æœ¨', å·½: 'æœ¨', å: 'æ°´', é›¢: 'ç«', è‰®: 'åœŸ', å…Œ: 'é‡‘' };
    const TRIG = { ä¹¾: [1,1,1], å…Œ: [1,1,0], é›¢: [1,0,1], éœ‡: [1,0,0], å·½: [0,1,1], å: [0,1,0], è‰®: [0,0,1], å¤: [0,0,0] };
    const TRINAMES = Object.keys(TRIG);
    const YANG_TRIG = new Set(['ä¹¾', 'éœ‡', 'å', 'è‰®']);
    const INNER_START = { ä¹¾: 'å­', å: 'å¯…', éœ‡: 'å­', è‰®: 'è¾°', å¤: 'æœª', å·½: 'ä¸‘', é›¢: 'å¯', å…Œ: 'å·³' };
    const OUTER_START = { ä¹¾: 'åˆ', å: 'ç”³', éœ‡: 'åˆ', è‰®: 'æˆŒ', å¤: 'ä¸‘', å·½: 'æœª', é›¢: 'é…‰', å…Œ: 'äº¥' };
    const SEQ_YANG = ['å­', 'å¯…', 'è¾°', 'åˆ', 'ç”³', 'æˆŒ'];
    const SEQ_YIN = ['äº¥', 'é…‰', 'æœª', 'å·³', 'å¯', 'ä¸‘'];
    const SIX = ['é’é¾', 'æœ±é›€', 'å‹¾é™³', 'è£è›‡', 'ç™½è™', 'ç„æ­¦'];
    const SIX_START_BY_GAN = { ç”²: 0, ä¹™: 0, ä¸™: 1, ä¸: 1, æˆŠ: 2, å·±: 3, åºš: 4, è¾›: 4, å£¬: 5, ç™¸: 5 };
    const WU_SHENG = { æœ¨: 'ç«', ç«: 'åœŸ', åœŸ: 'é‡‘', é‡‘: 'æ°´', æ°´: 'æœ¨' };
    const WU_KE = { æœ¨: 'åœŸ', åœŸ: 'æ°´', æ°´: 'ç«', ç«: 'é‡‘', é‡‘: 'æœ¨' };
    const YS_KIN = ['çˆ¶æ¯', 'å…„å¼Ÿ', 'å®˜é¬¼', 'å¦»è²¡', 'å­å­«'];

    // å…¨å±€ moving æ•¸çµ„
    window.moving = [false, false, false, false, false, false];

    function getYSFiveElementMap(meElem) { 
      return { 
        'çˆ¶æ¯': WU_SHENG[meElem], 
        'å…„å¼Ÿ': meElem, 
        'å®˜é¬¼': WU_KE[meElem], 
        'å¦»è²¡': WU_KE[WU_SHENG[meElem]], 
        'å­å­«': WU_SHENG[WU_KE[meElem]] 
      }; 
    }

    function trigFromBits(b3) { 
      for (const n of TRINAMES) { 
        const t = TRIG[n]; 
        if (t[0] === b3[0] && t[1] === b3[1] && t[2] === b3[2]) return n; 
      } 
      return null; 
    }

    function upperLowerOf(lines) { 
      const lo = trigFromBits(lines.slice(0, 3)), up = trigFromBits(lines.slice(3, 6)); 
      return { up, lo }; 
    }

    function guaNameOf(up, lo) { 
      const guaMap = {
        "ä¹¾ä¹¾": "ä¹¾ç‚ºå¤©", "å…Œå…Œ": "å…Œç‚ºæ¾¤", "é›¢é›¢": "é›¢ç‚ºç«", "éœ‡éœ‡": "éœ‡ç‚ºé›·",
        "å·½å·½": "å·½ç‚ºé¢¨", "åå": "åç‚ºæ°´", "è‰®è‰®": "è‰®ç‚ºå±±", "å¤å¤": "å¤ç‚ºåœ°",
        "ä¹¾å¤": "å¤©åœ°å¦", "ä¹¾å…Œ": "å¤©æ¾¤å±¥", "ä¹¾é›¢": "å¤©ç«åŒäºº", "ä¹¾éœ‡": "å¤©é›·ç„¡å¦„",
        "ä¹¾å·½": "å¤©é¢¨å§¤", "ä¹¾å": "å¤©æ°´è¨Ÿ", "ä¹¾è‰®": "å¤©å±±é¯", "å…Œä¹¾": "æ¾¤å¤©å¤¬",
        "å…Œå¤": "æ¾¤åœ°èƒ", "å…Œé›¢": "æ¾¤ç«é©", "å…Œéœ‡": "æ¾¤é›·éš¨", "å…Œå·½": "æ¾¤é¢¨å¤§é",
        "å…Œå": "æ¾¤æ°´å›°", "å…Œè‰®": "æ¾¤å±±å’¸", "é›¢ä¹¾": "ç«å¤©å¤§æœ‰", "é›¢å¤": "ç«åœ°æ™‰",
        "é›¢å…Œ": "ç«æ¾¤ç½", "é›¢éœ‡": "ç«é›·å™¬å—‘", "é›¢å·½": "ç«é¢¨é¼", "é›¢å": "ç«æ°´æœªæ¿Ÿ",
        "é›¢è‰®": "ç«å±±æ—…", "éœ‡ä¹¾": "é›·å¤©å¤§å£¯", "éœ‡å¤": "é›·åœ°è±«", "éœ‡å…Œ": "é›·æ¾¤æ­¸å¦¹",
        "éœ‡é›¢": "é›·ç«è±", "éœ‡å·½": "é›·é¢¨æ†", "éœ‡å": "é›·æ°´è§£", "éœ‡è‰®": "é›·å±±å°é",
        "å·½ä¹¾": "é¢¨å¤©å°ç•œ", "å·½å¤": "é¢¨åœ°è§€", "å·½å…Œ": "é¢¨æ¾¤ä¸­å­š", "å·½é›¢": "é¢¨ç«å®¶äºº",
        "å·½éœ‡": "é¢¨é›·ç›Š", "å·½å": "é¢¨æ°´æ¸™", "å·½è‰®": "é¢¨å±±æ¼¸", "åä¹¾": "æ°´å¤©éœ€",
        "åå¤": "æ°´åœ°æ¯”", "åå…Œ": "æ°´æ¾¤ç¯€", "åé›¢": "æ°´ç«æ—¢æ¿Ÿ", "åéœ‡": "æ°´é›·å±¯",
        "åå·½": "æ°´é¢¨äº•", "åè‰®": "æ°´å±±è¹‡", "è‰®ä¹¾": "å±±å¤©å¤§ç•œ", "è‰®å¤": "å±±åœ°å‰",
        "è‰®å…Œ": "å±±æ¾¤æ", "è‰®é›¢": "å±±ç«è³", "è‰®éœ‡": "å±±é›·é ¤", "è‰®å·½": "å±±é¢¨è ±",
        "è‰®å": "å±±æ°´è’™"
      };
      return guaMap[up + lo] || `${up}${lo}å¦`;
    }

    const toYMDhm = d => { 
      const z = n => (n < 10 ? '0' + n : n); 
      return `${d.getFullYear()}-${z(d.getMonth() + 1)}-${z(d.getDate())}T${z(d.getHours())}:${z(d.getMinutes())}`; 
    };

    function threeBranchesOfTrigram(tri, inner) { 
      const start = inner ? INNER_START[tri] : OUTER_START[tri]; 
      const seq = YANG_TRIG.has(tri) ? SEQ_YANG : SEQ_YIN; 
      const i0 = seq.indexOf(start); 
      return [seq[i0 % 6], seq[(i0 + 1) % 6], seq[(i0 + 2) % 6]]; 
    }

    function naJiaBranches(lines) { 
      const { up, lo } = upperLowerOf(lines); 
      return [...threeBranchesOfTrigram(lo, true), ...threeBranchesOfTrigram(up, false)]; 
    }

    function sixKin(meElem, branch) { 
      const e = ZHI_ELEM[branch] || 'åœŸ'; 
      if (e === meElem) return 'å…„å¼Ÿ'; 
      if (WU_KE[e] === meElem) return 'å®˜é¬¼'; 
      if (WU_KE[meElem] === e) return 'å¦»è²¡'; 
      if (WU_SHENG[e] === meElem) return 'çˆ¶æ¯'; 
      if (WU_SHENG[meElem] === e) return 'å­å­«'; 
      return 'å…„å¼Ÿ'; 
    }

    function changedLines(lines, moving) { 
      return lines.map((v, i) => moving[i] ? (v ? 0 : 1) : v); 
    }

    // ==================== å¢å¼·ç‰ˆä¸­é†« API ç³»çµ± ====================
    class EnhancedTCMSystem {
        constructor() {
            this.baseURL = '/api/analyze'; // æ‚¨çš„å¾Œç«¯ API åœ°å€
        }

        async getDetailedTCMAdvice(meElem, w5Scores, symptoms = [], userInfo = {}) {
            try {
                const response = await fetch(this.baseURL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'detailed_tcm_analysis',
                        constitution: meElem,
                        element_balance: w5Scores,
                        symptoms: symptoms,
                        user_info: userInfo,
                        timestamp: new Date().toISOString()
                    })
                });

                if (!response.ok) {
                    throw new Error(`å¾Œå°æœå‹™éŒ¯èª¤: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.success && data.data) {
                    return this.formatDetailedResponse(data.data);
                } else {
                    return this.getLocalTCMAdvice(meElem);
                }
                
            } catch (error) {
                console.error('ä¸­é†«å¾Œå°é€£æ¥å¤±æ•—:', error);
                return this.getLocalTCMAdvice(meElem);
            }
        }

        formatDetailedResponse(data) {
            return {
                constitution: data.constitution || '',
                zang_fu: data.zang_fu || {},
                diagnosis: data.patterns || [],
                syndrome_analysis: data.syndrome_analysis || '',
                risk_factors: data.risk_factors || [],
                recommended_departments: data.recommended_departments || [],
                herbal_prescriptions: data.herbal_prescriptions || [],
                acupuncture_points: data.acupuncture_points || [],
                lifestyle_advice: data.lifestyle_advice || [],
                diet_recommendations: data.diet_recommendations || [],
                exercise_suggestions: data.exercise_suggestions || [],
                seasonal_advice: data.seasonal_advice || {},
                urgent_advice: data.urgent_advice || [],
                professional_recommendations: data.professional_recommendations || []
            };
        }

        async submitSymptoms(symptoms, userInfo = {}) {
            try {
                const response = await fetch(this.baseURL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'submit_symptoms',
                        symptoms: symptoms,
                        user_info: userInfo,
                        timestamp: new Date().toISOString()
                    })
                });
                
                return await response.json();
            } catch (error) {
                console.error('ç—‡ç‹€æäº¤å¤±æ•—:', error);
                return { success: false, error: 'ç¶²çµ¡é€£æ¥å¤±æ•—' };
            }
        }

        async getHerbDetails(herbName) {
            try {
                const response = await fetch(this.baseURL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'get_herb_details',
                        herb_name: herbName
                    })
                });
                
                const data = await response.json();
                return data.success ? data.data : null;
            } catch (error) {
                console.error('è—¥æè©³æƒ…ç²å–å¤±æ•—:', error);
                return null;
            }
        }

        getLocalTCMAdvice(meElem) {
            const MAP = {
                'æœ¨': { 
                    zang: 'è‚', fu: 'è†½', 
                    dept: ['è‚è†½ç§‘', 'æƒ…å¿—ç§‘', 'ç¡çœ é–€è¨º', 'éª¨ç§‘/å¾©å¥ç§‘'], 
                    patterns: ['è‚æ°£é¬±çµ', 'è‚ç«ä¸Šç‚', 'è‚è¡€ä¸è¶³', 'è‚è…é™°è™›', 'è‚é™½ä¸Šäº¢'], 
                    self: ['è¦å¾‹ä½œæ¯ã€èˆ’å±•æ‹‰ç­‹', 'å°‘é…’è¾£èˆ‡ç†¬å¤œ', 'æƒ…å¿—èˆ’è§£ï¼ˆæ•£æ­¥ã€å†¥æƒ³ï¼‰'],
                    diet: ['ç¶ è‰²è”¬èœ', 'é…¸å‘³é£Ÿç‰©', 'æ¸æ', 'èŠèŠ±èŒ¶'],
                    warning: 'æ³¨æ„æƒ…ç·’æ³¢å‹•ï¼Œé¿å…éåº¦å‹ç´¯'
                },
                'ç«': { 
                    zang: 'å¿ƒ', fu: 'å°è…¸', 
                    dept: ['å¿ƒè¡€ç®¡', 'èº«å¿ƒ/ç¡çœ '], 
                    patterns: ['å¿ƒç«äº¢ç››', 'å¿ƒè„¾å…©è™›', 'å¿ƒé™°ä¸è¶³'], 
                    self: ['å°‘å’–å•¡é…’ç²¾', 'æ¸›å°‘ç†¬å¤œèˆ‡é‡é¹¹', 'åˆé–“å°æ†©ã€æ¸…å¿ƒå®‰ç¥'] 
                },
                'åœŸ': { 
                    zang: 'è„¾', fu: 'èƒƒ', 
                    dept: ['è„¾èƒƒæ¶ˆåŒ–', 'å…§åˆ†æ³Œ/ä»£è¬'], 
                    patterns: ['è„¾èƒƒè™›å¼±', 'æ¿•å›°è„¾èƒƒ', 'èƒƒæ°£ä¸Šé€†'], 
                    self: ['å°‘å†°å†·ç”œè†©', 'ä¸‰é¤å®šæ™‚å°‘é‡å¤šé¤', 'è…¹å¼å‘¼å¸ã€é£¯å¾Œæ­¥è¡Œ'] 
                },
                'é‡‘': { 
                    zang: 'è‚º', fu: 'å¤§è…¸', 
                    dept: ['å‘¼å¸éæ•', 'çš®è†š', 'è€³é¼»å–‰'], 
                    patterns: ['è‚ºæ°£è™›', 'è‚ºé™°è™›', 'é¢¨å¯’/é¢¨ç†±çŠ¯è‚º'], 
                    self: ['é¿å…éæ•æº', 'é©åº¦è’¸æ°£/ä¿æ¿•', 'æ—©ç¡æ—©èµ·ã€ç·´å‘¼å¸'] 
                },
                'æ°´': { 
                    zang: 'è…', fu: 'è†€èƒ±', 
                    dept: ['è…æ³Œå°¿', 'å…§ç§‘é«”è³ª'], 
                    patterns: ['è…é™½è™›', 'è…é™°è™›', 'è…æ°£ä¸è¶³'], 
                    self: ['ä¿æš–è…°è…¹èˆ‡è¶³éƒ¨', 'è¦å¾‹ä½œæ¯ã€æ—©ç¡', 'æº«å’Œä¼¸å±•èˆ‡è£œæ°´'] 
                }
            };
            return MAP[meElem] || MAP['åœŸ'];
        }
    }

    // åˆå§‹åŒ–å¢å¼·ç‰ˆä¸­é†«ç³»çµ±
    let tcmSystem = new EnhancedTCMSystem();

    // æ›´æ–°ä¸­é†«å»ºè­°é¡¯ç¤ºå‡½æ•¸
    async function updateTCMAdvice(meElem, w5Scores) {
        const core = document.getElementById('tcmCore');
        const lists = document.getElementById('tcmLists');
        
        if (!core || !lists) return;

        core.innerHTML = '<span class="tag">åˆ†æä¸­...</span>';
        lists.innerHTML = '<p>æ­£åœ¨é€£æ¥ä¸­é†«æ•¸æ“šåº«...</p>';

        try {
            const advice = await tcmSystem.getDetailedTCMAdvice(meElem, w5Scores);
            displayDetailedTCMAdvice(advice, meElem);
        } catch (error) {
            console.error('ä¸­é†«å»ºè­°ç²å–å¤±æ•—:', error);
            const localAdvice = tcmSystem.getLocalTCMAdvice(meElem);
            displayTCMAdvice(localAdvice, meElem);
        }
    }

    // é¡¯ç¤ºè©³ç´°ä¸­é†«å»ºè­°
    function displayDetailedTCMAdvice(advice, meElem) {
        const core = document.getElementById('tcmCore');
        const lists = document.getElementById('tcmLists');
        
        let tags = `<span class="tag">å¦å®®äº”è¡Œï¼š${meElem}</span>`;
        
        if (advice.zang_fu && advice.zang_fu.zang) {
            tags += `<span class="tag">è‡Ÿè…‘ï¼š${advice.zang_fu.zang}ï¼${advice.zang_fu.fu}</span>`;
        }
        
        if (advice.constitution) {
            tags += `<span class="tag">é«”è³ªï¼š${advice.constitution}</span>`;
        }
        
        core.innerHTML = tags;

        let html = '';
        
        if (advice.diagnosis && advice.diagnosis.length > 0) {
            html += `<div class="blk"><h4>ğŸ§¬ è¾¨è­‰è¨ºæ–·</h4><ul>`;
            html += advice.diagnosis.map(pattern => `<li>${pattern}</li>`).join('');
            html += `</ul></div>`;
        }

        if (advice.risk_factors && advice.risk_factors.length > 0) {
            html += `<div class="blk"><h4>âš ï¸ æ½›åœ¨é¢¨éšª</h4><ul>`;
            html += advice.risk_factors.map(risk => `<li>${risk}</li>`).join('');
            html += `</ul></div>`;
        }

        if (advice.recommended_departments && advice.recommended_departments.length > 0) {
            html += `<div class="blk"><h4>ğŸ¥ å»ºè­°å°±è¨ºç§‘åˆ¥</h4><ul>`;
            html += advice.recommended_departments.map(dept => `<li>${dept}</li>`).join('');
            html += `</ul></div>`;
        }

        if (advice.herbal_prescriptions && advice.herbal_prescriptions.length > 0) {
            html += `<div class="blk"><h4>ğŸŒ¿ ä¸­è—¥å»ºè­°ï¼ˆåƒè€ƒï¼‰</h4><ul>`;
            html += advice.herbal_prescriptions.map(herb => 
                `<li><span class="herb-name" data-herb="${herb.name}">${herb.name}</span> - ${herb.function || ''}</li>`
            ).join('');
            html += `</ul></div>`;
        }

        if (advice.acupuncture_points && advice.acupuncture_points.length > 0) {
            html += `<div class="blk"><h4>ğŸ“ é‡ç¸ç©´ä½å»ºè­°</h4><ul>`;
            html += advice.acupuncture_points.map(point => `<li>${point}</li>`).join('');
            html += `</ul></div>`;
        }

        if (advice.lifestyle_advice && advice.lifestyle_advice.length > 0) {
            html += `<div class="blk"><h4>ğŸ’ª ç”Ÿæ´»èª¿é¤Š</h4><ul>`;
            html += advice.lifestyle_advice.map(advice => `<li>${advice}</li>`).join('');
            html += `</ul></div>`;
        }

        if (advice.diet_recommendations && advice.diet_recommendations.length > 0) {
            html += `<div class="blk"><h4>ğŸ é£²é£Ÿå»ºè­°</h4><ul>`;
            html += advice.diet_recommendations.map(food => `<li>${food}</li>`).join('');
            html += `</ul></div>`;
        }

        if (advice.exercise_suggestions && advice.exercise_suggestions.length > 0) {
            html += `<div class="blk"><h4>ğŸš¶ é‹å‹•å»ºè­°</h4><ul>`;
            html += advice.exercise_suggestions.map(exercise => `<li>${exercise}</li>`).join('');
            html += `</ul></div>`;
        }

        if (advice.urgent_advice && advice.urgent_advice.length > 0) {
            html += `<div class="blk" style="border-left: 4px solid #ef4444; padding-left: 12px;">
                    <h4>ğŸš¨ é‡è¦æé†’</h4><ul>`;
            html += advice.urgent_advice.map(urgent => `<li style="color: #ef4444;">${urgent}</li>`).join('');
            html += `</ul></div>`;
        }

        lists.innerHTML = html;
        bindHerbDetailsEvents();
    }

    // ç¶å®šè—¥æè©³æƒ…äº‹ä»¶
    function bindHerbDetailsEvents() {
        document.querySelectorAll('.herb-name').forEach(herbElement => {
            herbElement.addEventListener('click', async function() {
                const herbName = this.dataset.herb;
                const details = await tcmSystem.getHerbDetails(herbName);
                
                if (details) {
                    showHerbDetailsModal(herbName, details);
                } else {
                    alert(`æš«ç„¡ ${herbName} çš„è©³ç´°è³‡æ–™`);
                }
            });
        });
    }

    // é¡¯ç¤ºè—¥æè©³æƒ…å½ˆçª—
    function showHerbDetailsModal(herbName, details) {
        const modalHTML = `
            <div style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; z-index:10000;">
                <div style="background:white; padding:20px; border-radius:10px; max-width:500px; max-height:80vh; overflow-y:auto;">
                    <h3>ğŸŒ¿ ${herbName}</h3>
                    ${details.properties ? `<p><strong>æ€§å‘³æ­¸ç¶“ï¼š</strong>${details.properties}</p>` : ''}
                    ${details.functions ? `<p><strong>åŠŸæ•ˆï¼š</strong>${details.functions}</p>` : ''}
                    ${details.usage ? `<p><strong>ç”¨æ³•ç”¨é‡ï¼š</strong>${details.usage}</p>` : ''}
                    ${details.precautions ? `<p><strong>æ³¨æ„äº‹é …ï¼š</strong>${details.precautions}</p>` : ''}
                    <button onclick="this.parentElement.parentElement.remove()" style="margin-top:10px; padding:5px 10px;">é—œé–‰</button>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    // åˆ†æç—‡ç‹€å‡½æ•¸
    async function analyzeSymptoms() {
        const symptomsInput = document.getElementById('symptoms');
        const symptoms = symptomsInput.value.trim();
        
        if (!symptoms) {
            alert('è«‹è¼¸å…¥ç—‡ç‹€æè¿°');
            return;
        }
        
        try {
            const result = await tcmSystem.submitSymptoms([symptoms]);
            
            if (result.success) {
                alert('ç—‡ç‹€å·²æäº¤åˆ†æï¼Œå»ºè­°å·²æ›´æ–°ï¼');
                const meElem = window.__lastMeElem;
                const w5Scores = getCurrentW5Scores();
                if (meElem) {
                    updateTCMAdvice(meElem, w5Scores);
                }
            } else {
                alert('ç—‡ç‹€åˆ†æå¤±æ•—ï¼š' + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
            }
        } catch (error) {
            alert('ç—‡ç‹€åˆ†æé€£æ¥å¤±æ•—');
        }
    }

    // ç²å–ç•¶å‰äº”è¡Œåˆ†æ•¸
    function getCurrentW5Scores() {
        return {
            'æœ¨': parseInt(document.getElementById('w5_mu').value),
            'ç«': parseInt(document.getElementById('w5_huo').value),
            'åœŸ': parseInt(document.getElementById('w5_tu').value),
            'é‡‘': parseInt(document.getElementById('w5_jin').value),
            'æ°´': parseInt(document.getElementById('w5_shui').value)
        };
    }

    // é¡¯ç¤ºæœ¬åœ°ä¸­é†«å»ºè­°ï¼ˆå‚™ç”¨ï¼‰
    function displayTCMAdvice(advice, meElem) {
        const core = document.getElementById('tcmCore');
        const lists = document.getElementById('tcmLists');
        
        let tags = `<span class="tag">å¦å®®äº”è¡Œï¼š${meElem}</span>`;
        
        if (advice.zang && advice.fu) {
            tags += `<span class="tag">è‡Ÿè…‘ï¼š${advice.zang}ï¼${advice.fu}</span>`;
        }
        
        core.innerHTML = tags;

        let html = '';
        
        if (advice.dept && advice.dept.length > 0) {
            html += `<div class="blk"><h4>å»ºè­°å°±è¨ºç§‘åˆ¥</h4><ul>`;
            html += advice.dept.map(dept => `<li>${dept}</li>`).join('');
            html += `</ul></div>`;
        }

        if (advice.patterns && advice.patterns.length > 0) {
            html += `<div class="blk"><h4>å¸¸è¦‹é«”è³ªï¼ç—‡å€™ï¼ˆåƒè€ƒï¼‰</h4><ul>`;
            html += advice.patterns.map(pattern => `<li>${pattern}</li>`).join('');
            html += `</ul></div>`;
        }

        if (advice.self && advice.self.length > 0) {
            html += `<div class="blk"><h4>æ—¥å¸¸èª¿é¤Šå»ºè­°</h4><ul>`;
            html += advice.self.map(self => `<li>${self}</li>`).join('');
            html += `</ul></div>`;
        }

        lists.innerHTML = html;
    }

    // ==================== ç”¨ç¥ä¸–æ‡‰åˆ†æç³»çµ± ====================
    function analyzeYongShenWithShiYing(yongShen, shiPosition, yingPosition, sixKin, moving) {
        const analysis = {
            ç”¨ç¥: yongShen,
            ä¸–çˆ»ä½ç½®: shiPosition,
            æ‡‰çˆ»ä½ç½®: yingPosition,
            ç”¨ç¥å¼·å¼±: 'ä¸­ç­‰',
            å»ºè­°: []
        };

        const yongShenAtShi = sixKin[6-shiPosition] === yongShen;
        const yongShenAtYing = sixKin[6-yingPosition] === yongShen;
        
        if (yongShenAtShi) {
            analysis.ç”¨ç¥å¼·å¼± = 'å¼·';
            analysis.å»ºè­°.push('ç”¨ç¥æŒä¸–ï¼Œäº‹æ˜“æˆ');
        } else if (yongShenAtYing) {
            analysis.ç”¨ç¥å¼·å¼± = 'ä¸­ç­‰';
            analysis.å»ºè­°.push('ç”¨ç¥åœ¨æ‡‰çˆ»ï¼Œéœ€çœ‹ä»–äººåŠ©åŠ›');
        }

        const yongShenMoving = sixKin.some((kin, index) => 
            kin === yongShen && moving[index]
        );
        
        if (yongShenMoving) {
            analysis.ç”¨ç¥å¼·å¼± = 'å‹•æ…‹è®ŠåŒ–';
            analysis.å»ºè­°.push('ç”¨ç¥ç™¼å‹•ï¼Œäº‹æœ‰è®Šå‹•');
        }

        return analysis;
    }

    function displayYongShenAnalysis(analysis) {
        const analysisHTML = `
            <div class="yongShenAnalysis">
                <h4>ç”¨ç¥åˆ†æ</h4>
                <p><strong>ç”¨ç¥ï¼š</strong>${analysis.ç”¨ç¥}</p>
                <p><strong>å¼·å¼±ï¼š</strong>${analysis.ç”¨ç¥å¼·å¼±}</p>
                <p><strong>å»ºè­°ï¼š</strong>${analysis.å»ºè­°.join('ï¼›')}</p>
            </div>
        `;
        
        const analysisDiv = document.getElementById('yongShenAnalysis');
        analysisDiv.innerHTML = analysisHTML;
    }

    // ==================== å¦ç›¤ç¹ªè£½ç³»çµ± ====================
    let pillars = null;
    function calcPillarsAndSix() {
      const s = E('dt').value; 
      const dt = s ? new Date(s) : new Date();
      const lunar = Lunar.fromDate(dt);
      pillars = { 
        year: lunar.getYearInGanZhiExact(), 
        month: lunar.getMonthInGanZhiExact(), 
        day: lunar.getDayInGanZhiExact(), 
        hour: lunar.getTimeInGanZhi() 
      };
      const dayGan = pillars.day.charAt(0);
      E('gzYear').textContent = `å¹´ï¼š${pillars.year}`; 
      E('gzMonth').textContent = `æœˆï¼š${pillars.month}`;
      E('gzDay').textContent = `æ—¥ï¼š${pillars.day}`; 
      E('gzHour').textContent = `æ™‚ï¼š${pillars.hour}`;
      E('gzXun').textContent = `æ—¬é¦–ï¼š${lunar.getDayXun()}`;
      E('gzKW').textContent = `ç©ºäº¡ï¼š${lunar.getDayXunKong()}`;
      const startIdx = SIX_START_BY_GAN[dayGan] ?? 0;
      return [0, 1, 2, 3, 4, 5].map(i => SIX[(startIdx + i) % 6]);
    }

    let cvs, ctx, DPR = 1;
    function setupCanvas() { 
      cvs = E('hexCanvas'); 
      ctx = cvs.getContext('2d'); 
      DPR = window.devicePixelRatio || 1; 
      cvs.width = Math.max(1, Math.floor(cvs.clientWidth * DPR)); 
      cvs.height = Math.max(1, Math.floor(cvs.clientHeight * DPR)); 
      ctx.setTransform(DPR, 0, 0, DPR, 0, 0); 
    }

    function drawWhiteTag(x, y, text) { 
      ctx.font = '14px "Noto Sans TC","Microsoft JhengHei"'; 
      const pad = 6, h = 20, w = ctx.measureText(text).width + pad * 2; 
      const pa = ctx.textAlign, pb = ctx.textBaseline; 
      ctx.textAlign = 'center'; 
      ctx.textBaseline = 'middle'; 
      ctx.fillStyle = 'rgba(255,255,255,.96)'; 
      ctx.fillRect(x - w / 2, y - h / 2, w, h); 
      ctx.fillStyle = '#0f172a'; 
      ctx.fillText(text, x, y + 1); 
      ctx.textAlign = pa; 
      ctx.textBaseline = pb; 
    }

    function drawBoard(meta, rows) {
      setupCanvas(); 
      const W = cvs.clientWidth, H = cvs.clientHeight; 
      ctx.clearRect(0, 0, W, H); 
      ctx.fillStyle = '#0f172a';
      
      ctx.font = 'bold 18px "Noto Sans TC","Microsoft JhengHei",sans-serif'; 
      ctx.fillText(`å•é¡Œï¼š${meta.q}`, 12, 26);
      ctx.font = '15px "Noto Sans TC","Microsoft JhengHei",sans-serif'; 
      ctx.fillText(`èµ·å¦ï¼š${meta.dt}`, 12, 48);
      ctx.fillText(`å››æŸ±ï¼š${meta.gzY}ã€€${meta.gzM}ã€€${meta.gzD}ã€€${meta.gzH}ã€€ï¼ˆæ—¬é¦–ï¼š${meta.xun}ã€€ç©ºäº¡ï¼š${meta.kw}ï¼‰`, 12, 70);
      ctx.fillText(`å¦åï¼š${meta.name}ã€€ä¸Šå¦ï¼š${meta.up}ã€€ä¸‹å¦ï¼š${meta.lo}ã€€å¦å®®ï¼š${meta.gong}ã€€å¦å‹ï¼š${meta.kind}ã€€ä¸–ï¼š${meta.shi}ã€€æ‡‰ï¼š${meta.ying} ${meta.ysTxt ? `ï½œç”¨ç¥ï¼š${meta.ysTxt}` : ''}`, 12, 92);
      
      const size = +E('size').value, offx = +E('offx').value, offy = +E('offy').value, gap = +E('gap').value, rowOffset = +E('headgap').value;
      E('sizeVal').textContent = size; E('offxVal').textContent = offx; E('offyVal').textContent = offy; E('gapVal').textContent = gap; E('headgapVal').textContent = rowOffset;
      
      const x0 = 16 + offx, y0 = 120 + offy, headerY = y0 - 8; 
      const yaoX1 = x0 + 120, yaoX2 = yaoX1 + size; 
      const col = { 
        six: x0, fu: x0 + 76, yao: yaoX1, kin: yaoX2 + 30, zhi: yaoX2 + 98, 
        mark: yaoX2 + 160, kinc: yaoX2 + 220, zhic: yaoX2 + 290 
      };
      
      ctx.textAlign = 'left'; ctx.textBaseline = 'alphabetic'; ctx.fillStyle = '#475569'; ctx.font = 'bold 13px "Noto Sans TC","Microsoft JhengHei"';
      Object.entries({ å…­ç¸: col.six, ä¼ç¥: col.fu, çˆ»è±¡: col.yao, å…­è¦ª: col.kin, åœ°æ”¯: col.zhi, ä¸–æ‡‰: col.mark, è®Šå…­è¦ª: col.kinc, è®Šæ”¯: col.zhic }).forEach(([k, v]) => ctx.fillText(k, v, headerY));
      
      ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(x0, headerY + 8); ctx.lineTo(yaoX2 + 320, headerY + 8); ctx.stroke();
      ctx.lineWidth = 6; ctx.strokeStyle = '#111827'; ctx.fillStyle = '#0f172a';
      
      rows.forEach((r, idx) => {
        const y = y0 + rowOffset + idx * gap; 
        ctx.font = '14px "Noto Sans TC","Microsoft JhengHei"'; 
        ctx.fillText(r.six || 'â€”', col.six, y + 5); 
        ctx.textAlign = 'center'; 
        ctx.fillText(r.fu ? '' : 'â€”', col.fu, y + 5); 
        ctx.textAlign = 'left';
        
        if (r.yy === 1) { 
          ctx.beginPath(); ctx.moveTo(col.yao, y); ctx.lineTo(col.yao + size, y); ctx.stroke(); 
        } else { 
          const g = size * 0.22, seg = (size - g) / 2; 
          ctx.beginPath(); ctx.moveTo(col.yao, y); ctx.lineTo(col.yao + seg, y); ctx.moveTo(col.yao + seg + g, y); ctx.lineTo(col.yao + size, y); ctx.stroke(); 
        }
        
        if (r.mv) {
          ctx.fillStyle = '#ef4444';
          ctx.font = 'bold 16px "Noto Sans TC","Microsoft JhengHei"';
          ctx.fillText(r.yy === 1 ? 'â—‹' : 'Ã—', col.yao + size + 12, y + 6);
          ctx.fillStyle = '#0f172a';
          ctx.font = '14px "Noto Sans TC","Microsoft JhengHei"';
        }
        
        ctx.fillText(r.kin || 'â€”', col.kin, y + 5); 
        ctx.fillText(r.zhi || 'â€”', col.zhi, y + 5);
        
        if (r.fu) drawWhiteTag(col.fu, y, r.fu); 
        if (r.mark) drawWhiteTag(col.mark, y, r.mark); 
        if (r.kinc) drawWhiteTag(col.kinc, y, r.kinc); 
        if (r.zhic) drawWhiteTag(col.zhic, y, r.zhic);
      });
    }

    function calculateYongShenWuxingScores(yongShen, monthZhi, dayZhi, meElem, baseBranches, moving) {
      const scores = { æœ¨: 6, ç«: 6, åœŸ: 6, é‡‘: 6, æ°´: 6 }; 
      const ysKinElemMap = getYSFiveElementMap(meElem); 
      const targetElem = ysKinElemMap[yongShen]; 
      if (!targetElem) return { scores, targetElem: '' };
      
      let factor = 0; 
      const monthElem = ZHI_ELEM[monthZhi.charAt(1)]; 
      const dayElem = ZHI_ELEM[dayZhi.charAt(1)];
      
      if (monthElem === targetElem || WU_SHENG[monthElem] === targetElem) factor += 3; 
      else if (WU_KE[monthElem] === targetElem) factor -= 3;
      
      if (dayElem === targetElem || WU_SHENG[dayElem] === targetElem) factor += 2; 
      else if (WU_KE[dayElem] === targetElem) factor -= 2;
      
      baseBranches.forEach((branch, i) => { 
        if (moving[i]) { 
          const moveElem = ZHI_ELEM[branch]; 
          if (moveElem === targetElem || WU_SHENG[moveElem] === targetElem) factor += 1.5; 
          else if (WU_KE[moveElem] === targetElem) factor -= 1.5; 
        } 
      });
      
      scores[targetElem] = Math.min(10, Math.max(1, 6 + factor)); 
      E('ysName').textContent = `${yongShen} (${targetElem} ${scores[targetElem].toFixed(1)})`;
      return { scores, targetElem };
    }

    function updateW5RadarScores(scores) {
      if (!scores) return; 
      const map = { 'æœ¨': 'mu', 'ç«': 'huo', 'åœŸ': 'tu', 'é‡‘': 'jin', 'æ°´': 'shui' };
      Object.entries(map).forEach(([k, v]) => {
        const el = E(`w5_${v}`);
        if (el && typeof scores[k] === 'number') {
          const newValue = Math.round(scores[k]);
          if (el.value !== String(newValue)) { 
            el.value = newValue; 
            const valEl = E(`w5_${v}Val`);
            if (valEl) valEl.textContent = newValue;
          }
        }
      });
      if (window.w5_draw) { 
        window.w5_draw(); 
      }
    }

    function applyRandomHexagram() {
      const TRIS = ['ä¹¾', 'å…Œ', 'é›¢', 'éœ‡', 'å·½', 'å', 'è‰®', 'å¤']; 
      E('upper').value = TRIS[Math.floor(Math.random() * TRIS.length)]; 
      E('lower').value = TRIS[Math.floor(Math.random() * TRIS.length)];
      
      window.moving = [false, false, false, false, false, false];
      
      let hasMovingYao = false; 
      const mvCtlInputs = document.querySelectorAll('#mvCtl input[type="checkbox"][data-mv]');
      mvCtlInputs.forEach((cb, index) => { 
        const isMoving = Math.random() < 0.35; 
        cb.checked = isMoving; 
        window.moving[index] = isMoving;
        if (isMoving) hasMovingYao = true; 
      });
      
      if (!hasMovingYao && mvCtlInputs.length > 0) { 
        const randomIndex = Math.floor(Math.random() * mvCtlInputs.length); 
        mvCtlInputs[randomIndex].checked = true; 
        window.moving[randomIndex] = true;
      }
      
      E('question').value = `éš¨æ©Ÿèµ·å¦`; 
      render();
    }

    function render() {
      const upTri = E('upper').value, loTri = E('lower').value, yongShen = E('yongShen').value; 
      const baseLines = [...TRIG[loTri], ...TRIG[upTri]]; 
      const gzSix = calcPillarsAndSix(); 
      if (!pillars) return;
      
      const guaName = guaNameOf(upTri, loTri); 
      const gong = upTri;
      const meElem = GONG_ELEM[gong]; 
      window.__lastMeElem = meElem;
      
      const branches = naJiaBranches(baseLines); 
      const kins = branches.map(b => sixKin(meElem, b)); 
      let w5s = { æœ¨: 6, ç«: 6, åœŸ: 6, é‡‘: 6, æ°´: 6 }, ysTxt = '';
      
      if (yongShen) { 
        const res = calculateYongShenWuxingScores(yongShen, pillars.month, pillars.day, meElem, branches, window.moving); 
        w5s = res.scores; 
        ysTxt = `${yongShen}(${res.targetElem} ${w5s[res.targetElem].toFixed(1)})`; 
        
        const yongShenAnalysis = analyzeYongShenWithShiYing(
            yongShen, 6, 3, kins, window.moving
        );
        displayYongShenAnalysis(yongShenAnalysis);
      } else {
        document.getElementById('yongShenAnalysis').innerHTML = '';
      }
      
      updateW5RadarScores(w5s); 
      
      const chLines = changedLines(baseLines, window.moving); 
      const branchesC = naJiaBranches(chLines), kinsC = branchesC.map(b => sixKin(meElem, b));
      
      const rows = [];
      for (let pos = 6; pos >= 1; pos--) { 
        const i = pos - 1; 
        rows.push({ 
          six: gzSix[i], 
          fu: '', 
          yy: baseLines[i], 
          mv: window.moving[i],
          kin: kins[i], 
          zhi: branches[i], 
          kinc: window.moving[i] ? kinsC[i] : '', 
          zhic: window.moving[i] ? branchesC[i] : '', 
          mark: (pos === 6) ? 'ä¸–' : (pos === 3) ? 'æ‡‰' : '' 
        }); 
      }
      
      const dtVal = (E('dt').value || '').replace('T', ' '); 
      drawBoard({ 
        q: E('question').value || 'â€”', 
        dt: dtVal, 
        gzY: pillars.year, 
        gzM: pillars.month, 
        gzD: pillars.day, 
        gzH: pillars.hour, 
        xun: E('gzXun').textContent.substr(3), 
        kw: E('gzKW').textContent.substr(3), 
        name: guaName, 
        up: upTri, 
        lo: loTri, 
        gong, 
        shi: 6, 
        ying: 3, 
        kind: 'æœ¬å®®', 
        ysTxt 
      }, rows);
      
      if (window.updateTCMAdvice) {
        try { 
          window.updateTCMAdvice(meElem, w5s); 
        } catch (e) {
          console.error('ä¸­é†«å»ºè­°æ›´æ–°éŒ¯èª¤:', e);
        }
      }
    }

    // ==================== é›·é”åœ–ç³»çµ± ====================
    function initRadarChart() {
      const COLORS = { æœ¨: '#16a34a', ç«: '#ef4444', åœŸ: '#f59e0b', é‡‘: '#64748b', æ°´: '#3b82f6' };
      const ORDER = ['ç«', 'æœ¨', 'åœŸ', 'é‡‘', 'æ°´'];
      
      const id = s => document.getElementById(s);
      const val = i => Number(id(i) && id(i).value) || 6;
      
      function values() { 
        return { 
          ç«: val('w5_huo'), 
          æœ¨: val('w5_mu'), 
          åœŸ: val('w5_tu'), 
          é‡‘: val('w5_jin'), 
          æ°´: val('w5_shui') 
        }; 
      }
      
      function drawRadar() {
        const c = id('w5_canv');
        if (!c) return;
        
        const dpr = window.devicePixelRatio || 1;
        const W = c.clientWidth, H = c.clientHeight;
        
        if (W === 0 || H === 0) {
          setTimeout(drawRadar, 100);
          return;
        }
        
        c.width = Math.floor(W * dpr);
        c.height = Math.floor(H * dpr);
        const ctx = c.getContext('2d');
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        
        const cx = W / 2, cy = H / 2, R = Math.min(W, H) / 2 * 0.7, rings = 5, ang0 = -Math.PI / 2;
        
        ctx.clearRect(0, 0, W, H);
        
        ctx.lineWidth = 1;
        ctx.strokeStyle = '#e5e7eb';
        
        for (let r = 1; r <= rings; r++) {
          const rr = R * r / rings;
          ctx.beginPath();
          for (let i = 0; i < ORDER.length; i++) {
            const a = ang0 + i * (2 * Math.PI / ORDER.length);
            i === 0 ? ctx.moveTo(cx + rr * Math.cos(a), cy + rr * Math.sin(a)) : 
                      ctx.lineTo(cx + rr * Math.cos(a), cy + rr * Math.sin(a));
          }
          ctx.closePath();
          ctx.stroke();
        }
        
        ctx.font = '14px "Noto Sans TC","Microsoft JhengHei",sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        
        ORDER.forEach((k, i) => {
          const a = ang0 + i * (2 * Math.PI / ORDER.length);
          const x = cx + (R + 18) * Math.cos(a);
          const y = cy + (R + 18) * Math.sin(a);
          ctx.fillStyle = COLORS[k];
          ctx.fillText(k, x, y);
        });
        
        const v = values();
        const pts = [];
        
        ORDER.forEach((k, i) => {
          const rr = R * Math.max(0.1, Math.min(1, v[k] / 10));
          const a = ang0 + i * (2 * Math.PI / ORDER.length);
          pts.push([cx + rr * Math.cos(a), cy + rr * Math.sin(a)]);
        });
        
        ctx.beginPath();
        pts.forEach((p, i) => {
          i === 0 ? ctx.moveTo(p[0], p[1]) : ctx.lineTo(p[0], p[1]);
        });
        ctx.closePath();
        ctx.fillStyle = 'rgba(59,130,246,0.2)';
        ctx.fill();
        
        ctx.strokeStyle = '#3b82f6';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        ctx.fillStyle = '#3b82f6';
        pts.forEach(p => {
          ctx.beginPath();
          ctx.arc(p[0], p[1], 4, 0, Math.PI * 2);
          ctx.fill();
        });
      }
      
      ['w5_mu', 'w5_huo', 'w5_tu', 'w5_jin', 'w5_shui'].forEach(i => {
        const el = id(i);
        if (el) {
          el.addEventListener('input', () => {
            const tip = id(i + 'Val');
            if (tip) tip.textContent = el.value;
            drawRadar();
            if (window.updateTCMAdvice && window.__lastMeElem) {
              window.updateTCMAdvice(window.__lastMeElem, values()); 
            }
          });
        }
      });
      
      window.w5_draw = drawRadar;
      setTimeout(() => {
        drawRadar();
      }, 100);
      window.addEventListener('resize', drawRadar);
    }

    // ==================== åˆå§‹åŒ–æ‰€æœ‰åŠŸèƒ½ ====================
    window.addEventListener('DOMContentLoaded', () => {
      E('dt').value = toYMDhm(new Date());
      
      E('btnNow')?.addEventListener('click', () => { E('dt').value = toYMDhm(new Date()); render(); });
      E('btnPrint')?.addEventListener('click', () => window.print());
      E('redraw')?.addEventListener('click', render);
      E('download')?.addEventListener('click', downloadPNG);
      E('btnUpdateRadar')?.addEventListener('click', render);
      E('btnRandomHex')?.addEventListener('click', applyRandomHexagram);
      
      E('btnTossCoins').addEventListener('click', tossCoins);
      E('btnResetCoins').addEventListener('click', resetCoins);
      E('btnApplyCoins').addEventListener('click', applyCoinResults);
      E('btnAutoToss').addEventListener('click', autoTossSixTimes);
      
      E('btnAnalyzeSymptoms').addEventListener('click', analyzeSymptoms);
      
      const mvCtl = E('mvCtl');
      mvCtl.innerHTML = [6, 5, 4, 3, 2, 1].map(p => 
        `<label><input type="checkbox" data-mv="${p-1}"> ${p === 6 ? 'ä¸Š' : p === 1 ? 'åˆ' : p}çˆ»å‹•</label>`
      ).join('');
      
      mvCtl.addEventListener('change', e => { 
        const i = e.target.dataset.mv; 
        if (i != null) { 
          window.moving[i] = e.target.checked; 
          render(); 
        } 
      });
      
      const bind = (id, fn) => { 
        const el = E(id); 
        if (el) { 
          ['input', 'change'].forEach(ev => el.addEventListener(ev, fn)); 
        } 
      };
      
      ['upper', 'lower', 'question', 'dt', 'size', 'offx', 'offy', 'gap', 'headgap', 'yongShen'].forEach(id => bind(id, render));
      
      updateCoinResultsDisplay();
      setTimeout(initRadarChart, 200);
      setTimeout(render, 300);
      
      window.updateTCMAdvice = updateTCMAdvice;
    });

    function downloadPNG() {
      const canvas = E('hexCanvas'); 
      const filename = 'hexagram.png';
      
      function openFallback() {
        const data = canvas.toDataURL('image/png');
        const win = window.open('about:blank', '_blank');
        if (win) { 
          win.document.title = 'å¦å­˜åœ–ç‰‡'; 
          win.document.body.style.margin = '0'; 
          const img = new Image(); 
          img.src = data; 
          win.document.body.appendChild(img); 
        } else { 
          const a = document.createElement('a'); 
          a.href = data; 
          a.download = filename; 
          document.body.appendChild(a); 
          a.click();
          a.remove(); 
        }
      }
      
      if (canvas.toBlob) {
        canvas.toBlob(blob => {
          if (!blob) { openFallback(); return; }
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); 
          a.href = url; 
          a.download = filename; 
          document.body.appendChild(a); 
          a.click();
          setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 0);
        });
      } else { 
        openFallback(); 
      }
    }
  </script>
</body>
</html>
