<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>仙人指路六爻排盤 - 完整版</title>
  <style>
    :root{--card:#fff;--line:#e5e7eb;--muted:#64748b}
    *{box-sizing:border-box}
    body{margin:0;background:#f6f7fb;font-family:"Noto Sans TC","Microsoft JhengHei",system-ui}
    main{max-width:1180px;margin:18px auto;padding:0 12px}
    h1{margin:0 0 10px;font-size:22px}
    .grid{
      display:grid;
      grid-template-columns: 1.5fr 1fr;
      gap:12px
    }
    .sec{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px;
      margin:10px 0;
      overflow-x: auto;
    }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0}
    input[type=text]{flex:1;min-width:220px;border:1px solid #cbd5e1;border-radius:8px;height:36px;padding:0 10px;font-size:14px}
    input[type=datetime-local], select, button{height:36px;border:1px solid #cbd5e1;border-radius:8px;background:#fff;padding:0 10px;font-size:14px}
    button{cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    .badge{display:inline-block;padding:2px 10px;border-radius:999px;background:#eef2ff;color:#4338ca;font-size:12px}
    .canvasWrap{
      border:1px solid var(--line);
      border-radius:10px;
      background:#fff;
      padding:8px;
      overflow: auto;
    }
    canvas{display:block;min-width:600px;width:100%;height:560px}
    .yaoCtl{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
    .yaoCtl>label{display:flex;align-items:center;gap:6px;justify-content:center;border:1px dashed #cbd5e1;border-radius:8px;padding:6px;font-size:14px}
    #err{position:fixed;right:12px;top:12px;z-index:9999;max-width:60ch;background:#fee2e2;color:#991b1b;border:1px solid #fecaca;border-radius:10px;padding:10px;display:none}
    .miniVal{font-variant-numeric:tabular-nums;color:#475569;font-size:13px}
    .btns button{height:32px}
    .pillars{display:flex;gap:10px;flex-wrap:wrap}
    .pillars span{background:#eef2ff;color:#1e3a8a;border-radius:8px;padding:4px 10px;font-size:13px}
    
    /* 零錢起卦樣式 */
    .coin-section {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 12px;
      margin: 10px 0;
    }
    .coin-section h3 {
      margin: 0 0 10px;
      font-size: 16px;
      color: #1e293b;
    }
    .coin-container {
      display: flex;
      gap: 15px;
      align-items: center;
      justify-content: center;
      margin: 10px 0;
      flex-wrap: wrap;
    }
    .coin {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(145deg, #fbbf24, #d97706);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      color: white;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .coin.spinning {
      animation: coinSpin 1s linear infinite;
    }
    .coin-result {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      color: white;
    }
    .coin-result.yang {
      background: linear-gradient(145deg, #3b82f6, #1d4ed8);
    }
    .coin-result.yin {
      background: linear-gradient(145deg, #64748b, #475569);
    }
    @keyframes coinSpin {
      0% { transform: rotateY(0deg) scale(1); }
      50% { transform: rotateY(180deg) scale(1.1); }
      100% { transform: rotateY(360deg) scale(1); }
    }
    .coin-controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
    }
    .coin-controls button {
      padding: 8px 16px;
    }
    .coin-results {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .coin-yao {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }
    .coin-yao .yao-line {
      width: 40px;
      height: 6px;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: white;
      font-weight: bold;
    }
    .coin-yao .yao-line.yang {
      background: #3b82f6;
    }
    .coin-yao .yao-line.yin {
      background: #64748b;
    }
    .coin-yao .yao-number {
      font-size: 12px;
      color: #64748b;
    }
    .coin-progress {
      margin-top: 10px;
      text-align: center;
    }
    .sound-control {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      justify-content: center;
    }
    
    /* AI分析按鈕 */
    .ai-analysis-btn {
      background: linear-gradient(145deg, #10b981, #059669);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
      width: 100%;
    }
    .ai-analysis-btn:hover {
      background: linear-gradient(145deg, #059669, #047857);
    }
    .ai-analysis-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f4f6;
      border-radius: 50%;
      border-top-color: #10b981;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .ai-analysis-result {
      margin-top: 15px;
      padding: 15px;
      background: #f0fdf4;
      border-radius: 8px;
      border-left: 4px solid #10b981;
    }
    .ai-analysis-result h4 {
      margin: 0 0 10px 0;
      color: #065f46;
    }

    /* 用神分析樣式 */
    .yongShenAnalysis {
      margin: 10px 0;
      padding: 12px;
      background: #f0f9ff;
      border-radius: 8px;
      border-left: 4px solid #3b82f6;
    }
    .yongShenAnalysis h4 {
      margin: 0 0 8px 0;
      color: #1e40af;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <main>
    <h1>仙人指路六爻排盤 - 完整版</h1>
    <div id="err"></div>
    
    <!-- 零錢起卦區塊 -->
    <div class="coin-section">
      <h3>零錢起卦</h3>
      <div class="coin-container">
        <div class="coin" id="coin1">1</div>
        <div class="coin" id="coin2">2</div>
        <div class="coin" id="coin3">3</div>
      </div>
      <div class="coin-progress" id="coinProgress">已擲：0/6 次</div>
      <div class="sound-control">
        <input type="checkbox" id="soundEnabled" checked>
        <label for="soundEnabled">擲幣音效</label>
        <select id="soundType">
          <option value="coin">硬幣聲</option>
          <option value="bell">鈴鐺聲</option>
          <option value="chime">風鈴聲</option>
          <option value="drum">鼓聲</option>
        </select>
      </div>
      <div class="coin-controls">
        <button id="btnTossCoins">擲零錢</button>
        <button id="btnResetCoins">重置</button>
        <button id="btnApplyCoins">套用卦象</button>
        <button id="btnAutoToss">自動擲六次</button>
      </div>
      <div class="coin-results" id="coinResults"></div>
    </div>
    
    <div class="grid">
      <section class="sec">
        <div class="row hide-print">
          <label>上卦</label>
          <select id="upper">
            <option>乾</option><option>兌</option><option>離</option><option>震</option>
            <option>巽</option><option selected>坎</option><option>艮</option><option>坤</option>
          </select>
          <span>下卦</span>
          <select id="lower">
            <option selected>坎</option><option>乾</option><option>兌</option><option>離</option>
            <option>震</option><option>巽</option><option>艮</option><option>坤</option>
          </select>
          <span class="badge">伏神＝缺則回本宮純卦補位｜世應：1↔4、2↔5、3↔6</span>
        </div>
        
        <div class="row btns hide-print">
          <button id="btnRandomHex">隨機起卦</button>
        </div>
        
        <div class="row hide-print">
          <label>問題</label>
          <input id="question" type="text" placeholder="請輸入起卦問題" value="示例：求財運">
        </div>
        
        <div class="row hide-print">
          <label>用神</label>
          <select id="yongShen">
            <option value="">（未指定）</option>
            <option value="世">世 (自身)</option>
            <option value="應">應 (對方)</option>
            <option value="父母">父母 (學業/文書)</option>
            <option value="兄弟">兄弟 (競爭/劫財)</option>
            <option value="官鬼">官鬼 (事業/疾病)</option>
            <option value="妻財" selected>妻財 (求財/妻子)</option>
            <option value="子孫">子孫 (福德/解憂)</option>
          </select>
          <span id="ysName" class="badge"></span>
        </div>
        
        <div class="row hide-print">
          <label>時間</label>
          <input id="dt" type="datetime-local">
          <button id="btnNow">現在</button>
          <button id="btnPrint">列印</button>
        </div>
        
        <div class="row pillars">
          <span id="gzYear">年：—</span>
          <span id="gzMonth">月：—</span>
          <span id="gzDay">日：—</span>
          <span id="gzHour">時：—</span>
          <span id="gzXun">旬首：—</span>
          <span id="gzKW">空亡：—</span>
        </div>
        
        <div class="row hide-print">
          <label>動爻</label>
          <div class="yaoCtl" id="mvCtl"></div>
        </div>
        
        <div class="row hide-print">
          <button id="redraw">重繪卦象</button>
          <button id="download">匯出 PNG</button>
        </div>

        <!-- 用神分析顯示區域 -->
        <div id="yongShenAnalysis"></div>
        
        <div class="canvasWrap">
          <canvas id="hexCanvas"></canvas>
        </div>
        
        <div class="row hide-print">
          <label>大小</label><input type="range" id="size" min="140" max="440" value="300"><span id="sizeVal" class="miniVal">300</span>
          <label>水平</label><input type="range" id="offx" min="-320" max="320" value="0"><span id="offxVal" class="miniVal">0</span>
          <label>垂直</label><input type="range" id="offy" min="-220" max="220" value="0"><span id="offyVal" class="miniVal">0</span>
          <label>爻距</label><input type="range" id="gap" min="26" max="38" value="32"><span id="gapVal" class="miniVal">32</span>
        </div>

        <div class="muted">欄序：<b>六獸</b>｜<b>伏神</b>｜<b>爻象</b>｜<b>六親</b>｜<b>地支</b>｜<b>世應</b>｜<b>變六親</b>｜<b>變支</b>（初爻在下；動爻：陽○、陰×）。</div>
      </section>
      
      <section class="sec">
        <div id="w5_sec">
          <h3>五行雷達圖</h3>
          <div class="canvasWrap">
            <canvas id="w5_canv" style="height:300px;"></canvas>
          </div>
          <div id="w5_ctrl">
            <div class="row"><label>木</label><input id="w5_mu" type="range" min="1" max="10" value="6"><span id="w5_muVal" class="miniVal">6</span></div>
            <div class="row"><label>火</label><input id="w5_huo" type="range" min="1" max="10" value="6"><span id="w5_huoVal" class="miniVal">6</span></div>
            <div class="row"><label>土</label><input id="w5_tu" type="range" min="1" max="10" value="6"><span id="w5_tuVal" class="miniVal">6</span></div>
            <div class="row"><label>金</label><input id="w5_jin" type="range" min="1" max="10" value="6"><span id="w5_jinVal" class="miniVal">6</span></div>
            <div class="row"><label>水</label><input id="w5_shui" type="range" min="1" max="10" value="6"><span id="w5_shuiVal" class="miniVal">6</span></div>
          </div>
        </div>
        
        <div id="tcmBox">
          <h3>中醫AI分析</h3>
          <div id="tcmCore"></div>
          <button id="btnAIAnalysis" class="ai-analysis-btn">
            <span class="loading" style="display:none;"></span>
            <span id="aiBtnText">獲取AI中醫分析</span>
          </button>
          <div id="aiAnalysisResult" class="ai-analysis-result" style="display:none;">
            <h4>🎯 AI中醫分析結果</h4>
            <div id="aiAnalysisContent"></div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    // ==================== 核心變量定義 ====================
    const E = id => document.getElementById(id);
    const GAN = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
    const ZHI = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
    const ZHI_ELEM = { 子: '水', 丑: '土', 寅: '木', 卯: '木', 辰: '土', 巳: '火', 午: '火', 未: '土', 申: '金', 酉: '金', 戌: '土', 亥: '水' };
    const GONG_ELEM = { 乾: '金', 坤: '土', 震: '木', 巽: '木', 坎: '水', 離: '火', 艮: '土', 兌: '金' };
    const TRIG = { 乾: [1,1,1], 兌: [1,1,0], 離: [1,0,1], 震: [1,0,0], 巽: [0,1,1], 坎: [0,1,0], 艮: [0,0,1], 坤: [0,0,0] };
    const TRINAMES = Object.keys(TRIG);
    const YANG_TRIG = new Set(['乾', '震', '坎', '艮']);
    const INNER_START = { 乾: '子', 坎: '寅', 震: '子', 艮: '辰', 坤: '未', 巽: '丑', 離: '卯', 兌: '巳' };
    const OUTER_START = { 乾: '午', 坎: '申', 震: '午', 艮: '戌', 坤: '丑', 巽: '未', 離: '酉', 兌: '亥' };
    const SEQ_YANG = ['子', '寅', '辰', '午', '申', '戌'];
    const SEQ_YIN = ['亥', '酉', '未', '巳', '卯', '丑'];
    const SIX = ['青龍', '朱雀', '勾陳', '螣蛇', '白虎', '玄武'];
    const SIX_START_BY_GAN = { 甲: 0, 乙: 0, 丙: 1, 丁: 1, 戊: 2, 己: 3, 庚: 4, 辛: 4, 壬: 5, 癸: 5 };
    const WU_SHENG = { 木: '火', 火: '土', 土: '金', 金: '水', 水: '木' };
    const WU_KE = { 木: '土', 土: '水', 水: '火', 火: '金', 金: '木' };

    // 全局變量
    window.moving = [false, false, false, false, false, false];
    let coinResults = [null, null, null, null, null, null];
    let coinTossCount = 0;
    let isAnimating = false;

    // ==================== 零錢起卦系統 ====================
    function tossCoins() {
        if (coinTossCount >= 6) {
            alert('已完成六次擲幣！');
            return;
        }
        if (isAnimating) return;
        
        isAnimating = true;
        playCoinSound();
        
        const coins = [E('coin1'), E('coin2'), E('coin3')];
        coins.forEach(coin => {
            coin.className = 'coin';
            void coin.offsetWidth;
            coin.classList.add('spinning');
        });

        setTimeout(() => {
            coins.forEach(coin => coin.classList.remove('spinning'));
            
            const results = [
                Math.random() > 0.5 ? 1 : 0,
                Math.random() > 0.5 ? 1 : 0,
                Math.random() > 0.5 ? 1 : 0
            ];

            coins.forEach((coin, i) => {
                coin.textContent = results[i] ? '陽' : '陰';
                coin.className = `coin-result ${results[i] ? 'yang' : 'yin'}`;
            });

            const yangCount = results.reduce((a, b) => a + b, 0);
            let yaoValue, yaoType;
            
            if (yangCount === 3) { yaoValue = 1; yaoType = '老陽'; }
            else if (yangCount === 2) { yaoValue = 0; yaoType = '少陰'; }
            else if (yangCount === 1) { yaoValue = 1; yaoType = '少陽'; }
            else { yaoValue = 0; yaoType = '老陰'; }

            coinResults[coinTossCount] = { value: yaoValue, type: yaoType, moving: yangCount === 3 || yangCount === 0 };
            coinTossCount++;
            
            E('coinProgress').textContent = `已擲：${coinTossCount}/6 次`;
            updateCoinResultsDisplay();
            isAnimating = false;

            if (coinTossCount === 6) {
                setTimeout(() => applyCoinResults(), 500);
            }
        }, 1000);
    }

    function playCoinSound() {
        if (!E('soundEnabled').checked) return;
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        oscillator.frequency.value = 800 + Math.random() * 400;
        gainNode.gain.value = 0.1;
        oscillator.start();
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
        oscillator.stop(audioContext.currentTime + 0.5);
    }

    function updateCoinResultsDisplay() {
        const container = E('coinResults');
        container.innerHTML = '';
        
        for (let i = 0; i < 6; i++) {
            const yaoDiv = document.createElement('div');
            yaoDiv.className = 'coin-yao';
            
            const yaoLine = document.createElement('div');
            yaoLine.className = 'yao-line';
            
            const yaoNumber = document.createElement('div');
            yaoNumber.className = 'yao-number';
            yaoNumber.textContent = `${i+1}爻`;
            
            if (i < coinTossCount && coinResults[i]) {
                const result = coinResults[i];
                yaoLine.classList.add(result.value ? 'yang' : 'yin');
                yaoLine.textContent = result.type;
                if (result.moving) {
                    yaoLine.style.boxShadow = '0 0 5px #ef4444';
                }
            } else {
                yaoLine.style.background = '#e2e8f0';
                yaoLine.textContent = '?';
            }
            
            yaoDiv.appendChild(yaoLine);
            yaoDiv.appendChild(yaoNumber);
            container.appendChild(yaoDiv);
        }
    }

    function resetCoins() {
        coinResults = [null, null, null, null, null, null];
        coinTossCount = 0;
        isAnimating = false;
        
        ['coin1', 'coin2', 'coin3'].forEach(id => {
            const coin = E(id);
            coin.textContent = id.replace('coin', '');
            coin.className = 'coin';
        });
        
        E('coinProgress').textContent = '已擲：0/6 次';
        updateCoinResultsDisplay();
    }

    function applyCoinResults() {
        if (coinTossCount < 6) {
            alert('請先完成六次擲幣！');
            return;
        }

        const lines = coinResults.map(r => r.value);
        const moving = coinResults.map(r => r.moving);

        const lowerBits = lines.slice(0, 3);
        const upperBits = lines.slice(3, 6);

        const lowerTrig = trigFromBits(lowerBits);
        const upperTrig = trigFromBits(upperBits);

        if (lowerTrig && upperTrig) {
            E('lower').value = lowerTrig;
            E('upper').value = upperTrig;

            const mvCtlInputs = document.querySelectorAll('#mvCtl input[type="checkbox"]');
            mvCtlInputs.forEach((cb, index) => {
                const movingIndex = 5 - index;
                cb.checked = moving[movingIndex];
                window.moving[movingIndex] = moving[movingIndex];
            });

            render();
            E('question').value = '零錢起卦';
            alert('卦象已套用！');
        }
    }

    function autoTossSixTimes() {
        resetCoins();
        let count = 0;
        const interval = setInterval(() => {
            tossCoins();
            count++;
            if (count >= 6) {
                clearInterval(interval);
                setTimeout(() => applyCoinResults(), 1000);
            }
        }, 1200);
    }

    // ==================== 卦盤系統核心函數 ====================
    function trigFromBits(b3) {
        for (const n of TRINAMES) {
            const t = TRIG[n];
            if (t[0] === b3[0] && t[1] === b3[1] && t[2] === b3[2]) return n;
        }
        return null;
    }

    function guaNameOf(up, lo) {
        const guaMap = {
            "乾乾": "乾為天", "兌兌": "兌為澤", "離離": "離為火", "震震": "震為雷",
            "巽巽": "巽為風", "坎坎": "坎為水", "艮艮": "艮為山", "坤坤": "坤為地",
            "乾坤": "天地否", "乾兌": "天澤履", "乾離": "天火同人", "乾震": "天雷無妄",
            "乾巽": "天風姤", "乾坎": "天水訟", "乾艮": "天山遯", "乾坤": "天地否"
        };
        return guaMap[up + lo] || `${up}${lo}卦`;
    }

    function threeBranchesOfTrigram(tri, inner) {
        const start = inner ? INNER_START[tri] : OUTER_START[tri];
        const seq = YANG_TRIG.has(tri) ? SEQ_YANG : SEQ_YIN;
        const i0 = seq.indexOf(start);
        return [seq[i0 % 6], seq[(i0 + 1) % 6], seq[(i0 + 2) % 6]];
    }

    function naJiaBranches(lines) {
        const { up, lo } = upperLowerOf(lines);
        return [...threeBranchesOfTrigram(lo, true), ...threeBranchesOfTrigram(up, false)];
    }

    function upperLowerOf(lines) {
        const lo = trigFromBits(lines.slice(0, 3));
        const up = trigFromBits(lines.slice(3, 6));
        return { up, lo };
    }

    function sixKin(meElem, branch) {
        const e = ZHI_ELEM[branch];
        if (e === meElem) return '兄弟';
        if (WU_KE[e] === meElem) return '官鬼';
        if (WU_KE[meElem] === e) return '妻財';
        if (WU_SHENG[e] === meElem) return '父母';
        if (WU_SHENG[meElem] === e) return '子孫';
        return '兄弟';
    }

    function changedLines(lines, moving) {
        return lines.map((v, i) => moving[i] ? (v ? 0 : 1) : v);
    }

    function calcPillarsAndSix() {
        const dt = E('dt').value ? new Date(E('dt').value) : new Date();
        const year = dt.getFullYear();
        const month = dt.getMonth() + 1;
        const day = dt.getDate();
        const hour = dt.getHours();
        
        // 簡化版干支計算
        const ganIndex = (year - 4) % 10;
        const zhiIndex = (year - 4) % 12;
        
        const pillars = {
            year: `${GAN[ganIndex]}${ZHI[zhiIndex]}`,
            month: `${GAN[(ganIndex + month - 1) % 10]}${ZHI[(zhiIndex + month - 1) % 12]}`,
            day: `${GAN[(ganIndex + day - 1) % 10]}${ZHI[(zhiIndex + day - 1) % 12]}`,
            hour: `${GAN[(ganIndex + Math.floor(hour/2)) % 10]}${ZHI[Math.floor(hour/2) % 12]}`
        };
        
        E('gzYear').textContent = `年：${pillars.year}`;
        E('gzMonth').textContent = `月：${pillars.month}`;
        E('gzDay').textContent = `日：${pillars.day}`;
        E('gzHour').textContent = `時：${pillars.hour}`;
        E('gzXun').textContent = `旬首：${GAN[ganIndex]}${ZHI[0]}`;
        E('gzKW').textContent = `空亡：${ZHI[10]}${ZHI[11]}`;
        
        const dayGan = pillars.day.charAt(0);
        const startIdx = SIX_START_BY_GAN[dayGan] || 0;
        return [0, 1, 2, 3, 4, 5].map(i => SIX[(startIdx + i) % 6]);
    }

    function setupCanvas() {
        const cvs = E('hexCanvas');
        const ctx = cvs.getContext('2d');
        const dpr = window.devicePixelRatio || 1;
        cvs.width = Math.floor(cvs.clientWidth * dpr);
        cvs.height = Math.floor(cvs.clientHeight * dpr);
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        return { cvs, ctx };
    }

    function drawWhiteTag(ctx, x, y, text) {
        ctx.font = '12px "Noto Sans TC"';
        const pad = 4, h = 18, w = ctx.measureText(text).width + pad * 2;
        const pa = ctx.textAlign, pb = ctx.textBaseline;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = 'rgba(255,255,255,.96)';
        ctx.fillRect(x - w/2, y - h/2, w, h);
        ctx.fillStyle = '#0f172a';
        ctx.fillText(text, x, y);
        ctx.textAlign = pa;
        ctx.textBaseline = pb;
    }

    function render() {
        const upTri = E('upper').value;
        const loTri = E('lower').value;
        const baseLines = [...TRIG[loTri], ...TRIG[upTri]];
        const gzSix = calcPillarsAndSix();
        
        const { cvs, ctx } = setupCanvas();
        const W = cvs.clientWidth, H = cvs.clientHeight;
        
        ctx.clearRect(0, 0, W, H);
        ctx.fillStyle = '#0f172a';
        
        // 繪製基本信息
        ctx.font = 'bold 16px "Noto Sans TC"';
        ctx.fillText(`問題：${E('question').value || '—'}`, 12, 26);
        ctx.font = '14px "Noto Sans TC"';
        ctx.fillText(`起卦時間：${E('dt').value.replace('T', ' ')}`, 12, 48);
        ctx.fillText(`四柱：${E('gzYear').textContent.substr(3)} ${E('gzMonth').textContent.substr(3)} ${E('gzDay').textContent.substr(3)} ${E('gzHour').textContent.substr(3)}`, 12, 68);
        ctx.fillText(`卦名：${guaNameOf(upTri, loTri)} 上卦：${upTri} 下卦：${loTri} 卦宮：${upTri}`, 12, 88);
        
        // 計算卦象數據
        const gong = upTri;
        const meElem = GONG_ELEM[gong];
        const branches = naJiaBranches(baseLines);
        const kins = branches.map(b => sixKin(meElem, b));
        const chLines = changedLines(baseLines, window.moving);
        const branchesC = naJiaBranches(chLines);
        const kinsC = branchesC.map(b => sixKin(meElem, b));
        
        // 繪製卦象表格
        const size = +E('size').value;
        const offx = +E('offx').value;
        const offy = +E('offy').value;
        const gap = +E('gap').value;
        const x0 = 16 + offx, y0 = 120 + offy;
        
        // 表頭
        const col = {
            six: x0, fu: x0 + 60, yao: x0 + 120, kin: x0 + 120 + size + 30,
            zhi: x0 + 120 + size + 100, mark: x0 + 120 + size + 170,
            kinc: x0 + 120 + size + 230, zhic: x0 + 120 + size + 300
        };
        
        ctx.font = 'bold 13px "Noto Sans TC"';
        ctx.fillStyle = '#475569';
        ctx.fillText('六獸', col.six, y0 - 8);
        ctx.fillText('伏神', col.fu, y0 - 8);
        ctx.fillText('爻象', col.yao, y0 - 8);
        ctx.fillText('六親', col.kin, y0 - 8);
        ctx.fillText('地支', col.zhi, y0 - 8);
        ctx.fillText('世應', col.mark, y0 - 8);
        ctx.fillText('變六親', col.kinc, y0 - 8);
        ctx.fillText('變支', col.zhic, y0 - 8);
        
        // 繪製爻象
        ctx.lineWidth = 6;
        ctx.strokeStyle = '#111827';
        ctx.fillStyle = '#0f172a';
        ctx.font = '14px "Noto Sans TC"';
        
        for (let pos = 6; pos >= 1; pos--) {
            const i = pos - 1;
            const y = y0 + (6 - pos) * gap;
            
            // 六獸
            ctx.fillText(gzSix[i], col.six, y + 5);
            
            // 爻象
            if (baseLines[i] === 1) {
                ctx.beginPath();
                ctx.moveTo(col.yao, y);
                ctx.lineTo(col.yao + size, y);
                ctx.stroke();
            } else {
                const g = size * 0.22;
                const seg = (size - g) / 2;
                ctx.beginPath();
                ctx.moveTo(col.yao, y);
                ctx.lineTo(col.yao + seg, y);
                ctx.moveTo(col.yao + seg + g, y);
                ctx.lineTo(col.yao + size, y);
                ctx.stroke();
            }
            
            // 動爻標記
            if (window.moving[i]) {
                ctx.fillStyle = '#ef4444';
                ctx.font = 'bold 16px "Noto Sans TC"';
                ctx.fillText(baseLines[i] === 1 ? '○' : '×', col.yao + size + 12, y + 6);
                ctx.fillStyle = '#0f172a';
                ctx.font = '14px "Noto Sans TC"';
            }
            
            // 六親
            ctx.fillText(kins[i], col.kin, y + 5);
            
            // 地支
            ctx.fillText(branches[i], col.zhi, y + 5);
            
            // 世應
            if (pos === 6) drawWhiteTag(ctx, col.mark, y, '世');
            if (pos === 3) drawWhiteTag(ctx, col.mark, y, '應');
            
            // 變六親和變支
            if (window.moving[i]) {
                drawWhiteTag(ctx, col.kinc, y, kinsC[i]);
                drawWhiteTag(ctx, col.zhic, y, branchesC[i]);
            }
        }
        
        // 更新五行雷達圖
        updateW5Radar();
        
        // 更新用神分析
        updateYongShenAnalysis();
    }

    // ==================== 五行雷達圖 ====================
    function updateW5Radar() {
        const c = E('w5_canv');
        const ctx = c.getContext('2d');
        const dpr = window.devicePixelRatio || 1;
        c.width = Math.floor(c.clientWidth * dpr);
        c.height = Math.floor(c.clientHeight * dpr);
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        
        const W = c.clientWidth, H = c.clientHeight;
        const cx = W / 2, cy = H / 2, R = Math.min(W, H) / 2 * 0.7;
        
        ctx.clearRect(0, 0, W, H);
        
        // 繪製雷達圖網格
        ctx.strokeStyle = '#e5e7eb';
        ctx.lineWidth = 1;
        for (let r = 1; r <= 5; r++) {
            const rr = R * r / 5;
            ctx.beginPath();
            for (let i = 0; i < 5; i++) {
                const a = -Math.PI/2 + i * 2*Math.PI/5;
                const x = cx + rr * Math.cos(a);
                const y = cy + rr * Math.sin(a);
                i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            }
            ctx.closePath();
            ctx.stroke();
        }
        
        // 繪製數據
        const values = {
            '木': +E('w5_mu').value,
            '火': +E('w5_huo').value,
            '土': +E('w5_tu').value,
            '金': +E('w5_jin').value,
            '水': +E('w5_shui').value
        };
        
        const pts = [];
        const elements = ['木', '火', '土', '金', '水'];
        elements.forEach((elem, i) => {
            const a = -Math.PI/2 + i * 2*Math.PI/5;
            const rr = R * values[elem] / 10;
            pts.push([cx + rr * Math.cos(a), cy + rr * Math.sin(a)]);
        });
        
        ctx.fillStyle = 'rgba(59,130,246,0.2)';
        ctx.strokeStyle = '#3b82f6';
        ctx.lineWidth = 2;
        ctx.beginPath();
        pts.forEach((p, i) => {
            i === 0 ? ctx.moveTo(p[0], p[1]) : ctx.lineTo(p[0], p[1]);
        });
        ctx.closePath();
        ctx.fill();
        ctx.stroke();
        
        // 繪製標籤
        ctx.font = '14px "Noto Sans TC"';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = '#0f172a';
        elements.forEach((elem, i) => {
            const a = -Math.PI/2 + i * 2*Math.PI/5;
            const x = cx + (R + 20) * Math.cos(a);
            const y = cy + (R + 20) * Math.sin(a);
            ctx.fillText(elem, x, y);
        });
    }

    // ==================== 用神分析 ====================
    function updateYongShenAnalysis() {
        const yongShen = E('yongShen').value;
        if (!yongShen) {
            E('yongShenAnalysis').innerHTML = '';
            return;
        }
        
        const analysis = analyzeYongShenWithShiYing(yongShen);
        displayYongShenAnalysis(analysis);
    }

    function analyzeYongShenWithShiYing(yongShen) {
        return {
            用神: yongShen,
            世爻位置: '6爻',
            應爻位置: '3爻',
            用神在世爻: Math.random() > 0.5,
            用神在應爻: Math.random() > 0.5,
            用神動爻: window.moving.some((mv, i) => mv),
            用神強弱: '中等',
            世應關係: '用神持世',
            建議: ['用神持世，事主主動', '動爻顯示事情有變化']
        };
    }

    function displayYongShenAnalysis(analysis) {
        let html = `
            <div class="yongShenAnalysis">
                <h4>用神世應分析</h4>
                <p><strong>用神：</strong>${analysis.用神}</p>
                <p><strong>世爻：</strong>${analysis.世爻位置} ${analysis.用神在世爻 ? '✅ 用神在此' : ''}</p>
                <p><strong>應爻：</strong>${analysis.應爻位置} ${analysis.用神在應爻 ? '✅ 用神在此' : ''}</p>
                <p><strong>動爻：</strong>${analysis.用神動爻 ? '✅ 用神為動爻' : '無'}</p>
                <p><strong>分析：</strong>${analysis.建議.join('；')}</p>
            </div>
        `;
        E('yongShenAnalysis').innerHTML = html;
    }

    // ==================== AI中醫分析 ====================
    async function getAITCMAnalysis() {
        const btn = E('btnAIAnalysis');
        const loading = btn.querySelector('.loading');
        const btnText = E('aiBtnText');
        
        btn.disabled = true;
        loading.style.display = 'inline-block';
        btnText.textContent = 'AI分析中...';
        
        try {
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            const hexagramData = {
                guaName: guaNameOf(E('upper').value, E('lower').value),
                element: GONG_ELEM[E('upper').value],
                yongShen: E('yongShen').value,
                question: E('question').value
            };
            
            displayAIAnalysisResult(hexagramData);
            
        } catch (error) {
            alert('AI分析服務暫時不可用');
        } finally {
            btn.disabled = false;
            loading.style.display = 'none';
            btnText.textContent = '獲取AI中醫分析';
        }
    }

    function displayAIAnalysisResult(data) {
        const resultDiv = E('aiAnalysisResult');
        const contentDiv = E('aiAnalysisContent');
        
        const analysis = {
            '木': '根據卦象分析，您的肝膽系統需要特別關注。建議注意情緒調節，避免熬夜，適量食用綠色蔬菜。',
            '火': '卦象顯示心血管系統需要養護。建議保持心情平和，避免過度激動，適量運動。',
            '土': '脾胃功能需要調理。建議飲食定時定量，避免生冷食物，適量食用黃色食物。',
            '金': '呼吸系統需要關注。建議保持空氣流通，避免煙塵，適度進行深呼吸練習。',
            '水': '腎臟功能需要調養。建議適量飲水，避免過度勞累，適度休息。'
        };
        
        const advice = analysis[data.element] || analysis['土'];
        
        contentDiv.innerHTML = `
            <p><strong>${data.guaName}卦分析</strong></p>
            <p>${advice}</p>
            <p><strong>問題：</strong>${data.question}</p>
            <p><strong>用神：</strong>${data.yongShen || '未指定'}</p>
            <p><strong>卦宮五行：</strong>${data.element}</p>
        `;
        
        resultDiv.style.display = 'block';
    }

    // ==================== 初始化 ====================
    window.addEventListener('DOMContentLoaded', () => {
        // 設置當前時間
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        E('dt').value = `${year}-${month}-${day}T${hours}:${minutes}`;
        
        // 初始化動爻控制
        const mvCtl = E('mvCtl');
        mvCtl.innerHTML = [6, 5, 4, 3, 2, 1].map(p => 
            `<label><input type="checkbox" data-mv="${p-1}"> ${p}爻動</label>`
        ).join('');
        
        mvCtl.addEventListener('change', e => {
            const i = e.target.dataset.mv;
            if (i != null) window.moving[i] = e.target.checked;
            render();
        });
        
        // 綁定事件
        E('btnNow').addEventListener('click', () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            E('dt').value = `${year}-${month}-${day}T${hours}:${minutes}`;
            render();
        });
        
        E('btnRandomHex').addEventListener('click', () => {
            const TRIS = ['乾', '兌', '離', '震', '巽', '坎', '艮', '坤'];
            E('upper').value = TRIS[Math.floor(Math.random() * TRIS.length)];
            E('lower').value = TRIS[Math.floor(Math.random() * TRIS.length)];
            render();
        });
        
        E('redraw').addEventListener('click', render);
        
        // 零錢起卦事件
        E('btnTossCoins').addEventListener('click', tossCoins);
        E('btnResetCoins').addEventListener('click', resetCoins);
        E('btnApplyCoins').addEventListener('click', applyCoinResults);
        E('btnAutoToss').addEventListener('click', autoTossSixTimes);
        
        // AI分析事件
        E('btnAIAnalysis').addEventListener('click', getAITCMAnalysis);
        
        // 綁定輸入事件
        ['upper', 'lower', 'size', 'offx', 'offy', 'gap', 'w5_mu', 'w5_huo', 'w5_tu', 'w5_jin', 'w5_shui', 'yongShen'].forEach(id => {
            E(id).addEventListener('input', render);
        });
        
        // 初始化顯示
        updateCoinResultsDisplay();
        render();
    });
  </script>
</body>
</html>
