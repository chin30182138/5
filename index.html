<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ä»™äººæŒ‡è·¯å…­çˆ»æ’ç›¤ - å®Œæ•´ç‰ˆ</title>
  <style>
    :root{--card:#fff;--line:#e5e7eb;--muted:#64748b}
    *{box-sizing:border-box}
    body{margin:0;background:#f6f7fb;font-family:"Noto Sans TC","Microsoft JhengHei",system-ui}
    main{max-width:1180px;margin:18px auto;padding:0 12px}
    h1{margin:0 0 10px;font-size:22px}
    .grid{
      display:grid;
      grid-template-columns: 1.5fr 1fr;
      gap:12px
    }
    .sec{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px;
      margin:10px 0;
      overflow-x: auto;
    }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0}
    input[type=text]{flex:1;min-width:220px;border:1px solid #cbd5e1;border-radius:8px;height:36px;padding:0 10px;font-size:14px}
    input[type=datetime-local], select, button{height:36px;border:1px solid #cbd5e1;border-radius:8px;background:#fff;padding:0 10px;font-size:14px}
    button{cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    .badge{display:inline-block;padding:2px 10px;border-radius:999px;background:#eef2ff;color:#4338ca;font-size:12px}
    .canvasWrap{
      border:1px solid var(--line);
      border-radius:10px;
      background:#fff;
      padding:8px;
      overflow: auto;
    }
    canvas{display:block;min-width:600px;width:100%;height:560px}
    .yaoCtl{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
    .yaoCtl>label{display:flex;align-items:center;gap:6px;justify-content:center;border:1px dashed #cbd5e1;border-radius:8px;padding:6px;font-size:14px}
    #err{position:fixed;right:12px;top:12px;z-index:9999;max-width:60ch;background:#fee2e2;color:#991b1b;border:1px solid #fecaca;border-radius:10px;padding:10px;display:none}
    .miniVal{font-variant-numeric:tabular-nums;color:#475569;font-size:13px}
    .btns button{height:32px}
    .pillars{display:flex;gap:10px;flex-wrap:wrap}
    .pillars span{background:#eef2ff;color:#1e3a8a;border-radius:8px;padding:4px 10px;font-size:13px}
    
    /* é›¶éŒ¢èµ·å¦æ¨£å¼ */
    .coin-section {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 12px;
      margin: 10px 0;
    }
    .coin-section h3 {
      margin: 0 0 10px;
      font-size: 16px;
      color: #1e293b;
    }
    .coin-container {
      display: flex;
      gap: 15px;
      align-items: center;
      justify-content: center;
      margin: 10px 0;
      flex-wrap: wrap;
    }
    .coin {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(145deg, #fbbf24, #d97706);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      color: white;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .coin.spinning {
      animation: coinSpin 1s linear infinite;
    }
    .coin-result {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      color: white;
    }
    .coin-result.yang {
      background: linear-gradient(145deg, #3b82f6, #1d4ed8);
    }
    .coin-result.yin {
      background: linear-gradient(145deg, #64748b, #475569);
    }
    @keyframes coinSpin {
      0% { transform: rotateY(0deg) scale(1); }
      50% { transform: rotateY(180deg) scale(1.1); }
      100% { transform: rotateY(360deg) scale(1); }
    }
    .coin-controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
    }
    .coin-controls button {
      padding: 8px 16px;
    }
    .coin-results {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .coin-yao {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }
    .coin-yao .yao-line {
      width: 40px;
      height: 6px;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: white;
      font-weight: bold;
    }
    .coin-yao .yao-line.yang {
      background: #3b82f6;
    }
    .coin-yao .yao-line.yin {
      background: #64748b;
    }
    .coin-yao .yao-number {
      font-size: 12px;
      color: #64748b;
    }
    .coin-progress {
      margin-top: 10px;
      text-align: center;
    }
    .sound-control {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      justify-content: center;
    }
    
    /* AIåˆ†ææŒ‰éˆ• */
    .ai-analysis-btn {
      background: linear-gradient(145deg, #10b981, #059669);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
      width: 100%;
    }
    .ai-analysis-btn:hover {
      background: linear-gradient(145deg, #059669, #047857);
    }
    .ai-analysis-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f4f6;
      border-radius: 50%;
      border-top-color: #10b981;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .ai-analysis-result {
      margin-top: 15px;
      padding: 15px;
      background: #f0fdf4;
      border-radius: 8px;
      border-left: 4px solid #10b981;
    }
    .ai-analysis-result h4 {
      margin: 0 0 10px 0;
      color: #065f46;
    }

    /* å¦åœ–æ§åˆ¶æ¨£å¼ */
    .canvas-controls {
      margin-top: 10px;
      padding: 10px;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }
    .canvas-controls .row {
      margin: 6px 0;
    }
    .canvas-controls label {
      min-width: 80px;
      font-size: 14px;
    }
    .canvas-controls input[type="range"] {
      flex: 1;
      max-width: 200px;
    }

    @media print {
      @page { size: A4 portrait; margin: 12mm; }
      .grid { display:block; }
      .sec { border:none; padding:0; margin:0 0 10px; overflow-x: visible; }
      .hide-print, .btns, .yaoCtl, #redraw, #download, #btnNow, #btnPrint, .canvas-controls, 
      #size, #offx, #offy, #gap, #headgap, #sizeVal, #offxVal, #offyVal, #gapVal, #headgapVal,
      .coin-section, #tcmBox { display:none !important; }
      .canvasWrap { border:none; padding:0; overflow-x: visible; }
      canvas { height:auto; width:100%; min-width: auto; }
    }
  </style>
</head>
<body>
  <main>
    <h1>ä»™äººæŒ‡è·¯å…­çˆ»æ’ç›¤ - å®Œæ•´ç‰ˆ</h1>
    <div id="err"></div>
    
    <!-- é›¶éŒ¢èµ·å¦å€å¡Š -->
    <div class="coin-section">
      <h3>é›¶éŒ¢èµ·å¦</h3>
      <div class="coin-container">
        <div class="coin" id="coin1">1</div>
        <div class="coin" id="coin2">2</div>
        <div class="coin" id="coin3">3</div>
      </div>
      <div class="coin-progress" id="coinProgress">å·²æ“²ï¼š0/6 æ¬¡</div>
      <div class="sound-control">
        <input type="checkbox" id="soundEnabled" checked>
        <label for="soundEnabled">æ“²å¹£éŸ³æ•ˆ</label>
        <select id="soundType">
          <option value="coin">ç¡¬å¹£è²</option>
          <option value="bell">éˆ´éºè²</option>
          <option value="chime">é¢¨éˆ´è²</option>
          <option value="drum">é¼“è²</option>
        </select>
      </div>
      <div class="coin-controls">
        <button id="btnTossCoins">æ“²é›¶éŒ¢</button>
        <button id="btnResetCoins">é‡ç½®</button>
        <button id="btnApplyCoins">å¥—ç”¨å¦è±¡</button>
        <button id="btnAutoToss">è‡ªå‹•æ“²å…­æ¬¡</button>
      </div>
      <div class="coin-results" id="coinResults"></div>
    </div>
    
    <div class="grid">
      <section class="sec">
        <div class="row hide-print">
          <label>ä¸Šå¦</label>
          <select id="upper">
            <option>ä¹¾</option><option>å…Œ</option><option>é›¢</option><option>éœ‡</option>
            <option>å·½</option><option selected>å</option><option>è‰®</option><option>å¤</option>
          </select>
          <span>ä¸‹å¦</span>
          <select id="lower">
            <option selected>å</option><option>ä¹¾</option><option>å…Œ</option><option>é›¢</option>
            <option>éœ‡</option><option>å·½</option><option>è‰®</option><option>å¤</option>
          </select>
          <span class="badge">ä¼ç¥ï¼ç¼ºå‰‡å›æœ¬å®®ç´”å¦è£œä½ï½œä¸–æ‡‰ï¼š1â†”4ã€2â†”5ã€3â†”6</span>
        </div>
        
        <div class="row btns hide-print">
          <button id="btnRandomHex">éš¨æ©Ÿèµ·å¦</button>
        </div>
        
        <div class="row hide-print">
          <label>å•é¡Œ</label>
          <input id="question" type="text" placeholder="è«‹è¼¸å…¥èµ·å¦å•é¡Œ" value="ç¤ºä¾‹ï¼šæ±‚è²¡é‹">
        </div>
        
        <div class="row hide-print">
          <label>ç”¨ç¥</label>
          <select id="yongShen">
            <option value="">ï¼ˆæœªæŒ‡å®šï¼‰</option>
            <option value="ä¸–">ä¸– (è‡ªèº«)</option>
            <option value="æ‡‰">æ‡‰ (å°æ–¹)</option>
            <option value="çˆ¶æ¯">çˆ¶æ¯ (å­¸æ¥­/æ–‡æ›¸)</option>
            <option value="å…„å¼Ÿ">å…„å¼Ÿ (ç«¶çˆ­/åŠ«è²¡)</option>
            <option value="å®˜é¬¼">å®˜é¬¼ (äº‹æ¥­/ç–¾ç—…)</option>
            <option value="å¦»è²¡" selected>å¦»è²¡ (æ±‚è²¡/å¦»å­)</option>
            <option value="å­å­«">å­å­« (ç¦å¾·/è§£æ†‚)</option>
          </select>
          <span id="ysName" class="badge"></span>
        </div>
        
        <div class="row hide-print">
          <label>æ™‚é–“</label>
          <input id="dt" type="datetime-local">
          <button id="btnNow">ç¾åœ¨</button>
          <button id="btnPrint">åˆ—å°</button>
        </div>
        
        <div class="row pillars">
          <span id="gzYear">å¹´ï¼šâ€”</span>
          <span id="gzMonth">æœˆï¼šâ€”</span>
          <span id="gzDay">æ—¥ï¼šâ€”</span>
          <span id="gzHour">æ™‚ï¼šâ€”</span>
          <span id="gzXun">æ—¬é¦–ï¼šâ€”</span>
          <span id="gzKW">ç©ºäº¡ï¼šâ€”</span>
        </div>
        
        <div class="row hide-print">
          <label>å‹•çˆ»</label>
          <div class="yaoCtl" id="mvCtl"></div>
        </div>
        
        <div class="row hide-print">
          <button id="redraw">é‡ç¹ªå¦è±¡</button>
          <button id="download">åŒ¯å‡º PNG</button>
        </div>
        
        <div class="canvasWrap">
          <canvas id="hexCanvas"></canvas>
        </div>

        <!-- å¦åœ–å¤§å°æ§åˆ¶ -->
        <div class="canvas-controls hide-print">
          <div class="row">
            <label>å¦åœ–å¤§å°</label>
            <input type="range" id="size" min="140" max="440" value="300">
            <span id="sizeVal" class="miniVal">300</span>
          </div>
          <div class="row">
            <label>æ°´å¹³åç§»</label>
            <input type="range" id="offx" min="-320" max="320" value="0">
            <span id="offxVal" class="miniVal">0</span>
          </div>
          <div class="row">
            <label>å‚ç›´åç§»</label>
            <input type="range" id="offy" min="-220" max="220" value="0">
            <span id="offyVal" class="miniVal">0</span>
          </div>
          <div class="row">
            <label>çˆ»è·</label>
            <input type="range" id="gap" min="26" max="38" value="32">
            <span id="gapVal" class="miniVal">32</span>
          </div>
          <div class="row">
            <label>æ¬„é ­é–“è·</label>
            <input type="range" id="headgap" min="16" max="48" value="24">
            <span id="headgapVal" class="miniVal">24</span>
          </div>
        </div>

        <div class="muted">æ¬„åºï¼š<b>å…­ç¸</b>ï½œ<b>ä¼ç¥</b>ï½œ<b>çˆ»è±¡</b>ï½œ<b>å…­è¦ª</b>ï½œ<b>åœ°æ”¯</b>ï½œ<b>ä¸–æ‡‰</b>ï½œ<b>è®Šå…­è¦ª</b>ï½œ<b>è®Šæ”¯</b>ï¼ˆåˆçˆ»åœ¨ä¸‹ï¼›å‹•çˆ»ï¼šé™½â—‹ã€é™°Ã—ï¼‰ã€‚</div>
      </section>
      
      <section class="sec">
        <div id="w5_sec">
          <h3>äº”è¡Œé›·é”åœ–</h3>
          <div class="canvasWrap">
            <canvas id="w5_canv" style="height:300px;"></canvas>
          </div>
          <div id="w5_ctrl">
            <div class="row"><label>æœ¨</label><input id="w5_mu" type="range" min="1" max="10" value="6"><span id="w5_muVal" class="miniVal">6</span></div>
            <div class="row"><label>ç«</label><input id="w5_huo" type="range" min="1" max="10" value="6"><span id="w5_huoVal" class="miniVal">6</span></div>
            <div class="row"><label>åœŸ</label><input id="w5_tu" type="range" min="1" max="10" value="6"><span id="w5_tuVal" class="miniVal">6</span></div>
            <div class="row"><label>é‡‘</label><input id="w5_jin" type="range" min="1" max="10" value="6"><span id="w5_jinVal" class="miniVal">6</span></div>
            <div class="row"><label>æ°´</label><input id="w5_shui" type="range" min="1" max="10" value="6"><span id="w5_shuiVal" class="miniVal">6</span></div>
          </div>
        </div>
        
        <div id="tcmBox">
          <h3>ä¸­é†«AIåˆ†æ</h3>
          <div id="tcmCore"></div>
          <button id="btnAIAnalysis" class="ai-analysis-btn">
            <span class="loading" style="display:none;"></span>
            <span id="aiBtnText">ç²å–AIä¸­é†«åˆ†æ</span>
          </button>
          <div id="aiAnalysisResult" class="ai-analysis-result" style="display:none;">
            <h4>ğŸ¯ AIä¸­é†«åˆ†æçµæœ</h4>
            <div id="aiAnalysisContent"></div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    // ==================== æ ¸å¿ƒè®Šé‡å®šç¾© ====================
    const E = id => document.getElementById(id);
    const GAN = ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'];
    const ZHI = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];
    const ZHI_ELEM = { å­: 'æ°´', ä¸‘: 'åœŸ', å¯…: 'æœ¨', å¯: 'æœ¨', è¾°: 'åœŸ', å·³: 'ç«', åˆ: 'ç«', æœª: 'åœŸ', ç”³: 'é‡‘', é…‰: 'é‡‘', æˆŒ: 'åœŸ', äº¥: 'æ°´' };
    const GONG_ELEM = { ä¹¾: 'é‡‘', å¤: 'åœŸ', éœ‡: 'æœ¨', å·½: 'æœ¨', å: 'æ°´', é›¢: 'ç«', è‰®: 'åœŸ', å…Œ: 'é‡‘' };
    const TRIG = { ä¹¾: [1,1,1], å…Œ: [1,1,0], é›¢: [1,0,1], éœ‡: [1,0,0], å·½: [0,1,1], å: [0,1,0], è‰®: [0,0,1], å¤: [0,0,0] };
    const TRINAMES = Object.keys(TRIG);
    const YANG_TRIG = new Set(['ä¹¾', 'éœ‡', 'å', 'è‰®']);
    const INNER_START = { ä¹¾: 'å­', å: 'å¯…', éœ‡: 'å­', è‰®: 'è¾°', å¤: 'æœª', å·½: 'ä¸‘', é›¢: 'å¯', å…Œ: 'å·³' };
    const OUTER_START = { ä¹¾: 'åˆ', å: 'ç”³', éœ‡: 'åˆ', è‰®: 'æˆŒ', å¤: 'ä¸‘', å·½: 'æœª', é›¢: 'é…‰', å…Œ: 'äº¥' };
    const SEQ_YANG = ['å­', 'å¯…', 'è¾°', 'åˆ', 'ç”³', 'æˆŒ'];
    const SEQ_YIN = ['äº¥', 'é…‰', 'æœª', 'å·³', 'å¯', 'ä¸‘'];
    const SIX = ['é’é¾', 'æœ±é›€', 'å‹¾é™³', 'è£è›‡', 'ç™½è™', 'ç„æ­¦'];
    const SIX_START_BY_GAN = { ç”²: 0, ä¹™: 0, ä¸™: 1, ä¸: 1, æˆŠ: 2, å·±: 3, åºš: 4, è¾›: 4, å£¬: 5, ç™¸: 5 };
    const WU_SHENG = { æœ¨: 'ç«', ç«: 'åœŸ', åœŸ: 'é‡‘', é‡‘: 'æ°´', æ°´: 'æœ¨' };
    const WU_KE = { æœ¨: 'åœŸ', åœŸ: 'æ°´', æ°´: 'ç«', ç«: 'é‡‘', é‡‘: 'æœ¨' };

    // å…¨å±€è®Šé‡
    window.moving = [false, false, false, false, false, false];
    let coinResults = [null, null, null, null, null, null];
    let coinTossCount = 0;
    let isAnimating = false;

    // ==================== å¾Œå°APIé…ç½® ====================
    const API_CONFIG = {
      baseURL: 'https://your-tcm-ai-api.com',
      endpoints: {
        tcmAnalysis: '/api/analyze-hexagram',
        healthAdvice: '/api/health-advice'
      },
      // å¯¦éš›éƒ¨ç½²æ™‚è¨­ç‚º false
      mockMode: true
    };

    // ==================== é›¶éŒ¢èµ·å¦ç³»çµ± ====================
    function tossCoins() {
        if (coinTossCount >= 6) {
            alert('å·²å®Œæˆå…­æ¬¡æ“²å¹£ï¼');
            return;
        }
        if (isAnimating) return;
        
        isAnimating = true;
        playCoinSound();
        
        const coins = [E('coin1'), E('coin2'), E('coin3')];
        coins.forEach(coin => {
            coin.className = 'coin';
            void coin.offsetWidth;
            coin.classList.add('spinning');
        });

        setTimeout(() => {
            coins.forEach(coin => coin.classList.remove('spinning'));
            
            const results = [
                Math.random() > 0.5 ? 1 : 0,
                Math.random() > 0.5 ? 1 : 0,
                Math.random() > 0.5 ? 1 : 0
            ];

            coins.forEach((coin, i) => {
                coin.textContent = results[i] ? 'é™½' : 'é™°';
                coin.className = `coin-result ${results[i] ? 'yang' : 'yin'}`;
            });

            const yangCount = results.reduce((a, b) => a + b, 0);
            let yaoValue, yaoType;
            
            if (yangCount === 3) { yaoValue = 1; yaoType = 'è€é™½'; }
            else if (yangCount === 2) { yaoValue = 0; yaoType = 'å°‘é™°'; }
            else if (yangCount === 1) { yaoValue = 1; yaoType = 'å°‘é™½'; }
            else { yaoValue = 0; yaoType = 'è€é™°'; }

            coinResults[coinTossCount] = { value: yaoValue, type: yaoType, moving: yangCount === 3 || yangCount === 0 };
            coinTossCount++;
            
            E('coinProgress').textContent = `å·²æ“²ï¼š${coinTossCount}/6 æ¬¡`;
            updateCoinResultsDisplay();
            isAnimating = false;

            if (coinTossCount === 6) {
                setTimeout(() => applyCoinResults(), 500);
            }
        }, 1000);
    }

    function playCoinSound() {
        if (!E('soundEnabled').checked) return;
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        oscillator.frequency.value = 800 + Math.random() * 400;
        gainNode.gain.value = 0.1;
        oscillator.start();
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
        oscillator.stop(audioContext.currentTime + 0.5);
    }

    function updateCoinResultsDisplay() {
        const container = E('coinResults');
        container.innerHTML = '';
        
        for (let i = 0; i < 6; i++) {
            const yaoDiv = document.createElement('div');
            yaoDiv.className = 'coin-yao';
            
            const yaoLine = document.createElement('div');
            yaoLine.className = 'yao-line';
            
            const yaoNumber = document.createElement('div');
            yaoNumber.className = 'yao-number';
            yaoNumber.textContent = `${i+1}çˆ»`;
            
            if (i < coinTossCount && coinResults[i]) {
                const result = coinResults[i];
                yaoLine.classList.add(result.value ? 'yang' : 'yin');
                yaoLine.textContent = result.type;
                if (result.moving) {
                    yaoLine.style.boxShadow = '0 0 5px #ef4444';
                }
            } else {
                yaoLine.style.background = '#e2e8f0';
                yaoLine.textContent = '?';
            }
            
            yaoDiv.appendChild(yaoLine);
            yaoDiv.appendChild(yaoNumber);
            container.appendChild(yaoDiv);
        }
    }

    function resetCoins() {
        coinResults = [null, null, null, null, null, null];
        coinTossCount = 0;
        isAnimating = false;
        
        ['coin1', 'coin2', 'coin3'].forEach(id => {
            const coin = E(id);
            coin.textContent = id.replace('coin', '');
            coin.className = 'coin';
        });
        
        E('coinProgress').textContent = 'å·²æ“²ï¼š0/6 æ¬¡';
        updateCoinResultsDisplay();
    }

    function applyCoinResults() {
        if (coinTossCount < 6) {
            alert('è«‹å…ˆå®Œæˆå…­æ¬¡æ“²å¹£ï¼');
            return;
        }

        const lines = coinResults.map(r => r.value);
        const moving = coinResults.map(r => r.moving);

        const lowerBits = lines.slice(0, 3);
        const upperBits = lines.slice(3, 6);

        const lowerTrig = trigFromBits(lowerBits);
        const upperTrig = trigFromBits(upperBits);

        if (lowerTrig && upperTrig) {
            E('lower').value = lowerTrig;
            E('upper').value = upperTrig;

            const mvCtlInputs = document.querySelectorAll('#mvCtl input[type="checkbox"]');
            mvCtlInputs.forEach((cb, index) => {
                const movingIndex = 5 - index;
                cb.checked = moving[movingIndex];
                window.moving[movingIndex] = moving[movingIndex];
            });

            render();
            updateW5RadarFromHexagram(); // æ›´æ–°é›·é”åœ–
            E('question').value = 'é›¶éŒ¢èµ·å¦';
            alert('å¦è±¡å·²å¥—ç”¨ï¼');
        }
    }

    function autoTossSixTimes() {
        resetCoins();
        let count = 0;
        const interval = setInterval(() => {
            tossCoins();
            count++;
            if (count >= 6) {
                clearInterval(interval);
                setTimeout(() => applyCoinResults(), 1000);
            }
        }, 1200);
    }

    // ==================== å¦ç›¤ç³»çµ±æ ¸å¿ƒå‡½æ•¸ ====================
    function trigFromBits(b3) {
        for (const n of TRINAMES) {
            const t = TRIG[n];
            if (t[0] === b3[0] && t[1] === b3[1] && t[2] === b3[2]) return n;
        }
        return null;
    }

    function guaNameOf(up, lo) {
        const guaMap = {
            "ä¹¾ä¹¾": "ä¹¾ç‚ºå¤©", "å…Œå…Œ": "å…Œç‚ºæ¾¤", "é›¢é›¢": "é›¢ç‚ºç«", "éœ‡éœ‡": "éœ‡ç‚ºé›·",
            "å·½å·½": "å·½ç‚ºé¢¨", "åå": "åç‚ºæ°´", "è‰®è‰®": "è‰®ç‚ºå±±", "å¤å¤": "å¤ç‚ºåœ°",
            "ä¹¾å¤": "å¤©åœ°å¦", "ä¹¾å…Œ": "å¤©æ¾¤å±¥", "ä¹¾é›¢": "å¤©ç«åŒäºº", "ä¹¾éœ‡": "å¤©é›·ç„¡å¦„",
            "ä¹¾å·½": "å¤©é¢¨å§¤", "ä¹¾å": "å¤©æ°´è¨Ÿ", "ä¹¾è‰®": "å¤©å±±é¯", "ä¹¾å¤": "å¤©åœ°å¦"
        };
        return guaMap[up + lo] || `${up}${lo}å¦`;
    }

    function threeBranchesOfTrigram(tri, inner) {
        const start = inner ? INNER_START[tri] : OUTER_START[tri];
        const seq = YANG_TRIG.has(tri) ? SEQ_YANG : SEQ_YIN;
        const i0 = seq.indexOf(start);
        return [seq[i0 % 6], seq[(i0 + 1) % 6], seq[(i0 + 2) % 6]];
    }

    function naJiaBranches(lines) {
        const { up, lo } = upperLowerOf(lines);
        return [...threeBranchesOfTrigram(lo, true), ...threeBranchesOfTrigram(up, false)];
    }

    function upperLowerOf(lines) {
        const lo = trigFromBits(lines.slice(0, 3));
        const up = trigFromBits(lines.slice(3, 6));
        return { up, lo };
    }

    function sixKin(meElem, branch) {
        const e = ZHI_ELEM[branch];
        if (e === meElem) return 'å…„å¼Ÿ';
        if (WU_KE[e] === meElem) return 'å®˜é¬¼';
        if (WU_KE[meElem] === e) return 'å¦»è²¡';
        if (WU_SHENG[e] === meElem) return 'çˆ¶æ¯';
        if (WU_SHENG[meElem] === e) return 'å­å­«';
        return 'å…„å¼Ÿ';
    }

    function changedLines(lines, moving) {
        return lines.map((v, i) => moving[i] ? (v ? 0 : 1) : v);
    }

    // è¨ˆç®—ç”¨ç¥äº”è¡Œæ—ºå¼±
    function calculateYongShenStrength(yongShen, monthZhi, dayZhi, meElem, branches, moving) {
        const ysKinElemMap = getYSFiveElementMap(meElem);
        const targetElem = ysKinElemMap[yongShen];
        if (!targetElem) return { scores: {æœ¨:6,ç«:6,åœŸ:6,é‡‘:6,æ°´:6}, targetElem: '' };
        
        let strength = 6; // åŸºç¤åˆ†æ•¸
        
        // æœˆä»¤å½±éŸ¿
        const monthElem = ZHI_ELEM[monthZhi.charAt(1)];
        if (monthElem === targetElem) strength += 2;
        else if (WU_SHENG[monthElem] === targetElem) strength += 1;
        else if (WU_KE[monthElem] === targetElem) strength -= 2;
        
        // æ—¥ä»¤å½±éŸ¿
        const dayElem = ZHI_ELEM[dayZhi.charAt(1)];
        if (dayElem === targetElem) strength += 1;
        else if (WU_SHENG[dayElem] === targetElem) strength += 0.5;
        else if (WU_KE[dayElem] === targetElem) strength -= 1;
        
        // å‹•çˆ»å½±éŸ¿
        branches.forEach((branch, i) => {
            if (moving[i]) {
                const moveElem = ZHI_ELEM[branch];
                if (moveElem === targetElem) strength += 1;
                else if (WU_SHENG[moveElem] === targetElem) strength += 0.5;
                else if (WU_KE[moveElem] === targetElem) strength -= 1;
            }
        });
        
        // è½‰æ›ç‚ºäº”è¡Œåˆ†æ•¸
        const scores = {æœ¨:6,ç«:6,åœŸ:6,é‡‘:6,æ°´:6};
        scores[targetElem] = Math.min(10, Math.max(1, Math.round(strength)));
        
        return { scores, targetElem };
    }

    function getYSFiveElementMap(meElem) {
        return {
            'çˆ¶æ¯': WU_SHENG[meElem],
            'å…„å¼Ÿ': meElem,
            'å®˜é¬¼': WU_KE[meElem],
            'å¦»è²¡': WU_KE[WU_SHENG[meElem]],
            'å­å­«': WU_SHENG[WU_KE[meElem]],
            'ä¸–': meElem,
            'æ‡‰': meElem
        };
    }

    function calcPillarsAndSix() {
        const dt = E('dt').value ? new Date(E('dt').value) : new Date();
        const year = dt.getFullYear();
        const month = dt.getMonth() + 1;
        const day = dt.getDate();
        const hour = dt.getHours();
        
        // å®Œæ•´å¹²æ”¯è¨ˆç®—
        const ganIndex = (year - 4) % 10;
        const zhiIndex = (year - 4) % 12;
        
        const pillars = {
            year: `${GAN[ganIndex]}${ZHI[zhiIndex]}`,
            month: `${GAN[(ganIndex + month - 1) % 10]}${ZHI[(zhiIndex + month - 1) % 12]}`,
            day: `${GAN[(ganIndex + day - 1) % 10]}${ZHI[(zhiIndex + day - 1) % 12]}`,
            hour: `${GAN[(ganIndex + Math.floor(hour/2)) % 10]}${ZHI[Math.floor(hour/2) % 12]}`
        };
        
        E('gzYear').textContent = `å¹´ï¼š${pillars.year}`;
        E('gzMonth').textContent = `æœˆï¼š${pillars.month}`;
        E('gzDay').textContent = `æ—¥ï¼š${pillars.day}`;
        E('gzHour').textContent = `æ™‚ï¼š${pillars.hour}`;
        E('gzXun').textContent = `æ—¬é¦–ï¼š${GAN[ganIndex]}${ZHI[0]}`;
        E('gzKW').textContent = `ç©ºäº¡ï¼š${ZHI[10]}${ZHI[11]}`;
        
        const dayGan = pillars.day.charAt(0);
        const startIdx = SIX_START_BY_GAN[dayGan] || 0;
        return {
            six: [0, 1, 2, 3, 4, 5].map(i => SIX[(startIdx + i) % 6]),
            pillars: pillars
        };
    }

    function setupCanvas() {
        const cvs = E('hexCanvas');
        const ctx = cvs.getContext('2d');
        const dpr = window.devicePixelRatio || 1;
        cvs.width = Math.floor(cvs.clientWidth * dpr);
        cvs.height = Math.floor(cvs.clientHeight * dpr);
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        return { cvs, ctx };
    }

    function drawWhiteTag(ctx, x, y, text) {
        ctx.font = '12px "Noto Sans TC"';
        const pad = 4, h = 18, w = ctx.measureText(text).width + pad * 2;
        const pa = ctx.textAlign, pb = ctx.textBaseline;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = 'rgba(255,255,255,.96)';
        ctx.fillRect(x - w/2, y - h/2, w, h);
        ctx.fillStyle = '#0f172a';
        ctx.fillText(text, x, y);
        ctx.textAlign = pa;
        ctx.textBaseline = pb;
    }

    function render() {
        const upTri = E('upper').value;
        const loTri = E('lower').value;
        const baseLines = [...TRIG[loTri], ...TRIG[upTri]];
        const { six, pillars } = calcPillarsAndSix();
        
        const { cvs, ctx } = setupCanvas();
        const W = cvs.clientWidth, H = cvs.clientHeight;
        
        ctx.clearRect(0, 0, W, H);
        ctx.fillStyle = '#0f172a';
        
        // ç¹ªè£½åŸºæœ¬ä¿¡æ¯
        ctx.font = 'bold 16px "Noto Sans TC"';
        ctx.fillText(`å•é¡Œï¼š${E('question').value || 'â€”'}`, 12, 26);
        ctx.font = '14px "Noto Sans TC"';
        ctx.fillText(`èµ·å¦æ™‚é–“ï¼š${E('dt').value.replace('T', ' ')}`, 12, 48);
        ctx.fillText(`å››æŸ±ï¼š${pillars.year} ${pillars.month} ${pillars.day} ${pillars.hour}`, 12, 68);
        ctx.fillText(`å¦åï¼š${guaNameOf(upTri, loTri)} ä¸Šå¦ï¼š${upTri} ä¸‹å¦ï¼š${loTri} å¦å®®ï¼š${upTri}`, 12, 88);
        
        // è¨ˆç®—å¦è±¡æ•¸æ“š
        const gong = upTri;
        const meElem = GONG_ELEM[gong];
        const branches = naJiaBranches(baseLines);
        const kins = branches.map(b => sixKin(meElem, b));
        const chLines = changedLines(baseLines, window.moving);
        const branchesC = naJiaBranches(chLines);
        const kinsC = branchesC.map(b => sixKin(meElem, b));
        
        // ç¹ªè£½å¦è±¡è¡¨æ ¼
        const size = +E('size').value;
        const offx = +E('offx').value;
        const offy = +E('offy').value;
        const gap = +E('gap').value;
        const headgap = +E('headgap').value;
        const x0 = 16 + offx, y0 = 120 + offy + headgap;
        
        // è¡¨é ­
        const col = {
            six: x0, fu: x0 + 60, yao: x0 + 120, kin: x0 + 120 + size + 30,
            zhi: x0 + 120 + size + 100, mark: x0 + 120 + size + 170,
            kinc: x0 + 120 + size + 230, zhic: x0 + 120 + size + 300
        };
        
        ctx.font = 'bold 13px "Noto Sans TC"';
        ctx.fillStyle = '#475569';
        ctx.fillText('å…­ç¸', col.six, y0 - 8 - headgap);
        ctx.fillText('ä¼ç¥', col.fu, y0 - 8 - headgap);
        ctx.fillText('çˆ»è±¡', col.yao, y0 - 8 - headgap);
        ctx.fillText('å…­è¦ª', col.kin, y0 - 8 - headgap);
        ctx.fillText('åœ°æ”¯', col.zhi, y0 - 8 - headgap);
        ctx.fillText('ä¸–æ‡‰', col.mark, y0 - 8 - headgap);
        ctx.fillText('è®Šå…­è¦ª', col.kinc, y0 - 8 - headgap);
        ctx.fillText('è®Šæ”¯', col.zhic, y0 - 8 - headgap);
        
        // ç¹ªè£½çˆ»è±¡
        ctx.lineWidth = 6;
        ctx.strokeStyle = '#111827';
        ctx.fillStyle = '#0f172a';
        ctx.font = '14px "Noto Sans TC"';
        
        for (let pos = 6; pos >= 1; pos--) {
            const i = pos - 1;
            const y = y0 + (6 - pos) * gap;
            
            // å…­ç¸
            ctx.fillText(six[i], col.six, y + 5);
            
            // çˆ»è±¡
            if (baseLines[i] === 1) {
                ctx.beginPath();
                ctx.moveTo(col.yao, y);
                ctx.lineTo(col.yao + size, y);
                ctx.stroke();
            } else {
                const g = size * 0.22;
                const seg = (size - g) / 2;
                ctx.beginPath();
                ctx.moveTo(col.yao, y);
                ctx.lineTo(col.yao + seg, y);
                ctx.moveTo(col.yao + seg + g, y);
                ctx.lineTo(col.yao + size, y);
                ctx.stroke();
            }
            
            // å‹•çˆ»æ¨™è¨˜
            if (window.moving[i]) {
                ctx.fillStyle = '#ef4444';
                ctx.font = 'bold 16px "Noto Sans TC"';
                ctx.fillText(baseLines[i] === 1 ? 'â—‹' : 'Ã—', col.yao + size + 12, y + 6);
                ctx.fillStyle = '#0f172a';
                ctx.font = '14px "Noto Sans TC"';
            }
            
            // å…­è¦ª
            ctx.fillText(kins[i], col.kin, y + 5);
            
            // åœ°æ”¯
            ctx.fillText(branches[i], col.zhi, y + 5);
            
            // ä¸–æ‡‰
            if (pos === 6) drawWhiteTag(ctx, col.mark, y, 'ä¸–');
            if (pos === 3) drawWhiteTag(ctx, col.mark, y, 'æ‡‰');
            
            // è®Šå…­è¦ªå’Œè®Šæ”¯
            if (window.moving[i]) {
                drawWhiteTag(ctx, col.kinc, y, kinsC[i]);
                drawWhiteTag(ctx, col.zhic, y, branchesC[i]);
            }
        }
        
        // æ›´æ–°äº”è¡Œé›·é”åœ–
        updateW5RadarFromHexagram();
    }

    // ==================== äº”è¡Œé›·é”åœ– ====================
    function updateW5RadarFromHexagram() {
        const yongShen = E('yongShen').value;
        if (!yongShen) return;
        
        const upTri = E('upper').value;
        const meElem = GONG_ELEM[upTri];
        const baseLines = [...TRIG[E('lower').value], ...TRIG[upTri]];
        const branches = naJiaBranches(baseLines);
        const pillars = {
            month: E('gzMonth').textContent.substr(3),
            day: E('gzDay').textContent.substr(3)
        };
        
        const { scores } = calculateYongShenStrength(yongShen, pillars.month, pillars.day, meElem, branches, window.moving);
        
        // æ›´æ–°æ»‘æ¡¿å€¼
        E('w5_mu').value = scores.æœ¨;
        E('w5_huo').value = scores.ç«;
        E('w5_tu').value = scores.åœŸ;
        E('w5_jin').value = scores.é‡‘;
        E('w5_shui').value = scores.æ°´;
        
        E('w5_muVal').textContent = scores.æœ¨;
        E('w5_huoVal').textContent = scores.ç«;
        E('w5_tuVal').textContent = scores.åœŸ;
        E('w5_jinVal').textContent = scores.é‡‘;
        E('w5_shuiVal').textContent = scores.æ°´;
        
        updateW5Radar();
    }

    function updateW5Radar() {
        const c = E('w5_canv');
        const ctx = c.getContext('2d');
        const dpr = window.devicePixelRatio || 1;
        c.width = Math.floor(c.clientWidth * dpr);
        c.height = Math.floor(c.clientHeight * dpr);
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        
        const W = c.clientWidth, H = c.clientHeight;
        const cx = W / 2, cy = H / 2, R = Math.min(W, H) / 2 * 0.7;
        
        ctx.clearRect(0, 0, W, H);
        
        // ç¹ªè£½é›·é”åœ–ç¶²æ ¼
        ctx.strokeStyle = '#e5e7eb';
        ctx.lineWidth = 1;
        for (let r = 1; r <= 5; r++) {
            const rr = R * r / 5;
            ctx.beginPath();
            for (let i = 0; i < 5; i++) {
                const a = -Math.PI/2 + i * 2*Math.PI/5;
                const x = cx + rr * Math.cos(a);
                const y = cy + rr * Math.sin(a);
                i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            }
            ctx.closePath();
            ctx.stroke();
        }
        
        // ç¹ªè£½æ•¸æ“š
        const values = {
            'æœ¨': +E('w5_mu').value,
            'ç«': +E('w5_huo').value,
            'åœŸ': +E('w5_tu').value,
            'é‡‘': +E('w5_jin').value,
            'æ°´': +E('w5_shui').value
        };
        
        const pts = [];
        const elements = ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´'];
        elements.forEach((elem, i) => {
            const a = -Math.PI/2 + i * 2*Math.PI/5;
            const rr = R * values[elem] / 10;
            pts.push([cx + rr * Math.cos(a), cy + rr * Math.sin(a)]);
        });
        
        ctx.fillStyle = 'rgba(59,130,246,0.2)';
        ctx.strokeStyle = '#3b82f6';
        ctx.lineWidth = 2;
        ctx.beginPath();
        pts.forEach((p, i) => {
            i === 0 ? ctx.moveTo(p[0], p[1]) : ctx.lineTo(p[0], p[1]);
        });
        ctx.closePath();
        ctx.fill();
        ctx.stroke();
        
        // ç¹ªè£½æ¨™ç±¤
        ctx.font = '14px "Noto Sans TC"';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = '#0f172a';
        elements.forEach((elem, i) => {
            const a = -Math.PI/2 + i * 2*Math.PI/5;
            const x = cx + (R + 20) * Math.cos(a);
            const y = cy + (R + 20) * Math.sin(a);
            ctx.fillText(elem, x, y);
        });
    }

    // ==================== AIä¸­é†«åˆ†æ ====================
    async function getAITCMAnalysis() {
        const btn = E('btnAIAnalysis');
        const loading = btn.querySelector('.loading');
        const btnText = E('aiBtnText');
        
        btn.disabled = true;
        loading.style.display = 'inline-block';
        btnText.textContent = 'AIåˆ†æä¸­...';
        
        try {
            const hexagramData = getHexagramDataForAI();
            let result;
            
            if (API_CONFIG.mockMode) {
                // æ¨¡æ“¬APIéŸ¿æ‡‰
                result = await mockAITCMAnalysis(hexagramData);
            } else {
                // å¯¦éš›APIèª¿ç”¨
                result = await callAITCMAnalysisAPI(hexagramData);
            }
            
            displayAIAnalysisResult(result);
            
        } catch (error) {
            console.error('AIåˆ†æå¤±æ•—:', error);
            alert('AIåˆ†ææœå‹™æš«æ™‚ä¸å¯ç”¨');
        } finally {
            btn.disabled = false;
            loading.style.display = 'none';
            btnText.textContent = 'ç²å–AIä¸­é†«åˆ†æ';
        }
    }

    function getHexagramDataForAI() {
        const upTri = E('upper').value;
        const loTri = E('lower').value;
        const baseLines = [...TRIG[loTri], ...TRIG[upTri]];
        const branches = naJiaBranches(baseLines);
        const meElem = GONG_ELEM[upTri];
        const kins = branches.map(b => sixKin(meElem, b));
        
        return {
            guaName: guaNameOf(upTri, loTri),
            element: meElem,
            yongShen: E('yongShen').value,
            question: E('question').value,
            pillars: {
                year: E('gzYear').textContent.substr(3),
                month: E('gzMonth').textContent.substr(3),
                day: E('gzDay').textContent.substr(3),
                hour: E('gzHour').textContent.substr(3)
            },
            moving: window.moving,
            sixRelations: kins,
            branches: branches,
            wuxingScores: {
                æœ¨: +E('w5_mu').value,
                ç«: +E('w5_huo').value,
                åœŸ: +E('w5_tu').value,
                é‡‘: +E('w5_jin').value,
                æ°´: +E('w5_shui').value
            }
        };
    }

    async function mockAITCMAnalysis(hexagramData) {
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        const analysisMap = {
            'æœ¨': {
                title: 'è‚è†½ç³»çµ±æ·±åº¦åˆ†æ',
                analysis: `æ ¹æ“š${hexagramData.guaName}å¦è±¡åŠäº”è¡Œé…ç½®ï¼Œæ‚¨çš„è‚è†½ç³»çµ±éœ€è¦ç‰¹åˆ¥èª¿ç†ã€‚å¦ä¸­æœ¨å…ƒç´ å¾—åˆ†${hexagramData.wuxingScores.æœ¨}/10ï¼Œ${hexagramData.wuxingScores.æœ¨ > 6 ? 'åæ—ºéœ€ç–æ³„' : 'åå¼±éœ€æ»‹é¤Š'}ã€‚`,
                suggestions: [
                    'å»ºè­°å°±è¨ºï¼šè‚è†½ç§‘ã€ä¸­é†«å…§ç§‘',
                    'é£²é£Ÿèª¿ç†ï¼šå¤šåƒç¶ è‰²è”¬èœï¼Œé©é‡é…¸å‘³é£Ÿç‰©',
                    'ä½œæ¯å»ºè­°ï¼šæ™šä¸Š11é»å‰å…¥ç¡ï¼Œé¿å…ç†¬å¤œå‚·è‚',
                    'æƒ…ç·’èª¿ç¯€ï¼šä¿æŒå¿ƒæƒ…èˆ’æš¢ï¼Œé¿å…æŠ‘é¬±æ€’æ°£',
                    'é‹å‹•å»ºè­°ï¼šæ™¨é–“æ•£æ­¥ã€å¤ªæ¥µæ‹³ã€ç‘œä¼½'
                ]
            },
            'ç«': {
                title: 'å¿ƒè¡€ç®¡ç³»çµ±å°ˆæ¥­åˆ†æ',
                analysis: `å¾${hexagramData.guaName}å¦è±¡åˆ†æï¼Œå¿ƒè¡€ç®¡ç³»çµ±ç‚ºé—œæ³¨é‡é»ã€‚ç«å…ƒç´ å¾—åˆ†${hexagramData.wuxingScores.ç«}/10ï¼Œ${hexagramData.wuxingScores.ç« > 6 ? 'éœ€æ¸…ç†±é™ç«' : 'éœ€æº«è£œå¿ƒé™½'}ã€‚`,
                suggestions: [
                    'å»ºè­°å°±è¨ºï¼šå¿ƒè¡€ç®¡ç§‘ã€ä¸­é†«å¿ƒç³»é–€è¨º',
                    'é£²é£Ÿèª¿ç†ï¼šé©é‡ç´…è‰²é£Ÿç‰©ï¼Œé¿å…è¾›è¾£åˆºæ¿€',
                    'æƒ…ç·’ç®¡ç†ï¼šä¿æŒå¹³å’Œï¼Œé¿å…éåº¦æ¿€å‹•',
                    'ä½œæ¯å»ºè­°ï¼šåˆé–“é©ç•¶ä¼‘æ¯ï¼Œé¿å…éå‹',
                    'é‹å‹•å»ºè­°ï¼šåˆå¾Œé©åº¦é‹å‹•ï¼Œé¿å…åŠ‡çƒˆé‹å‹•'
                ]
            }
        };
        
        const baseAnalysis = analysisMap[hexagramData.element] || analysisMap['æœ¨'];
        
        return {
            success: true,
            data: {
                title: baseAnalysis.title,
                analysis: baseAnalysis.analysis,
                suggestions: baseAnalysis.suggestions,
                hexagramInfo: hexagramData,
                timestamp: new Date().toISOString(),
                aiModel: 'TCM-AI-Expert v2.0'
            }
        };
    }

    async function callAITCMAnalysisAPI(hexagramData) {
        const response = await fetch(`${API_CONFIG.baseURL}${API_CONFIG.endpoints.tcmAnalysis}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                hexagram: hexagramData,
                timestamp: new Date().toISOString()
            })
        });
        
        if (!response.ok) {
            throw new Error(`APIè«‹æ±‚å¤±æ•—: ${response.status}`);
        }
        
        return await response.json();
    }

    function displayAIAnalysisResult(result) {
        const resultDiv = E('aiAnalysisResult');
        const contentDiv = E('aiAnalysisContent');
        
        if (result.success && result.data) {
            const { title, analysis, suggestions, hexagramInfo, aiModel } = result.data;
            
            let html = `
                <p><strong>${title}</strong></p>
                <p>${analysis}</p>
                <p><strong>å…·é«”å»ºè­°ï¼š</strong></p>
                <ul style="margin: 10px 0; padding-left: 20px;">
            `;
            
            suggestions.forEach(suggestion => {
                html += `<li style="margin: 5px 0;">${suggestion}</li>`;
            });
            
            html += `</ul>`;
            
            // æ·»åŠ è©³ç´°ä¿¡æ¯
            html += `
                <div style="margin-top: 15px; padding: 10px; background: #e0f2fe; border-radius: 6px;">
                    <p style="margin: 0; font-size: 12px; color: #0369a1;">
                        <strong>åˆ†æä¾æ“šï¼š</strong>${hexagramInfo.guaName}å¦ | å¦å®®äº”è¡Œï¼š${hexagramInfo.element} | ç”¨ç¥ï¼š${hexagramInfo.yongShen}<br>
                        <strong>AIæ¨¡å‹ï¼š</strong>${aiModel} | æ™‚é–“ï¼š${new Date().toLocaleString()}
                    </p>
                </div>
            `;
            
            contentDiv.innerHTML = html;
            resultDiv.style.display = 'block';
        } else {
            alert('AIåˆ†æçµæœè§£æå¤±æ•—');
        }
    }

    // ==================== åˆå§‹åŒ– ====================
    window.addEventListener('DOMContentLoaded', () => {
        // è¨­ç½®ç•¶å‰æ™‚é–“
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        E('dt').value = `${year}-${month}-${day}T${hours}:${minutes}`;
        
        // åˆå§‹åŒ–å‹•çˆ»æ§åˆ¶
        const mvCtl = E('mvCtl');
        mvCtl.innerHTML = [6, 5, 4, 3, 2, 1].map(p => 
            `<label><input type="checkbox" data-mv="${p-1}"> ${p}çˆ»å‹•</label>`
        ).join('');
        
        mvCtl.addEventListener('change', e => {
            const i = e.target.dataset.mv;
            if (i != null) window.moving[i] = e.target.checked;
            render();
        });
        
        // ç¶å®šäº‹ä»¶
        E('btnNow').addEventListener('click', () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            E('dt').value = `${year}-${month}-${day}T${hours}:${minutes}`;
            render();
        });
        
        E('btnPrint').addEventListener('click', () => {
            window.print();
        });
        
        E('btnRandomHex').addEventListener('click', () => {
            const TRIS = ['ä¹¾', 'å…Œ', 'é›¢', 'éœ‡', 'å·½', 'å', 'è‰®', 'å¤'];
            E('upper').value = TRIS[Math.floor(Math.random() * TRIS.length)];
            E('lower').value = TRIS[Math.floor(Math.random() * TRIS.length)];
            render();
        });
        
        E('redraw').addEventListener('click', render);
        
        // é›¶éŒ¢èµ·å¦äº‹ä»¶
        E('btnTossCoins').addEventListener('click', tossCoins);
        E('btnResetCoins').addEventListener('click', resetCoins);
        E('btnApplyCoins').addEventListener('click', applyCoinResults);
        E('btnAutoToss').addEventListener('click', autoTossSixTimes);
        
        // AIåˆ†æäº‹ä»¶
        E('btnAIAnalysis').addEventListener('click', getAITCMAnalysis);
        
        // ç¶å®šè¼¸å…¥äº‹ä»¶
        ['upper', 'lower', 'size', 'offx', 'offy', 'gap', 'headgap', 'w5_mu', 'w5_huo', 'w5_tu', 'w5_jin', 'w5_shui', 'yongShen'].forEach(id => {
            E(id).addEventListener('input', render);
        });
        
        // åˆå§‹åŒ–é¡¯ç¤º
        updateCoinResultsDisplay();
        render();
    });
  </script>
</body>
</html>
