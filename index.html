<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>仙人指路六爻排盤（0901-V1）</title>
<style>
  :root{--card:#fff;--line:#e5e7eb;--muted:#64748b}
  *{box-sizing:border-box}
  body{margin:0;background:#f6f7fb;font-family:"Noto Sans TC","Microsoft JhengHei",system-ui}
  main{max-width:1180px;margin:18px auto;padding:0 12px}
  h1{margin:0 0 10px;font-size:22px}
  /* 【版面修正】：確保內容流暢顯示 */
  .grid{display:flex;gap:12px;flex-wrap:wrap;} 
  .grid>section:nth-child(1) {flex: 1 1 55%;} /* 左側控制台佔大頭 */
  .grid>section:nth-child(2) {flex: 1 1 35%;} /* 右側顯示區佔小頭 */
  .sec{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;margin:10px 0}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0}
  input[type=text]{flex:1;min-width:220px;border:1px solid #cbd5e1;border-radius:8px;height:36px;padding:0 10px;font-size:14px}
  input[type=datetime-local], select, button{height:36px;border:1px solid #cbd5e1;border-radius:8px;background:#fff;padding:0 10px;font-size:14px}
  button{cursor:pointer}
  .muted{color:var(--muted);font-size:13px}
  .badge{display:inline-block;padding:2px 10px;border-radius:999px;background:#eef2ff;color:#4338ca;font-size:12px}
  .yaoCtl{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
  .yaoCtl>label{display:flex;align-items:center;gap:6px;justify-content:center;border:1px dashed #cbd5e1;border-radius:8px;padding:6px;font-size:14px}
  #err{position:fixed;right:12px;top:12px;max-width:60ch;background:#fee2e2;color:#991b1b;border:1px solid #fecaca;border-radius:10px;padding:10px;display:none}
  .miniVal{font-variant-numeric:tabular-nums;color:#475569;font-size:13px}
  .btns button{height:32px}
  .pillars{display:flex;gap:10px;flex-wrap:wrap}
  .pillars span{background:#eef2ff;color:#1e3a8a;border-radius:8px;padding:4px 10px;font-size:13px}
  .rightNote{white-space:pre-wrap;margin-top:8px;background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:10px;font-size:14px}
  
  /* 移除 Canvas 和雷達圖相關的額外樣式 */
  #tcmBox h3{margin:0 0 10px;font-size:16px;color:#0f172a}
  #tcmBox .tcm-note{margin-top:8px;color:#64748b;font-size:12px}
  #brief{display:block!important;font-size:12px;} /* 確保卦象摘要可以顯示 */
  #w5_sec {display: none;} /* 隱藏雷達圖區域 */

  @media print {
    @page { size: A4 portrait; margin: 12mm; }
    .grid { display:block; }
    .sec { border:none; padding:0; margin:0 0 10px; }
    .hide-print { display:none !important; }
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.11/lunar.min.js"></script>
</head>
<body>
<main>
  <h1>仙人指路六爻排盤（0901-V1）</h1>
  <div id="err"></div>

  <div class="grid">
    <section class="sec">
      <div class="row hide-print">
        <label>上卦</label>
        <select id="upper">
          <option>乾</option><option>兌</option><option>離</option><option>震</option>
          <option>巽</option><option selected>坎</option><option>艮</option><option>坤</option>
        </select>
        <span>下卦</span>
        <select id="lower">
          <option selected>坎</option><option>乾</option><option>兌</option><option>離</option>
          <option>震</option><option>巽</option><option>艮</option><option>坤</option>
        </select>
        <span class="badge">伏神＝缺則回本宮純卦補位｜世應：1↔4、2↔5、3↔6</span>
      </div>

      <div class="row btns hide-print" style="gap:8px">
        <button id="btnRandomHex">隨機起卦</button>
      </div>

      <div class="row hide-print" style="gap:14px">
        <label>問題</label>
        <input id="question" type="text" placeholder="請輸入起卦問題（會印在卦象上方）" value="示例：求財運">
      </div>
      
      <div class="row hide-print" style="gap:14px">
        <label>用神</label>
        <select id="yongShen">
          <option value="">（未指定）</option>
          <option value="父母">父母 (學業/文書)</option>
          <option value="兄弟">兄弟 (競爭/劫財)</option>
          <option value="官鬼">官鬼 (事業/疾病)</option>
          <option value="妻財" selected>妻財 (求財/妻子)</option>
          <option value="子孫">子孫 (福德/解憂)</option>
        </select>
        <span id="ysName" class="badge"></span>
      </div>

      <div class="row hide-print" style="gap:14px">
        <label>時間</label>
        <input id="dt" type="datetime-local">
        <button id="btnNow">現在</button>
        <button id="btnPrint">列印（A4）</button>
        <span class="muted">四柱由 Lunar.js 精準換算（含節氣切換）</span>
      </div>

      <div class="row pillars">
        <span id="gzYear">年：—</span>
        <span id="gzMonth">月：—</span>
        <span id="gzDay">日：—</span>
        <span id="gzHour">時：—</span>
        <span id="gzXun">旬首：—</span>
        <span id="gzKW">空亡：—</span>
      </div>

      <div class="row hide-print">
        <label>動爻</label>
        <div class="yaoCtl" id="mvCtl"></div>
      </div>

      <div class="row hide-print" style="gap:10px">
        <button id="redraw">重繪卦象</button>
        <button id="download">匯出 PNG</button>
        </div>

      <div id="noteBox" class="noteBox">
  <label for="userNote" style="display:block;margin:6px 0 4px;color:#0f172a;font-size:14px">備註（會列印）</label>
  <textarea id="userNote" rows="5" placeholder="在此輸入要印在卦象旁的說明、重點、問卦背景等"></textarea>
</div>
      <div class="muted">欄序：<b>六獸</b>｜<b>伏神</b>｜<b>爻象</b>｜<b>六親</b>｜<b>地支</b>｜<b>世應</b>｜<b>變六親</b>｜<b>變支</b>（初爻在下；動爻：陽○、陰×）。</div>
    </section>

    <section class="sec hide-print">
      <div id="headInfo" class="muted" style="font-size:14px">卦名：—　上卦：—　下卦：—　卦宮：—　卦型：—　世：—　應：—</div>
      <pre id="brief" class="rightNote">（這裡會列出六爻摘要）</pre>
<div id="tcmBox" class="tcm-box">
  <h3>中醫分科建議</h3>
  <div id="tcmCore"></div>
  <div id="tcmLists"></div>
  <div class="tcm-note">※ 本欄為一般性養生與就診建議，非醫療診斷；若有急性或持續性不適，請儘速就醫。</div>
</div>
<div id="w5_sec" class="sec">
  <h3 style="margin:0 0 8px;font-size:16px;color:#0f172a">五行雷達圖 (數值核心)</h3>
  <div id="w5_ctrl">
    <p class="muted">圖表功能已移除，下方僅顯示核心數值：</p>
    <div class="row"><label>木 (6)</label><input id="w5_mu" type="range" min="1" max="10" step="1" value="6"><span id="w5_muVal" class="miniVal">6</span></div>
    <div class="row"><label>火 (6)</label><input id="w5_huo" type="range" min="1" max="10" step="1" value="6"><span id="w5_huoVal" class="miniVal">6</span></div>
    <div class="row"><label>土 (6)</label><input id="w5_tu" type="range" min="1" max="10" step="1" value="6"><span id="w5_tuVal" class="miniVal">6</span></div>
    <div class="row"><label>金 (6)</label><input id="w5_jin" type="range" min="1" max="10" step="1" value="6"><span id="w5_jinVal" class="miniVal">6</span></div>
    <div class="row"><label>水 (6)</label><input id="w5_shui" type="range" min="1" max="10" step="1" value="6"><span id="w5_shuiVal" class="miniVal">6</span></div>
  </div>
</div>
</section>
  </div>
</main>

<script>
const E=(id)=>{const el=document.getElementById(id);if(!el){const b=document.getElementById('err');b.style.display='block';b.textContent='⚠️ 缺少元素 #'+id;}return el;};
(function(){const box=E('err');const show=msg=>{box.style.display='block';box.textContent='⚠️ 發生錯誤：'+msg};window.addEventListener('error',e=>show(e.message||e.error));window.addEventListener('unhandledrejection',e=>show(e.reason&&e.reason.message?e.reason:String(e.reason)));})();

/* ===== 常量 ===== */
const GAN=['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
const ZHI=['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];
const ZHI_ELEM={子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'};
const GONG_ELEM={乾:'金',坤:'土',震:'木',巽:'木',坎:'水',離:'火',艮:'土',兌:'金'};
const TRIG={乾:[1,1,1],兌:[1,1,0],離:[1,0,1],震:[1,0,0],巽:[0,1,1],坎:[0,1,0],艮:[0,0,1],坤:[0,0,0]};
const TRINAMES=Object.keys(TRIG); const YANG_TRIG=new Set(['乾','震','坎','艮']);
const INNER_START={乾:'子',坎:'寅',震:'子',艮:'辰',坤:'未',巽:'丑',離:'卯',兌:'巳'};
const OUTER_START={乾:'午',坎:'申',震:'午',艮:'戌',坤:'丑',巽:'未',離:'酉',兌:'亥'};
const SEQ_YANG=['子','寅','辰','午','申','戌']; const SEQ_YIN=['亥','酉','未','巳','卯','丑'];
const SIX=['青龍','朱雀','勾陳','螣蛇','白虎','玄武'];
const SIX_START_BY_GAN={甲:0,乙:0,丙:1,丁:1,戊:2,己:3,庚:4,辛:4,壬:5,癸:5};
const NAMES={ '乾':{'乾':'乾為天','兌':'天澤履','離':'天火同人','震':'天雷無妄','巽':'天風姤','坎':'天水訟','艮':'天山遁','坤':'天地否'},
 '兌':{'乾':'澤天夬','兌':'兌為澤','離':'澤火革','震':'澤雷隨','巽':'澤風大過','坎':'澤水困','艮':'澤山咸','坤':'澤地萃'},
 '離':{'乾':'火天大有','兌':'火澤睽','離':'離為火','震':'火雷噬嗑','巽':'火風鼎','坎':'火水未濟','艮':'火山旅','坤':'火地晉'},
 '震':{'乾':'雷天大壯','兌':'雷澤歸妹','離':'雷火豐','震':'震為雷','巽':'雷風恆','坎':'雷水解','艮':'雷山小過','坤':'雷地豫'},
 '巽':{'乾':'風天小畜','兌':'風澤中孚','離':'風火家人','震':'風雷益','巽':'巽為風','坎':'風水渙','艮':'風山漸','坤':'風地觀'},
 '坎':{'乾':'水天需','兌':'水澤節','離':'水火既濟','震':'水雷屯','巽':'水風井','坎':'坎為水','艮':'水山蹇','坤':'水地比'},
 '艮':{'乾':'山天大畜','兌':'山澤損','離':'山火賁','震':'山雷頤','巽':'山風蠱','坎':'山水蒙','艮':'艮為山','坤':'坤為地'},
 '坤':{'乾':'地天泰','兌':'地澤臨','離':'地火明夷','震':'地雷復','巽':'地風升','坎':'地水師','艮':'地山謙','坤':'坤為地'} };

/* ===== 64卦：卦宮/類型查表 ===== */
const GUA_CLASS = {
  "乾為天":{gong:"乾",type:"本宮"},"天風姤":{gong:"乾",type:"飛"},"天山遯":{gong:"乾",type:"飛"},"天地否":{gong:"乾",type:"飛"},
  "風地觀":{gong:"乾",type:"飛"},"山地剝":{gong:"乾",type:"飛"},"火地晉":{gong:"乾",type:"遊魂"},"火天大有":{gong:"乾",type:"歸魂"},
  "坤為地":{gong:"坤",type:"本宮"},"地雷復":{gong:"坤",type:"飛"},"地澤臨":{gong:"坤",type:"飛"},"地天泰":{gong:"坤",type:"飛"},
  "雷天大壯":{gong:"坤",type:"飛"},"澤天夬":{gong:"坤",type:"飛"},"水天需":{gong:"坤",type:"遊魂"},"水地比":{gong:"坤",type:"歸魂"},
  "震為雷":{gong:"震",type:"本宮"},"雷地豫":{gong:"震",type:"飛"},"雷水解":{gong:"震",type:"飛"},"雷風恆":{gong:"震",type:"飛"},
  "地風升":{gong:"震",type:"飛"},"水風井":{gong:"震",type:"飛"},"澤風大過":{gong:"震",type:"遊魂"},"澤雷隨":{gong:"震",type:"歸魂"},
  "巽為風":{gong:"巽",type:"本宮"},"風天小畜":{gong:"巽",type:"飛"},"風火家人":{gong:"巽",type:"飛"},"風雷益":{gong:"巽",type:"飛"},
  "天雷無妄":{gong:"巽",type:"飛"},"火雷噬嗑":{gong:"巽",type:"飛"},"山雷頤":{gong:"巽",type:"遊魂"},"山風蠱":{gong:"巽",type:"歸魂"},
  "坎為水":{gong:"坎",type:"本宮"},"水澤節":{gong:"坎",type:"飛"},"水雷屯":{gong:"坎",type:"飛"},"水火既濟":{gong:"坎",type:"飛"},
  "澤火革":{gong:"坎",type:"飛"},"雷火豐":{gong:"坎",type:"飛"},"地火明夷":{gong:"坎",type:"遊魂"},"地水師":{gong:"坎",type:"歸魂"},
  "離為火":{gong:"離",type:"本宮"},"火山旅":{gong:"離",type:"飛"},"火風鼎":{gong:"離",type:"飛"},"火水未濟":{gong:"離",type:"飛"},
  "山水蒙":{gong:"離",type:"飛"},"風水渙":{gong:"離",type:"飛"},"天水訟":{gong:"離",type:"遊魂"},"天火同人":{gong:"離",type:"歸魂"},
  "艮為山":{gong:"艮",type:"本宮"},"山火賁":{gong:"艮",type:"飛"},"山天大畜":{gong:"艮",type:"飛"},"山澤損":{gong:"艮",type:"飛"},
  "火澤睽":{gong:"艮",type:"飛"},"天澤履":{gong:"艮",type:"飛"},"風澤中孚":{gong:"艮",type:"遊魂"},"風山漸":{gong:"艮",type:"歸魂"},
  "兌為澤":{gong:"兌",type:"本宮"},"澤水困":{gong:"兌",type:"飛"},"澤地萃":{gong:"兌",type:"飛"},"澤山咸":{gong:"兌",type:"飛"},
  "水山蹇":{gong:"兌",type:"飛"},"地山謙":{gong:"兌",type:"飛"},"雷山小過":{gong:"兌",type:"遊魂"},"雷澤歸妹":{gong:"兌",type:"歸魂"}
};

// 【六爻生剋核心常量】
const WU_SHENG = {木:'火',火:'土',土:'金',金:'水',水:'木'}; // 我生
const WU_KE = {木:'土',土:'水',水:'火',火:'金',金:'木'};    // 我克
const YS_KIN = ['父母','兄弟','官鬼','妻財','子孫'];

// 【Helper】：獲取六親五行對應關係
function getYSFiveElementMap(meElem) {
    // meElem 是卦宮的五行 (兄弟)
    return {
      '父母': WU_SHENG[meElem],              // 生我者
      '兄弟': meElem,                       // 助我者
      '官鬼': WU_KE[meElem],                // 克我者
      '妻財': WU_KE[WU_SHENG[meElem]],      // 我克者 (生兄弟者所克)
      '子孫': WU_SHENG[WU_KE[meElem]]       // 我生者 (克官鬼者)
    };
}


function trigFromBits(b3){for(const n of TRINAMES){const t=TRIG[n];if(t[0]===b3[0]&&t[1]===b3[1]&&t[2]===b3[2]) return n} return null}
function upperLowerOf(lines){const lo=trigFromBits([lines[0],lines[1],lines[2]]), up=trigFromBits([lines[3],lines[4],lines[5]]); return {up,lo}}
function guaNameOf(up,lo){
  const N={'乾':{'乾':'乾為天','兌':'天澤履','離':'天火同人','震':'天雷無妄','巽':'天風姤','坎':'天水訟','艮':'天山遁','坤':'天地否'},
           '兌':{'乾':'澤天夬','兌':'兌為澤','離':'澤火革','震':'澤雷隨','巽':'澤風大過','坎':'澤水困','艮':'澤山咸','坤':'澤地萃'},
           '離':{'乾':'火天大有','兌':'火澤睽','離':'離為火','震':'火雷噬嗑','巽':'火風鼎','坎':'火水未濟','艮':'火山旅','坤':'火地晉'},
           '震':{'乾':'雷天大壯','兌':'雷澤歸妹','離':'雷火豐','震':'震為雷','巽':'雷風恆','坎':'雷水解','艮':'雷山小過','坤':'雷地豫'},
           '巽':{'乾':'風天小畜','兌':'風澤中孚','離':'風火家人','震':'風雷益','巽':'巽為風','坎':'風水渙','艮':'風山漸','坤':'風地觀'},
           '坎':{'乾':'水天需','兌':'水澤節','離':'水火既濟','震':'水雷屯','巽':'水風井','坎':'坎為水','艮':'水山蹇','坤':'水地比'},
           '艮':{'乾':'山天大畜','兌':'山澤損','離':'山火賁','震':'山雷頤','巽':'山風蠱','坎':'山水蒙','艮':'艮為山','坤':'坤為地'},
           '坤':{'乾':'地天泰','兌':'地澤臨','離':'地火明夷','震':'地雷復','巽':'地風升','坎':'地水師','艮':'地山謙','坤':'坤為地'} };
  return (N[up]&&N[up][lo])?N[up][lo]:`${up}上·${lo}下`;
}

const toYMDhm=d=>{const z=n=>(n<10?'0'+n:n);return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}T${z(d.getHours())}:${z(d.getMinutes())}`;};
function threeBranchesOfTrigram(tri,inner){
  const start=inner?INNER_START[tri]:OUTER_START[tri];
  const seq=YANG_TRIG.has(tri)?SEQ_YANG:SEQ_YIN;
  const i0=seq.indexOf(start); return [seq[i0%6],seq[(i0+1)%6],seq[(i0+2)%6]];
}
function naJiaBranches(lines){const {up,lo}=upperLowerOf(lines); return [...threeBranchesOfTrigram(lo,true), ...threeBranchesOfTrigram(up,false)]}
function sixKin(meElem,branch){
  const e=ZHI_ELEM[branch]||'土';
  const GEN={木:'火',火:'土',土:'金',金:'水',水:'木'};
  const CTL={木:'土',土:'水',水:'火',火:'金',金:'木'};
  if(e===meElem) return '兄弟';
  if(CTL[e]===meElem) return '官鬼';
  if(CTL[meElem]===e) return '妻財';
  if(GEN[e]===meElem) return '父母';
  if(GEN[meElem]===e) return '子孫';
  return '兄弟';
}
function changedLines(lines,moving){ return lines.map((v,i)=> moving[i] ? (v?0:1) : v); }

function cycleIndexFromGZ(ganChar,zhiChar){
  const gi=GAN.indexOf(ganChar), zi=ZHI.indexOf(zhiChar);
  for(let k=0;k<60;k++){ if(k%10===gi && k%12===zi) return k; }
  return 0;
}
let pillars=null, dayGan='甲', dayZhi='子';
function calcPillarsAndSix(){
  const s=E('dt').value; const dt=s?new Date(s):new Date();
  const lunar=Lunar.fromDate(dt);
  const Y=lunar.getYearInGanZhiExact();
  const M=lunar.getMonthInGanZhiExact();
  const D=lunar.getDayInGanZhiExact();
  const H=lunar.getTimeInGanZhi();
  pillars={year:Y,month:M,day:D,hour:H};
  dayGan=D.charAt(0); dayZhi=D.charAt(1);
  const idx=cycleIndexFromGZ(dayGan, dayZhi);
  const start=Math.floor(idx/10)*10; const startBranch=ZHI[start%12];
  const kw1=ZHI[(start%12+10)%12], kw2=ZHI[(start%12+11)%12];
  E('gzYear').textContent=`年：${Y}`; E('gzMonth').textContent=`月：${M}`;
  E('gzDay').textContent=`日：${D}`; E('gzHour').textContent=`時：${H}`;
  E('gzXun').textContent=`旬首：${GAN[start%10]}${startBranch}`;
  E('gzKW').textContent=`空亡：${kw1}${kw2}`;
  const startIdx=SIX_START_BY_GAN[dayGan]??0;
  return [0,1,2,3,4,5].map(i=> SIX[(startIdx+i)%6]); // 初→上
}

function purePalaceRows(palace){
  const lines=[...TRIG[palace], ...TRIG[palace]];
  const branches=naJiaBranches(lines);
  const elem=GONG_ELEM[palace];
  const kins=branches.map(b=>sixKin(elem,b));
  return {branches, kins};
}
function buildFuShenForCurrent(meElem,palace,currentKins){
  const NEEDS=['兄弟','父母','官鬼','妻財','子孫'];
  const have=new Set(currentKins);
  const missing=NEEDS.filter(k=>!have.has(k));
  if(missing.length===0) return {};
  const {branches, kins}=purePalaceRows(palace);
  const fuMap={};
  for(const miss of missing){
    const idx=kins.findIndex(k=>k===miss);
    if(idx!==-1){
      const pos=idx+1;
      if(currentKins[idx]!==miss){
        fuMap[pos]=`${branches[idx]} ${miss}`;
      }
    }
  }
  return fuMap;
}
// 【最終修復】：將 y 改為 ying_pos
function yingFromShi_fixed(shi){const ying_pos=shi+3;return ying_pos>6?ying_pos-6:ying_pos;} 

function findShiByYaoBian(lines){
  const eqTri = arr => { const {up,lo}=upperLowerOf(arr); return (up===lo)?up:null; };
  const flipAt=(arr,i)=>{const t=[...arr]; t[i]=t[i]?0:1; return t;};
  let tmp=[...lines];
  for(let i=0;i<5;i++){ tmp=flipAt(tmp,i); if(eqTri(tmp)) return i+1; }
  tmp=[...lines];
  for(let i=4;i>=0;i--){ tmp=flipAt(tmp,i); if(eqTri(tmp)) return (i===0?3:i+1); }
  return 6; 
}
function decideShiYing(upTri, loTri, guaName, lines){
  const info = GUA_CLASS[guaName];
  if(!info || info.type==='飛'){
    const shi=findShiByYaoBian(lines);
    return {shi, ying:yingFromShi_fixed(shi), gong: (info&&info.gong) || upTri, kind: (info?'飛':'飛（保險）')};
  }
  if(info.type==='本宮') return {shi:6, ying:3, gong:info.gong, kind:'本宮'};
  if(info.type==='遊魂') return {shi:4, ying:1, gong:info.gong, kind:'遊魂'};
  if(info.type==='歸魂') return {shi:3, ying:6, gong:info.gong, kind:'歸魂'};
  const shi=findShiByYaoBian(lines);
  return {shi, ying:yingFromShi_fixed(shi), gong:info.gong, kind:'飛（保險）'};
}
let moving=[false,false,false,false,false,false];
// 繪圖變數和 Canvas 設置已移除

// 【六爻用神旺弱計算函數】：計算用神及其五行的旺弱評分 (1-10分)
function calculateYongShenWuxingScores(yongShen, monthZhi, dayZhi, meElem, baseBranches, moving) {
    const defaultScore = 6;
    const scores = {木: defaultScore, 火: defaultScore, 土: defaultScore, 金: defaultScore, 水: defaultScore};
    if (!yongShen || !YS_KIN.includes(yongShen)) return {scores, targetElem: ''};
    
    // 取得五行對應關係和目標五行
    const ysKinElemMap = getYSFiveElementMap(meElem);
    const targetElem = ysKinElemMap[yongShen];

    if (!targetElem) return {scores, targetElem: ''};

    let factor = 0;
    const monthElem = ZHI_ELEM[monthZhi.charAt(1)];
    const dayElem = ZHI_ELEM[dayZhi.charAt(1)];
    
    // --- 1. 月建對用神五行的影響 (權重高) ---
    if (monthElem === targetElem || WU_SHENG[monthElem] === targetElem) { factor += 3; } else if (WU_KE[monthElem] === targetElem) { factor -= 3; } 

    // --- 2. 日辰對用神五行的影響 (權重中) ---
    if (dayElem === targetElem || WU_SHENG[dayElem] === targetElem) { factor += 2; } else if (WU_KE[dayElem] === targetElem) { factor -= 2; }

    // --- 3. 動爻對用神五行的影響 (權重中) ---
    baseBranches.forEach((branch, i) => {
      if (moving[i]) {
        const moveElem = ZHI_ELEM[branch];
        if (moveElem === targetElem || WU_SHENG[moveElem] === targetElem) { factor += 1.5; } else if (WU_KE[moveElem] === targetElem) { factor -= 1.5; }
      }
    });

    // 將總分應用到目標五行，並限制在 1-10
    const finalScore = Math.min(10, Math.max(1, defaultScore + factor));
    
    scores[targetElem] = finalScore;
    E('ysName').textContent = `${yongShen} (五行:${targetElem} 旺度:${finalScore.toFixed(1)})`;

    return {scores, targetElem}; // 回傳分數與目標五行
}

// 【修正：移除繪圖依賴，只更新滑桿數值】
function updateW5RadarScores(scores) {
    if (!scores || !Object.keys(scores).length) return;
    const ELEMENTS = ['木', '火', '土', '金', '水'];
    ELEMENTS.forEach(e => {
        const id = `w5_${e.toLowerCase()}`;
        const el = document.getElementById(id);
        const score = scores[e];

        if (el && typeof score === 'number') {
            const newValue = Math.round(score); 
            if (el.value !== String(newValue)) {
                el.value = newValue;
                // 更新滑桿旁邊的數字顯示
                const valEl = document.getElementById(`${id}Val`);
                if(valEl) valEl.textContent = String(newValue); 
            }
        }
    });
}

// 【新增】：隨機起卦函數
function applyRandomHexagram() {
    const TRIS = ['乾','兌','離','震','巽','坎','艮','坤'];
    
    const upperTri = TRIS[Math.floor(Math.random() * TRIS.length)];
    const lowerTri = TRIS[Math.floor(Math.random() * TRIS.length)];
    E('upper').value = upperTri;
    E('lower').value = lowerTri;
    
    let hasMovingYao = false;
    const mvCtlInputs = document.querySelectorAll('#mvCtl input[type="checkbox"][data-mv]');
    
    mvCtlInputs.forEach(cb => {
        const isMoving = Math.random() < 0.35; // 35% chance to be a moving line
        cb.checked = isMoving;
        if (isMoving) hasMovingYao = true;
    });

    if (!hasMovingYao && mvCtlInputs.length > 0) {
        const randomIndex = Math.floor(Math.random() * mvCtlInputs.length);
        mvCtlInputs[randomIndex].checked = true;
    }
    
    const newMoving = Array.from(mvCtlInputs).map(cb => cb.checked);
    for (let i = 0; i < 6; i++) {
        moving[i] = newMoving[i];
    }
    
    E('question').value = `隨機起卦：${upperTri}${lowerTri}`;
    render();
}


// 【移除】forceRadarUpdate 函數，因為它專門用於繪圖同步

function render(){
  const upTri=E('upper').value, loTri=E('lower').value;
  const yongShen=E('yongShen').value; 
  
  const baseLines=[...TRIG[loTri], ...TRIG[upTri]]; 
  const q=(E('question').value||'').trim()||'—';
  const dt=E('dt').value||toYMDhm(new Date());
  const gzSix=calcPillarsAndSix();
  const xun=E('gzXun').textContent.replace('旬首：','');
  const kw=E('gzKW').textContent.replace('空亡：','');
  const monthZhi = E('gzMonth').textContent.replace('月：',''); 
  const dayZhi = E('gzDay').textContent.replace('日：','');     

  const guaName = guaNameOf(upTri, loTri);
  const {shi, ying, gong, kind} = decideShiYing(upTri, loTri, guaName, baseLines);
  const meElem=GONG_ELEM[gong];
  window.__lastMeElem = meElem;
  
  const branches=naJiaBranches(baseLines);
  const kins=branches.map(b=>sixKin(meElem,b));

  // 【核心計算】用神計算，並傳入五行分數
  let w5Scores = {木:6, 火:6, 土:6, 金:6, 水:6};
  let ysTxt = '';
  if (yongShen) {
    const result = calculateYongShenWuxingScores(yongShen, monthZhi, dayZhi, meElem, branches, moving);
    w5Scores = result.scores;
    const targetElem = result.targetElem; 
    
    ysTxt = `${yongShen} (五行:${targetElem} 旺度:${w5Scores[targetElem].toFixed(1)})`;
  } else {
    E('ysName').textContent = '';
    w5Scores = {木:6, 火:6, 土:6, 金:6, 水:6}; 
  }
  
  // 呼叫更新函數，傳入計算後的五行分數 (只更新文字和滑桿)
  updateW5RadarScores(w5Scores); 
  
  const chLines=changedLines(baseLines,moving);
  const branchesC=naJiaBranches(chLines);
  const kinsC=branchesC.map(b=>sixKin(meElem,b));

  const fuMap=buildFuShenForCurrent(meElem,gong,kins);

  const rows=[];
  for(let pos=6;pos>=1;pos--){
    const i=pos-1;
    rows.push({
      six:gzSix[i],
      fu: fuMap[pos] || '',
      yy: baseLines[i],
      kin: kins[i],
      zhi: branches[i],
      kinc: moving[i]? kinsC[i] : '',
      zhic: moving[i]? branchesC[i] : '',
      mark:(pos===shi)?'世':(pos===ying)?'應':''
    });
  }

  const y=pillars.year, m=pillars.month, d=pillars.day, h=pillars.hour;
  
  // 卦象文字摘要輸出
  const yaoTxt=(yy,mv)=> mv?(yy?'—○—':'--×--'):(yy?'———':'-- --');
  let brief=`卦名：${guaName}｜上：${upTri} 下：${loTri}｜卦宮：${gong}｜卦型：${kind}｜世：${shi} 應：${ying}<br>`;
  brief+=`四柱：${y} ${m} ${d} ${h}　（${xun}｜空亡${kw}）<br>`;
  brief+=`問題：${q}`;
  if(yongShen) brief+=`｜用神：${ysTxt}`; 
  brief+=`<br>起卦：${dt.replace('T',' ')}<br><br>位次  六獸  伏神    爻象  六親  地支  世應  變六親  變支<br>`;
  for(let pos=6;pos>=1;pos--){
    const i=pos-1; const fuTxt=fuMap[pos] || '—';
    brief+=`${pos===6?'上':pos===1?'初':pos}  ${gzSix[i]}  ${fuTxt.padEnd(6,' ')}  ${yaoTxt(baseLines[i],moving[i])}  ${(kins[i]||'').padEnd(2,' ')}  ${(branches[i]||'').padEnd(2,' ')}  ${(pos===shi?'世':(pos===ying?'應':' '))}  ${(moving[i]?kinsC[i]:'').padEnd(2,' ')}  ${moving[i]?branchesC[i]:''}<br>`;
  }

  // 更新 DOM 元素
  E('headInfo').textContent=`卦名：${guaName}　上卦：${upTri}　下卦：${loTri}　卦宮：${gong}　卦型：${kind}　世：${shi}　應：${ying}${yongShen ? `｜用神：${yongShen}` : ''}`;
  E('brief').textContent=brief;

  // 更新右欄中醫建議
  if (window.updateTCMAdvice) try{ window.updateTCMAdvice(meElem, w5Scores); } catch(_) { }
}

function downloadPNG(){
  // 移除 Canvas 依賴
  alert('匯出 PNG 功能已被禁用，請使用瀏覽器列印功能。');
}

window.addEventListener('DOMContentLoaded', ()=>{
  const now=new Date(); const z=n=>(n<10?'0'+n:n);
  E('dt').value=`${now.getFullYear()}-${z(now.getMonth()+1)}-${z(now.getDate())}T${z(now.getHours())}:${z(now.getMinutes())}`;

  E('btnNow').addEventListener('click', ()=>{ const t=new Date(); const z=n=>(n<10?'0'+n:n);
    E('dt').value=`${t.getFullYear()}-${z(t.getMonth()+1)}-${z(t.getDate())}T${z(t.getHours())}:${z(t.getMinutes())}`; render(); });
  E('btnPrint').addEventListener('click', ()=>{ window.print(); });

  const mvCtl=E('mvCtl'); mvCtl.innerHTML='';
  for(let pos=1;pos<=6;pos++){ const i=pos-1; const lab=document.createElement('label');
    lab.innerHTML=`<input type="checkbox" data-mv="${i}"> ${pos===6?'上':pos===1?'初':pos}爻動`; mvCtl.appendChild(lab); }
  mvCtl.addEventListener('change',e=>{const i=+e.target.getAttribute('data-mv'); if(!isNaN(i)){moving[i]=e.target.checked; render();}});

  const bind=(id,fn)=>{const el=E(id);['input','change'].forEach(ev=>el&&el.addEventListener(ev,fn));};
  ['upper','lower','question','dt','size','offx','offy','gap','headgap','yongShen'].forEach(id=>bind(id,render)); 
  E('redraw').addEventListener('click',render);
  E('download').addEventListener('click',downloadPNG);
  
  E('btnRandomHex').addEventListener('click',applyRandomHexagram);

  render();
});
</script>

<script id="TCM_BOX_JS">
(function(){
  if(window.__TCM_BOX__) return; window.__TCM_BOX__=true;
  const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
  const MAP={
    '木':{zang:'肝',fu:'膽',dept:['肝膽科','情志/睡眠','骨傷/筋膜'],patterns:['肝氣鬱結','肝火上炎','肝血不足','肝腎陰虛'],self:['規律作息、舒展拉筋','少酒辣與熬夜','情志舒解（散步、冥想）']},
    '火':{zang:'心',fu:'小腸',dept:['心血管','身心/睡眠'],patterns:['心火亢盛','心脾兩虛','心陰不足'],self:['少咖啡酒精','減少熬夜與重鹹','午間小憩、清心安神']},
    '土':{zang:'脾',fu:'胃',dept:['脾胃消化','內分泌/代謝'],patterns:['脾胃虛弱','濕困脾胃','胃氣上逆'],self:['少冰冷甜膩','三餐定時少量多餐','腹式呼吸、飯後步行']},
    '金':{zang:'肺',fu:'大腸',dept:['呼吸過敏','皮膚','耳鼻喉'],patterns:['肺氣虛','肺陰虛','風寒/風熱犯肺'],self:['避免過敏源','適度蒸氣/保濕','早睡早起、練呼吸']},
    '水':{zang:'腎',fu:'膀胱',dept:['腎泌尿','內科體質'],patterns:['腎陽虛','腎陰虛','腎氣不足'],self:['保暖腰腹與足部','規律作息、早睡','溫和伸展與補水']}
  };
  
  // 【新增】茶飲/湯品數據
  const TEA_MAP = {
      '通用': '安迪湯（補氣養血，增強體力）',
      '木旺': '菊花枸杞茶（清肝明目，疏肝解鬱）',
      '木弱': '桂圓紅棗茶（養血柔肝，改善睡眠）',
      '火旺': '蓮子心茶／竹葉茶（清心降火，幫助安神）',
      '火弱': '酸棗仁湯（滋陰養血，寧心安神）',
      '土弱': '四神湯／紅豆薏仁水（健脾祛濕，利水消腫）',
      '金弱': '銀耳雪梨湯（潤肺生津，止咳化痰）',
      '水弱': '黑豆杜仲茶（補腎益精，強腰補骨）'
  };

  function pickFive(w5Scores){
    if (w5Scores && Object.values(w5Scores).some(x => typeof x === 'number' && !isNaN(x))) {
        return w5Scores;
    }
    // 繪圖功能已移除，所以這裡只需要一個預設值
    return {木:6, 火:6, 土:6, 金:6, 水:6};
  }
  function hiLo(v){ 
    if(!v) return null; 
    const arr=Object.entries(v); 
    arr.sort((a,b)=>b[1]-a[1]); 
    // 【修正點】：放寬觸發門檻 (7.5 -> 7.0, 4.5 -> 5.0)
    const hi=arr.slice(0,3).filter(x=>x[1] > 7.0); // 旺度 > 7.0 視為偏旺
    const lo=arr.slice(-3).filter(x=>x[1] < 5.0); // 旺度 < 5.0 視為偏弱
    return {hi, lo}; 
  }
  function htmlList(items){ return '<ul>'+items.map(s=>'<li>'+s+'</li>').join('')+'</ul>'; }
  
  // 修正：現在 build 函數接收五行分數物件
  window.updateTCMAdvice = function build(meElem, w5Scores){
    const core=$('#tcmCore'), lists=$('#tcmLists'); if(!core||!lists) return;
    const base=MAP[meElem]||MAP['土'];
    const five=pickFive(w5Scores); 
    const trend=hiLo(five);
    
    let tags=`<span class="tag">卦宮五行：${meElem}</span><span class="tag">臟腑：${base.zang}／${base.fu}</span>`;
    if(trend){ 
        tags+=trend.hi.length? `<span class="tag">偏旺：${trend.hi.map(x=>x[0]+'('+x[1].toFixed(0)+')').join('、')}</span>`:''; 
        tags+=trend.lo.length? `<span class="tag">偏弱：${trend.lo.map(x=>x[0]+'('+x[1].toFixed(0)+')').join('、')}</span>`:''; 
    }
    core.innerHTML=tags;

    let html='';
    html+=`<div class="blk"><h4>建議就診科別</h4>${htmlList(base.dept)}</div>`;
    html+=`<div class="blk"><h4>常見體質／症候（參考）</h4>${htmlList(base.patterns)}</div>`;
    
    // 【茶飲建議】
    const teaList = [];
    if (trend && (trend.hi.length > 0 || trend.lo.length > 0)) {
        trend.hi.forEach(([k]) => { if (TEA_MAP[`${k}旺`]) teaList.push(TEA_MAP[`${k}旺`]); });
        trend.lo.forEach(([k]) => { if (TEA_MAP[`${k}弱`]) teaList.push(TEA_MAP[`${k}弱`]); });
    }
    if (teaList.length === 0) {
        teaList.push(TEA_MAP['通用']);
    }
    html+=`<div class="blk"><h4>養生茶飲／湯品</h4>${htmlList(teaList)}</div>`;

    html+=`<div class="blk"><h4>日常調養建議</h4>${htmlList(base.self)}</div>`;

    lists.innerHTML=html;
  }
})();
</script>


<script id="TCM_HOOK_RENDER">
// 讓主 render 結束後會順便更新中醫建議
(function(){
  const _render = window.render; if(!_render) return;
  window.render = function(){ _render.apply(this, arguments); try{ if(window.updateTCMAdvice){ window.updateTCMAdvice(window.__lastMeElem, {木:6, 火:6, 土:6, 金:6, 水:6}); } }catch(_){} };
})();
</script>

<script id="W5_SAFE_JS"></script>

<style id="PRINT_W5_TCM_CSS">
/* 讓「五行雷達圖 + 中醫建議」能列印 */
@media print{
  /* 移除雷達圖相關樣式 */
}
</style>


<style id="SAVE_BAR_V1_CSS">
/* —— 存檔工具列（右上角，列印隱藏） —— */
#saveBarTop{position:fixed;top:10px;right:120px;z-index:10002;display:flex;gap:6px;flex-wrap:wrap}
#saveBarTop button{height:30px;padding:0 10px;border:1px solid #cbd5e1;border-radius:8px;background:#fff;cursor:pointer;font-size:13px}
#saveBarTop button:hover{box-shadow:0 1px 6px rgba(0,0,0,.08)}
@media print{#saveBarTop{display:none!important}}
</style>

<script id="SAVE_BAR_V1_JS"></script>
<script id="SAVE_BAR_VAULT_JS"></script>


<style id="SAVE_BAR_V1_TWEAK">#saveBarTop{right:12px}</style>
<style id="NOTE_PRINT_VAULT_CSS">
/* 備註區塊 */
#noteBox{margin:8px 0 4px}
#userNote{width:100%;min-height:110px;border:1px solid #cbd5e1;border-radius:8px;padding:8px;font-size:14px;resize:vertical}
/* 列印調整：隱藏五行拉桿、工具列與舊列印鈕 */
@media print{
  #w5_ctrl, #saveBarTop, #vaultWrap, #btnPrint{display:none!important}
}
/* 保存庫面板 */
#vaultWrap{position:fixed;top:50px;right:12px;z-index:10003;background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.12);width:360px;max-height:70vh;display:none;overflow:auto}
#vaultWrap .vhdr{font-weight:600;padding:10px 12px;border-bottom:1px solid #e5e7eb;color:#0f172a}
#vaultWrap .vsec{padding:10px 12px}
#vaultWrap .vrow{display:flex;gap:8px;align-items:center;margin:6px 0;flex-wrap:wrap}
#vaultWrap input[type=text]{flex:1;min-width:120px;border:1px solid #cbd5e1;border-radius:8px;height:30px;padding:0 8px}
#vaultWrap select{height:30px;border:1px solid #cbd5e1;border-radius:8px;padding:0 8px}
#vaultWrap button{height:30px;border:1px solid #cbd5e1;border-radius:8px;background:#fff;padding:0 10px;cursor:pointer}
#vaultWrap ul{list-style:none;margin:6px 0 0 0;padding:0;border:1px solid #e5e7eb;border-radius:8px;max-height:36vh;overflow:auto}
#vaultWrap li{display:flex;justify-content:space-between;gap:8px;padding:8px 10px;border-bottom:1px solid #f1f5f9;cursor:pointer}
#vaultWrap li:last-child{border-bottom:none}
#vaultWrap li.sel{background:#f1f5f9}
#vaultWrap .vfoot{padding:10px 12px;border-top:1px solid #e5e7eb;display:flex;justify-content:flex-end;gap:8px}
</style>
</body>
</html>
