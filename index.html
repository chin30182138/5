<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>五行齒輪模擬｜常見症案例版</title>
<style>
  body{margin:0;display:flex;height:100vh;overflow:hidden;font-family:"Noto Sans TC","PingFang TC","Microsoft JhengHei",system-ui,sans-serif}
  canvas{flex:1;display:block;background:#ffffff}
  #controls{
    width:300px;background:#f7f7f8;border-left:1px solid #e5e7eb;box-sizing:border-box;
    padding:12px 12px 16px;overflow:auto
  }
  h2{font-size:16px;margin:8px 0 8px}
  .section{border:1px solid #e5e7eb;background:#fff;border-radius:10px;padding:10px;margin-bottom:10px}
  .row{display:flex;align-items:center;gap:8px;margin:6px 0}
  label{font-size:14px;min-width:2em}
  input[type=range]{flex:1}
  input[type=number]{width:72px}
  select,button,input[type=color]{width:100%;height:34px;border:1px solid #cbd5e1;border-radius:8px;background:#fff}
  button{cursor:pointer}
  .muted{font-size:12px;color:#64748b}
  /* 五行強度條 */
  .bar{height:10px;background:#e2e8f0;border-radius:999px;overflow:hidden}
  .bar>span{display:block;height:100%;border-radius:999px}
  .b-wood{background:#2ecc71}
  .b-fire{background:#e74c3c}
  .b-earth{background:#f1c40f}
  .b-metal{background:#cfd8dc}
  .b-water{background:#3498db}
  .line{display:flex;justify-content:space-between;align-items:center;gap:8px;margin:8px 0}
  .line .name{min-width:2em}
  #caseNote{margin-top:8px;padding:8px;border-radius:8px;background:#f8fafc;border:1px solid #e2e8f0;color:#334155;font-size:13px;line-height:1.5}
</style>
</head>
<body>
<canvas id="canvas"></canvas>

<div id="controls">
  <h2>常見症案例</h2>
  <div class="section">
    <select id="caseSelect">
      <option value="">（選一個案例）</option>
      <option value="insomnia">失眠</option>
      <option value="headache">頭痛</option>
      <option value="obesity">肥胖</option>
      <option value="piShi">脾濕</option>
      <option value="yangWei">陽痿</option>
    </select>
    <div class="row" style="margin-top:8px">
      <button id="applyCase">套用案例</button>
    </div>
    <div id="caseNote" class="muted">選擇後按「套用案例」，可再用下方滑桿微調。</div>
  </div>

  <h2>五行入/實（速度）</h2>
  <div class="section" id="sliders">
    <div class="row"><label>木</label><input type="range" id="wood" min="-180" max="180" step="1" value="0"><input type="number" id="woodVal" value="0"></div>
    <div class="row"><label>火</label><input type="range" id="fire" min="-180" max="180" step="1" value="0"><input type="number" id="fireVal" value="0"></div>
    <div class="row"><label>土</label><input type="range" id="earth" min="-180" max="180" step="1" value="0"><input type="number" id="earthVal" value="0"></div>
    <div class="row"><label>金</label><input type="range" id="metal" min="-180" max="180" step="1" value="0"><input type="number" id="metalVal" value="0"></div>
    <div class="row"><label>水</label><input type="range" id="water" min="-180" max="180" step="1" value="0"><input type="number" id="waterVal" value="0"></div>
    <div class="row"><button id="resetAll">全部歸零</button></div>
    <div class="muted">負值＝逆轉（入）；正值＝順時針（實）。</div>
  </div>

  <h2>整體控制</h2>
  <div class="section">
    <div class="row"><label>大小</label><input type="range" id="gearSize" min="20" max="110" value="60"></div>
    <div class="row"><label>垂直</label><input type="range" id="gearOffsetY" min="-200" max="240" value="0"></div>
    <div class="row"><label>水平</label><input type="range" id="gearOffsetX" min="-240" max="240" value="0"></div>
    <div class="row"><label>自動</label><input type="checkbox" id="autoScale" checked><span class="muted">手機自動大小</span></div>
    <div class="row"><label>背景</label><input type="color" id="bgColor" value="#ffffff"></div>
  </div>

  <h2>五行強度（實際）</h2>
  <div class="section" id="bars">
    <div class="line"><span class="name">木</span><div class="bar"><span id="bw" class="b-wood" style="width:0%"></span></div><span id="pw" class="muted">0</span></div>
    <div class="line"><span class="name">火</span><div class="bar"><span id="bf" class="b-fire" style="width:0%"></span></div><span id="pf" class="muted">0</span></div>
    <div class="line"><span class="name">土</span><div class="bar"><span id="be" class="b-earth" style="width:0%"></span></div><span id="pe" class="muted">0</span></div>
    <div class="line"><span class="name">金</span><div class="bar"><span id="bm" class="b-metal" style="width:0%"></span></div><span id="pm" class="muted">0</span></div>
    <div class="line"><span class="name">水</span><div class="bar"><span id="ba" class="b-water" style="width:0%"></span></div><span id="pa" class="muted">0</span></div>
    <div class="muted">以「實際速度」的絕對值換算（0～180）。</div>
  </div>

  <div class="muted">仙人指路占卜研究學會｜阿青師製作</div>
</div>

<script>
/* ====== 畫布 ====== */
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
function resize(){
  canvas.width = window.innerWidth - document.getElementById('controls').offsetWidth;
  canvas.height = window.innerHeight;
}
addEventListener("resize", resize); resize();

/* ====== 狀態 ====== */
let RADIUS = 60;
let OFFSET_Y = 0;
let OFFSET_X = 0;
let autoScale = true;
let bgColor = "#ffffff";

const colors = { wood:"#2ecc71", fire:"#e74c3c", earth:"#f1c40f", metal:"#bdc3c7", water:"#3498db" };
const angle = { wood:0, fire:0, earth:0, metal:0, water:0 };
const input = { wood:0, fire:0, earth:0, metal:0, water:0 };
const speed = { wood:0, fire:0, earth:0, metal:0, water:0 };

const BASE_CW = 12;                  // 基礎順時針
const K_GEN = 0.20, K_CTRL = 0.50, K_REB = 0.30;
const generateOf = { wood:'fire', fire:'earth', earth:'metal', metal:'water', water:'wood' };
const controlTo  = { wood:'earth', earth:'water', water:'fire',  fire:'metal', metal:'wood' };
const HK = { enabled:true, K_HK_FIRE_GAIN:0.60, K_HK_WOOD_BACK:0.40, K_HK_EARTH_FEED:0.30, K_HK_METAL_BURN:0.50 };

const cap = v => Math.max(-180, Math.min(180, v));

/* ====== 常見症案例（入/實：-180~180）====== */
const CASES = {
  // 失眠：多因心火擾神 / 陰虛火旺，常見「火旺、水虧，木稍亢，土稍助，金受克」
  insomnia: { wood: 10, fire: 60, earth: 10, metal: -10, water: -40 },
  // 頭痛：常見肝陽上亢（木亢）、火上擾，金水略受抑
  headache: { wood: 50, fire: 20, earth: 0,  metal: -10, water: -10 },
  // 肥胖：多屬痰濕內盛、脾運失健 → 水濕偏盛、土虛、其餘偏低
  obesity:  { wood:-10, fire:-10, earth:-40, metal:-10, water: 40 },
  // 脾濕：重點在「土運差、水濕偏盛」
  piShi:    { wood:-10, fire:-10, earth:-50, metal:-10, water: 30 },
  // 陽痿：多見腎陽不足 → 水虛明顯，火不足、土稍虛，其餘平
  yangWei:  { wood:  0, fire:-20, earth:-10, metal:  0, water:-70 }
};
const CASE_DESC = {
  insomnia: "失眠：火旺擾神，水不足制火；木稍亢助火，土略助運化，金受火剋。",
  headache: "頭痛：多見肝陽上亢（木亢）兼火上擾，金水略被抑制。",
  obesity:  "肥胖：痰濕內盛，水濕偏多；脾土虛，運化失職，其餘偏低。",
  piShi:    "脾濕：土虛為主，運化不及；水濕偏盛，木火金皆略受抑。",
  yangWei:  "陽痿：腎陽不足，水虛明顯；心火不足，脾土亦虛。"
};

/* ====== 計算關係 ====== */
function applyRelations(){
  for(const k in speed) speed[k] = input[k];

  // 相生
  for(const a in generateOf){ const b = generateOf[a]; speed[b] += input[a]*K_GEN; }

  // 相剋
  for(const a in controlTo){ const b = controlTo[a]; speed[b] -= Math.sign(input[a]) * Math.abs(input[a]) * K_CTRL; }

  // 反剋
  for(const a in controlTo){
    const b = controlTo[a];
    const diff = Math.abs(speed[b]) - Math.abs(speed[a]);
    if(diff > 0){ const sgn = Math.sign(speed[b]); speed[a] -= sgn * diff * K_REB; }
  }

  // 心腎相交（特例：水<0）
  if (HK.enabled && speed.water < 0){
    const mag = Math.abs(speed.water);
    speed.fire += HK.K_HK_FIRE_GAIN * mag;
    const fm = Math.abs(speed.fire);
    speed.wood  -= HK.K_HK_WOOD_BACK  * fm;
    speed.earth += HK.K_HK_EARTH_FEED * fm;
    speed.metal -= HK.K_HK_METAL_BURN * fm;
  }

  // 基礎順時針與限幅
  for(const k in speed) speed[k] = cap(speed[k] + BASE_CW);
}

/* ====== 位置與繪圖 ====== */
function center(){ return { x: canvas.width/2 + OFFSET_X, y: canvas.height/2 + OFFSET_Y }; }

function drawGear(x,y,r,deg,fillColor,text){
  const teeth=14, step=Math.PI/(teeth), R1=r, R2=r*1.12;
  ctx.save(); ctx.translate(x,y); ctx.rotate(deg);

  // 外齒
  ctx.beginPath();
  for(let i=0;i<teeth*2;i++){
    const useR=(i%2===0)?R2:R1, a=-Math.PI/2+i*step;
    const px=useR*Math.cos(a), py=useR*Math.sin(a);
    (i===0)?ctx.moveTo(px,py):ctx.lineTo(px,py);
  }
  ctx.closePath();
  const g=ctx.createRadialGradient(0,0,r*0.2,0,0,R2); g.addColorStop(0,"#ffffffcc"); g.addColorStop(1,fillColor);
  ctx.fillStyle=g; ctx.fill(); ctx.lineWidth=2; ctx.strokeStyle="#25314f"; ctx.stroke();

  // 內輻條＋中心孔
  const innerR=r*0.65, spokeW=Math.max(3,r*0.07);
  ctx.lineWidth=spokeW; ctx.strokeStyle="rgba(0,0,0,0.35)";
  for(let s=0;s<4;s++){ const a=s*Math.PI/2; ctx.beginPath(); ctx.moveTo(innerR*Math.cos(a),innerR*Math.sin(a)); ctx.lineTo((r*0.25)*Math.cos(a),(r*0.25)*Math.sin(a)); ctx.stroke(); }
  ctx.beginPath(); ctx.arc(0,0,Math.max(6,r*0.22),0,Math.PI*2); ctx.lineWidth=2; ctx.strokeStyle="rgba(0,0,0,0.4)"; ctx.stroke();

  // 旋轉指示點
  ctx.beginPath(); ctx.arc(0,-R2-4,Math.max(3,r*0.06),0,Math.PI*2); ctx.fillStyle="#000"; ctx.fill();

  ctx.restore();

  // 中文大字
  ctx.save();
  ctx.font = `bold ${Math.round(r*0.6)}px "Noto Sans TC","PingFang TC","Microsoft JhengHei",system-ui,sans-serif`;
  ctx.textAlign="center"; ctx.textBaseline="middle";
  ctx.lineWidth=4; ctx.strokeStyle="rgba(0,0,0,0.78)"; ctx.strokeText(text,x,y+1);
  ctx.fillStyle="#fff"; ctx.fillText(text,x,y+1);
  ctx.restore();
}

/* ====== 主循環 ====== */
let last = performance.now();
function loop(now){
  const dt = (now - last)/1000; last = now;

  // 自動大小（手機/窄螢幕）
  if (autoScale){
    const shortSide = Math.min(canvas.width, canvas.height);
    RADIUS = Math.max(24, Math.min(110, Math.round(shortSide/8)));
    const sizeSlider = document.getElementById('gearSize');
    if (sizeSlider) sizeSlider.value = RADIUS;
  }

  applyRelations();
  for(const k in angle){ angle[k] = (angle[k] + speed[k]*dt) % 360; }

  // 背景
  ctx.fillStyle = bgColor;
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // 位置
  const c = center();
  const d = RADIUS*2 + 26;
  const pos = {
    earth:{x:c.x, y:c.y,     label:'土', color:colors.earth},
    wood :{x:c.x-d, y:c.y,   label:'木', color:colors.wood },
    fire :{x:c.x, y:c.y-d,   label:'火', color:colors.fire },
    metal:{x:c.x+d, y:c.y,   label:'金', color:colors.metal},
    water:{x:c.x, y:c.y+d,   label:'水', color:colors.water}
  };

  // 齒輪
  drawGear(pos.earth.x,pos.earth.y,RADIUS, angle.earth*Math.PI/180, pos.earth.color, pos.earth.label);
  drawGear(pos.wood .x,pos.wood .y,RADIUS, angle.wood *Math.PI/180, pos.wood .color, pos.wood .label);
  drawGear(pos.fire .x,pos.fire .y,RADIUS, angle.fire *Math.PI/180, pos.fire .color, pos.fire .label);
  drawGear(pos.metal.x,pos.metal.y,RADIUS, angle.metal*Math.PI/180, pos.metal.color, pos.metal.label);
  drawGear(pos.water.x,pos.water.y,RADIUS, angle.water*Math.PI/180, pos.water.color, pos.water.label);

  // 署名
  ctx.save();
  const SIGN="仙人指路占卜研究學會 阿青師製作";
  ctx.font='bold 18px "Noto Sans TC","PingFang TC","Microsoft JhengHei",system-ui,ui-sans-serif,sans-serif';
  ctx.textAlign='left'; ctx.textBaseline='top'; ctx.fillStyle='rgba(0,0,0,0.55)';
  ctx.fillText(SIGN, 12, 10);
  ctx.restore();

  // 更新強度條
  updateBars();

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* ====== 強度條（以「實」＝speed 的絕對值）====== */
function toPct(v){ return Math.round(Math.min(100, Math.max(0, Math.abs(v)/180*100))); }
function updateBars(){
  const pairs = [
    ['bw','pw',speed.wood],
    ['bf','pf',speed.fire],
    ['be','pe',speed.earth],
    ['bm','pm',speed.metal],
    ['ba','pa',speed.water],
  ];
  for(const [barId,txtId,val] of pairs){
    const pct = toPct(val);
    const bar = document.getElementById(barId);
    const txt = document.getElementById(txtId);
    if(bar) bar.style.width = pct + '%';
    if(txt) txt.textContent = Math.round(val);
  }
}

/* ====== 綁定：滑桿 & 數值 ====== */
function bind(id,key){
  const s = document.getElementById(id);
  const n = document.getElementById(id+'Val');
  const set = v => { v = cap(+v||0); s.value=v; n.value=v; input[key]=v; };
  s.addEventListener('input', ()=> set(s.value));
  n.addEventListener('input', ()=> set(n.value));
}
bind('wood','wood'); bind('fire','fire'); bind('earth','earth'); bind('metal','metal'); bind('water','water');

document.getElementById('resetAll').addEventListener('click', ()=>{
  for(const k of ['wood','fire','earth','metal','water']){
    input[k]=0; document.getElementById(k).value=0; document.getElementById(k+'Val').value=0;
  }
});

/* ====== 整體控制 ====== */
document.getElementById('gearSize').addEventListener('input', e=>{
  autoScale=false; document.getElementById('autoScale').checked=false;
  RADIUS = +e.target.value;
});
document.getElementById('gearOffsetY').addEventListener('input', e=>{ OFFSET_Y = +e.target.value; });
document.getElementById('gearOffsetX').addEventListener('input', e=>{ OFFSET_X = +e.target.value; });
document.getElementById('autoScale').addEventListener('change', e=>{
  autoScale = e.target.checked;
});
document.getElementById('bgColor').addEventListener('input', e=>{ bgColor = e.target.value; });

/* ====== 套用案例 ====== */
const caseNote = document.getElementById('caseNote');
document.getElementById('applyCase').addEventListener('click', ()=>{
  const key = document.getElementById('caseSelect').value;
  if(!key || !CASES[key]){ caseNote.textContent = "請先選擇一個案例。"; return; }
  const preset = CASES[key];
  for(const k of ['wood','fire','earth','metal','water']){
    const v = preset[k] ?? 0;
    input[k] = v;
    document.getElementById(k).value = v;
    document.getElementById(k+'Val').value = v;
  }
  caseNote.textContent = CASE_DESC[key] || "已套用預設，可再用滑桿微調。";
});
</script>
</body>
</html>
