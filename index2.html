<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>五行齒輪（穩定顯示版）</title>
<style>
  *{box-sizing:border-box}
  body{margin:0;height:100vh;display:flex;font-family:"Noto Sans TC","Microsoft JhengHei",system-ui}
  #left{flex:1;min-width:0}
  #canvas{width:100%;height:100%;display:block;background:#fff}
  #controls{width:320px;max-width:45vw;background:#f7f7f8;border-left:1px solid #e5e7eb;padding:12px;overflow:auto}
  h2{margin:8px 0;font-size:16px}
  .section{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:10px;margin-bottom:10px}
  .tabs{display:flex;gap:6px;flex-wrap:wrap}
  .tab{padding:6px 10px;border:1px solid #cbd5e1;border-radius:999px;background:#fff;cursor:pointer}
  .tab.active{background:#1d4ed8;color:#fff;border-color:#1d4ed8}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
  .btn{padding:8px;border:1px solid #cbd5e1;border-radius:10px;background:#fff;cursor:pointer}
  .btn:hover{background:#eef2ff}
  .row{display:flex;gap:8px;align-items:center;margin:6px 0}
  label{min-width:2em}
  input[type=range]{flex:1}
  input[type=number]{width:72px}
  .muted{font-size:12px;color:#64748b}
</style>
</head>
<body>
  <div id="left"><canvas id="canvas"></canvas></div>
  <aside id="controls">
    <h2>分科案例</h2>
    <div class="section">
      <div id="tabs" class="tabs"></div>
      <div id="cases" class="grid"></div>
      <div id="note" class="muted" style="margin-top:8px">點案例即套用；仍可用下方滑桿微調。</div>
    </div>

    <h2>五行入/實</h2>
    <div class="section">
      <div class="row"><label>木</label><input type="range" id="wood" min="-180" max="180" value="0"><input type="number" id="woodVal" value="0"></div>
      <div class="row"><label>火</label><input type="range" id="fire" min="-180" max="180" value="0"><input type="number" id="fireVal" value="0"></div>
      <div class="row"><label>土</label><input type="range" id="earth" min="-180" max="180" value="0"><input type="number" id="earthVal" value="0"></div>
      <div class="row"><label>金</label><input type="range" id="metal" min="-180" max="180" value="0"><input type="number" id="metalVal" value="0"></div>
      <div class="row"><label>水</label><input type="range" id="water" min="-180" max="180" value="0"><input type="number" id="waterVal" value="0"></div>
      <div class="row"><button id="reset" style="width:100%">全部歸零</button></div>
      <div class="muted">負值＝逆轉（入）；正值＝順時針（實）。</div>
    </div>

    <h2>整體控制</h2>
    <div class="section">
      <div class="row"><label>大小</label><input type="range" id="gearSize" min="24" max="110" value="60"></div>
      <div class="row"><label>垂直</label><input type="range" id="offY" min="-240" max="240" value="0"></div>
      <div class="row"><label>水平</label><input type="range" id="offX" min="-280" max="280" value="0"></div>
      <div class="row"><label>背景</label><input type="color" id="bg" value="#ffffff"></div>
      <div class="row"><label>心腎</label><input type="checkbox" id="hk" checked><span class="muted">心腎相交啟用</span></div>
    </div>
    <div class="muted">仙人指路占卜研究學會｜阿青師製作</div>
  </aside>

<script>
/* ===== 基本狀態 ===== */
const cvs = document.getElementById('canvas'), ctx = cvs.getContext('2d');
const left = document.getElementById('left'), controls = document.getElementById('controls');
function fit(){ cvs.width = left.clientWidth; cvs.height = left.clientHeight; }
addEventListener('resize', fit); fit();

let R=60, OX=0, OY=0, BG='#ffffff';
const angle={wood:0,fire:0,earth:0,metal:0,water:0};
const input={wood:0,fire:0,earth:0,metal:0,water:0};
const speed={wood:0,fire:0,earth:0,metal:0,water:0};
const color={wood:'#2ecc71',fire:'#e74c3c',earth:'#f1c40f',metal:'#cfd8dc',water:'#3498db'};

const BASE=12, K_GEN=0.2, K_CTRL=0.5, K_REB=0.3;
const gen={wood:'fire',fire:'earth',earth:'metal',metal:'water',water:'wood'};
const ctl={wood:'earth',earth:'water',water:'fire',fire:'metal',metal:'wood'};
const HK={enabled:true,FG:0.6,WB:0.4,EF:0.3,MB:0.5};
const cap=v=>Math.max(-180,Math.min(180,v));

/* ===== 案例（精簡，但包含你要的現代病） ===== */
const CASES={
  神志:{失眠:{wood:10,fire:60,earth:10,metal:-10,water:-40},心悸焦慮:{wood:0,fire:50,earth:10,metal:-10,water:-20}},
  頭部:{偏頭痛:{wood:50,fire:20,earth:0,metal:-10,water:-10},眩暈:{wood:20,fire:10,earth:0,metal:0,water:-30}},
  消化:{肥胖:{wood:-10,fire:-10,earth:-40,metal:-10,water:40},脾濕:{wood:-10,fire:-10,earth:-50,metal:-10,water:30}},
  代謝:{高血壓:{wood:40,fire:30,earth:0,metal:-10,water:-20},高血脂:{wood:-10,fire:-10,earth:30,metal:-10,water:10},"高血糖(糖尿病)":{"wood":0,"fire":30,"earth":-30,"metal":0,"water":-40}}
};
const DESC={
  失眠:"補水、瀉火、調心腎", 心悸焦慮:"瀉火、補土",
  偏頭痛:"瀉木火、補水制木", 眩暈:"補水填精、平肝熄風",
  肥胖:"化濕祛痰、健脾",     脾濕:"健脾祛濕、補土",
  高血壓:"平肝瀉火、滋水涵木", 高血脂:"化濕祛痰、健脾",
  "高血糖(糖尿病)":"滋陰補水、健脾、瀉火"
};

/* ===== UI：分科＋案例 ===== */
const tabs=document.getElementById('tabs'), casesDiv=document.getElementById('cases'), note=document.getElementById('note');
const depts=Object.keys(CASES); let activeDept=depts[0];
function renderTabs(){
  tabs.innerHTML='';
  depts.forEach(d=>{
    const b=document.createElement('button'); b.className='tab'+(d===activeDept?' active':''); b.textContent=d;
    b.onclick=()=>{activeDept=d; renderTabs(); renderCases(); note.textContent='點案例即套用；仍可用滑桿微調。'};
    tabs.appendChild(b);
  });
}
function renderCases(){
  casesDiv.innerHTML='';
  Object.keys(CASES[activeDept]).forEach(name=>{
    const b=document.createElement('button'); b.className='btn'; b.textContent=name;
    b.onclick=()=>{
      const p=CASES[activeDept][name];
      ['wood','fire','earth','metal','water'].forEach(k=>{
        input[k]=p[k]||0; document.getElementById(k).value=input[k]; document.getElementById(k+'Val').value=input[k];
      });
      note.textContent=DESC[name]||'已套用預設。';
    };
    casesDiv.appendChild(b);
  });
}
renderTabs(); renderCases();

/* ===== 邏輯：相生相剋＋心腎相交 ===== */
function applyRelations(){
  for(const k in speed) speed[k]=input[k];
  for(const a in gen){ const b=gen[a]; speed[b]+=input[a]*K_GEN; }
  for(const a in ctl){ const b=ctl[a]; speed[b]-=Math.sign(input[a])*Math.abs(input[a])*K_CTRL; }
  for(const a in ctl){ const b=ctl[a]; const diff=Math.abs(speed[b])-Math.abs(speed[a]); if(diff>0){ const s=Math.sign(speed[b]); speed[a]-=s*diff*K_REB; } }
  if(HK.enabled && speed.water<0){
    const m=Math.abs(speed.water);
    speed.fire+=HK.FG*m;
    const fm=Math.abs(speed.fire);
    speed.wood-=HK.WB*fm; speed.earth+=HK.EF*fm; speed.metal-=HK.MB*fm;
  }
  for(const k in speed) speed[k]=cap(speed[k]+BASE);
}

/* ===== 繪圖 ===== */
function center(){ return {x:cvs.width/2+OX, y:cvs.height/2+OY}; }
function drawGear(x,y,r,deg,fill,txt){
  const teeth=14, step=Math.PI/teeth, R1=r, R2=r*1.12;
  ctx.save(); ctx.translate(x,y); ctx.rotate(deg);
  ctx.beginPath();
  for(let i=0;i<teeth*2;i++){ const rr=(i%2===0)?R2:R1, a=-Math.PI/2+i*step; const px=rr*Math.cos(a), py=rr*Math.sin(a); i?ctx.lineTo(px,py):ctx.moveTo(px,py); }
  ctx.closePath();
  const g=ctx.createRadialGradient(0,0,r*0.2,0,0,R2); g.addColorStop(0,'#ffffffcc'); g.addColorStop(1,fill);
  ctx.fillStyle=g; ctx.fill(); ctx.lineWidth=2; ctx.strokeStyle='#25314f'; ctx.stroke();
  // 指示點
  ctx.beginPath(); ctx.arc(0,-R2-4,Math.max(3,r*0.06),0,Math.PI*2); ctx.fillStyle='#000'; ctx.fill();
  ctx.restore();
  // 大字
  ctx.save();
  ctx.font=`bold ${Math.round(r*0.6)}px "Noto Sans TC","Microsoft JhengHei",system-ui`;
  ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.lineWidth=4; ctx.strokeStyle='rgba(0,0,0,.75)'; ctx.strokeText(txt,x,y+1);
  ctx.fillStyle='#fff'; ctx.fillText(txt,x,y+1);
  ctx.restore();
}

let last=performance.now();
function loop(now){
  const dt=(now-last)/1000; last=now;
  applyRelations();
  for(const k in angle){ angle[k]=(angle[k]+speed[k]*dt)%360; }

  ctx.fillStyle=BG; ctx.fillRect(0,0,cvs.width,cvs.height);
  const c=center(), d=R*2+26;
  const pos={ earth:{x:c.x,y:c.y,l:'土',f:color.earth},
              wood:{x:c.x-d,y:c.y,l:'木',f:color.wood},
              fire:{x:c.x,y:c.y-d,l:'火',f:color.fire},
              metal:{x:c.x+d,y:c.y,l:'金',f:color.metal},
              water:{x:c.x,y:c.y+d,l:'水',f:color.water} };
  drawGear(pos.earth.x,pos.earth.y,R, angle.earth*Math.PI/180,pos.earth.f,pos.earth.l);
  drawGear(pos.wood.x ,pos.wood.y ,R, angle.wood *Math.PI/180,pos.wood.f ,pos.wood.l );
  drawGear(pos.fire.x ,pos.fire.y ,R, angle.fire *Math.PI/180,pos.fire.f ,pos.fire.l );
  drawGear(pos.metal.x,pos.metal.y,R, angle.metal*Math.PI/180,pos.metal.f,pos.metal.l);
  drawGear(pos.water.x,pos.water.y,R, angle.water*Math.PI/180,pos.water.f,pos.water.l);

  // 署名
  ctx.fillStyle='rgba(0,0,0,.55)'; ctx.font='bold 16px "Noto Sans TC","Microsoft JhengHei"';
  ctx.fillText('仙人指路占卜研究學會 阿青師製作', 12, 10);

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* ===== 綁定控制 ===== */
function bind(id,key){
  const s=document.getElementById(id), n=document.getElementById(id+'Val');
  const set=v=>{ v=cap(+v||0); s.value=v; n.value=v; input[key]=v; };
  s.addEventListener('input',()=>set(s.value)); n.addEventListener('input',()=>set(n.value));
}
['wood','fire','earth','metal','water'].forEach(k=>bind(k,k));
document.getElementById('reset').onclick=()=>{
  ['wood','fire','earth','metal','water'].forEach(k=>{ input[k]=0; document.getElementById(k).value=0; document.getElementById(k+'Val').value=0; });
};
document.getElementById('gearSize').oninput=e=>{ R=+e.target.value; };
document.getElementById('offX').oninput=e=>{ OX=+e.target.value; };
document.getElementById('offY').oninput=e=>{ OY=+e.target.value; };
document.getElementById('bg').oninput=e=>{ BG=e.target.value; };
document.getElementById('hk').onchange=e=>{ HK.enabled=e.target.checked; };
</script>
</body>
</html>
